# OverlayFS

## Introdução

O Docker utiliza o kernel do Linux e diversos recursos de sistemas de arquivos para fornecer isolamento e eficiência na gestão de contêineres. Um dos componentes centrais desse mecanismo é o **OverlayFS**, um sistema de arquivos do tipo **union** que permite montar múltiplas camadas de diretório (lower, upper, work) em um único ponto de montagem (merged). Nesta explicação, cobriremos em detalhe como o Docker faz uso do OverlayFS para organizar suas camadas de imagem e camadas de contêiner.

## Sumário

1. [Conceitos Fundamentais](OverlayFS%202159462188c680eca625d75e8922ac28.md)
2. [Sintaxe Detalhada e Uso Prático](OverlayFS%202159462188c680eca625d75e8922ac28.md)
3. [Cenários de Restrição ou Não Aplicação](OverlayFS%202159462188c680eca625d75e8922ac28.md)
4. [Componentes Chave Associados](OverlayFS%202159462188c680eca625d75e8922ac28.md)
5. [Melhores Práticas e Padrões de Uso](OverlayFS%202159462188c680eca625d75e8922ac28.md)
6. [Exemplo Prático Completo](OverlayFS%202159462188c680eca625d75e8922ac28.md)
7. [Sugestões para Aprofundamento](OverlayFS%202159462188c680eca625d75e8922ac28.md)

---

## 1. Conceitos Fundamentais

### 1.1 Union Filesystems

UnionFS é um conceito de sistemas de arquivos que permite adicionar múltiplos sistemas de arquivos em camadas (layers), exibindo-os como uma única árvore unificada. Cada camada pode ser somente leitura ou leitura/gravação, possibilitando reutilização de conteúdo comum e gravações diferenciadas por contêiner.

### 1.2 OverlayFS

OverlayFS é uma implementação nativa no kernel Linux de um union filesystem. Ela trabalha com:

- **lowerdir**: diretório somente leitura, onde residem camadas base (por exemplo, camadas de imagem Docker).
- **upperdir**: diretório leitura/gravação, onde alterações feitas pelo contêiner são registradas.
- **workdir**: diretório necessário para operações internas de OverlayFS (garante consistência de gravação).
- **merged**: ponto de montagem unificado que apresenta a união de lowerdir e upperdir.

No contexto do Docker:

- Cada imagem Docker consiste em múltiplas camadas somente leitura, todas montadas como lowerdir.
- Ao iniciar um contêiner, o Docker cria um upperdir e workdir exclusivos, permitindo gravações sem alterar a imagem base.
- O sistema de arquivos exibido dentro do contêiner é o merged.

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Montagem Manual de OverlayFS

```bash
# Criar diretórios
mkdir -p /tmp/lower /tmp/upper /tmp/work /tmp/merged

# Montar OverlayFS
mount -t overlay overlay   -o lowerdir=/tmp/lower,upperdir=/tmp/upper,workdir=/tmp/work   /tmp/merged

```

- **lowerdir** pode apontar para múltiplos diretórios separados por dois pontos (`:`).
- Após montagem, `/tmp/merged` reflete o conteúdo de `/tmp/lower`, mas gravações vão para `/tmp/upper`.

### 2.2 Configuração do Docker

No arquivo **/etc/docker/daemon.json**, configure o driver de armazenamento:

```json
{
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.size=100G"
  ]
}

```

- `"overlay2"` é a versão recomendada para a maioria das distribuições Linux.
- **storage-opts** permite ajustes como tamanho máximo para sistemas de arquivos contidos.

### 2.3 Estrutura em Disco

Dentro de **/var/lib/docker/overlay2**, você encontrará:

```
<layer-id>/
  diff/         # conteúdo da camada somente leitura
  merged/       # ponto de montagem unificado
  work/         # diretório de trabalho
  lower/        # links simbólicos para camadas inferiores

```

- Um contêiner ativo cria subdiretórios próprios para upper e work, mantendo isolamento entre contêineres.

---

## 3. Cenários de Restrição ou Não Aplicação

- **Sistemas de arquivos não compatíveis**: OverlayFS requer suporte no kernel (>=3.10) e sistemas de arquivos subjacentes que permitam reflinks (recomendado XFS ou ext4).
- **Recursos limitados**: em ambientes com I/O de disco lento, múltiplas camadas podem impactar desempenho de leitura/gravação.
- **Uso de drivers alternativos**: em distribuições sem suporte a OverlayFS, o Docker pode usar drivers como **aufs**, **devicemapper**, **btrfs** ou **zfs**.

---

## 4. Componentes Chave Associados

- **overlay2**: driver Docker que gerencia múltiplos lowerdir em uma única upperdir/workdir.
- **containerd**: daemon intermediário que cria e gerencia snapshots de OverlayFS.
- **runc**: runtime responsável por efetuar o mount final e iniciar o contêiner.
- **lowerdir**, **upperdir**, **workdir**: opções essenciais de montagem.
- **Merged Directory**: ponto apresentado ao processo dentro do contêiner.

---

## 5. Melhores Práticas e Padrões de Uso

- **Limitar camadas**: minimize o número de camadas em imagens Docker para reduzir lookup em lowerdir múltiplos.
- **Usar overlay2**: é o driver mais maduro e suportado.
- **Monitoração de uso de disco**: acompanhe espaço em /var/lib/docker/overlay2 para evitar esgotamento.
- **Compactar imagens**: remova arquivos temporários ao final do Dockerfile para reduzir tamanho de lowerdir.

---

## 6. Exemplo Prático Completo

Imaginemos uma **aplicação Node.js**:

1. **Dockerfile**:
    
    ```
    FROM node:18 AS build
    WORKDIR /app
    COPY package.json .
    RUN npm install
    COPY . .
    RUN npm run build
    
    FROM node:18-slim
    WORKDIR /app
    COPY --from=build /app/dist ./dist
    CMD ["node", "dist/index.js"]
    
    ```
    
2. **Processo de montagem**:
    - O Docker baixa a imagem `node:18` criando lowerdir para cada camada.
    - Na fase `build`, cria upperdir específico para escrever dependências e build.
    - Na fase `runtime`, utiliza overlay2 para unificar lowerdir das camadas base com upperdir mínimo contendo `dist`.
    - O contêiner final executa sobre o merged resultante.

---

## 7. Sugestões para Aprofundamento

- Documentação oficial do kernel sobre OverlayFS: [https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html](https://www.kernel.org/doc/html/latest/filesystems/overlayfs.html)
- Guia de storage drivers do Docker: [https://docs.docker.com/storage/storagedriver/](https://docs.docker.com/storage/storagedriver/)
- Artigos sobre performance de UnionFS em Linux.

---