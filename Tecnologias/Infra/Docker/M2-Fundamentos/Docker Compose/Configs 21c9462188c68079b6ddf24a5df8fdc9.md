# Configs

**Gerenciamento de Configuração com Docker Compose Configs**

---

## Sumário

1. [Introdução](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#introdu%C3%A7%C3%A3o)
2. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
3. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - 3.1. Top-level `configs`
    - 3.2. Acesso via `services.configs` (short & long syntax)
4. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
5. [Componentes-Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
6. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
7. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
8. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Introdução

Em ambientes de múltiplos containers, manter dados de configuração separados da imagem Docker é essencial para flexibilidade e segurança. O recurso **configs** do Docker Compose (baseado em Docker Swarm) permite definir e gerenciar arquivos de configuração de forma declarativa no seu *compose.yaml*, sem a necessidade de rebuild de imagem a cada ajuste de parâmetros. Isso promove práticas de infraestrutura como código, facilita rollbacks e simplifica a gestão de configurações sensíveis e não-sensíveis.

---

## Conceitos Fundamentais

- **Decoupling de Configuração:** Mantém o mesmo artefato de imagem em diferentes ambientes (dev, staging, prod), alterando apenas o conteúdo do config.
- **Montagem como Arquivo:** Tal como volumes, configs são montados no filesystem do container, mas carregados e versionados pelo Docker Swarm.
- **Controle de Acesso e Permissões:** Configs são, por padrão, **0444** (world-readable) e pertencentes ao usuário que executa o container, mas podem ser ajustados por serviço. ([docs.docker.com](https://docs.docker.com/reference/compose-file/configs/?utm_source=chatgpt.com))

---

## Sintaxe Detalhada e Uso Prático

### 3.1. Top-level `configs`

Define ou referencia os dados usados pelos serviços. Cada entrada é um map com as seguintes propriedades possíveis:

| Campo | Descrição |
| --- | --- |
| `file` | Caminho para arquivo local cujos conteúdos serão registrados como config. |
| `environment` | (v2.23.1+) Valor vindo de variável de ambiente. |
| `content` | (v2.23.1+) Valor inline diretamente no Compose. |
| `external` | `true` se o config já existe no Swarm; não será criado pelo Compose. |
| `name` | Nome explícito do objeto no Docker Engine (útil para caracteres especiais). |

```yaml
configs:
  app_config:
    file: ./config/app.conf
  secret_token:
    external: true
  dynamic_setting:
    environment: APP_SETTING
  inline_notes:
    content: |
      # notas
      enabled=true

```

([docs.docker.com](https://docs.docker.com/reference/compose-file/configs/?utm_source=chatgpt.com))

---

### 3.2. Acesso via `services.configs`

Para que um serviço utilize um config, é **obrigatório** declará-lo em `services.<nome>.configs`. Há duas sintaxes:

### 3.2.1. Short Syntax

Basta listar o **nome** do config; será montado em `/<nome>` (Linux) ou `C:\<nome>` (Windows).

```yaml
services:
  web:
    image: nginx:latest
    configs:
      - app_config
      - secret_token

configs:
  app_config:
    file: ./config/app.conf
  secret_token:
    external: true

```

([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

### 3.2.2. Long Syntax

Permite customizar destino, propriedade de usuário e permissões:

| Campo | Descrição |
| --- | --- |
| `source` | Nome do config definido no top-level. |
| `target` | Path completo dentro do container (padrão: `/<source>`). |
| `uid` | UID do proprietário do arquivo montado (padrão: usuário do container). |
| `gid` | GID do grupo proprietário. |
| `mode` | Permissões octais (ex.: `0440`, `0644`; bit de escrita é ignorado, exec pode ser aplicado). |

```yaml
services:
  web:
    image: nginx:latest
    configs:
      - source: app_config
        target: /etc/nginx/conf.d/app.conf
        uid: "1000"
        gid: "1000"
        mode: 0440

configs:
  app_config:
    file: ./config/app.conf

```

([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

## Cenários de Restrição ou Não Aplicação

- **Somente Swarm Services:** Configs são um recurso de Docker Swarm. Não funcionam em containers standalone sem modo Swarm ou em engine sem suporte a configs. ([docs.docker.com](https://docs.docker.com/engine/swarm/configs/?utm_source=chatgpt.com))
- **Tamanho Máximo:** Cada config suporta até ~500 KB. Para arquivos maiores, considere volumes.
- **Permissões Limitadas:** O bit de escrita é sempre ignorado; se escrita for necessária, use um volume ou outro mecanismo.
- **Fallback de Plataforma:** Se o nó não suportar configs, o Compose reporta erro na criação ou atribuição.

---

## Componentes-Chave Associados

1. **Docker Swarm Configs** (`docker config create`/`docker config ls`): recurso subjacente de CLI ([docs.docker.com](https://docs.docker.com/engine/swarm/configs/?utm_source=chatgpt.com))
2. **Compose Spec Version:** Requer Compose V2.23.1+ para `environment` e `content`.
3. **`docker compose config` CLI:** Verifica e renderiza a configuração completa antes de aplicar. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/config/?utm_source=chatgpt.com))

---

## Melhores Práticas e Padrões de Uso

- **Agrupamento Lógico:** Nomeie configs por propósito (ex.: `db_cert`, `oauth_tokens`).
- **Uso de `external` em Prod:** Crie e gerencie configs via CLI/infra CI e referencie como `external: true`.
- **Inline para Pequenos Valores:** Variáveis ou flags simples podem usar `content:`.
- **Auditoria de Permissões:** Defina `mode: 0440` para configs sensíveis, garantindo leitura restrita a grupos.
- **Evitar Rebuilds:** Use configs ao invés de build-time ENV para alterações frequentes.
- **Documentação:** Inclua comentários nos exemplos para cada campo, facilitando manutenção.

---

## Exemplo Prático Completo

```yaml
version: "3.8"

# 1. Definição de Configs
configs:
  nginx_conf:
    file: ./deploy/nginx.conf
  app_settings:
    environment: APP_SETTINGS_JSON
  feature_flags:
    content: |
      {
        "betaFeature": true,
        "maxItems": 50
      }

services:
  api:
    image: myorg/api:latest
    deploy:
      replicas: 3
    configs:
      # Short syntax: monta /app_settings
      - app_settings

  web:
    image: nginx:latest
    ports:
      - "80:80"
    configs:
      # Long syntax: monta nginx.conf em /etc/nginx/nginx.conf
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
        uid: "0"
        gid: "0"
        mode: 0444
      # Inline de feature flags
      - source: feature_flags
        target: /etc/nginx/flags.json

  worker:
    image: myorg/worker:latest
    configs:
      - app_settings
      - feature_flags

```

1. **`nginx_conf`** é carregado de arquivo local.
2. **`app_settings`** vem de variável de ambiente no CI/CD (ex.: JSON).
3. **`feature_flags`** é um JSON inline, fácil de versionar no Compose.

---

## Sugestões para Aprofundamento

- [Compose Specification (GitHub)](https://github.com/compose-spec/compose-spec)
- [Referência de Configs no Docker Engine (Swarm)](https://docs.docker.com/engine/swarm/configs/)
- Artigos de blog sobre **Feature Flags** e **Infraestrutura como Código**

---

Se precisar de exemplos adicionais ou aprofundar algum tópico específico, fico à disposição!