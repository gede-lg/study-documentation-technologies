# Include

**Título: Modularizando Configurações com `include` no Docker Compose**

---

## Introdução

O elemento top-level `include` do Docker Compose permite que você **quebre configurações complexas** em múltiplos arquivos menores e reutilizáveis. Em vez de gerenciar um único `docker-compose.yaml` inchado, você pode **incluir** otros Compose files, cada um tratado como um sub-projeto, e agregá-los na hora de subir sua aplicação.

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada
    - 2.1. Short Syntax
    - 2.2. Long Syntax
3. Cenários onde **não** usar `include`
4. Componentes-Chave
    - `path`
    - `project_directory`
    - `env_file`
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Propósito**: Modularizar configurações, delegando partes da aplicação a arquivos especializados (por exemplo, serviços comuns a vários domínios).
- **Como funciona**: Cada arquivo listado em `include` é carregado como um **sub-projeto Docker Compose**, mantendo seu próprio contexto para resolução de paths e variáveis. Ao final, todos os recursos (services, volumes, networks etc.) são mesclados no modelo principal. ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/include/?utm_source=chatgpt.com))

---

## 2. Sintaxe Detalhada

### 2.1. Short Syntax

Define apenas uma lista de caminhos. O Compose carrega cada arquivo, usando sua própria pasta como **project directory** e um `.env` opcional para interpolação de variáveis.

```yaml
include:
  - ../commons/compose.yaml
  - ../another_domain/compose.yaml

services:
  webapp:
    depends_on:
      - included-service

```

- **Resolução de paths**: relativa ao diretório de cada arquivo incluído.
- **Interpolação de variáveis**: usa `.env` no diretório do Compose incluído, mas permite override pelos valores do ambiente local. ([docs.docker.com](https://docs.docker.com/reference/compose-file/include/?utm_source=chatgpt.com))

---

### 2.2. Long Syntax

Oferece controle granular para cada arquivo incluído:

```yaml
include:
  - path: ../commons/compose.yaml
    project_directory: ..
    env_file: ../another/.env
  - path:
      - ../shared/compose.yaml
      - ./override.yaml
    env_file:
      - ../shared/.env
      - ../shared/dev.env

services:
  app:
    image: my-app:latest

```

| Campo | Descrição |
| --- | --- |
| `path` (string ou lista) | Localização do(s) arquivo(s) Compose a serem incluídos. |
| `project_directory` | Base para resolver caminhos relativos no Compose incluído. Default: diretório do arquivo referenciado. |
| `env_file` (string ou lista) | Arquivo(s) de ambiente para definir valores padrão em interpolação de variáveis. Default: `.env` no `project_directory`. |
- **Merge de múltiplos Compose**: quando `path` for lista, os arquivos serão **mesclados** na ordem informada antes de serem incluídos. ([docs.docker.com](https://docs.docker.com/reference/compose-file/include/?utm_source=chatgpt.com))

---

## 3. Cenários de Restrição ou Não Aplicação

- **Simplicidade**: para projetos pequenos (1 ou 2 serviços), a inclusão pode adicionar complexidade desnecessária.
- **Performance**: muitas camadas de include podem tornar o parsing inicial mais lento.
- **Override fino**: se precisa somente alterar algumas configurações de um serviço, o `extends` ou uso de múltiplos `f` no CLI pode ser mais apropriado.

---

## 4. Componentes-Chave Associados

1. **`path`**
    - Define o(s) arquivo(s) Compose a incluir.
    - Pode ser uma string (arquivo único) ou lista (merge prévio).
2. **`project_directory`**
    - Base para resolver caminhos relativos (volumes, build contexts etc.).
    - Útil quando o arquivo incluído vive em local distinto do repositório principal.
3. **`env_file`**
    - Define valores padrão para interpolação.
    - Permite mesclar vários arquivos de ambiente, útil em cenários multi-ambiente (dev, qa, prod).

---

## 5. Melhores Práticas e Padrões de Uso

- **Organização por equipe ou domínio**: separar configurações de infra-comuns (banco, redis) em arquivos próprios.
- **Prefixo de projeto explícito**: utilize `project_directory` para manter consistência na resolução de arquivos.
- **Controle de versões**: trate arquivos incluídos como sub-módulos Git ou pacotes versionados.
- **Documentação clara**: inclua comentários e um README explicando a arquitetura de includes.

---

## 6. Exemplo Prático Completo

**Estrutura de diretórios:**

```
project/
├─ docker-compose.yaml
├─ commons/
│  ├─ compose.yaml
│  └─ .env
└─ services/
   ├─ auth/
   │  └─ compose.yaml
   └─ payments/
      └─ compose.yaml

```

**`docker-compose.yaml` principal:**

```yaml
include:
  - path: commons/compose.yaml
    env_file: commons/.env
  - path:
      - services/auth/compose.yaml
      - services/auth/override.yaml
    project_directory: services/auth
  - path: services/payments/compose.yaml

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"

```

- **Execução**:
    
    ```bash
    docker compose up -d
    
    ```
    
    O Compose carrega `commons/compose.yaml`, aplica variáveis de `commons/.env`, mescla `auth/compose.yaml` com `auth/override.yaml`, inclui `payments/compose.yaml` e, por fim, sobe o serviço `frontend`.
    

---

## 7. Sugestões para Aprofundamento

- **Working with multiple Compose files** (How-tos)
- **CLI: `docker compose --profile`**, para perfis de serviços
- **Compose Specification** no GitHub, para entender regras de merge detalhadas

---

Com este guia, você tem uma visão completa do `include`: desde conceitos centrais, usos práticos, até melhores práticas e um exemplo real, facilitando a modularização de aplicações Docker Compose.