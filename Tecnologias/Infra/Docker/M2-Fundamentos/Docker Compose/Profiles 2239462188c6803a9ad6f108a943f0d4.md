# Profiles

**Docker Compose Profiles: Configuração e Uso Detalhado**

---

## Introdução

Em ambientes de desenvolvimento e produção, frequentemente precisamos ajustar quais serviços são iniciados pelo Docker Compose sem manter múltiplos arquivos de configuração. **Profiles** (perfís) foram introduzidos para resolver exatamente esse problema, permitindo agrupar serviços e ativá-los de forma seletiva conforme o cenário desejado. Com isso, é possível manter um único `docker-compose.yml` que atenda a diferentes contextos (desenvolvimento, testes, debug, staging, etc.) sem duplicação de configurações ([docs.docker.com](https://docs.docker.com/reference/compose-file/profiles/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Uso via CLI e Variáveis de Ambiente](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#uso-via-cli-e-vari%C3%A1veis-de-ambiente)
4. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
5. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
6. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
7. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
8. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **O que são Profiles?**
    
    São rótulos atribuídos a serviços dentro do Compose que definem quando esses serviços devem ser incluídos no modelo de aplicação. Serviços sem atributo `profiles` são sempre ativos. ([docs.docker.com](https://docs.docker.com/reference/compose-file/profiles/?utm_source=chatgpt.com))
    
- **Propósito e Importância**
    - Redução de duplicidade: evita manter múltiplos arquivos `docker-compose.yml`.
    - Flexibilidade: ativa apenas o subconjunto de serviços necessários para testes, debug, ou produção.
    - Legibilidade: centraliza configurações e facilita a manutenção. ([docs.docker.com](https://docs.docker.com/compose/how-tos/profiles/?utm_source=chatgpt.com))
- **Como Funciona**
    - Ao fazer o parsing do Compose, apenas serviços cujo perfil está ativo (ou sem perfil) são considerados.
    - Se um serviço referenciado for parte de um perfil inativo, um erro de dependência é lançado. ([docs.docker.com](https://docs.docker.com/reference/compose-file/profiles/?utm_source=chatgpt.com))

---

## Sintaxe Detalhada e Uso Prático

### Definindo Perfis no `docker-compose.yml`

```yaml
services:
  web:
    image: web_image
    # Sem profiles: sempre ativo

  test_lib:
    image: test_lib_image
    profiles:
      - test

  debug_lib:
    image: debug_lib_image
    depends_on:
      - test_lib
    profiles:
      - debug

```

- `profiles:` aceita um **array** de nomes de perfil.
- Perfis seguem a regex `[a-zA-Z0-9][a-zA-Z0-9_.-]+` ([docs.docker.com](https://docs.docker.com/compose/how-tos/profiles/?utm_source=chatgpt.com)).
- Serviços sem `profiles` iniciam sempre; serviços com `profiles` iniciam somente se o perfil estiver ativo. ([docs.docker.com](https://docs.docker.com/reference/compose-file/profiles/?utm_source=chatgpt.com))

### Variações e Comentários

```yaml
services:
  db:
    image: mysql:8
    # exemplo de serviço sempre ativo

  metrics:
    image: prom/prometheus
    profiles: ["monitoring", "metrics"]
    # inicia quando 'monitoring' OU 'metrics' estiver ativo

```

- Permite escalonar perfis para casos compostos (ex.: `monitoring` e `metrics`).
- Comentários no YAML (`# ...`) ajudam a documentar cenários de ativação.

---

## Uso via CLI e Variáveis de Ambiente

### Ativando Perfis pela Linha de Comando

```bash
docker compose --profile test up

```

- A flag `-profile` pode ser repetida para múltiplos perfis:
    
    ```bash
    docker compose --profile frontend --profile debug up
    ``` :contentReference[oaicite:6]{index=6}
    
    ```
    

### Variável de Ambiente `COMPOSE_PROFILES`

- Alternativa para não precisar repetir flags a cada comando:
    
    ```bash
    export COMPOSE_PROFILES="debug,metrics"
    docker compose up
    
    ```
    
- Também suportada em arquivos `.env`. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/?utm_source=chatgpt.com))

---

## Cenários de Restrição ou Não Aplicação

1. **Dependências Cruzadas Incompatíveis**
    
    Se um serviço em perfil `A` depende de outro em perfil `B`, mas apenas `A` é ativado, ocorre erro de dependência.
    
2. **Configurações Específicas de Versão**
    
    Perfis não alteram atributos fora da seção `services`. Redes, volumes e outros elementos de topo sempre são carregados.
    
3. **Ambientes Sem Compose V2**
    
    Perfis requerem Docker Compose V2 (CLI `docker compose`). Em versões legadas (`docker-compose`), não disponíveis.
    

---

## Componentes Chave Associados

- **`profiles` (services → list)**
    
    Define os perfis em que o serviço participa.
    
- **CLI Flag `-profile`**
    
    Ativa perfis pontuais no comando.
    
- **Variável `COMPOSE_PROFILES`**
    
    Configura perfis de forma persistente via ambiente.
    
- **Resolução de Dependências**
    
    Se um serviço ativo depende de outro inativo, erro é lançado:
    
    > “service X depends_on service Y, which is not selected by active profiles” (docs.docker.com).
    > 

---

## Melhores Práticas e Padrões de Uso

- **Nomear Perfis de Forma Descritiva**
    
    Ex.: `test`, `debug`, `staging`, `monitoring`.
    
- **Manter Serviços Sempre Ativos para Core**
    
    Perfis apenas para serviços complementares (logs, métricas, debug).
    
- **Documentar Cenários no Próprio YAML**
    
    Use comentários claros sobre quando cada perfil deve ser ativado.
    
- **Testar Perfis Individualmente**
    
    Validar:
    
    ```bash
    docker compose --profile debug config
    
    ```
    
    para checar configuração consolidada.
    
- **Combinar com Múltiplos Arquivos `f`**
    
    Arquivos separados para ajustes finos, mas preferir perfis quando possível.
    

---

## Exemplo Prático Completo

```yaml
version: "3.9"

services:
  app:
    image: example/app:latest

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=app

  redis:
    image: redis:6
    profiles: ["cache"]

  prometheus:
    image: prom/prometheus
    profiles: ["monitoring"]
    ports:
      - "9090:9090"

  debug_tools:
    image: nicolaka/netshoot
    profiles: ["debug"]
    command: ["sleep", "3600"]

```

- **Cenário “Default”**:
    
    ```bash
    docker compose up
    
    ```
    
    Inicia apenas `app` e `db`.
    
- **Cenário “Cache”**:
    
    ```bash
    docker compose --profile cache up
    
    ```
    
    Inclui `redis`.
    
- **Cenário Completo**:
    
    ```bash
    COMPOSE_PROFILES="cache,monitoring,debug" docker compose up
    
    ```
    
    Inicia todos os serviços, inclusive ferramentas de debug e métricas.
    

---

## Sugestões para Aprofundamento

- **Compose Specification** ([https://github.com/compose-spec/compose-spec](https://github.com/compose-spec/compose-spec))
- **Best Practices**: testar `docker compose config` para cada perfil.
- **Artigos e Casos de Uso**: explorar blogs como Event-Driven.io e posts no Medium sobre perfis avançados.

---

Com esse guia completo, você deve estar apto a configurar, utilizar e gerenciar **Profiles** no Docker Compose de forma eficaz, garantindo flexibilidade e clareza em múltiplos cenários de implantação.