# Fragments

**Fragments no Docker Compose: Uso de Anchors e Aliases**

---

## Introdução

No contexto do Docker Compose, **fragments** referem-se ao uso de recursos nativos do YAML — **anchors** e **aliases** — para criar blocos reutilizáveis de configuração. Isso torna o arquivo `docker-compose.yml` mais organizado, evita duplicação de código e minimiza erros de manutenção. Nesta explicação, exploraremos em detalhes como definir, referenciar e estender fragments, além de suas limitações e boas práticas. ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/))

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Exemplo 1: Volumes com Anchor
    - Exemplo 2: Environment com Alias
    - Exemplo 3: Merge parcial de mappings
    - Exemplo 4: Extensão de fragments
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes-Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Anchor (`&`)**: Define um bloco nomeado de configuração que pode ser reutilizado.
- **Alias ()**: Refere-se a um anchor previamente definido, inserindo seu conteúdo no local onde o alias é usado.
- **Resolução de Fragments**: O processamento de anchors e aliases ocorre **antes** da interpolação de variáveis do Compose, portanto não é possível usar variáveis para criar nomes de anchors ou aliases ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/)).
- **YAML Merge (`<<:`)**: Permite mesclar um mapping existente (via alias) e, opcionalmente, sobrescrever ou estender seus atributos ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/)).

O uso de fragments melhora a manutenibilidade quando configurações idênticas ou semelhantes se repetem em múltiplos serviços, volumes ou outros blocos do Compose.

---

## Sintaxe Detalhada e Uso Prático

### Exemplo 1: Volumes com Anchor

```yaml
volumes:
  db-data: &default-volume
    driver: default
  metrics: *default-volume

```

- `&default-volume`: define um anchor chamado `default-volume` baseado na configuração de `db-data`.
- `default-volume`: reutiliza exatamente a mesma configuração em `metrics`.

> Observação: Anchors não podem ser definidos via variáveis de ambiente, pois sua resolução acontece antes da interpolação. (docs.docker.com)
> 

---

### Exemplo 2: Environment com Alias

```yaml
services:
  first:
    image: my-image:latest
    environment: &env
      - CONFIG_KEY
      - EXAMPLE_KEY
      - DEMO_VAR
  second:
    image: another-image:latest
    environment: *env

```

- Define-se um bloco `environment` com o anchor `&env`.
- Em outro serviço, `environment: *env` importa exatamente as mesmas variáveis.
- Útil para compartilhar listas de variáveis entre múltiplos serviços. ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/))

---

### Exemplo 3: Merge Parcial de Mappings

Quando deseja-se **sobrescrever parcialmente** atributos de um bloco ancorado, utiliza-se o operador de merge `<<:` do YAML:

```yaml
services:
  backend:
    image: example/database
    volumes:
      - db-data
      - metrics

volumes:
  db-data: &default-volume
    driver: default
    name: "data"
  metrics:
    <<: *default-volume
    name: "metrics"

```

- `metrics` recebe inicialmente toda a configuração de `default-volume`.
- Em seguida, sobrescreve o atributo `name`, mantendo `driver: default`.
- **Limitação:** o YAML merge só funciona para *mappings* (objetos), não para *sequences* (listas) ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/)).

---

### Exemplo 4: Extensão de Fragments

Além de sobrescrever, é possível **estender** um bloco, adicionando novos pares:

```yaml
services:
  first:
    image: my-image:latest
    environment: &env
      FOO: BAR
      ZOT: QUIX
  second:
    image: another-image:latest
    environment:
      <<: *env
      YET_ANOTHER: VARIABLE

```

- Aqui, `second.environment` importa as chaves `FOO` e `ZOT` e adiciona `YET_ANOTHER`.
- Importante: usar sintaxe de mapping (`CHAVE: VALOR`) quando envolver fragments. ([docs.docker.com](https://docs.docker.com/reference/compose-file/fragments/))

---

## Cenários de Restrição ou Não Aplicação

- **Sequences (listas)**: Merges de listas não são suportados pelo YAML; somente por meio de concatenação manual ou templates externos.
- **Interpolação de Variáveis**: Não é possível usar variáveis para definir nomes de anchors ou aliases.
- **Complexidade Excessiva**: Em arquivos muito grandes, excesso de fragments pode dificultar a leitura. Avaliar se vale a pena abstrair em múltiplos arquivos via **include** ou **multiple-compose-files**.

---

## Componentes-Chave Associados

- **`&<nome>`**: cria um anchor.
- **`<nome>`**: referencia um anchor.
- **`<<: *<nome>`**: YAML merge para mappings, importando e sobrescrevendo atributos.
- **`include` / múltiplos arquivos**: alternativa para fragmentação quando há dependências entre projetos.

---

## Melhores Práticas e Padrões de Uso

1. **Nomeclatura Clara**: Escolher nomes de anchors que reflitam seu propósito (e.g., `&common-env`, `&default-volume`).
2. **Limitar Escopo**: Use anchors locais ao arquivo ou grupo de serviços que compartilham configuração.
3. **Documentação Inline**: Comente cada anchor explicando seu uso, evitando confusão.
4. **Combine com Extensões**: Use anchors junto a `extends` ou `include` quando precisar reutilizar configuração entre projetos distintos.
5. **Valide o Arquivo**: Sempre execute `docker compose config` após alterações para verificar se os fragments estão sendo resolvidos corretamente.

---

## Exemplo Prático Completo

Imaginemos um cenário com três serviços que compartilham variáveis de ambiente e configuração de rede:

```yaml
version: "3.9"

x-env: &common-env
  DATABASE_URL: "postgres://user:pass@db:5432/app"
  REDIS_URL: "redis://cache:6379"

x-network: &common-network
  driver: bridge

networks:
  default_network:
    <<: *common-network

services:
  web:
    image: myapp/web:latest
    environment: *common-env
    networks:
      - default_network
    ports:
      - "80:80"

  worker:
    image: myapp/worker:latest
    environment: *common-env
    networks:
      - default_network

  scheduler:
    image: myapp/scheduler:latest
    environment:
      <<: *common-env
      SCHEDULE_INTERVAL: "5m"
    networks:
      - default_network

```

- **`x-env`**: anchor centraliza todas as variáveis comuns.
- **`x-network`**: anchor para rede padrão.
- **`environment`**: importado por todos, com extensão para `scheduler`.
- **Validação**: use `docker compose config` para garantir o merge correto.

---

## Sugestões para Aprofundamento

- Explore **YAML anchors/aliases** em documentação oficial do YAML: [https://yaml.org/spec/1.2/spec.html](https://yaml.org/spec/1.2/spec.html)
- Avalie **multiple Compose files** e `include` para fragmentação entre diferentes equipes.
- Pesquise sobre **templating** (e.g., Jsonnet, Helm) quando precisar de lógica condicional na geração de arquivos Compose.

---

Com esta base, você estará apto a aplicar **fragments** de forma eficaz em seus projetos Docker Compose, tornando seus arquivos mais limpos, reutilizáveis e fáceis de manter.