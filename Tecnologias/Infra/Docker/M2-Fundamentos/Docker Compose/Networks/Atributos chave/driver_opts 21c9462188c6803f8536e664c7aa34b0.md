# driver_opts

## Título da Explicação

Explorando o atributo `driver_opts` em `networks` do Docker Compose

## Introdução

Em Docker Compose, as redes definem como os serviços comunicam entre si dentro de um projeto, criando rotas IP e isolamentos conforme necessário ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)). Sob a chave `networks`, o atributo `driver_opts` permite repassar parâmetros específicos diretamente ao driver de rede, habilitando customizações de baixo nível, como configurações avançadas de bridge e parent interfaces em macvlan ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)).

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

## Conceitos Fundamentais

O atributo `driver_opts` especifica um mapeamento de opções (pares chave-valor) que são repassadas ao driver de rede correspondente, sendo seu conteúdo totalmente dependente do driver selecionado ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)). Isso permite ajustar configurações que não estão disponíveis nas opções padrão do Compose, como binding de IPs específicos, parâmetros de sub-interface ou flags avançadas do driver ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).

## Sintaxe Detalhada e Uso Prático

A seguir, exemplos comentados de como declarar `driver_opts` em diferentes drivers:

```yaml
networks:
  # 1) Rede customizada usando o driver 'bridge'
  frontend:
    driver: bridge          # Driver de bridge padrão
    driver_opts:            # Opções específicas ao driver bridge
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"

```

- `driver: bridge` especifica o driver nativo de bridge do Docker ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- Em `driver_opts`, o par `com.docker.network.bridge.host_binding_ipv4` força o binding IPv4 do host para “127.0.0.1” ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))

```yaml
networks:
  # 2) Rede usando o driver 'macvlan'
  macvlan_net:
    driver: macvlan        # Exponha containers como dispositivos físicos
    driver_opts:           # Parâmetros do driver macvlan
      parent: eth0         # Interface física usada pelo macvlan
    ipam:                  # Configuração de IPAM para controlar sub-rede
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

```

- `driver: macvlan` atribui um MAC único a cada container, simulando um dispositivo físico ([docs.docker.com](https://docs.docker.com/engine/network/drivers/macvlan/?utm_source=chatgpt.com))
- `parent: eth0` define a interface de rede do host utilizada para tráfego macvlan ([docs.docker.com](https://docs.docker.com/engine/network/drivers/macvlan/?utm_source=chatgpt.com))

## Cenários de Restrição ou Não Aplicação

- Quando `external: true` é usado, todas as outras propriedades (incluindo `driver_opts`) são ignoradas, pois a rede já existe externamente ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).
- Em Compose **versões ≤ 3.3**, combinar `external` com `driver_opts` resulta em erro de validação; a limitação foi removida a partir da **versão 3.4** ([github.com](https://github.com/docker/docker.github.io-1/blob/master/compose/compose-file/compose-file-v3.md?utm_source=chatgpt.com)).
- Selecionar um driver não suportado na plataforma gera erro na execução do `docker compose up` ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).

## Componentes Chave Associados

- **driver:** Define o plugin de rede (`bridge`, `overlay`, `macvlan`, etc.) ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **driver_opts:** Mapeamento de opções específicas para o driver ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **attachable:** Permite conexões de containers standalone (`true`/`false`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **enable_ipv4 / enable_ipv6:** Habilita ou desabilita IPv4 e IPv6, respectivamente ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **external:** Indica que a rede é gerenciada fora do Compose (`true`/`false`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **ipam:** Configuração de IPAM, com `driver`, `config` (subnet, gateway, aux_addresses) e `options` ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **internal:** Cria rede isolada, sem acesso externo ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **labels:** Metadados em notação reverse-DNS para documentação ou automação ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **name:** Nome personalizado, útil para referenciar redes já existentes ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))

## Melhores Práticas e Padrões de Uso

- Sempre consulte a documentação oficial do **Network drivers** para descobrir quais `driver_opts` são suportados ([docs.docker.com](https://docs.docker.com/engine/network/drivers/macvlan/?utm_source=chatgpt.com)).
- Use nomes expressivos e labels em reverse-DNS para evitar conflitos e facilitar o troubleshooting ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).
- Em ambientes distribuídos (Swarm ou multiplos hosts), prefira `overlay` com IPAM customizado para alta disponibilidade ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).
- Para desenvolvimento local, ajuste `driver_opts` no `bridge` para mapear portas e endereços conforme necessidade de testes ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/)).
- Evite configurações excessivas de `driver_opts` sem necessidade; muitas vezes, bind mounts ou configurações de host resolvem o caso sem customizar o driver.

## Exemplo Prático Completo

```yaml
version: '3.8'
services:
  web:
    image: nginx
    networks:
      - frontend

  api:
    image: myapi
    networks:
      - frontend
      - backend

  db:
    image: postgres
    networks:
      - backend

  legacy:
    image: legacy-app
    networks:
      - macvlan_net

networks:
  frontend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"

  backend:
    driver: overlay
    attachable: true
    ipam:
      driver: default
      config:
        - subnet: 10.5.0.0/16
          gateway: 10.5.0.1

  macvlan_net:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

```

Neste exemplo:

- **frontend** usa bridge com `driver_opts` para permitir comunicação padrão entre containers.
- **backend** usa overlay, marcado como `attachable` para depuração e expansão.
- **macvlan_net** expõe o serviço legacy como um dispositivo físico na rede do host.

## Sugestões para Aprofundamento

- Consulte a documentação de [Network drivers] para detalhes de cada driver e suas opções avançadas. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- Veja o tutorial de [Networking in Compose] para casos de uso práticos e exemplos adicionais. ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com))
- Avalie orquestradores como Kubernetes se precisar de políticas de rede ainda mais granulares e automáticas.

---

Para mais detalhes, acesse:

- **Compose file reference: Networks** ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **Macvlan network driver** ([docs.docker.com](https://docs.docker.com/engine/network/drivers/macvlan/?utm_source=chatgpt.com))