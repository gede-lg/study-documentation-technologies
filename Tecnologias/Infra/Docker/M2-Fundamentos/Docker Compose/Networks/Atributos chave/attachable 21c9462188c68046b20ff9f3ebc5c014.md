# attachable

**Título da Explicação:** Entendendo o atributo `attachable` no bloco `networks` do Docker Compose

## Introdução

O atributo `attachable` no bloco `networks` do Docker Compose determina se containers independentes (executados fora do contexto dos serviços definidos no Compose) podem conectar-se a essa rede, além dos serviços gerenciados pelo Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)). Em redes do tipo `overlay`, criadas para comunicação multi-host em Swarm, esse atributo está habilitado por padrão, mas pode ser opcionalmente definido como `false` para restringir conexões externas ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).

## Sumário

- Conceitos Fundamentais
- Sintaxe Detalhada e Uso Prático
- Cenários de Restrição ou Não Aplicação
- Componentes Chave Associados
- Melhores Práticas e Padrões de Uso
- Exemplo Prático Completo
- Sugestões para Aprofundamento

## Conceitos Fundamentais

1. **Rede Standalone x Rede de Serviço:** As redes definidas no Compose conectam containers de serviços por padrão. O `attachable` permite que containers gerenciados via `docker run` também se conectem ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)).
2. **Swarm Mode e Overlay Networks:** O atributo é relevante especialmente em redes `overlay` usadas no modo Swarm, pois redes bridge não suportam nativamente esse tipo de conexão externa via Compose ([stackoverflow.com](https://stackoverflow.com/questions/41847656/network-not-manually-attachable-when-running-one-off-command-against-docker-sw?utm_source=chatgpt.com)).
3. **Compose File Format:** A configuração `attachable` foi introduzida em Compose v3.2. Em versões anteriores, não era possível defini-la no arquivo; em Compose v2.1+, redes overlay eram sempre attachable e não configuráveis ([stackoverflow.com](https://stackoverflow.com/questions/41847656/network-not-manually-attachable-when-running-one-off-command-against-docker-sw?utm_source=chatgpt.com), [docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/networking/?utm_source=chatgpt.com)).

## Sintaxe Detalhada e Uso Prático

```yaml
version: "3.8"

services:
  app:
    image: nginx
    networks:
      - my_overlay_network

networks:
  my_overlay_network:
    driver: overlay
    attachable: true

```

- **`version`**: mínimo `"3.2"` para usar `attachable` ([stackoverflow.com](https://stackoverflow.com/questions/41847656/network-not-manually-attachable-when-running-one-off-command-against-docker-sw?utm_source=chatgpt.com)).
- **`driver: overlay`**: obrigatório para redes multi-host no Swarm.
- **`attachable: true|false`**: habilita/desabilita conexões externas (padrão em overlay: `true`) ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).

Para criar manualmente via CLI:

```bash
docker network create --driver overlay --attachable my-attachable-overlay-network

```

Isso gera uma rede `overlay` que pode receber containers standalone ([stackoverflow.com](https://stackoverflow.com/questions/41847656/network-not-manually-attachable-when-running-one-off-command-against-docker-sw?utm_source=chatgpt.com)).

## Cenários de Restrição ou Não Aplicação

- **Redes Bridge e Host:** O atributo `attachable` não tem efeito em drivers que não suportam conexões externas via Swarm; aplica-se apenas a `overlay`.
- **Modo não-Swarm:** Em engines sem Swarm mode ativo, a configuração `attachable` é ignorada.
- **Compose v2.0 – v2.0:** Antes de v2.1, não havia suporte para `attachable`; e overlay era sempre attachable sem opção de desabilitar ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/networking/?utm_source=chatgpt.com)).

## Componentes Chave Associados

- **`networks` (top-level):** define as redes que podem ser referenciadas por serviços.
- **`driver_opts`:** opções específicas do driver, como configurações de IPAM.
- **`external`:** indica redes pré-criadas fora do Compose; útil para anexar redes já existentes que foram criadas com `-attachable` ([forums.docker.com](https://forums.docker.com/t/how-to-connect-to-named-networks-in-docker-compose/113233?utm_source=chatgpt.com)).
- **`enable_ipv4/enable_ipv6`:** controla atribuição de IPs para IPv4 e IPv6 (Compose ≥ 2.33.1).
- **`internal`:** impede acesso externo à rede (não confundir com `attachable`).

## Melhores Práticas e Padrões de Uso

- **Use `attachable` somente quando necessário** para permitir containers ad-hoc se comunicarem com serviços em Swarm.
- **Prefira criar redes externamente** com `docker network create --attachable` e referenciá-las com `external: true` para maior controle de *lifecycle* ([forums.docker.com](https://forums.docker.com/t/how-to-connect-to-named-networks-in-docker-compose/113233?utm_source=chatgpt.com)).
- **Evite `attachable` em redes sensíveis** de produção se quiser isolar completamente serviços gerenciados.
- **Combine com `labels` e `driver_opts`** para nomeação e configuração avançada de IPAM.

## Exemplo Prático Completo

Imagine um cenário onde um serviço `web` e `db` rodam em Swarm, mas você quer executar containers de migração de dados fora do Compose:

```bash
# 1. Crie a rede Swarm attachable
docker network create --driver overlay --attachable app_network

# 2. Defina o docker-compose.yml
version: "3.8"

services:
  web:
    image: nginx
    networks:
      - app_network
  db:
    image: postgres
    networks:
      - app_network

networks:
  app_network:
    external: true

```

```bash
# 3. Implemente a stack no Swarm
docker stack deploy -c docker-compose.yml appstack

# 4. Rode um job ad-hoc usando a mesma rede
docker run --rm \
  --network app_network \
  migrate-tool:latest \
  migrate --db-host db

```

Dessa forma, o container `migrate-tool` conecta-se à rede `app_network`, dialogando com `db` e `web` sem pertencer ao Compose original ([stackoverflow.com](https://stackoverflow.com/questions/41847656/network-not-manually-attachable-when-running-one-off-command-against-docker-sw?utm_source=chatgpt.com)).

## Sugestões para Aprofundamento

- **Documentação oficial de Compose File**: consulte a referência completa em [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/).
- **Swarm Mode networking**: explore [https://docs.docker.com/network/overlay/](https://docs.docker.com/network/overlay/) para detalhes de overlay.
- **Docker CLI e IPAM**: veja `docker network create --help` e a seção de `driver_opts` para ajustes finos.