# internal

**Título da Explicação:** Rede Interna em Docker Compose: atributo `internal` da chave `networks`

---

## 1. Introdução

Em Docker Compose, o gerenciamento de redes permite definir como os containers se comunicam entre si e com o mundo externo. Por padrão, o Compose cria uma rede “bridge” que conecta os serviços ao host e à internet. O atributo `internal` na seção `networks` serve para criar redes isoladas, bloqueando qualquer conectividade externa (Host ↔ Container e Container ↔ Internet) e permitindo apenas a comunicação entre containers pertencentes àquela rede. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com), [github.com](https://github.com/compose-spec/compose-spec/blob/main/06-networks.md?utm_source=chatgpt.com))

---

## 2. Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 3. Conceitos Fundamentais

- **Rede Default:** Ao dar `docker compose up`, o Compose cria uma rede padrão (`<projeto>_default`) do tipo *bridge*, permitindo comunicação bidirecional entre containers e com o host ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).
- **Isolamento Externo:** O atributo `internal: true` remove qualquer gateway para o host ou internet, isolando completamente o tráfego dentro da própria rede definida ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com), [devops.stackexchange.com](https://devops.stackexchange.com/questions/4514/internal-network-between-container-docker-compose-with-outgoing-connection?utm_source=chatgpt.com)).
- **Casos de Uso:** Ideal para testes de segurança, ambientes de integração interna, bancos de dados sensíveis ou microserviços que não devem acessar nem ser acessados externamente.

---

## 4. Sintaxe Detalhada e Uso Prático

```yaml
version: "3.9"

services:
  app:
    image: minha-app:latest
    networks:
      - interna

  db:
    image: postgres:14
    networks:
      - interna

networks:
  interna:
    driver: bridge       # Tipo de driver (pode ser bridge, overlay, etc.)
    internal: true       # Isola do host e da internet
    ipam:                # (Opcional) Configuração de IP manual
      driver: default
      config:
        - subnet: 10.10.0.0/16
          gateway: 10.10.0.1

```

> Comentários:
> 
> - `driver`: define o tipo de rede (o padrão é `bridge`).
> - `internal: true`: aplica o isolamento externo.
> - `ipam`: opcional, permite especificar sub-rede, gateway e faixas de IP. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com))

---

## 5. Cenários de Restrição ou Não Aplicação

- **Necessidade de Internet ou Host:** Se o serviço precisa baixar pacotes, enviar logs para um servidor externo ou expor portas para o host, não utilize `internal: true`.
- **Redes Overlay em Swarm:** Embora seja possível combinar `internal` com drivers como `overlay`, o isolamento pode impedir a comunicação entre nós do cluster se mal configurado ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).
- **Conexão com Redes Externas:** Para conectar a um network já existente fora do Compose, deve-se usar `external: true` em vez de `internal`.

---

## 6. Componentes Chave Associados

| Atributo | Descrição |
| --- | --- |
| `driver` | Tipo de rede (e.g., `bridge`, `overlay`). Define a implementação subjacente do network. |
| `internal` | *booleano*. Quando `true`, remove todo gateway externo, isolando o tráfego internamente. |
| `external` | *booleano*. Conecta a uma rede existente, gerenciada fora do Compose. |
| `ipam` | *mapa*. Configuração de alocação de IP (subnet, gateway, faixas). |
| `labels` | Metadados aplicados à rede para organização e automação. |
| `attachable` | (Swarm) Permite containers não-swarm se conectarem a um overlay. |

---

## 7. Melhores Práticas e Padrões de Uso

- **Isolamento por Ambiente:** Crie redes internas distintas por ambiente (dev, staging, prod) para evitar vazamento de dados.
- **Nomeclatura Consistente:** Use prefixos claros (`interna_`, `externa_`, `mgmt_`) para facilitar a manutenção e o diagnóstico.
- **Uso de Labels:** Aplique `labels` para documentar propósito e equipe responsável, facilitando monitoramento e auditoria.
- **Documentação:** Sempre documente no README do projeto o comportamento das redes (especialmente as internas).

---

## 8. Exemplo Prático Completo

Suponha um sistema com três serviços:

1. **frontend** (acessível externamente)
2. **backend** (isolado para tráfego interno)
3. **db** (totalmente isolado)

```yaml
version: "3.9"

services:
  frontend:
    image: meu-frontend:latest
    ports:
      - "8080:80"
    networks:
      - externa
      - interna

  backend:
    image: meu-backend:latest
    networks:
      - interna

  db:
    image: postgres:14
    networks:
      - interna-db

networks:
  externa:
    driver: bridge

  interna:
    driver: bridge
    internal: true

  interna-db:
    driver: bridge
    internal: true
    labels:
      com.exemplo.purpose: "Rede do banco de dados"

```

- O **frontend** conecta-se às redes `externa` (para receber requisições HTTP do usuário) e `interna` (para chamar a API do backend).
- O **backend** só está em `interna`, não expõe portas ao host.
- O **db** está em `interna-db`, completamente isolado, e só é acessível por serviços na mesma rede.

---

## 9. Sugestões para Aprofundamento

- **Compose Specification (seção Networks):** [https://github.com/compose-spec/compose-spec/blob/main/06-networks.md](https://github.com/compose-spec/compose-spec/blob/main/06-networks.md) ([github.com](https://github.com/compose-spec/compose-spec/blob/main/06-networks.md?utm_source=chatgpt.com))
- **Boas práticas de segurança em container networking**
- **Swarm Mode e Overlay Networks**

Com esta explanação, você terá uma compreensão completa do atributo `internal` em Docker Compose, seus usos, limitações e como aplicá-lo de forma prática.