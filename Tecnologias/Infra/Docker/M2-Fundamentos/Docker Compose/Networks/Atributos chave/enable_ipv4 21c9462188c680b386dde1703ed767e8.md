# enable_ipv4

**Título da Explicação:** *Como usar o atributo `enable_ipv4` no elemento `networks` do Docker Compose*

---

## 1. Introdução

O Docker Compose facilita a orquestração de múltiplos contêineres através de um arquivo YAML, permitindo definir serviços, volumes e **redes** de forma declarativa. Por padrão, o Compose cria uma rede **IPv4** para sua aplicação, atribuindo automaticamente endereços IPv4 a cada contêiner. No entanto, em cenários avançados—como ambientes que exigem apenas **IPv6**—é necessário controlar explicitamente a alocação de endereços IP. É aí que entra o atributo `enable_ipv4`, disponível desde o Docker Compose **2.33.1**, que permite **desabilitar** a atribuição de endereços IPv4 em uma rede personalizada. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))

---

## 2. Sumário

- Conceitos Fundamentais
- Sintaxe Detalhada e Uso Prático
- Cenários de Restrição ou Não Aplicação
- Componentes Chave Associados
- Melhores Práticas e Padrões de Uso
- Exemplo Prático Completo
- Sugestões para Aprofundamento

---

## 3. Conceitos Fundamentais

- **Rede Padrão do Compose:**
    
    Quando não há redes declaradas, o Compose cria uma rede chamada `default`, usando IPv4. Cada contêiner é conectado a ela e pode se comunicar pelos endereços atribuídos automaticamente. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
    
- **IPv4 vs. IPv6:**
    - *IPv4* é habilitado automaticamente em todas as redes do Compose.
    - *IPv6* só é alocado se for explicitamente habilitado com `enable_ipv6: true`.
    - Para criar uma rede **somente IPv6**, é preciso **desabilitar** o IPv4 e habilitar o IPv6. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **O que faz o `enable_ipv4`:**
    
    A opção `enable_ipv4`, quando definida como `false`, **impede** que o Compose atribua endereços IPv4 aos contêineres conectados à rede. Isso é útil em ambientes onde apenas IPv6 deve ser utilizado ou para testar cenários de dual-stack de forma controlada. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
    

---

## 4. Sintaxe Detalhada e Uso Prático

O atributo `enable_ipv4` deve ser definido **no nível superior** do elemento `networks` do seu `docker-compose.yml`. Ele **não** é utilizado sob `services`.

```yaml
version: "3.9"  # ou superior
services:
  web:
    image: nginx:latest
    networks:
      - ip6net       # conecta o serviço à rede ip6net

networks:
  ip6net:
    enable_ipv4: false   # desabilita alocação de endereços IPv4
    enable_ipv6: true    # habilita alocação de endereços IPv6
    # opcional: ipam para especificar subnet IPv6
    ipam:
      driver: default
      config:
        - subnet: "2001:db8:1::/64"

```

1. **`enable_ipv4: false`**: impede DHCP interno para IPv4 nesta rede.
2. **`enable_ipv6: true`**: liga o suporte a IPv6 (por padrão está desligado).
3. **`ipam.config`**: define o *subnet* IPv6 e gateway, se necessário. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))

Você pode combinar `enable_ipv4` e `enable_ipv6` para criar redes:

- **Dual-stack** (ambos ativos):
    
    ```yaml
    networks:
      dualnet:
        enable_ipv4: true     # IPv4 permanece ativo (padrão)
        enable_ipv6: true     # ativa IPv6
        ipam:
          config:
            - subnet: "172.28.0.0/16"
            - subnet: "2001:db8:2::/64"
    
    ```
    
- **Somente IPv4** (comportamento padrão – não precisa declarar):
    
    ```yaml
    networks:
      v4only:
        # sem enable_ipv6, sem disable de IPv4
    
    ```
    
- **Somente IPv6**:
    
    ```yaml
    networks:
      v6only:
        enable_ipv4: false
        enable_ipv6: true
        ipam:
          config:
            - subnet: "2001:db8:3::/64"
    
    ```
    

---

## 5. Cenários de Restrição ou Não Aplicação

- **Versões anteriores ao Compose 2.33.1**: não suportam `enable_ipv4`—o Compose irá rejeitar a configuração.
- **Redes externas (`external: true`)**: quando você declara `external: true`, o Compose **não** tenta criar ou gerenciar atributos como `enable_ipv4`; esses atributos são ignorados e geram erro de validação se presentes. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))
- **Drivers sem suporte a IPAM**: alguns drivers (por ex., `host` ou plugins de terceiros) podem não implementar completamente IPAM, tornando `enable_ipv4` ineficaz.
- **Testes ou ambientes locais que não suportam IPv6**: desabilitar IPv4 sem infraestrutura IPv6 resultará em perda de conectividade.

---

## 6. Componentes Chave Associados

Além de `enable_ipv4`, é importante conhecer outros atributos do `networks` top-level:

- **`driver`**: define o driver (por ex., `bridge`, `overlay`).
- **`driver_opts`**: opções específicas para o driver (ex.: MTU, host-binding).
- **`attachable`**: permite contêineres standalone conectarem-se à rede.
- **`external`**: indica rede gerida fora do Compose.
- **`ipam`**: configura sub-redes, gateways e faixas de IP.
- **`internal`**: cria rede isolada, sem acesso à rede externa.
- **`labels`**: metadados para a rede.
- **`name`**: nome customizado usado pelo Docker, sem escopo de projeto. ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/))

---

## 7. Melhores Práticas e Padrões de Uso

- **Use `enable_ipv4: false` apenas quando precisar de IPv6 puro** (por exemplo, em testes de dual-stack ou ambientes nativos IPv6).
- **Versione seu Compose**: especifique sempre `version: "3.x"` compatível com 2.33.1 ou superior.
- **Combine com IPAM** para controlar exatamente suas sub-redes e gateways.
- **Documente no README** do projeto quais redes exigem IPv6 e por quê.
- **Teste em ambientes reais**: garanta que seu host suporta IPv6 antes de desabilitar o IPv4.

---

## 8. Exemplo Prático Completo

```yaml
version: "3.9"

services:
  app:
    image: your-app-image:latest
    ports:
      - "80:80"
    networks:
      - v6only

  db:
    image: postgres:14
    environment:
      POSTGRES_PASSWORD: example
    networks:
      - v6only

networks:
  v6only:
    driver: bridge
    enable_ipv4: false      # IPv4 desligado
    enable_ipv6: true       # IPv6 ligado
    internal: false         # permite acesso externo via host
    ipam:
      driver: default
      config:
        - subnet: "2001:db8:4::/64"
          gateway: "2001:db8:4::1"

```

Neste cenário, as aplicações **app** e **db** comunicar-se-ão apenas via IPv6 dentro da rede `v6only`, utilizando o subnet definido.

---

## 9. Sugestões para Aprofundamento

- [Networking in Compose (Docker Docs)](https://docs.docker.com/compose/networking/)
- [Compose file reference: Networks top-level elements](https://docs.docker.com/compose/compose-file/compose-file-v3/#networks)
- [IPAM reference (Docker Engine)](https://docs.docker.com/engine/reference/commandline/network_create/#specifying-ip-and-mac-addresses)

---

Com esta explicação detalhada, você tem tudo o que precisa para controlar a alocação de IPv4 e IPv6 em suas redes do Docker Compose, garantindo configurações precisas e ambientes de rede bem definidos.