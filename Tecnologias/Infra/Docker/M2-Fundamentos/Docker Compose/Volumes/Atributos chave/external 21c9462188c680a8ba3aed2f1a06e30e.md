# external

**Entendendo o atributo `external` em volumes do Docker Compose**

---

## Sumário

1. [Introdução](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#introdu%C3%A7%C3%A3o)
2. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
3. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    1. Formato Curto
    2. Formato Longo
4. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
5. [Componentes-Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
6. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
7. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
8. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Introdução

No contexto do Docker Compose, **volumes** são a forma padrão de persistir dados gerados e consumidos por containers, desacoplando-os do sistema de arquivos do host e permitindo compartilhamento e migração mais seguros e controlados ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com)). O atributo `external` na seção de volumes habilita o uso de volumes que já existem no host ou no provedor de volumes, delegando seu ciclo de vida para fora do escopo do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com)).

---

## Conceitos Fundamentais

- **Volume Nomeado**: recurso gerenciado pelo Docker com localização isolada (ex.: `/var/lib/docker/volumes/<nome>`).
- **External = true**: informa ao Compose que **não** deve criar nem recriar o volume, mas montar um volume pré-existente. Se não for encontrado, o Compose aborta com erro ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com)).
- **Ciclo de Vida**: ao usar `external: true`, toda criação, remoção e backup do volume fica sob responsabilidade do operador ou de outro sistema, não do Compose.

---

## Sintaxe Detalhada e Uso Prático

### 1. Formato Curto

```yaml
version: '3.9'

services:
  app:
    image: my-app-image
    volumes:
      - db-data:/var/lib/data

volumes:
  db-data:
    external: true

```

- Aqui o Compose procura por um volume **exatamente** chamado `db-data`.
- **Se não existir**, a execução falha com mensagem de erro similar a:
    
    > Volume "db-data" declared as external, but could not be found. Please create the volume manually and try again. (docs.docker.com).
    > 

### 2. Formato Longo

Permite especificar também um nome de volume diferente da chave:

```yaml
version: '3.9'

services:
  app:
    image: my-app-image
    volumes:
      - type: volume
        source: production_db
        target: /var/lib/data
        external: true

volumes:
  production_db:
    name: prod-db-data
    external: true

```

- `source` ou `name`: o nome real do volume já existente.
- **Atenção**: nenhuma outra opção (por exemplo `driver`, `driver_opts` ou `labels`) pode ser usada junto com `external: true`—exceto `name`—ou o Compose rejeitará o arquivo como inválido ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Desenvolvimento Local Simples**: se quiser que o Compose crie e gerencie o volume automaticamente, **não** use `external`.
- **Testes Efêmeros**: para testar sem impactar dados reais, prefira volumes gerenciados internamente ao projeto.
- **Volumes Compartilhados em Várias Aplicações**: ideal quando múltiplos projetos ou serviços precisam acessar o mesmo volume, sem recriá-lo a cada `up`.
- **Bind Mounts ou tmpfs**: se precisar de acesso a pastas específicas do host ou de volumes voláteis em RAM, opte por `type: bind` ou `type: tmpfs` em vez de `external`.

---

## Componentes-Chave Associados

| Componente | Descrição |
| --- | --- |
| `external` | Booleano que indica uso de volume já existente. |
| `name` | Nome real do volume quando for diferente da chave do mapa `volumes:`. |
| `driver` | (Não aplicável com `external: true`) |
| `driver_opts` | (Não aplicável com `external: true`) |
| `labels` | (Não aplicável com `external: true`) |
| `type`, `source`, `target`, `read_only` | Usados na sintaxe longa dentro de `services[].volumes`. |

---

## Melhores Práticas e Padrões de Uso

1. **Criação Manual Antecipada**
    - Execute `docker volume create <nome>` antes de usar `external: true`.
2. **Controle de Acesso**
    - Use labels de *monitoramento* e *backup* fora do Compose para gerenciar esses volumes.
3. **Consistência de Nomes**
    - Padronize nomes de volumes compartilhados entre ambientes (ex.: `staging_db`, `prod_db`).
4. **Documentação Interna**
    - Mantenha um README no repositório indicando quais volumes externos são necessários e como criá-los.
5. **Versionamento de Compose**
    - Confirme a versão do Compose (CLI V2 ou V1) e especifique `version: '3.x'` compatível.

---

## Exemplo Prático Completo

```yaml
# docker-compose.yml
version: '3.9'

services:
  web:
    image: nginx:alpine
    volumes:
      - logs_volume:/var/log/nginx
    ports:
      - "8080:80"

  db:
    image: postgres:14
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  # Volume de logs compartilhado, gerenciado externamente
  logs_volume:
    external: true
    name: project_shared_logs

  # Volume de dados do banco, gerenciado pelo Compose
  db_data: {}

```

**Passos para uso deste exemplo**:

1. Criar volume de logs manualmente:
    
    ```bash
    docker volume create --name project_shared_logs
    
    ```
    
2. Subir aplicação:
    
    ```bash
    docker compose up -d
    
    ```
    

---

## Sugestões para Aprofundamento

- Examine a [Specificação Compose](https://docs.docker.com/reference/compose-file/) para entender evolução de versões.
- Estude casos de uso de **bind mounts** vs **volumes nomeados** para otimizar performance.
- Explore plugins de drivers de volume (ex.: EBS, Azure Files) quando usar `external` em produção.

---

Com isso, você tem um panorama completo do **atributo `external`** em volumes do Docker Compose: desde a base teórica até exemplos práticos e padrões de uso recomendado. Caso queira aprofundar em cenários avançados, como integração com orquestradores de nuvem ou drivers customizados, estou à disposição!