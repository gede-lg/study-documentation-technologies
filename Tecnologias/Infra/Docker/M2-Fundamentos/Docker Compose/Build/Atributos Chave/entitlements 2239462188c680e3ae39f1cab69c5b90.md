# entitlements

**Título da Explicação:** Atributo `entitlements` na chave `build` do Docker Compose

---

### Introdução

O Docker Compose, a partir da versão 2.27.1, passou a suportar o atributo `entitlements` dentro do bloco `build`, permitindo que determinadas permissões adicionais sejam concedidas ao processo de build executado via BuildKit. Isso é especialmente útil quando você precisa, por exemplo, de acesso a rede host ou de desabilitar partes do sandbox para executar etapas específicas do Dockerfile com privilégios eleváveis. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))

---

### Sumário

1. [Conceitos Fundamentais](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
2. [Sintaxe Detalhada e Uso Prático](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
3. [Cenários de Restrição ou Não Aplicação](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
4. [Componentes Chave Associados](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
5. [Melhores Práticas e Padrões de Uso](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
6. [Exemplo Prático Completo](entitlements%202239462188c680e3ae39f1cab69c5b90.md)
7. [Sugestões para Aprofundamento](entitlements%202239462188c680e3ae39f1cab69c5b90.md)

---

## Conceitos Fundamentais

- **BuildKit e Sandbox:** O Docker Compose v2 usa internamente o BuildKit, que isola cada etapa do build em um “sandbox” para maior segurança e escalabilidade. Por padrão, muitos recursos do host (rede, montagem de sistemas, etc.) ficam restritos.
- **Entitlements:** São “permissões” que você pode liberar para o processo de build, contornando parte dessas restrições de segurança. As duas entitlements atualmente suportadas são:
    - `network.host`: permite que o build use a rede do host, útil para baixar dependências de servidores que só aceitam conexões locais.
    - `security.insecure`: desativa partes do sandbox de segurança, permitindo operações que normalmente seriam bloqueadas. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))

---

## Sintaxe Detalhada e Uso Prático

```yaml
services:
  minha-aplicacao:
    build:
      context: .
      dockerfile: Dockerfile
      entitlements:
        - network.host
        - security.insecure

```

- **Localização:** O bloco `entitlements` fica aninhado diretamente sob `build` na definição de um serviço.
- **Formato:** Uma lista YAML de *strings* – cada string é uma entitlement a ser habilitada.
- **Requisitos de versão:** Exige Docker Compose CLI ≥ 2.27.1; também é necessário que o daemon BuildKit aceite tais entitlements (configurável via `-allow-insecure-entitlement` ao inicializar o daemon). ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/), [docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))

---

## Cenários de Restrição ou Não Aplicação

- **Versões anteriores:** Em versões do Compose abaixo da 2.27.1, o atributo não existe, gerando erro de parsing.
- **BuildKit desativado:** Se você estiver usando o builder legado (`docker-compose build --no-buildkit`), o `entitlements` será ignorado ou causará falha.
- **Ambientes de produção:** Conceder `security.insecure` pode introduzir riscos de segurança. Em ambientes controlados, prefira soluções que não exijam privilégios além do necessário.
- **Builders específicos:** Alguns builders alternativos (como plugins de terceiros) podem não suportar todas as entitlements, gerando warnings ou erros. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))

---

## Componentes Chave Associados

- **Daemon BuildKit (`buildkitd`):** Deve ser iniciado com flags como `-allow-insecure-entitlement security.insecure` para que o daemon permita o uso dessas entitlements durante o build.
- **CLI Compose (`docker compose`):** A partir da versão 2.27.1, a CLI reconhece e repassa `entitlements` ao builder interno.
- **Variáveis de Contexto:** O uso de `network.host` pode interagir com `extra_hosts` e `network` (definições de rede no Compose), afetando como o container de build resolve DNS e acessa serviços locais.
- **Dockerfile:** Para aproveitar entitlements como `security.insecure`, seus `RUN` podem usar mounts ou operações privilegiadas, por exemplo `RUN --mount=type=secret...` com acesso ampliado.

---

## Melhores Práticas e Padrões de Uso

1. **Mínimo necessário:** Conceda apenas as entitlements estritamente necessárias (princípio do menor privilégio).
2. **Ambientes separados:** Em desenvolvimento, pode-se usar `security.insecure`, mas em CI/CD e produção, avalie alternativas seguras (ex.: proxies de rede, credenciais temporárias).
3. **Documentação de riscos:** Registre no README do projeto quais entitlements são usadas e por que, facilitando auditoria de segurança.
4. **Validação de versão:** Inclua nos scripts de build ou pipelines checagens de versão do Compose (`docker compose version`) para garantir compatibilidade.

---

## Exemplo Prático Completo

```yaml
version: '3.9'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # Habilita acesso ao host e desativa sandbox de segurança para etapas específicas
      entitlements:
        - network.host        # Necessário para baixar dependências internas
        - security.insecure   # Usado para montagem de volume especial
    image: minha-aplicacao:latest
    ports:
      - "8080:8080"

```

1. **Inicialize o daemon BuildKit** (se não usar Docker Desktop):
    
    ```bash
    dockerd --containerd=/run/containerd/containerd.sock \\
            --add-runtime docker-runc=/usr/bin/docker-runc \\
            --experimental \\
            --allow-insecure-entitlement security.insecure
    
    ```
    
2. **Construção**:
    
    ```bash
    docker compose build app
    
    ```
    
3. **Execução**:
    
    ```bash
    docker compose up -d
    
    ```
    

Esse fluxo garante que passos do Dockerfile que exigem rede host e operações fora do sandbox ocorram sem falhas. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/), [docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))

---

## Sugestões para Aprofundamento

- **Documentação BuildKit:** explore outras opções de flags `-allow` do `buildx` (ex.: `-allow=network.host`) para uso avançado em CLI ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com)).
- **Segurança de Containers:** leia sobre práticas de hardening do BuildKit e isolamento do kernel para mitigar riscos de entitlements.
- **Pipelines CI/CD:** veja integrações de entitlements em Jenkins, GitLab CI e GitHub Actions para builds seguros e reproduzíveis.
- **Compose Specification:** acompanhe o repositório oficial do Compose Spec no GitHub para novidades em atributos de `build` ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).