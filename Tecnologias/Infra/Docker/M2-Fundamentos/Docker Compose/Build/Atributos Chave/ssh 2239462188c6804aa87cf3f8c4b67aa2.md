# ssh

## O Atributo `ssh` na Chave `build` do Docker Compose: Explicação Detalhada

Olá, Gedê\! A.R.I.A. aqui para te ajudar a entender o atributo `ssh` na chave `build` do Docker Compose, um recurso essencial para a construção segura de imagens Docker que precisam interagir com recursos protegidos por SSH, como repositórios Git privados.

### Introdução

Ao trabalhar com Docker, é comum que a construção de uma imagem precise acessar recursos externos. Quando esses recursos são privados e protegidos por SSH (como repositórios Git privados), surge o desafio de como fornecer as credenciais SSH de forma segura durante o processo de build, sem comprometer a segurança inserindo chaves sensíveis diretamente na imagem final. É nesse contexto que o atributo `ssh` do `build` no Docker Compose, em conjunto com o BuildKit, se torna uma solução robusta e segura, permitindo o encaminhamento do agente SSH do host para o ambiente de build do Docker.

### Sumário

Esta explicação detalhada abordará os seguintes pontos:

- **Conceitos Fundamentais:** O que é o encaminhamento de agente SSH, a importância da segurança e o papel do BuildKit.
- **Sintaxe Detalhada e Uso Prático:** Como configurar o atributo `ssh` no `docker-compose.yml` e utilizá-lo no `Dockerfile` com exemplos práticos.
- **Cenários de Restrição ou Não Aplicação:** Limitações e alternativas quando o `ssh` não é a melhor escolha.
- **Componentes Chave Associados:** Explicação de `-mount=type=ssh` e `SSH_AUTH_SOCK`.
- **Melhores Práticas e Padrões de Uso:** Recomendações para um uso seguro e eficiente.
- **Exemplo Prático Completo:** Um cenário de ponta a ponta para ilustrar a aplicação.

### Conceitos Fundamentais

O atributo `ssh` na seção `build` do Docker Compose facilita o **encaminhamento do agente SSH** (SSH Agent Forwarding) para o processo de construção da imagem Docker. Para entender sua importância, é crucial compreender os seguintes conceitos:

- **SSH Agent (Agente SSH):** É um programa em execução no seu sistema operacional (host) que armazena suas chaves privadas SSH descriptografadas em memória. Isso evita que você precise digitar sua senha de chave (passphrase) toda vez que usa uma chave SSH para se autenticar. O agente SSH interage com o cliente SSH por meio de um socket Unix (tipicamente via a variável de ambiente `SSH_AUTH_SOCK`).
- **Encaminhamento de Agente SSH:** Permite que um cliente SSH em uma máquina (neste caso, dentro do contêiner de build do Docker) utilize as chaves SSH armazenadas no agente SSH de outra máquina (seu host) sem que as chaves privadas sejam copiadas para a máquina remota ou contêiner. Isso é fundamental para a segurança, pois suas chaves privadas nunca saem do seu ambiente seguro.
- **BuildKit:** É o construtor de imagens padrão do Docker, otimizado para desempenho, cache e segurança. Ele introduziu recursos avançados de build, como os *mounts de build* (`-mount`), que são essenciais para o funcionamento do atributo `ssh`. O encaminhamento do agente SSH via `build.ssh` é uma funcionalidade habilitada pelo BuildKit, que permite montar o socket do agente SSH do host no contexto de build do contêiner.

**Importância e Propósito:**

O propósito principal do atributo `ssh` é permitir que um Dockerfile execute comandos que requerem autenticação SSH (como `git clone` de um repositório privado, ou `npm install` de pacotes privados via SSH) *durante o processo de construção da imagem*, sem a necessidade de:

1. **Incorporar chaves SSH privadas diretamente na imagem:** Copiar chaves privadas para a imagem resultaria em uma imagem menos segura, pois as chaves estariam permanentemente em uma camada da imagem, passíveis de serem extraídas.
2. **Passar chaves como `build-args`:** Embora possível, é menos seguro, pois os valores de `build-args` podem ser inspecionados no histórico de build.
3. **Montar volumes de chaves SSH do host:** Isso pode ter implicações de permissão e também não utiliza o agente SSH para gerenciar a passphrase.

Com o `ssh` attribute, o BuildKit cria um "mount" temporário do socket do seu agente SSH para o ambiente de build, permitindo que as ferramentas dentro do Dockerfile se autentiquem usando as chaves do seu agente host, sem expô-las na imagem final.

### Sintaxe Detalhada e Uso Prático

O uso do atributo `ssh` envolve configurações tanto no `docker-compose.yml` quanto no `Dockerfile`.

### 1\. Configuração no `docker-compose.yml`

O atributo `ssh` é um sub-atributo da chave `build` de um serviço. Ele aceita uma lista de *named SSH agents* ou o valor `default`.

**Sintaxe:**

```yaml
version: '3.8' # ou superior
services:
  meu_servico:
    build:
      context: .
      dockerfile: Dockerfile
      ssh:
        - default       # Encaminha o agente SSH padrão do seu host
        - mykey=/path/to/my/private_key # Opcional: Encaminha uma chave privada específica
                                       # como um agente nomeado 'mykey'.
                                       # Útil se você não usa um agente SSH ou precisa de uma chave diferente.

```

**Explicação dos valores:**

- **`default`**: Este é o valor mais comum e recomendado. Ele instrui o Docker a encaminhar o socket do seu agente SSH ativo (normalmente definido pela variável de ambiente `SSH_AUTH_SOCK` no seu host) para o ambiente de build do contêiner. Se o `SSH_AUTH_SOCK` não estiver configurado ou o agente não estiver rodando, essa opção pode não funcionar.
- **`named_agent=/path/to/private_key`**: Permite especificar uma chave privada SSH diretamente, nomeando-a. O BuildKit cria um agente SSH temporário para essa chave durante o build. Isso é útil em ambientes onde um agente SSH não está em uso, ou quando você precisa de uma chave específica que não está carregada no seu agente padrão. **Cuidado**: Embora a chave não seja copiada para a imagem final, a referência à chave local no `docker-compose.yml` e seu tratamento devem ser feitos com segurança.

### 2\. Utilização no `Dockerfile`

Dentro do `Dockerfile`, você usa a diretiva `--mount=type=ssh` em um comando `RUN` para acessar o agente SSH encaminhado. Essa diretiva é parte do BuildKit e precisa de um `# syntax=docker/dockerfile:1.x` ou similar no topo do Dockerfile para habilitar funcionalidades experimentais (embora `type=ssh` seja amplamente suportado agora).

**Sintaxe:**

```
# syntax=docker/dockerfile:1.4  # Garante que o BuildKit esteja habilitado e use a sintaxe correta

FROM node:20-alpine

# Instala git e openssh-client (necessário para comandos ssh/git)
RUN apk add --no-cache git openssh-client

# Adiciona o host SSH ao known_hosts para evitar prompts de confirmação
# CUIDADO: Em ambiente de produção, considere usar 'ssh-keyscan -H' ou pré-configurar known_hosts.
RUN mkdir -p -m 0600 ~/.ssh && ssh-keyscan github.com >> ~/.ssh/known_hosts

# Exemplo 1: Clonando um repositório Git privado via SSH
# O --mount=type=ssh fornece acesso ao agente SSH configurado no docker-compose.yml
RUN --mount=type=ssh git clone git@github.com:sua-organizacao/seu-repo-privado.git /app/meu_projeto

# Exemplo 2: Instalando dependências de um pacote npm privado via SSH
# (Assumindo que o package.json referencia um repositório Git via SSH)
WORKDIR /app/meu_projeto
COPY package.json package-lock.json ./
RUN --mount=type=ssh npm install

# Exemplo 3: Usando um agente SSH nomeado (se configurado no docker-compose.yml)
# RUN --mount=type=ssh,id=mykey git clone git@github.com:outra-org/outro-repo.git /app/outro_projeto

```

**Explicação do `--mount=type=ssh` no Dockerfile:**

- **`-mount=type=ssh`**: Esta é a chave. Ela informa ao BuildKit para montar o socket do agente SSH disponível no caminho padrão (`/run/buildkit/ssh_agent.<id>`) dentro do contêiner de build para o comando `RUN` atual. O comando `ssh` ou `git` (que usa SSH internamente) detectará automaticamente este socket e o usará para autenticação.
- **`id=<agent_id>` (Opcional):** Se você definiu agentes SSH nomeados no seu `docker-compose.yml` (ex: `mykey=/path/to/private_key`), você pode referenciá-los especificamente usando `id=mykey`. Se você usar `ssh: - default`, não precisa especificar um `id` no `-mount`, pois `default` é o `id` implícito.

### Exemplo Completo de `docker-compose.yml` e `Dockerfile`:

**`docker-compose.yml`:**

```yaml
version: '3.8'
services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      ssh:
        - default # Encaminha o agente SSH padrão para o build
    image: meu_app_backend:latest
    ports:
      - "8080:8080"

```

**`Dockerfile` (no mesmo diretório do `docker-compose.yml`):**

```
# syntax=docker/dockerfile:1.4

FROM openjdk:17-jdk-slim

# Instala git e openssh-client
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    openssh-client \\
    && rm -rf /var/lib/apt/lists/*

# Adiciona chaves de host SSH para GitHub ao known_hosts
RUN mkdir -p -m 0600 ~/.ssh && \\
    ssh-keyscan github.com >> ~/.ssh/known_hosts

WORKDIR /app

# Exemplo de build: clona um projeto Maven privado
# --mount=type=ssh permite que o git clone use as credenciais do agente SSH
# (Assumindo que sua chave SSH tem acesso a 'git@github.com:sua-organizacao/projeto-privado.git')
RUN --mount=type=ssh git clone git@github.com:sua-organizacao/projeto-privado.git .

# Copia o restante do código
COPY . .

# Compila o projeto (exemplo: Spring Boot com Maven wrapper)
RUN ./mvnw package

# Define o ponto de entrada da aplicação
ENTRYPOINT ["java", "-jar", "target/seu-app.jar"]

```

Para construir a imagem, basta rodar:

```bash
docker compose build

```

Certifique-se de que seu agente SSH esteja em execução e sua chave esteja carregada (`ssh-add -l` para verificar).

### Cenários de Restrição ou Não Aplicação

Embora o atributo `ssh` seja extremamente útil, existem situações em que ele pode não ser a melhor escolha ou ter limitações:

- **Necessidade de Chaves SSH no Contêiner em Tempo de Execução:** O `build.ssh` é estritamente para o *processo de build*. As chaves SSH não são persistidas na imagem final. Se sua aplicação dentro do contêiner precisar acessar recursos protegidos por SSH *após o build* (em tempo de execução), você precisará de uma estratégia diferente, como:
    - Montar o socket do agente SSH do host como um volume (`volumes: - $SSH_AUTH_SOCK:$SSH_AUTH_SOCK`) e definir a variável `SSH_AUTH_SOCK` no serviço do Docker Compose.
    - Usar secrets do Docker para injetar chaves privadas de forma mais segura em tempo de execução (apenas para Docker Swarm ou Kubernetes).
    - Configurar SSH na máquina que hospeda o contêiner e acessar recursos através dela.
- **Compatibilidade do BuildKit:** Embora BuildKit seja o padrão, em ambientes muito antigos ou configurações específicas, ele pode não estar habilitado. Verifique se `DOCKER_BUILDKIT=1` está ativado ou se seu `Dockerfile` inclui a linha `# syntax=docker/dockerfile:1.x`.
- **`docker compose up` e o `ssh` atributo:** Alguns usuários relataram que o encaminhamento do agente SSH via `build.ssh` pode não funcionar consistentemente quando se usa `docker compose up` para iniciar um serviço que precisa *construir* uma imagem pela primeira vez. A recomendação geralmente é rodar `docker compose build` explicitamente antes de `docker compose up` para garantir que o processo de build com SSH ocorra corretamente. O atributo `ssh` na seção `build` só se aplica ao comando `docker compose build`.
- **Repositórios HTTPS com Token/Usuário e Senha:** Para repositórios Git privados acessados via HTTPS (não SSH), você não usaria o atributo `ssh`. Em vez disso, você passaria tokens de acesso pessoal ou credenciais de usuário/senha (com cautela, preferencialmente via `build-args` com `DOCKER_BUILDKIT=1` ou usando um *secret* de build no BuildKit para evitar que as credenciais sejam expostas em camadas da imagem).

### Componentes Chave Associados

- **`-mount=type=ssh` (no Dockerfile):** Esta é a diretiva do BuildKit que torna o socket do agente SSH acessível dentro do ambiente de build. É um tipo de "mount" temporário que conecta o processo de build ao seu agente SSH externo. Ele é um mecanismo de segurança porque o conteúdo do mount (ou seja, as chaves) não é copiado para as camadas da imagem.
- **`SSH_AUTH_SOCK` (variável de ambiente):** Esta variável de ambiente aponta para o caminho do socket Unix que o agente SSH está escutando. Quando você usa `ssh: - default` no `docker-compose.yml`, o Docker (via BuildKit) mapeia este socket do host para um local acessível dentro do contêiner de build. Ferramentas como `git` e `ssh` dentro do contêiner automaticamente procuram por esta variável para se comunicar com o agente.

### Melhores Práticas e Padrões de Uso

1. **Sempre use `default` quando possível:** A opção `ssh: - default` é a mais segura e conveniente, pois reutiliza o agente SSH do seu host, que já gerencia suas chaves e passphrases.
2. **Mantenha o agente SSH ativo e com as chaves carregadas:** Antes de rodar `docker compose build`, certifique-se de que seu agente SSH esteja em execução e que as chaves necessárias estejam carregadas (`ssh-add ~/.ssh/id_rsa` e `ssh-add -l` para verificar).
3. **Adicione `ssh-keyscan` ao `Dockerfile`:** É uma boa prática adicionar o host remoto (ex: `github.com`) ao arquivo `~/.ssh/known_hosts` dentro do contêiner de build. Isso evita que o comando SSH solicite confirmação de host, que falharia em um build não interativo.
4. **Use `# syntax=docker/dockerfile:1.x` no topo do Dockerfile:** Garante que o BuildKit esteja habilitado para usar recursos avançados como `-mount`.
5. **Entenda a diferença entre build e runtime:** Lembre-se que o `ssh` atributo é para **build time**. Se precisar de acesso SSH em **runtime**, use montagem de volume para `SSH_AUTH_SOCK` ou Docker secrets.
6. **Instale clientes SSH no contêiner:** Certifique-se de que o `Dockerfile` instale as ferramentas necessárias (`git`, `openssh-client`) para que os comandos SSH possam ser executados.
7. **Evite copiar chaves diretamente:** Nunca copie chaves privadas SSH diretamente para o Dockerfile usando `COPY` ou `ADD` ou via `build-args` simples. O atributo `ssh` foi criado para evitar essa prática insegura.

### Exemplo Prático Completo: Aplicação Python com Dependência Privada

Vamos considerar uma aplicação Python que precisa instalar um pacote privado hospedado em um repositório Git via SSH durante o build da imagem.

**Estrutura do Projeto:**

```
.
├── docker-compose.yml
├── Dockerfile
└── requirements.txt

```

**`requirements.txt`:**

```
# Exemplo de dependência de um repositório Git privado via SSH
git+ssh://git@github.com/sua-organizacao/meu-pacote-privado.git@main#egg=meu_pacote_privado

```

**`docker-compose.yml`:**

```yaml
version: '3.8'
services:
  python_app:
    build:
      context: .
      dockerfile: Dockerfile
      ssh:
        - default # Habilita o encaminhamento do agente SSH
    image: python_app_com_privado:latest
    ports:
      - "5000:5000" # Exemplo, se for uma aplicação web

```

**`Dockerfile`:**

```
# syntax=docker/dockerfile:1.4

FROM python:3.9-slim-buster

# Instala git e openssh-client
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    openssh-client \\
    && rm -rf /var/lib/apt/lists/*

# Adiciona o host do GitHub ao known_hosts
RUN mkdir -p -m 0600 ~/.ssh && \\
    ssh-keyscan github.com >> ~/.ssh/known_hosts

WORKDIR /app

# Copia o arquivo de requisitos
COPY requirements.txt .

# Instala as dependências, utilizando o agente SSH encaminhado para o pacote privado
# O --mount=type=ssh permite que o 'pip' (que usa git para instalar pacotes VCS)
# se autentique via SSH.
RUN --mount=type=ssh pip install -r requirements.txt

# Copia o restante do código da aplicação
COPY . .

# Comando para iniciar a aplicação (exemplo)
CMD ["python", "app.py"]

```

**Passos para Execução:**

1. **Garanta que seu Agente SSH esteja ativo:**
    - No Linux/macOS: `eval "$(ssh-agent -s)"` e depois `ssh-add ~/.ssh/id_rsa` (ou o caminho da sua chave).
    - No Windows com Git Bash: `eval $(ssh-agent -s)` e `ssh-add ~/.ssh/id_rsa`.
2. **Tenha sua chave SSH carregada no agente:** Verifique com `ssh-add -l` se a chave que tem acesso ao `github.com` está listada.
3. **Navegue até o diretório do projeto** no seu terminal.
4. **Execute o build:**
    
    ```bash
    docker compose build
    
    ```
    

Durante o passo `RUN --mount=type=ssh pip install -r requirements.txt`, o BuildKit usará o agente SSH do seu host para autenticar o acesso ao repositório `meu-pacote-privado.git`, permitindo que o `pip` o clone e instale. A chave privada nunca é copiada para a imagem.

---

Espero que esta explicação abrangente e detalhada sobre o atributo `ssh` da chave `build` no Docker Compose seja extremamente útil, Gedê\! Se tiver mais alguma dúvida ou precisar de mais exemplos, é só perguntar.