# network

**Título da Explicação:** Entendendo o atributo `network` da chave `build` no Docker Compose

---

## Introdução

O atributo `network`, disponível dentro da seção `build` de um serviço no **Docker Compose**, permite controlar o modo de rede utilizado pelas instruções `RUN` durante o processo de construção da imagem. Essa configuração é especialmente útil quando comandos de build (por exemplo, instalação de pacotes via `apt`, `npm` ou `pip`) precisam de acesso a recursos de rede — sejam repositórios externos ou serviços internos já em execução.

---

## Sumário

1. [Conceitos Fundamentais](network%202239462188c6801893b8cbef88554239.md)
2. [Sintaxe Detalhada e Uso Prático](network%202239462188c6801893b8cbef88554239.md)
3. [Variações de Sintaxe](network%202239462188c6801893b8cbef88554239.md)
4. [Cenários de Restrição ou Não Aplicação](network%202239462188c6801893b8cbef88554239.md)
5. [Componentes-Chave Associados](network%202239462188c6801893b8cbef88554239.md)
6. [Melhores Práticas e Padrões de Uso](network%202239462188c6801893b8cbef88554239.md)
7. [Exemplo Prático Completo](network%202239462188c6801893b8cbef88554239.md)
8. [Sugestões para Aprofundamento](network%202239462188c6801893b8cbef88554239.md)

---

## Conceitos Fundamentais

- **Objetivo:** Definir o *modo de rede* ao executar instruções `RUN` dentro do Dockerfile durante o build pelo Compose.
- **Importância:** Em ambientes isolados, o modo padrão (`bridge`) pode não permitir acesso a repositórios internos ou resolver nomes específicos; por isso, escolher corretamente o modo de rede garante builds confiáveis.
- **Valores Suportados:**
    - `default` – modo de rede padrão (equivalente a `bridge`).
    - `host` – compartilha a pilha de rede com o host, sem isolamento.
    - `none` – sem acesso de rede.
    - `container:<nome|id>` – reutiliza a rede de outro container em execução.
    - `<nome_da_rede>` – conecta-se a uma rede de usuário já criada. <small>Fonte: Documento de especificação do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))</small>

---

## Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    build:
      context: .
      dockerfile: Dockerfile
      network: host     # <-- Aqui escolhemos o modo de rede
      # outros atributos de build ...

```

- **`network: host`**
Conecta o processo de build à rede do host, útil para acessar serviços locais ou bancos de dados que não estão em uma rede Docker.
- **`network: none`**
Desabilita qualquer acesso de rede, garantindo build totalmente offline.
- **`network: minha_rede_customizada`**
Usa uma rede definida no topo do Compose, por exemplo:
    
    ```yaml
    networks:
      minha_rede_customizada:
        driver: bridge
    
    services:
      meu-servico:
        build:
          context: .
          network: minha_rede_customizada
    
    ```
    

<small>Fonte: Documento de especificação do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))</small>

---

## Variações de Sintaxe

- **Forma Curta vs. Estruturada**
O Compose também aceita a forma curta para build (apenas `context`), mas sem suporte a `network`. Para usar `network`, é **obrigatório** usar a forma estruturada (objeto).
- **Uso em Buildx**
Ao usar o plugin `buildx`, o mesmo atributo `-network` está disponível na CLI (`docker buildx build --network=<modo>`). <small>Fonte: CLI Buildx ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))</small>

---

## Cenários de Restrição ou Não Aplicação

- **Não há outro container ativo:** usar `container:<nome>` falhará se o container referenciado não estiver em execução.
- **Ambientes totalmente isolados:** quando a política de segurança exige builds offline, recomenda-se `network: none`.
- **Builds multi-plataforma:** ao cruzar plataformas, nem todas as implementações suportam modos avançados de rede; teste antes.

---

## Componentes-Chave Associados

- **`docker-compose.yml`** – arquivo de definição de serviços que agrupa `build`, `image` e `network`.
- **`networks` (top-level)** – seção para declarar redes reutilizáveis, referenciadas dentro de `build` ou `services`.
- **CLI `docker build --network`** – parâmetro equivalente na linha de comando do Docker Engine para build manual. <small>Fonte: Stack Overflow sobre `-network` em `docker build` ([stackoverflow.com](https://stackoverflow.com/questions/70190760/what-does-docker-build-network-host-actually-do?utm_source=chatgpt.com))</small>

---

## Melhores Práticas e Padrões de Uso

1. **Prefira redes isoladas para produção:** evitar `host` em pipelines de CI/CD por razões de segurança.
2. **Use `none` para builds determinísticos offline:** garante que nada seja baixado inadvertidamente.
3. **Documente redes customizadas no Compose:** facilite a manutenção e o onboarding de novos desenvolvedores.
4. **Teste localmente com `-network` na CLI antes de integrar ao Compose:** isole problemas de build de rede.

---

## Exemplo Prático Completo

```yaml
version: "3.9"

networks:
  internal_net:
    driver: bridge

services:
  builder:
    build:
      context: ./app
      dockerfile: Dockerfile
      network: internal_net
      args:
        - APP_VERSION=1.2.3
    image: minha-app:${APP_VERSION}
    networks:
      - internal_net

  database:
    image: postgres:15
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    networks:
      - internal_net

```

- **Cenário:**
    - A imagem `builder` precisa baixar dependências de um repositório interno acessível apenas pela rede `internal_net`.
    - A rede é criada uma única vez e compartilhada entre `builder` e `database`.
- **Fluxo de build:**
    1. `docker compose up --build` cria `internal_net`.
    2. Durante o `build`, o container temporário conecta-se a `internal_net`.
    3. Os comandos `RUN apt-get ...` ou `RUN curl ...` conseguem resolver nomes internos.

---

## Sugestões para Aprofundamento

- **Leitura do Dockerfile Reference** sobre o flag [`-network`](https://docs.docker.com/engine/reference/commandline/build/#network) na CLI.
- **Estudo de casos reais** em fóruns Docker, buscando cenários de build que exigem acesso a serviços internos já em execução.
- **Explorar `buildx`** para builds multi-plataforma e ver como o atributo `network` interage com caches distribuídos.

---

*Espero que esta explicação ajude a entender completamente o atributo `network` na chave `build` do Docker Compose!*