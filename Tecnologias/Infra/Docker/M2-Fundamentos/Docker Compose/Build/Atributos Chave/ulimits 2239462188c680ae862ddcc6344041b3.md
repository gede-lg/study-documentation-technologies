# ulimits

**Título da Explicação:** Entendendo o atributo `ulimits` na chave `build` no Docker Compose

---

## Introdução

O atributo `ulimits` dentro da seção `build` do Docker Compose permite ajustar os limites de recursos do sistema (como número de arquivos abertos ou processos) durante o processo de construção da imagem. Ao sobrescrever os valores padrão, é possível adaptar a build a requisitos específicos de aplicações que necessitam de limites maiores ou menores para funcionar corretamente ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **O que são ulimits?**
    
    São configurações do kernel Linux que limitam recursos como número de processos (`nproc`), número de descritores de arquivo abertos (`nofile`), entre outros. Ajustar esses valores pode ser crucial ao construir imagens que executam multithreading intensivo ou manipulam muitos arquivos simultaneamente.
    
- **Importância na build de imagens:**
    
    Durante o `docker build`, várias etapas (como compilação, testes, cópia de arquivos) podem exceder os limites padrão. Se não ajustados, podem ocorrer erros de “too many open files” ou falha na criação de processos, comprometendo a build ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
    

---

## Sintaxe Detalhada e Uso Prático

Dentro de um `docker-compose.yml`, o `ulimits` é especificado sob a chave `build` de um serviço. Há duas formas de configuração:

1. **Valor único (soft e hard iguais):**
    
    ```yaml
    services:
      app:
        build:
          context: .
          ulimits:
            nproc: 65535
    
    ```
    
    Aqui, o limite suave e o limite rígido recebem o mesmo valor ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
    
2. **Mapeamento de soft e hard:**
    
    ```yaml
    services:
      app:
        build:
          context: .
          ulimits:
            nofile:
              soft: 20000
              hard: 40000
    
    ```
    
    Permite definir valores distintos para `soft` (valor operacional) e `hard` (valor máximo permitido) ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
    

> Observação: Esse recurso exige Docker Compose versão 2.23.1 ou superior, conforme o Compose Build Specification (docs.docker.com).
> 

---

## Cenários de Restrição ou Não Aplicação

- **Ambientes com BuildKit desativado:** Nem todas as versões legadas suportam `ulimits` em build; versões anteriores ao Compose V2 podem não reconhecer o atributo.
- **Containers em produção:** O `ulimits` definido em `build` não afeta o container em runtime; para isso, use a chave de mesmo nome no nível do serviço (fora de `build`).
- **Plataformas não Linux:** Ulimits são específicos ao kernel Linux; em Windows ou macOS (via Docker Desktop), o comportamento pode ser diferente ou ignorado.

---

## Componentes Chave Associados

- **`build.context`**: Diretório ou URL Git usado como contexto de build. Sem definição explícita, assume-se o diretório do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **`build.target`**: Escolhe estágio de um Dockerfile multistage; não influencia diretamente `ulimits`, mas útil para builds segmentados ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **`build.ssh`, `build.secrets`**: Outras formas de fornecer credenciais ou dados sensíveis durante build; complementam `ulimits` ao garantir acesso necessário a recursos externos ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## Melhores Práticas e Padrões de Uso

- **Definir apenas limites necessários:** Evite valores excessivamente altos que possam mascarar vazamentos de recursos na aplicação.
- **Testar em ambiente isolado:** Use builds locais com verbose mode (`docker compose build --progress plain`) para verificar de fato a aplicação dos limites.
- **Consistência de versões:** Mantenha Compose CLI atualizado (>=2.23.1) e documente no README do projeto a necessidade do `ulimits` em build.

---

## Exemplo Prático Completo

```yaml
version: '3.9'
services:
  webapp:
    build:
      context: ./web
      dockerfile: Dockerfile
      ulimits:
        nproc: 32768
        nofile:
          soft: 10240
          hard: 20480
    image: myorg/webapp:latest
    ports:
      - "8080:80"

```

Neste cenário:

1. **`nproc: 32768`** assegura que o processo de build pode criar até 32.768 processos simultâneos.
2. **`nofile.soft: 10240`** permite até 10.240 arquivos abertos durante build.
3. **`nofile.hard: 20480`** define o teto máximo que `nofile.soft` pode alcançar.

---

## Sugestões para Aprofundamento

- **Documentação Oficial Compose Spec:** explore outros atributos de `build`: `cache_from`, `shm_size`, `platforms` ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/), [docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **Artigo sobre limites de recursos no Docker Engine:** entenda como Docker herda `ulimits` do host e interage com cgroups.
- **Comparativo Compose V1 vs V2:** veja limitações de versões legadas e migre seu ambiente para aproveitar recursos como `ulimits` em build.

---

Com esses detalhes, você terá um panorama completo para usar o atributo `ulimits` na fase de build do seu Docker Compose, ajustando recursos conforme as necessidades da sua aplicação.