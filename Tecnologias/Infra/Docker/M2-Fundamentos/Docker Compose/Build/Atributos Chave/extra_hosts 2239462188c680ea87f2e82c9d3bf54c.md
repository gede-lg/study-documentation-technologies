# extra_hosts

**Título da Explicação:** Entendendo o atributo `extra_hosts` em `build` no Docker Compose

---

## Introdução

No Docker Compose, o bloco `build` define como a imagem de um serviço é construída. A partir da versão 2.24.1 do Docker Compose, foi introduzido o atributo `extra_hosts` dentro de `build`, permitindo que sejam adicionados mapeamentos de hostname para IPs específicos **durante o processo de build**. Isso é útil quando, no momento da construção da imagem, você precisa resolver nomes de host que não estão disponíveis via DNS público ou interna, como servidores de dependências privadas ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Variações de Sintaxe](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#varia%C3%A7%C3%B5es-de-sintaxe)
4. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
5. [Componentes-Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
6. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
7. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
8. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Objetivo:** Injetar entradas no arquivo `/etc/hosts` do contêiner de build, permitindo sobrescrever ou complementar a resolução DNS durante a build da imagem. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
- **Importância:** Em cenários onde dependências (por exemplo, repositórios Git privados) residem em hosts sem registro DNS ou em VPNs, o Docker Build poderá falhar ao não conseguir resolver esses nomes. Com `extra_hosts`, assegura-se a resolução correta apenas para o build. ([forums.docker.com](https://forums.docker.com/t/specifing-extra-hosts-in-docker-compose-build-step/91980?utm_source=chatgpt.com))

---

## Sintaxe Detalhada e Uso Prático

Dentro do serviço, declare o bloco `build` e, aninhado a ele, o atributo `extra_hosts`:

```yaml
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      extra_hosts:
        - "somehost=162.242.195.82"
        - "otherhost=50.31.209.229"

```

- Cada entrada é uma string `"hostname=IP"` (ou `"hostname:IP"`).
- O Docker irá criar linhas adicionais em `/etc/hosts` do contêiner de build, como:
    
    ```
    162.242.195.82  somehost
    50.31.209.229   otherhost
    ``` :contentReference[oaicite:3]{index=3}
    
    ```
    

---

## Variações de Sintaxe

- **Separador `=` ou `:`**
    
    O formato preferido é `hostname=IP`, mas `hostname:IP` também funciona. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com))
    
- **Suporte a IPv6:**
    
    Endereços IPv6 podem ser colocados entre colchetes:
    
    ```yaml
    extra_hosts:
      - "myhostv6=[::1]"
    ``` :contentReference[oaicite:5]{index=5}
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Compose versão antiga:**
    
    O atributo só existe a partir do Docker Compose **v2.24.1**; em versões anteriores, não há suporte para `build.extra_hosts`. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com))
    
- **Imagem pré-construída:**
    
    Se você usa `image:` em vez de `build:`, o bloco `build.extra_hosts` é ignorado e não tem efeito. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
    
- **Ambientes Windows com `/etc/hosts` apenas leitura:**
    
    Alguns usuários reportaram falhas em ambientes Windows onde o arquivo é somente leitura e não permite modificações durante o build ([github.com](https://github.com/docker/compose/issues/8187/linked_closing_reference?utm_source=chatgpt.com)).
    

---

## Componentes-Chave Associados

- **`build.context`**: diretório onde está o `Dockerfile`.
- **`build.dockerfile`**: caminho para o Dockerfile (opcional se for `Dockerfile`).
- **`build.extra_hosts`**: lista de strings para adicionar mapeamentos durante o build.
- **`build.args`, `build.cache_from`, `build.labels`**: outros atributos no mesmo bloco `build` para passagem de variáveis, cache, e metadados, respectivamente ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

1. **Uso pontual:** Reserve `extra_hosts` apenas para builds que realmente dependem de hostnames privados. Não o utilize como substituto de DNS interno ou redes Docker.
2. **Manter centralizado:** Documente os mapeamentos de hosts em um arquivo `.env` ou comentário no `docker-compose.yml` para facilitar manutenção.
3. **Preferir DNS Docker:** Se possível, crie uma rede Docker com aliases (via `networks` + `aliases`) em vez de `extra_hosts`, pois isso mantém o build mais portável.
4. **Versionamento claro:** Declare no README a necessidade de uma versão mínima do Docker Compose (`>=2.24.1`).

---

## Exemplo Prático Completo

```yaml
version: "3.9"

services:
  builder:
    build:
      context: ./app
      dockerfile: Dockerfile
      # Mapeia hostname de serviço interno ao IP da VPN
      extra_hosts:
        - "git.internal.company.com=10.10.0.5"
        - "artifact.repo=10.10.0.6"
    image: company/app:latest

  web:
    image: nginx:stable
    ports:
      - "8080:80"

```

1. Durante `docker-compose build builder`, o hostname `git.internal.company.com` apontará para `10.10.0.5`.
2. Assim, comandos dentro do Dockerfile, como `RUN git clone https://git.internal.company.com/repo.git`, funcionarão sem falhas de DNS.

---

## Sugestões para Aprofundamento

- **Compose Specification:** leia a especificação completa de `build` em [https://docs.docker.com/reference/compose-file/build](https://docs.docker.com/reference/compose-file/build) ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com))
- **Redes Docker e Aliases:** explore como as [networks](https://docs.docker.com/reference/compose-file/services/#networks) podem eliminar a necessidade de `extra_hosts` no runtime ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
- **Uso de `host-gateway`:** para acesso ao host Docker, combine `extra_hosts` com `host.docker.internal:host-gateway` em ambientes Linux ([medium.com](https://medium.com/%40adityar947/how-to-establish-a-connection-from-a-docker-container-to-the-host-machine-130ce603dd55?utm_source=chatgpt.com))

---

Com isso, você tem uma visão completa e prática do atributo `extra_hosts` no bloco `build` do Docker Compose, capaz de resolver ambientes de build complexos com dependências de hosts privados.