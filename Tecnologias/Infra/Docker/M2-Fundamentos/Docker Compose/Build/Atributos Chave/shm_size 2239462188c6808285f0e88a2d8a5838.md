# shm_size

**Título da Explicação:** Entendendo o atributo `shm_size` na chave `build` do Docker Compose

---

## 1. Introdução

No Docker Compose, a seção `build` define como a imagem de um serviço deve ser construída a partir do código-fonte e de um `Dockerfile`. Dentro dessa seção, o atributo `shm_size` permite ajustar o tamanho da área de memória compartilhada (`/dev/shm`) que será usada pelos contêineres durante o processo de build. Esse recurso é especialmente relevante para workloads que dependem intensivamente de memória compartilhada, como aplicações de processamento de imagens, bancos de dados in-memory ou frameworks de machine learning que utilizam buffers compartilhados. ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/?utm_source=chatgpt.com))

---

## 2. Sumário

1. **Conceitos Fundamentais**
2. **Sintaxe Detalhada e Uso Prático**
3. **Cenários de Restrição ou Não Aplicação**
4. **Componentes-chave Associados**
5. **Melhores Práticas e Padrões de Uso**
6. **Exemplo Prático Completo**
7. **Sugestões para Aprofundamento**

---

## 3. Conceitos Fundamentais

- **Memória Compartilhada (`/dev/shm`):** é um sistema de arquivos em RAM (`tmpfs`) usado para troca rápida de dados entre processos.
- **Importância no Build:** processos `RUN` em um `Dockerfile` executam scripts e binários dentro de contêineres temporários; limites baixos de `/dev/shm` (padrão de **64 MB**) podem causar falhas ou degradação de performance em operações que geram buffers grandes ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container?utm_source=chatgpt.com)).
- **Atributo `shm_size`:** informa ao Docker Compose o tamanho (em bytes ou em notação de unidade) a ser montado em `/dev/shm` durante cada estágio de build ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/?utm_source=chatgpt.com)).

---

## 4. Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    build:
      context: ./app
      dockerfile: Dockerfile
      shm_size: 2gb        # valor em string com unidade
      # ou
      shm_size: 209715200  # valor em bytes

```

- **`context`**: diretório de build.
- **`dockerfile`**: nome ou caminho do Dockerfile.
- **`shm_size`**:
    - **Tipo:** string ou inteiro.
    - **Formato string:** aceita sufixos como `b`, `k`, `m`, `g` (case-insensitive).
    - **Formato inteiro:** número exato de bytes.
- **Equivalência no CLI do Docker BuildKit:**
    
    ```bash
    docker buildx build --shm-size=2gb .
    
    ```
    
    ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))
    

---

## 5. Cenários de Restrição ou Não Aplicação

- **BuildKit ativado vs. Build clássico:**
    - No **BuildKit** (padrão no Docker Desktop recente e no `docker buildx`), `-shm-size` é suportado ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com)).
    - Em versões antigas de Docker Engine com BuildKit desativado, esse parâmetro podia ser ignorado pelo Compose, exigindo `DOCKER_BUILDKIT=0` para retorno ao build clássico ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container?utm_source=chatgpt.com)).
- **Imagens finais não herdam `/dev/shm` customizado:** o `shm_size` só afeta os contêineres temporários do build; a imagem resultante não registra esse valor para runs futuros ([github.com](https://github.com/moby/moby/issues/26230?utm_source=chatgpt.com)).
- **Ambientes sem necessidade de alta memória compartilhada:** para builds simples ou que não envolvam bancos de dados embutidos, aumentar o `shm_size` pode desperdiçar RAM no host.

---

## 6. Componentes-chave Associados

- **`context`**: define onde o Compose busca arquivos para o build.
- **`dockerfile`**: permite apontar para um arquivo `Dockerfile` não padrão.
- **Outros atributos de isolamento**:
    - `network`: controla redes para instruções `RUN`.
    - `isolation`, `privileged`, `ulimits`, etc. ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/?utm_source=chatgpt.com))
- **Parâmetros de cache**:
    - `cache_from` / `cache_to`: influenciam performance de builds recorrentes.
    - `target`: para multi-stage builds.

---

## 7. Melhores Práticas e Padrões de Uso

1. **Dimensionamento Moderado:** defina `shm_size` entre 512 MB e 2 GB, conforme necessidade real de buffers compartilhados.
2. **Unidades Claras:** prefira notação string (`'512m'`, `'1g'`) para legibilidade.
3. **Versões de Compose:** utilize Compose V2 (CLI >= 1.27.0) para suporte completo ao spec ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com)).
4. **Verificação Pós-build:** teste o valor aplicado inspecionando contêineres temporários ou efetuando builds locais antes de CI/CD.
5. **Documentação Interna:** comente no arquivo Compose o motivo do ajuste, facilitando manutenção por outras equipes.

---

## 8. Exemplo Prático Completo

```yaml
version: '3.8'
services:
  processamento-imagem:
    build:
      context: ./image-processor
      dockerfile: Dockerfile
      shm_size: '1.5g'          # 1.5 GB de memória compartilhada
      args:
        - NODE_ENV=production
    image: empresa/imagem:latest
    volumes:
      - cache-npm:/root/.npm
    networks:
      - backend

volumes:
  cache-npm:

networks:
  backend:
    driver: bridge

```

1. **Fluxo**
    - `docker-compose build processamento-imagem` monta `/dev/shm` com 1.5 GB no contêiner de build.
    - Scripts em `RUN` que dependem de buffers grandes executam sem erro de falta de memória.
2. **Verificação**
    - Durante o build, inspecione logs de montagem:
        
        ```bash
        docker-compose run --rm processamento-imagem sh -c "df -h /dev/shm"
        
        ```
        
    - Deve retornar algo como `1.5G` disponível.

---

## 9. Sugestões para Aprofundamento

- **Compose Specification**: exploração completa das versões e atributos – [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
- **Docker BuildKit**: documentação de CLI e casos de uso avançados – [https://docs.docker.com/engine/reference/commandline/buildx_build/](https://docs.docker.com/engine/reference/commandline/buildx_build/) ([docs.docker.com](https://docs.docker.com/reference/cli/docker/buildx/build/?utm_source=chatgpt.com))
- **Gestão de Memória em Contêineres**: artigos sobre `-tmpfs`, `-ipc=host` e uso de volumes de memória.
- **Perfis de desempenho**: comparações de build com diferentes `shm_size` em pipelines de CI.

---

Com isso, você dispõe de uma visão completa sobre o atributo `shm_size`: sua definição, aplicação prática, limitações e exemplos de uso em projetos reais.