# cache_from

**Entendendo o atributo `cache_from` na chave `build` do Docker Compose**

---

## Introdução

O atributo `cache_from`, disponível na subseção `build` de um serviço no Docker Compose, serve para especificar fontes externas de cache de camadas de imagem que o construtor deve tentar reutilizar antes de reconstruir passos do Dockerfile. Essa funcionalidade é fundamental para agilizar builds, reduzir consumo de recursos e acelerar pipelines, sobretudo em ambientes de CI/CD. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes-Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## 1. Conceitos Fundamentais

- **Build Cache no Docker:** Cada instrução do Dockerfile gera uma camada (layer). Em builds subsequentes, se o contexto e a instrução não mudarem, o Docker pode reutilizar a camada já existente, economizando tempo.
- **Por que `cache_from`?** Por padrão, o Docker olha apenas para o cache local (layers já existentes na máquina). Em cenários de CI/CD, agentes de build normalmente começam “do zero” sem histórico de camadas. O `cache_from` permite apontar imagens pré-existentes (no registro ou local) que contenham camadas compatíveis, importando esse cache para o build atual ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **BuildKit:** A partir da versão 3.4 do Compose, o BuildKit é o builder padrão. Ele oferece suporte avançado para `cache_from` e `cache_to`, inclusive importação/exportação de cache em diversos formatos ([yuki-nakamura.com](https://yuki-nakamura.com/2024/01/20/use-buildkit-from-docker-compose/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    build:
      context: ./app
      dockerfile: Dockerfile
      cache_from:
        - nome-da-imagem:tag               # atalho para registry (type=registry,ref)
        - type=local,src=./.cache-local     # cache no filesystem local
        - type=gha                          # cache armazenado no GitHub Actions

```

- **Formato Simples:**
    - `"nome-da-imagem:tag"` é equivalente a `type=registry,ref=nome-da-imagem:tag`.
- **Formato Avançado (`type=…`):**
    - `type=registry,ref=<imagem>`: importa cache de um repositório OCI.
    - `type=local,src=<caminho>`: importa cache de um diretório local.
    - `type=gha`: (GitHub Actions) importa cache gerenciado pela Actions ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **Ordem de Resolução:** o builder tenta cada item em ordem e importa o que estiver disponível; fontes não suportadas ou indisponíveis são ignoradas sem falhar o build.

---

## 3. Cenários de Restrição ou Não Aplicação

- **Cache ausente ou obsoleto:** se nenhuma das fontes contiver camadas adequadas, o build prossegue sem cache.
- **Imagens não versionadas:** usar `latest` pode causar inconsistência de cache; prefira tags fixas ou legadas de branches (`feature-x-cache`) para evitar sobrescrita indesejada.
- **Builders sem suporte:** algumas versões antigas do Compose ou builders externos podem não reconhecer tipos de cache além do registry.
- **Segurança e privacidade:** cuidado ao importar cache de fontes públicas ou compartilhadas, pois camadas podem conter artefatos sensíveis.

---

## 4. Componentes-Chave Associados

| Componente | Descrição |
| --- | --- |
| `cache_from` | Lista de fontes de importação de cache. |
| `type=registry` | Importa cache de um registro OCI, via `ref=<imagem:tag>`. |
| `type=local` | Importa cache de um diretório local, via `src=<caminho>`. |
| `src` | Chave obrigatória quando `type=local`. |
| `ref` | Chave obrigatória quando `type=registry`. |
| `type=gha` | Importa cache armazenado no GitHub Actions (requisição via BuildKit no contexto do runner). |

---

## 5. Melhores Práticas e Padrões de Uso

- **Padronize nomes de cache:** use convenções como `<app>-cache:<branch>` para manter histórico de cache por branch.
- **Combine `cache_from` e `cache_to`:** exporte cache ao final do build (`cache_to`) e importe no próximo (`cache_from`) para circulação eficiente em pipelines.
- **Evite `latest` para cache:** tags imutáveis garantem reprodutibilidade.
- **Limpeza periódica:** remova caches obsoletos (comandos `docker builder prune` ou limpeza de diretórios locais) para evitar acúmulo desnecessário.
- **CI/CD:** configure pulls prévios das imagens de cache antes do build (`docker pull imagem:cache`) para maximizar reutilização.

---

## 6. Exemplo Prático Completo

A seguir, um `docker-compose.yml` simplificado de um serviço web em Python usando cache de um registro e localmente:

```yaml
version: '3.8'
services:
  web:
    image: minhaorg/webapp:latest
    build:
      context: ./webapp
      dockerfile: Dockerfile
      cache_from:
        - minhaorg/webapp:cache-main
        - type=local,src=./.buildkit-cache/webapp
      cache_to:
        - type=local,dest=./.buildkit-cache/webapp,mode=max
        - minhaorg/webapp:cache-main
    ports:
      - "8000:8000"

```

1. **`cache_from`** tenta importar:
    - Camadas de `minhaorg/webapp:cache-main` no registro OCI.
    - Diretório local `./.buildkit-cache/webapp`.
2. **`cache_to`** exporta:
    - Cache máximo para `./.buildkit-cache/webapp`.
    - Atualiza a imagem `minhaorg/webapp:cache-main` no registro.
3. **Pipeline CI/CD típico:**
    
    ```bash
    docker pull minhaorg/webapp:cache-main || true
    docker-compose build web
    docker-compose push web
    
    ```
    

Esse fluxo garante que, a cada build, você aproveita o máximo de cache possível e atualiza o cache para usos futuros.

---

## 7. Sugestões para Aprofundamento

- Explore [Cache storage backends no BuildKit](https://docs.docker.com/build/cache/backends/) para conhecer outros tipos de backend e parâmetros de compressão e modo de cache ([docs.docker.com](https://docs.docker.com/build/cache/backends/?utm_source=chatgpt.com)).
- Estude a integração de `cache_from` em pipelines GitHub Actions com `actions/cache` para ambientes serverless.
- Teste cenários de **multi-stage builds**, onde importar cache de estágios intermediários pode reduzir drasticamente o tempo total de build.

---

Com essa visão detalhada, você está apto a configurar e otimizar corretamente o uso de `cache_from` em seus projetos Docker Compose, garantindo builds mais rápidos, reprodutíveis e escaláveis.