# no_cache

**Understanding the `no_cache` Attribute in Docker Compose Build**

---

## Introdução

Ao construir imagens Docker, o cache de camadas acelera builds subsequentes reaproveitando etapas não modificadas. Porém, em algumas situações (por exemplo, quando bibliotecas externas mudam sem atualização de arquivos copiáveis) é desejável desativar esse cache. O atributo `no_cache`, disponível na seção `build` do Compose File, controla exatamente esse comportamento, equivalendo ao uso de `--no-cache` na CLI do Docker .

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Variações de Sintaxe e Versões Suportadas
4. Cenários de Restrição ou Não Aplicação
5. Componentes Chave Associados
6. Melhores Práticas e Padrões de Uso
7. Exemplo Prático Completo
8. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Cache de build**: cada instrução do Dockerfile gera uma “camada” cacheável. Se nothing muda na instrução e nos artefatos que ela copia, o Docker reutiliza a camada anterior, acelerando o build.
- **Desativar cache**: ao usar `-no-cache`, força o Docker a ignorar todo o cache, reconstruindo cada etapa do zero. Isso garante atualizações “frescas” mas penaliza o tempo de build.
- **Objetivo do `no_cache`**: simplificar a configuração de builds “limpos” diretamente no Compose File, sem precisar lembrar de passar a flag na linha de comando ([github.com](https://github.com/docker/compose/issues/10392?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/74853034/what-is-the-correct-syntax-to-add-no-cache-to-a-docker-compose-file?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

### Atributo `no_cache`

```yaml
version: "3.8"
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # desativa o uso de cache em todas as etapas
      no_cache: true
    image: minha-imagem:latest
    # ...

```

- **Campo**: `no_cache`
- **Tipo**: boolean
- **Padrão**: `false`
- **Efeito**: equivale a `docker compose build --no-cache` para este serviço

### Equivalência CLI

- **Com cache**:
    
    ```bash
    docker compose build
    
    ```
    
- **Sem cache**:
    
    ```bash
    docker compose build --no-cache
    
    ```
    
    ou
    
    ```bash
    docker compose up --build --no-cache
    ``` :contentReference[oaicite:2]{index=2}.
    
    ```
    

---

## 3. Variações de Sintaxe e Versões Suportadas

- **Compose File Version**: o atributo `no_cache` faz parte da **Compose Specification** (v2 e posteriores) mas **não está implementado** no binário legado `docker-compose` (com hífen) até as versões 1.x. É suportado pela nova CLI `docker compose` (plugin do Docker) a partir da versão 2.4.0 ([stackoverflow.com](https://stackoverflow.com/questions/74853034/what-is-the-correct-syntax-to-add-no-cache-to-a-docker-compose-file)).
- **Compose Specification**: mesmo que apareça na spec oficial (compose-spec.json), nem todas implementações (como Swarm ou `docker-compose` antigo) necessariamente o reconhecem.

---

## 4. Cenários de Restrição ou Não Aplicação

- **Ferramentas legadas**: `docker-compose` (< v2/plugin) ignora ou rejeita `no_cache`, gerando erro de opção não suportada.
- **BuildKit avançado**: ao usar caches externos ou remotos, pode-se preferir opções mais granulares como `-build-arg CACHEBUST=$(date +%s)` ou `-no-cache-filter` do BuildKit ([docs.docker.com](https://docs.docker.com/build/cache/invalidation/?utm_source=chatgpt.com)).
- **Desempenho**: em cenários de CI/CD, builds frequentes sem cache podem sobrecarregar recursos e redes ao rebaixar pacotes.

---

## 5. Componentes Chave Associados

- **`context`**: diretório onde fica o Dockerfile e demais artefatos.
- **`dockerfile`**: caminho do Dockerfile relativo ao `context`.
- **`args`**: variáveis de build, usadas para bust de cache se variáveis mudam.
- **`target`**: em builds multi-stage, pode-se especificar estágios específicos.
- **`no_cache`**: bool que controla a desativação geral do cache.

---

## 6. Melhores Práticas e Padrões de Uso

- **Use com parcimônia**: cache é seu aliado para builds rápidos; só desative em quando realmente necessário (mudanças em pacotes externos, trabalho com imagens base mutáveis, correções de segurança).
- **Cache busting seletivo**: prefira `ARG` dinâmicos ou alterar `COPY` de arquivos de dependências para invalidar somente etapas necessárias.
- **CI/CD**: em pipelines, combine `-cache-from` com registries remotos para acelerar builds sem risco de usar camadas antigas demais.
- **Consistência de ambiente**: documente o uso de `no_cache` para que todos os desenvolvedores saibam que aquele serviço sempre rebuilda.

---

## 7. Exemplo Prático Completo

### Estrutura de Projeto

```
.
├── docker-compose.yml
├── app/
│   ├── Dockerfile
│   └── requirements.txt
└── web/
    ├── Dockerfile
    └── package.json

```

### `docker-compose.yml`

```yaml
version: "3.9"

services:
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      no_cache: true      # força rebuild completo
      args:
        - ENV=prod
    image: minha-app:prod
    restart: always

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      # mantém cache normal para web
    image: minha-web:latest
    ports:
      - "80:3000"

```

1. `app` será sempre reconstruído do zero, útil para instalar dependências que mudam sem alteração de `requirements.txt`.
2. `web` usará cache normalmente, acelerando rebuilds ao alterar apenas código de frontend.

---

## 8. Sugestões para Aprofundamento

- **Caching Avançado com BuildKit**: explore `-cache-from`, `-cache-to`, e `-no-cache-filter` na CLI do BuildKit ([docs.docker.com](https://docs.docker.com/build/cache/invalidation/?utm_source=chatgpt.com)).
- **Compose Specification Completa**: leia o [compose-spec.yaml](https://github.com/compose-spec/compose-spec/blob/master/compose-spec.yaml) para entender todas opções de `build`.
- **CI/CD e Cache Remoto**: integração com registries para armazenamento de cache (`docker buildx bake`) em pipelines.

---

> Em resumo, o atributo no_cache: true no build do Compose File é a forma declarativa de aplicar --no-cache no build da imagem, garantindo que nenhuma camada anterior seja reaproveitada. Este recurso está disponível na nova CLI docker compose (v2.4.0+) e deve ser usado com cuidado, pois aumenta significativamente o tempo de build.
>