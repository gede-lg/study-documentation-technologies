# secrets

**Entendendo o atributo `secrets` no `build` do Docker Compose**

---

## Introdução

O atributo `secrets` dentro da chave `build` no Docker Compose permite que informações sensíveis (como senhas, tokens de API ou certificados) sejam disponibilizadas ao processo de build de forma segura, sem persistirem na imagem final. Essa funcionalidade faz parte da especificação do Compose V2 e aprimora a segurança em comparação ao uso de variáveis de ambiente ou build args comuns ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
    - Sintaxe Curta
    - Sintaxe Longa
3. Cenários de Restrição ou Não Aplicação
4. Componentes-Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Build Secrets**: informações sensíveis consumidas apenas durante o *build* e montadas temporariamente no container de build, evitando que fiquem gravadas na imagem final ([docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com)).
- **Montagem Segura**: ao usar `secrets`, o Compose monta cada segredo em `/run/secrets/<nome_do_segredo>` no container de build, com permissões de arquivo controladas para minimizar exposição ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **Escopo por Serviço**: há dois níveis de definição — o top-level `secrets`, que registra as origens (arquivos, variáveis de ambiente ou segredos externos), e o `build.secrets`, que atribui especificamente cada segredo ao build de um *service* ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Sintaxe Curta

Define apenas o nome do segredo, montando-o em `/run/secrets/<nome>` com fonte e destino iguais ao nome.

```yaml
version: "3.9"
services:
  frontend:
    build:
      context: .
      secrets:
        - server-certificate   # <- uso da sintaxe curta
secrets:
  server-certificate:
    file: ./server.cert     # <- fonte do segredo

```

- **Fluxo**:
    1. `docker compose build` lê `./server.cert`.
    2. Monta `/run/secrets/server-certificate`.
    3. Disponibiliza ao `RUN` do Dockerfile (por exemplo, via `-mount=type=secret`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

### 2.2 Sintaxe Longa

Permite configurar `source`, `target`, `mode`, `uid` e `gid` para maior controle.

```yaml
services:
  frontend:
    build:
      context: .
      secrets:
        - source: server-certificate  # nome do segredo registrado
          target: cert                 # nome interno de uso no Dockerfile
          uid: "103"                   # dono do arquivo
          gid: "103"                   # grupo do arquivo
          mode: 0440                   # permissão em octal
secrets:
  server-certificate:
    external: true                  # vem de um segredo gerenciado externamente

```

- **Campos**:
    - `source`: nome como registrado top-level ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
    - `target`: ID no `RUN --mount=type=secret,id=<target>` do Dockerfile.
    - `mode`: define permissões (o bit escrevível é ignorado).
    - `uid`/`gid`: controle de propriedade.

---

## 3. Cenários de Restrição ou Não Aplicação

- **Compose V1**: o `build.secrets` só funciona com o comando integrado `docker compose` (V2+), não com `docker-compose` em Python ([stackoverflow.com](https://stackoverflow.com/questions/72280771/how-to-use-secrets-when-building-docker-compose-locally?utm_source=chatgpt.com)).
- **Build em Multi-etapas sem Buildx**: algumas implementações antigas podem não suportar montagens de segredo; recomenda-se usar Buildx ou Docker Engine ≥ 20.10.
- **Imagens Minimalistas sem Shell**: se o build depende de processadores de ambiente (ex.: `<ENTRYPOINT>` sem shell), talvez seja inviável ler o arquivo de segredo.

---

## 4. Componentes-Chave Associados

- **Top-level `secrets`**: define a origem. Pode ser `file`, `environment`, `external` ou driver de secret do Swarm/Kubernetes ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **`RUN --mount=type=secret`**: instrução do Dockerfile que consome o segredo durante o build, apontando para o `id` configurado em `build.secrets` ([docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com)).
- **`-secret` CLI**: ao usar Docker CLI diretamente, passa segredos ao build com `docker build --secret id=aws,src=$HOME/.aws/credentials` ([docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com)).

---

## 5. Melhores Práticas e Padrões de Uso

1. **Segregue Segredos**: registre apenas segredos necessários ao build em `build.secrets`.
2. **Use Permissões Restringidas**: configure `mode: 0440` ou mais restritivo para minimizar leitura por processos não autorizados.
3. **Evite Variáveis de Ambiente**: mesmo em `.env`, variáveis podem vazar em logs; prefira `secrets`.
4. **Limpe Builds**: certifique-se de que instruções `RUN` não gravem os arquivos de segredo em camadas posteriores.
5. **Versionamento de Compose**: especifique `version: "3.9"` ou superior no Compose file para garantir suporte ao recurso.

---

## 6. Exemplo Prático Completo

Imagine um build que precise de uma chave privada para compilar um cliente SSH customizado:

```yaml
version: "3.9"
services:
  ssh-client:
    build:
      context: ./ssh-client
      dockerfile: Dockerfile
      secrets:
        - source: ssh_key
          target: id_rsa            # referência no Dockerfile
          uid: "1000"
          gid: "1000"
          mode: 0400
secrets:
  ssh_key:
    file: ~/.ssh/id_rsa          # arquivo local com chave privada

```

**Dockerfile**:

```
FROM alpine:latest
# Instalação de dependências
RUN apk add --no-cache openssh-client
# Montagem segura do segredo e uso
RUN --mount=type=secret,id=id_rsa \
    chmod 400 /run/secrets/id_rsa && \
    ssh-keyscan github.com >> /etc/ssh/known_hosts && \
    git clone git@github.com:meu-repo/privado.git

```

1. O Compose monta o arquivo `~/.ssh/id_rsa` em `/run/secrets/id_rsa`.
2. O `RUN --mount` expõe o segredo apenas para este passo de build.
3. A chave nunca permanece na imagem final — ela é descartada ao final do build ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/), [docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com)).

---

## 7. Sugestões para Aprofundamento

- **Docker Build Secrets**: explore builds com SSH mounts e autenticação para Git remotos ([docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com)).
- **Swarm/Kubernetes Secrets**: veja como integrar segredos de orquestradores externos com Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).
- **Ferramentas de Gestão**: avalie o uso de Vault ou AWS Secrets Manager como *back-end* para segredos externos.

---

Com essa explicação completa, você está apto a usar o atributo `secrets` no `build` do Docker Compose de forma segura, flexível e de acordo com as melhores práticas.