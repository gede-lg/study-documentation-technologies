# privileged

**Entendendo o atributo `privileged` na chave `build` do Docker Compose**

---

## Introdução

O Docker Compose permite definir, em um único arquivo, como construir e orquestrar serviços Docker. Dentro da seção `build`, diversos atributos configuram o processo de build de uma imagem. Entre eles, o atributo `privileged` habilita privilégios elevados para os containers de build, permitindo operações normalmente restritas pelo sandbox de segurança padrão do Docker ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **O que é**: `privileged: true` faz com que o container usado no estágio de build seja executado com privilégios elevados, semelhantes ao `-privileged` do `docker run`.
- **Por que existe**: alguns processos de build demandam acesso a recursos do sistema (ex.: montagem de dispositivos, uso de namespaces específicos, execução de Docker-in-Docker). Sem privilégios, esses comandos falham.
- **Importância**: habilita conteúdos avançados de build sem sair do framework portátil do Compose. Contudo, expõe riscos de segurança, pois desativa muitas proteções do kernel ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## Sintaxe Detalhada e Uso Prático

```yaml
version: "3.9"
services:
  builder:
    build:
      context: ./app
      dockerfile: Dockerfile
      privileged: true   # ativa privilégios elevados para o container de build

```

- `privileged`: valor booleano, obrigatório apenas para habilitar (`true`).
- **Resolução de caminho**: `context` e `dockerfile` funcionam normalmente, relativos ao arquivo Compose.
- **Interação com outros atributos**: pode ser combinado com `entitlements` (ex.: `security.insecure`), porém ambos se sobrepõem apenas se a plataforma suportar ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)).

---

## Cenários de Restrição ou Não Aplicação

- **Não suportado** em todas as plataformas: algumas implementações de container runtime podem ignorar ou rejeitar este atributo.
- **Risks**: amplia a superfície de ataque, pois dá acesso a todos os dispositivos do host.
- **Alternativa**: em muitos casos, usar apenas `entitlements` (`network.host`, `security.insecure`) supre as necessidades específicas de build sem dar privilégios totais.
- **Quando evitar**: builds simples que não requerem operações de baixo nível ou em ambientes de produção com políticas de segurança restritas.

---

## Componentes Chave Associados

| Componente | Descrição |
| --- | --- |
| `build.privileged` | Habilita modo privilégios elevados (equivalente a `--privileged` no `docker run`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)) |
| `entitlements` | Permite granularidade em privilégios (ex.: `security.insecure`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/)) |
| `pull_policy` | Define se puxa imagens antes de buildar; não impacta diretamente no `privileged`. |
| Versão mínima do Compose CLI | A partir da **2.15.0** (Compose V2.x). |

---

## Melhores Práticas e Padrões de Uso

- **Use só quando necessário**: limpe o build de dependências ou operações de baixo nível antes de ativar `privileged`.
- **Combinar com entitlements**: prefira ações específicas (`security.insecure`) a privilégios totais, reduzindo riscos.
- **Ambientes isolados**: restrinja Builds privilegiados a pipelines CI/CD confiáveis, nunca em hosts de produção diretos.
- **Documentação clara**: comente no Compose a razão de usar `privileged`, facilitando auditorias de segurança.
- **Teste de compatibilidade**: valide localmente se sua runtime suporta `build.privileged` antes de integrar em pipelines.

---

## Exemplo Prático Completo

Suponha um projeto que precisa rodar Docker-in-Docker para construir imagens secundárias:

```yaml
version: "3.9"
services:
  dind:
    image: docker:24.0-dind
    privileged: true                       # habilita DIND
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - dind-var-lib-docker:/var/lib/docker

  app-builder:
    build:
      context: ./app
      dockerfile: Dockerfile
      privileged: true                      # permite chamadas Docker dentro do build
    depends_on:
      - dind
    environment:
      DOCKER_HOST: tcp://dind:2375
    volumes:
      - ./app:/app

volumes:
  dind-var-lib-docker:

```

1. **`dind`**: serviço Docker-in-Docker, executando em modo privilegiado.
2. **`app-builder`**: conecta ao `dind` para executar comandos `docker build` dentro de seu processo de build, também em modo privilegiado.

Esse setup possibilita pipelines que constroem imagens secundárias dinamicamente, mantendo toda a definição no Compose.

---

## Sugestões para Aprofundamento

- Documentação oficial do Compose Build Specification (atributos completos): ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/))
- Guia de entitlements no Buildx (uso avançado de permissões): repositório Docker Buildx
- Artigos sobre riscos de segurança ao usar `-privileged` em containers: Dan Walsh no Red Hat Blog
- Exemplos de CI/CD com DIND em ambientes seguros (GitLab CI/CD, GitHub Actions)

---

> Observação: utilize privileged com cautela e sempre avalie se não seria possível alcançar o mesmo resultado com permissões mais restritas (via entitlements), mantendo seu ambiente mais seguro e auditável.
>