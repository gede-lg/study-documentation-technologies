# logging

# Atributo `logging` da chave `services` no Docker Compose

## Introdução

O atributo `logging` no contexto de um serviço definido em um arquivo `docker-compose.yml` permite configurar, de forma declarativa, o mecanismo de coleta e armazenamento de logs de containers. Ao especificar um driver de logs e suas opções, você ganha controle sobre a roteabilidade, retenção e formatação das saídas de STDOUT/STDERR das suas aplicações em containers ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Logs como fluxo de eventos:** Em ambientes conteinerizados, cada serviço geralmente escreve em STDOUT e STDERR. Esses fluxos de texto bruto precisam ser coletados, processados e armazenados por um driver de logs.
- **Driver de logs:** É um plugin do Docker Engine que define como e para onde os logs são encaminhados (arquivo local, syslog, Fluentd, GELF, etc.). No Compose, o atributo `logging.driver` equivale ao parâmetro `-log-driver` do comando `docker run`.
- **Opções de driver:** Cada driver pode prover parâmetros específicos, como tamanho máximo de arquivo, número de arquivos rotacionados, destino de logs remotos, tags, entre outros ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sintaxe Detalhada e Uso Prático

### Estrutura YAML

```yaml
services:
  <nome_serviço>:
    image: <imagem>
    logging:
      driver: <nome_do_driver>
      options:
        <chave_opção_1>: "<valor>"
        <chave_opção_2>: "<valor>"

```

> Observação: As opções em options são interpretadas como strings, mesmo quando representam números ou booleanos (docs.docker.com).
> 

### Elementos do Atributo `logging`

- **`driver`**
    - Tipo: *string*
    - Descrição: identifica o driver de logs a ser usado pelo container. Se não especificado, utiliza o driver padrão configurado no daemon Docker (geralmente `json-file`).
- **`options`**
    - Tipo: *mapa* (chave: valor)
    - Descrição: parâmetros passados ao driver, correspondentes às flags `-log-opt` do Docker.

### Exemplo comentado

```yaml
services:
  web:
    image: nginx:latest         # Imagem oficial do NGINX
    logging:
      driver: "json-file"       # Usa o driver que gera arquivos JSON no host
      options:
        max-size: "10m"         # Tamanho máximo antes de rotacionar o arquivo
        max-file: "3"           # Número máximo de arquivos de log

```

- `driver: "json-file"` → habilita logs em arquivo ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- `max-size: "10m"` e `max-file: "3"` → controlam rotação para evitar uso excessivo de disco ([docs.docker.com](https://docs.docker.com/engine/logging/configure/?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Swarm com `docker stack deploy`:** Em versões mais antigas do Compose, configurações de `logging` no nível de serviço podiam ser ignoradas quando implantadas via `docker stack deploy`. Verifique a compatibilidade da versão do Docker e do Compose CLI.
- **Drivers não instalados:** Se o driver especificado não estiver presente no host, o Docker utilizará o driver padrão, sem emitir erro fatal.
- **Ambientes de teste/exploração:** Em setups temporários, a sobrecarga de configuração de logging pode não ser necessária; o comando `docker-compose logs` já permite inspeção ad hoc.

---

## Componentes Chave Associados

1. **`logging.driver`** → Nome do plugin de logging (ex.: `json-file`, `local`, `syslog`, `fluentd`, `gelf`, `awslogs`, etc.) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
2. **`logging.options`** → Parâmetros específicos do driver:
    - `max-size`, `max-file` (json-file, local)
    - `syslog-address`, `syslog-facility` (syslog)
    - `fluentd-address`, `tag` (fluentd) ([last9.io](https://last9.io/blog/docker-logging-drivers/?utm_source=chatgpt.com))
    - `gelf-address`, `gelf-compression-type` (gelf)
    - entre outros, conforme documentado pelo driver.
3. **Configuração do daemon** (`daemon.json`) → Define o driver padrão (`log-driver`) e opções globais (`log-opts`) que podem ser sobrescritas pelo Compose ([docs.docker.com](https://docs.docker.com/engine/logging/configure/?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

- **Use o driver `local` em produção**
    
    O driver `local` faz rotação automática e usa um formato de arquivo mais eficiente, reduzindo o risco de esgotamento de disco e melhorando a performance ([docs.docker.com](https://docs.docker.com/engine/logging/configure/?utm_source=chatgpt.com)).
    
- **Defina limites de tamanho e quantidade de arquivos**
    
    Mesmo com drivers rotacionados, especifique `max-size` e `max-file` para manter logs sob controle e facilitar a retenção de histórico.
    
- **Centralize seus logs em uma solução de agregação**
    
    Para múltiplos serviços e hosts, use drivers como `fluentd` ou `gelf` para enviar logs a sistemas como ELK, Graylog ou Fluent Bit ([squadcast.com](https://www.squadcast.com/blog/docker-compose-logs?utm_source=chatgpt.com)).
    
- **Padronize `tag` para facilitar o parsing**
    
    Ao configurar drivers como Fluentd, defina opções de `tag` que incluam `{{.Service.Name}}` ou similares, garantindo diferenciação clara de serviços nos agregadores ([last9.io](https://last9.io/blog/docker-logging-drivers/?utm_source=chatgpt.com)).
    
- **Monitore o uso de disco**
    
    Utilize métricas de sistemas de arquivos ou ferramentas de monitoramento para alertar sobre uso elevado de logs.
    

---

## Exemplo Prático Completo

```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api:
    image: my-api:latest
    environment:
      - NODE_ENV=production
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "fluentd:24224"
        tag: "api.{{.Name}}"

  fluentd:
    image: fluent/fluentd:latest
    ports:
      - "24224:24224"
    volumes:
      - ./fluentd.conf:/fluentd/etc/fluent.conf

```

1. **Serviço `web`** → logs em JSON com rotação (3 arquivos de até 10 MB cada).
2. **Serviço `api`** → envia logs para um container `fluentd`, que por sua vez pode encaminhar a um agregador centralizado.
3. **Container `fluentd`** → recebe e processa as entradas conforme o `fluentd.conf`, podendo persistir localmente ou encaminhar a outros destinos.

---

## Sugestões para Aprofundamento

- Explore o [Controle de logs no Docker Engine](https://docs.docker.com/engine/logging/configure/) para entender detalhes sobre drivers nativos ([docs.docker.com](https://docs.docker.com/engine/logging/configure/?utm_source=chatgpt.com)).
- Teste plugins de logging customizados através de `docker plugin install <nome>` e valide-o no Compose.
- Integre métricas de logs com sistemas como Prometheus usando exporters de logs.
- Analise soluções de *log shipping* em Kubernetes para compreender diferenças de arquitetura.

---

Com essa visão completa, você está pronto para configurar e gerenciar de forma eficiente os logs dos seus serviços Docker Compose, tanto em ambientes de desenvolvimento quanto de produção.