# runtime

**Atributo `runtime` em serviços do Docker Compose: Explicação Detalhada**

---

## Introdução

O atributo `runtime` no bloco de um serviço do Docker Compose permite especificar qual **OCI container runtime** (por exemplo, `runc`, `nvidia`, `kata`, `gvisor` etc.) será utilizado para instanciar o contêiner. Na prática, equivale ao parâmetro `--runtime` do comando `docker run` e é especialmente útil para cenários que exigem runtimes alternativos, como aceleração por GPU ([docs.docker.com](https://docs.docker.com/engine/daemon/alternative-runtimes/?utm_source=chatgpt.com)).

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## 1. Conceitos Fundamentais

- **OCI Runtime**: é o binário responsável por criar e gerenciar o namespace dos contêineres no nível do sistema operacional. Por padrão o Docker Engine usa o `runc`, mas suporta outros como `gvisor`, `kata` ou runtimes de GPU ([docs.docker.com](https://docs.docker.com/engine/daemon/alternative-runtimes/?utm_source=chatgpt.com)).
- **Compose Specification**: define como atributos opcionais, incluindo configurações específicas ao runtime, podem ser declarados no `docker-compose.yml` ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/main/spec.md)).
- O atributo `runtime` mapeia diretamente para o flag `-runtime` do Docker CLI e deve corresponder ao nome configurado no arquivo de daemon do Docker (`daemon.json`).

---

## 2. Sintaxe Detalhada e Uso Prático

```yaml
version: "2.3"    # mínimo para suportar `runtime`
services:
  meu-servico:
    image: exemplo/imagem:latest
    runtime: "nvidia"    # usa o NVIDIA Container Runtime
    command: nvidia-smi  # demonstra uso da GPU

```

- **`version: "2.3"`**: o suporte a `runtime` surge a partir do Compose file v2.3 ([stackoverflow.com](https://stackoverflow.com/questions/47465696/how-do-i-specify-nvidia-runtime-from-docker-compose-yml?utm_source=chatgpt.com)).
- **Valores permitidos**: names dos runtimes registrados no daemon, ex.: `"nvidia"`, `"kata"`, `"amd"`, `"io.containerd.kata.v2"` etc.
- **Variações de sintaxe**: não há variações; o valor deve ser uma string simples.

> Nota: tentar usar runtime em versões 3.x sem plugin de compatibilidade pode resultar em erro (stackoverflow.com).
> 

---

## 3. Cenários de Restrição ou Não Aplicação

- **Docker Swarm / `docker stack deploy`**: o atributo `runtime` não é suportado; nesses casos deve-se usar o bloco `deploy.resources.reservations.devices` para GPUs (exclusivo de Swarm mode) ([stackoverflow.com](https://stackoverflow.com/questions/72665778/docker-compose-gpu-support-services-deploy-resources-reservations-additional?utm_source=chatgpt.com)).
- **Versões antigas do Compose CLI**: somente Compose CLI ≥ 1.27.0 (Compose V2) implementa de fato a Compose Specification que inclui `runtime` ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com)).
- **Ambientes Windows**: runtimes alternativos geralmente não fazem sentido; o atributo pode ser ignorado ou rejeitado.

---

## 4. Componentes Chave Associados

- **`daemon.json`**: registra runtimes adicionais:
    
    ```
    {
      "runtimes": {
        "gvisor": {
          "runtimeType": "io.containerd.runsc.v1",
          "options": { "ConfigPath": "/etc/containerd/runsc.toml" }
        },
        "youki": { "path": "/usr/local/bin/youki" }
      }
    }
    
    ```
    
- **CLI correspondente**:
    
    ```bash
    docker run --runtime gvisor hello-world
    
    ```
    
- **Compose Spec**: atributo opcional, portanto implementações podem ignorá-lo com warning, segundo recomendações ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/main/spec.md)).

---

## 5. Melhores Práticas e Padrões de Uso

- **Manter Compose atualizado**: use sempre Compose V2 (CLI integrado) para garantir suporte ao `runtime`.
- **Prefira recursos nativos**: para GPUs em produção com Swarm, utilize `deploy.resources.reservations.devices` ao invés de `runtime` ([stackoverflow.com](https://stackoverflow.com/questions/72665778/docker-compose-gpu-support-services-deploy-resources-reservations-additional?utm_source=chatgpt.com)).
- **Ambientes heterogêneos**: documente o requisito de runtime no README para que outros desenvolvedores registrem corretamente no daemon.
- **Fallback transparente**: combine `runtime` com profiles ou variáveis de ambiente para ativar somente em dev ou CI.

---

## 6. Exemplo Prático Completo

Suponha um projeto de inferência ML com TensorFlow e AMD GPUs:

```yaml
version: "3.8"  # funciona desde Compose V2.0+
services:
  inferencia:
    image: rocm/tensorflow:latest
    runtime: "amd"
    environment:
      - AMD_VISIBLE_DEVICES=all
    volumes:
      - ./modelos:/mnt/modelos
    command: python app.py --model /mnt/modelos/meu_modelo

```

1. **Registre** o runtime `amd` no `/etc/docker/daemon.json` conforme a [documentação AMD Container Toolkit] ([instinct.docs.amd.com](https://instinct.docs.amd.com/projects/container-toolkit/en/latest/container-runtime/docker-compose.html?utm_source=chatgpt.com)).
2. **Execute** com `docker compose up inferencia`.
3. O contêiner iniciará usando o runtime AMD, habilitando acesso GPU.

---

## 7. Sugestões para Aprofundamento

- **Compose Specification Completa** (GitHub): detalhes de todos os atributos ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/main/spec.md)).
- **Alternative Runtimes no Docker Engine**: guia oficial de configuração de shims ([docs.docker.com](https://docs.docker.com/engine/daemon/alternative-runtimes/?utm_source=chatgpt.com)).
- **GPU Support How-to**: tutoriais de acesso a GPUs em Compose ([docs.docker.com](https://docs.docker.com/compose/how-tos/gpu-support/?utm_source=chatgpt.com)).
- **Migração para Compose V2**: quando e como atualizar projetos antigos ([docs.docker.com](https://docs.docker.com/compose/releases/migrate/?utm_source=chatgpt.com)).

---

**Espero que esta explicação tenha esclarecido em profundidade o uso do atributo `runtime` nos serviços do Docker Compose!**