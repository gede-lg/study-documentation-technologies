# sysctls

**Título da Explicação:** Entendendo o atributo `sysctls` no Docker Compose

---

## Introdução

O Docker Compose é uma ferramenta que permite definir e executar aplicações multicontainer a partir de um arquivo YAML. Dentro da seção `services`, o atributo `sysctls` possibilita ajustar parâmetros de kernel (sysctl) específicos para cada container, sem afetar o sistema host ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

Em Linux, a interface **sysctl** permite modificar parâmetros do kernel em tempo de execução, consultáveis em `/proc/sys/` ([docs.okd.io](https://docs.okd.io/4.11/nodes/containers/nodes-containers-sysctls.html?utm_source=chatgpt.com)).

Containers Docker compartilham o mesmo kernel do host, mas permitem namespace de sysctls isolados; ou seja, só é possível alterar parâmetros que não afetem globalmente o sistema ([medium.com](https://medium.com/mercedes-benz-techinnovation-blog/tuning-network-sysctls-in-docker-and-kubernetes-766e05da4ff2?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

No contexto do Compose, `sysctls` traduz essa capacidade para o nível de definição de serviço, permitindo configurar limites de rede, memória e outros subsistemas do kernel para cada container ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sintaxe Detalhada e Uso Prático

O atributo `sysctls` admite dois formatos no Compose:

1. **Mapa (map)**
    
    Cada chave é o nome do parâmetro e o valor, seu valor (numérico ou string):
    
    ```yaml
    services:
      app:
        image: minha-aplicacao:latest
        sysctls:
          net.core.somaxconn: "1024"       # Máximo de conexões pendentes na fila
          net.ipv4.tcp_syncookies: "0"     # Desabilita cookies TCP
    
    ```
    
    ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
    
2. **Array**
    
    Cada elemento é uma string `parametro=valor`:
    
    ```yaml
    services:
      app:
        image: minha-aplicacao:latest
        sysctls:
          - net.core.somaxconn=1024        # mesma função que acima
          - net.ipv4.tcp_syncookies=0
    
    ```
    
    ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
    

> Observação: Em versões do Docker Engine ≥ 19.03.0, o suporte a sysctls em Compose foi oficialmente introduzido, estendendo o comportamento nativo do flag --sysctl do docker run (gist.github.com, medium.com).
> 

---

## Cenários de Restrição ou Não Aplicação

- **Só namespaced:** Apenas sysctls namespaced são suportados. Parâmetros que afetam o host são rejeitados, garantindo isolamento e segurança do sistema ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Plataforma Linux:** Em hosts Windows/Linux (via WSL2), nem todos os parâmetros podem estar disponíveis ou serem aplicáveis.
- **Networking host:** Ao usar `network_mode: host`, algumas sysctls de rede podem não ter efeito, pois o container compartilha interfaces do host ([discuss.hashicorp.com](https://discuss.hashicorp.com/t/how-to-set-kernel-parameters-using-sysctl-for-a-hashicorp-nomad-job/44896?utm_source=chatgpt.com)).

---

## Componentes Chave Associados

- **Docker CLI**
    
    O comando equivalente é `docker run --sysctl <param>=<valor>` para containers avulsos ([medium.com](https://medium.com/mercedes-benz-techinnovation-blog/tuning-network-sysctls-in-docker-and-kubernetes-766e05da4ff2?utm_source=chatgpt.com)).
    
- **Compose Specification**
    
    Implementado em Compose V2 (CLI ≥ 1.27.0), o atributo `sysctls` faz parte das opções de configuração de serviços ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **Kernel parameters**
    
    Parâmetros devem constar na lista de sysctls namespaced do kernel; consulte a documentação oficial do kernel para ver a lista completa ([docs.okd.io](https://docs.okd.io/4.11/nodes/containers/nodes-containers-sysctls.html?utm_source=chatgpt.com)).
    

---

## Melhores Práticas e Padrões de Uso

- **Prefira o formato mapa:** Melhora legibilidade e permite comentários claros para cada parâmetro ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Agrupe por subsistema:** Mantenha sysctls de rede juntos e, se necessário, separe os de memória ou I/O em blocos distintos.
- **Documente valores:** Explique no comentário o motivo de cada ajuste (ex.: otimização de conexões, ajustes de tempo de espera).
- **Valide suporte:** Antes de aplicar, verifique se o parâmetro é namespaced e suportado pela versão do kernel e do Docker Engine.

---

## Exemplo Prático Completo

```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    ports:
      - "80:80"
    sysctls:
      # Aumenta fila de conexões pendentes para alto tráfego
      net.core.somaxconn: "4096"
      # Reduz tempo de espera FIN para liberar sockets mais rápido
      net.ipv4.tcp_fin_timeout: "30"
      # Ajuste de mapeamento de memória para aplicações Java
      vm.max_map_count: "262144"
    deploy:
      resources:
        limits:
          memory: 512M

```

Neste cenário, otimizamos o container Nginx para alto tráfego e preparamos o host para aplicações que exigem grande quantidade de mapeamento de memória.

---

## Sugestões para Aprofundamento

- **Compose Specification**: [https://github.com/compose-spec/compose-spec](https://github.com/compose-spec/compose-spec)
- **Documentação oficial do Docker Engine sobre `sysctl`**
- **Kernel Documentation**: arquivos em `/proc/sys/` e `/usr/src/linux/Documentation/sysctl/`
- **Ferramentas de monitoramento**: use `docker stats` e `sysctl -a` via container privilegiado para validar impactos.
- **Artigos e blogs**: explore ajustes de desempenho de rede e memória em ambientes de produção Docker/Kubernetes.

---

Espero que esta explicação detalhada o ajude a compreender e aplicar o atributo `sysctls` no seu workflow com Docker Compose!