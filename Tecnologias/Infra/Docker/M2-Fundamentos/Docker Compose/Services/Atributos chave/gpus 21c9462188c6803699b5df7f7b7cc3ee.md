# gpus

**Entendendo o atributo `gpus` na chave `services` do Docker Compose**

---

## Introdução

O Docker Compose, a partir da versão 2.30.0, passou a oferecer o atributo `gpus` dentro de cada serviço, permitindo reservar dispositivos de GPU de forma simplificada no arquivo de definição de serviços. Esse recurso é equivalente a um *device request* com a capacidade implícita de GPU, mapeando diretamente para a flag `--gpus` do comando `docker run` ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **O que é o atributo `gpus`:**
    
    Um atalho para definir solicitações de dispositivos de GPU diretamente no nível do serviço, sem precisar usar a seção `deploy.resources.reservations.devices`. Internamente, corresponde ao esquema de *device requests* do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **Por que usar `gpus`:**
    
    Facilita o uso de aceleradores de GPU em workloads de IA/ML, processamento de vídeo, etc., reduzindo a verbosidade do Compose e mantendo a portabilidade entre ambientes de desenvolvimento e produção. Além disso, acaba integrando-se naturalmente ao ecossistema NVIDIA Container Toolkit quando presente ([docs.docker.com](https://docs.docker.com/compose/gpu-support/)).
    

---

## Sintaxe Detalhada e Uso Prático

Existem duas formas de especificar GPUs:

1. **Long Syntax (lista de objetos)**
    
    ```yaml
    services:
      model:
        image: minhapp-gpu:latest
        command: nvidia-smi
        gpus:
          - driver: nvidia      # Nome do driver (ex: 'nvidia')
            count: 2            # Número de GPUs a reservar
    
    ```
    
    - **driver:** Identifica o driver do host (ex: `nvidia`).
    - **count:** Quantidade de GPUs; pode ser inteiro ou `all`.
2. **String simplificada**
    
    ```yaml
    services:
      model:
        image: minhapp-gpu:latest
        command: nvidia-smi
        gpus: all               # Reserva todas as GPUs disponíveis
    
    ```
    
    Essa forma é equivalente a `count: all` na sintaxe longa ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    

---

## Cenários de Restrição ou Não Aplicação

- **Versão mínima do Docker Compose:** Requer *Compose* ≥ **2.30.0**; em versões anteriores, não há suporte ao atributo `gpus` e será rejeitado ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Ambientes sem GPUs:** Em hosts sem GPU ou sem drivers instalados, a definição fará com que o serviço falhe ao iniciar.
- **Swarm Mode:** Para stacks em *Swarm*, prefira usar a seção `deploy.resources.reservations.devices`, pois o atributo `gpus` aplica-se apenas a containers gerenciados pelo Compose em modo standalone ([docs.docker.com](https://docs.docker.com/compose/gpu-support/)).

---

## Componentes Chave Associados

- **`driver`**
    
    Define o driver do dispositivo GPU no host. Ex.: `nvidia`, `3dfx` ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **`count`**
    
    Número de GPUs a reservar. Pode ser um inteiro ou `all` para indicar todas as GPUs disponíveis.
    
- **Solicitação Implícita de Capacidade `gpu`**
    
    O Compose injeta o capability `gpu` automaticamente, sem necessidade de declará-lo.
    
- ***Under the hood***
    
    Mapeia para a mesma lógica de *device requests* na especificação de deploy, mas de forma mais direta.
    

---

## Melhores Práticas e Padrões de Uso

- **Especifique sempre `gpus` ou `deploy.resources`**, nunca ambos para o mesmo fim.
- **Use `gpus: all`** em ambientes de desenvolvimento onde a quantidade não importa, e **`count`** em produção, para controlar o consumo.
- **Verifique drivers e toolkit** (ex.: NVIDIA Container Toolkit) instalados no host para evitar erros de deployment.
- **Monitore a alocação de GPUs** via `nvidia-smi` para confirmar se as reservas estão sendo atendidas.

---

## Exemplo Prático Completo

```yaml
version: "3.9"

services:
  training:
    image: tensorflow/tensorflow:latest-gpu
    command: >
      bash -c "python train.py --epochs 10"
    gpus:
      - driver: nvidia
        count: 2
    volumes:
      - ./data:/app/data
    environment:
      - NVIDIA_VISIBLE_DEVICES=all

```

1. **Pull da imagem:**
    
    ```bash
    $ docker compose pull
    
    ```
    
2. **Execução com GPUs:**
    
    ```bash
    $ docker compose up --build
    
    ```
    
3. **Validação:**
    
    Dentro do container, `nvidia-smi` deve listar 2 GPUs alocadas.
    

---

## Sugestões para Aprofundamento

- **Compose Deploy Specification** (discussão de device requests):
    
    [https://docs.docker.com/compose/compose-file/deploy/](https://docs.docker.com/compose/compose-file/deploy/) ([docs.docker.com](https://docs.docker.com/compose/gpu-support/))
    
- **How-to: Enable GPU support** (detalhes de pré-requisitos e opções avançadas):
    
    [https://docs.docker.com/compose/how-tos/gpu-support/](https://docs.docker.com/compose/how-tos/gpu-support/) ([docs.docker.com](https://docs.docker.com/compose/gpu-support/))
    
- **NVIDIA Container Toolkit** (instalação e configuração no host):
    
    [https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)
    

---

Com essa visão, você tem uma compreensão completa do atributo `gpus` no Docker Compose, desde sua teoria até a aplicação prática em projetos que demandam aceleradores de GPU.