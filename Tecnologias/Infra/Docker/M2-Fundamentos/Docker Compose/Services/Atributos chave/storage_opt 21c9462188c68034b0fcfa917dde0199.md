# storage_opt

**Título da Explicação:** Atributo `storage_opt` em serviços do Docker Compose

---

## Introdução

O Docker Compose oferece uma forma declarativa de orquestrar múltiplos contêineres Docker como parte de uma aplicação. Dentro do bloco `services`, o atributo `storage_opt` permite configurar opções específicas do driver de armazenamento, controlando aspectos como limite de espaço da camada de gravação (writable layer) de cada contêiner. ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/), [docs.docker.com](https://docs.docker.com/engine/storage/?utm_source=chatgpt.com))

## Sumário

- Conceitos Fundamentais
- Sintaxe Detalhada e Uso Prático
- Cenários de Restrição ou Não Aplicação
- Componentes-Chave Associados
- Melhores Práticas e Padrões de Uso
- Exemplo Prático Completo
- Sugestões para Aprofundamento

---

## Conceitos Fundamentais

Cada contêiner Docker é construído sobre camadas de imagem somente leitura, acrescidas de uma *camada de gravação* onde todas as alterações são persistidas. Esse conjunto é gerido por um *driver de armazenamento* (storage driver), como `overlay2`, `devicemapper`, `btrfs` ou `zfs`, responsável por unir camadas e aplicar quotas quando suportado ([docs.docker.com](https://docs.docker.com/engine/storage/?utm_source=chatgpt.com)).

O `storage_opt` é o mecanismo via Compose para repassar diretamente ao daemon Docker as opções de configuração desse driver, como definir limites de tamanho ou parâmetros específicos de desempenho e provisionamento ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/)).

---

## Sintaxe Detalhada e Uso Prático

O `storage_opt` deve ser declarado dentro de um serviço e funciona a partir do formato de arquivo Compose v2.1 ou superior. Veja um exemplo mínimo:

```yaml
version: "2.4"
services:
  meu_servico:
    image: ubuntu:20.04
    storage_opt:
      size: "1G"

```

- **version**: define o formato do Compose; `2.1+` habilita `storage_opt`.
- **meu_servico**: nome do serviço onde a opção será aplicada.
- **storage_opt**: mapa de pares chave–valor que serão equivalentes a usar `docker run --storage-opt key=value` ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/compose-file-v2/), [matsuand.github.io](https://matsuand.github.io/docs.docker.jp.onthefly/compose/compose-file/?utm_source=chatgpt.com)).

Opções comuns por driver:

- **overlay2**: suporta `size` quando o sistema de arquivos subjacente é XFS com `pquota` ([github.com](https://github.com/moby/moby/issues/46823?utm_source=chatgpt.com)).
- **devicemapper**: embora aceite `dm.basesize`, muitas vezes recomenda-se configurar essa opção diretamente no daemon Docker ([stackoverflow.com](https://stackoverflow.com/questions/41521832/using-docker-compose-with-storage-options-size?utm_source=chatgpt.com)).
- **btrfs/zfs**: possuem opções próprias de quota, mas menos usadas via Compose.

---

## Cenários de Restrição ou Não Aplicação

- **Versão do Compose**: `storage_opt` existe em Compose v2 (≥ 2.1); em v3 a documentação oficial ainda não documenta completamente seu comportamento e pode haver suporte limitado ([github.com](https://github.com/docker/cli/issues/1177?utm_source=chatgpt.com)).
- **Windows Containers**: no Windows, o Compose pode simplesmente ignorar `storage_opt` em contêineres Windows ([github.com](https://github.com/docker/compose/issues/11395?utm_source=chatgpt.com)).
- **Drivers sem suporte**: alguns drivers não oferecem controle de quotas (ex.: `aufs`, `overlay` sem overlay2) e descartam opções não reconhecidas.
- **File system**: para quotas em overlay2, é mandatório ter XFS com `pquota`; caso contrário, o Docker emite erro de opção não suportada ([github.com](https://github.com/moby/moby/issues/46823?utm_source=chatgpt.com)).

---

## Componentes-Chave Associados

- **`storage_opt`**: atributo de serviço que agrupa opções de driver.
- **`size`**: limite máximo de espaço da camada de gravação (ex.: `"1G"`, `"500M"`).
- **Chaves específicas**: qualquer par `key: value` suportado pelo driver (por exemplo, `dm.basesize` para devicemapper).
- **`version`**: deve ser definido como `2.1` ou superior para habilitar `storage_opt`.
- **Alternativa com volumes**: para volumes nomeados, usa-se `driver_opts` no bloco `volumes`, porém isso atua no volume, não no writable layer do contêiner ([stackoverflow.com](https://stackoverflow.com/questions/66172226/how-do-i-set-the-storage-options-in-docker-compose-v3?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

- Defina quotas com base em métricas reais de uso de disco.
- Combine limitações de disco (`storage_opt`) com limites de memória (`mem_limit`) e CPU (`cpus`) para isolamento completo de recursos.
- Teste sempre em homologação antes de promover em produção, especialmente para overlay2 em XFS.
- Documente a versão do Compose no repositório para evitar ambiguidades de compatibilidade.
- Se necessário, utilize volumes dedicados com controle de espaço no nível do host (LVM, partições isoladas) como fallback.

---

## Exemplo Prático Completo

```yaml
version: "2.4"
services:
  app:
    image: my-app:latest
    ports:
      - "8080:80"
    storage_opt:
      size: "2G"       # Limita o writable layer a 2 GB
      performance: "low"  # Exemplo genérico para driver customizado
    mem_limit: "512m"
    cpus: "1.0"
    environment:
      - NODE_ENV=production

networks:
  default:
    driver: bridge

```

Neste arquivo:

- O serviço `app` só poderá gravar até 2 GB na camada de escrita.
- Ainda há limitação de memória e CPU, consolidando isolamento de recursos.

---

## Sugestões para Aprofundamento

- **Compose file v2 reference**: consulte a seção de serviços para `storage_opt`.
- **Docker Engine Storage Drivers**: documentação sobre `overlay2`, `devicemapper`, `btrfs`, `zfs`.
- **Compose Specification**: padrão unificado da especificação (GitHub: compose-spec).
- **Tutoriais de quotas no Linux**: operação de XFS com `pquota` e configuração de LVM para volumes.

Com essas informações, você terá uma visão completa de como usar `storage_opt` para gerenciar eficientemente o espaço em disco dos seus contêineres via Docker Compose.