# driver_opts

**driver_opts em Docker Compose: explicação detalhada**

---

## 1. Introdução

No Docker Compose, volumes nomeados oferecem persistência de dados além do ciclo de vida dos containers. O atributo `driver_opts` permite personalizar o comportamento do driver de volumes, passando opções específicas ao mecanismo de armazenamento subjacente. Esta capacidade é fundamental para cenários avançados de storage, como montar NFS, bind mounts com parâmetros específicos ou uso de sistemas de arquivos em memória (tmpfs).

---

## 2. Sumário

1. **Conceitos Fundamentais**
2. **Sintaxe Detalhada e Uso Prático**
3. **Cenários de Restrição ou Não Aplicação**
4. **Componentes Chave Associados**
5. **Melhores Práticas e Padrões de Uso**
6. **Exemplo Prático Completo**
7. **Sugestões para Aprofundamento**

---

## 3. Conceitos Fundamentais

- **Vol­umes no Compose:** abstração de armazenamento persistente que independe do container e pode ser compartilhada entre serviços.
- **Driver de Volume:** componente responsável por criar e gerenciar volumes (por exemplo, o driver `local`, `nfs`, `flocker`, etc.).
- **`driver_opts`:** lista de opções (pares chave-valor) passadas diretamente ao driver para customizar sua criação ou montagem; cada opção é *driver-dependent*. ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com))

---

## 4. Sintaxe Detalhada e Uso Prático

### 4.1. Definição no Compose

```yaml
version: "3.8"
services:
  app:
    image: nginx:latest
    volumes:
      - dados:/usr/share/nginx/html

volumes:
  dados:
    driver: local
    driver_opts:
      type: "nfs"
      o: "addr=10.0.0.1,nolock,soft,rw"
      device: ":/export/html"

```

- **`driver: local`**: especifica o driver (padrão).
- **`driver_opts`**: lista de opções para o driver `local`, neste caso, montando um recurso NFS. ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com))
- **`type`**: tipo de sistema de arquivos (e.g., `nfs`, `tmpfs`, `none`).
- **`device`**: dispositivo ou caminho de origem a ser montado (e.g., endereço NFS ou diretório de bind).
- **`o`**: opções de montagem no formato de string (`addr=...,rw,bind`, etc). ([stackoverflow.com](https://stackoverflow.com/questions/74079078/what-is-the-meaning-of-the-type-o-device-flags-in-driver-opts-in-the-docker-comp?utm_source=chatgpt.com))

### 4.2. Equivalência com CLI

O mesmo efeito é obtido via `docker volume create`:

```bash
docker volume create \
  --driver local \
  --opt type=nfs \
  --opt o=addr=10.0.0.1,nolock,soft,rw \
  --opt device=:/export/html \
  dados

```

Isso reforça que `driver_opts` espelha as flags `--opt` do comando `docker volume create`. ([stackoverflow.com](https://stackoverflow.com/questions/74079078/what-is-the-meaning-of-the-type-o-device-flags-in-driver-opts-in-the-docker-comp?utm_source=chatgpt.com))

---

## 5. Cenários de Restrição ou Não Aplicação

- **Bind Mounts Simples:** cenários onde basta mapear um diretório do host (e.g., `./app:/app`), não exigindo `driver_opts`.
- **Volumes Externos:** se `external: true`, o Compose não tenta criar o volume, ignorando `driver_opts`.
- **Drivers Não Suportados:** nem todos os drivers suportam todas as chaves; consultar a documentação do driver (e.g., `man mount.nfs`, `man mount.tmpfs`). ([stackoverflow.com](https://stackoverflow.com/questions/74079078/what-is-the-meaning-of-the-type-o-device-flags-in-driver-opts-in-the-docker-comp?utm_source=chatgpt.com))
- **Portabilidade Limitada:** opções específicas de `driver_opts` podem prejudicar a portabilidade do Compose entre ambientes com drivers diferentes.

---

## 6. Componentes Chave Associados

| Componente | Descrição |
| --- | --- |
| `driver` | Nome do driver de volume (e.g., `local`, `nfs`, `flocker`). |
| `driver_opts` | Pares chave-valor para customizar o driver. |
| `type` | Tipo de sistema de arquivos (localmente `none`, `tmpfs`, `nfs`, etc). |
| `device` | Caminho ou recurso de origem (diretório host, endereço remoto). |
| `o` | Opções de montagem (opções padrão de `mount(8)` para o driver em questão). |
| `external` | Se `true`, volume é pré-existente e gerenciado fora do Compose. |
| `labels` | Metadados associados ao volume (útil para integração com orquestradores externos). |

---

## 7. Melhores Práticas e Padrões de Uso

1. **Use `driver_opts` apenas quando necessário:** para bind mounts simples ou tmpfs sem requisitos especiais, prefira as formas curtas de volume ou bind mounts.
2. **Mantenha portabilidade:** evite opções muito específicas que só funcionem em um ambiente.
3. **Documente o Compose:** sempre comente o propósito de cada `driver_opts`, especialmente em equipes.
4. **Teste localmente:** valide o comportamento de montagem antes de usar em produção.
5. **Gerencie permissões:** ao usar `o=bind`, confirme que UID/GID host estão corretos para evitar erros de permissão. ([forums.docker.com](https://forums.docker.com/t/create-local-volume-with-custom-mount-options/117924?utm_source=chatgpt.com))

---

## 8. Exemplo Prático Completo

Um cenário comum: compartilhar um diretório do host em múltiplos containers com UID customizado:

```yaml
version: "3.8"
services:
  web:
    image: nginx:latest
    volumes:
      - shared-data:/data

  worker:
    image: alpine:latest
    command: ["sh", "-c", "ls -l /data"]
    volumes:
      - shared-data:/data

volumes:
  shared-data:
    driver: local
    driver_opts:
      type: "none"
      device: "/home/user/app/data"
      o: "bind,uid=1000,gid=1000"

```

1. **Top-level `volumes`** define o volume `shared-data` com bind mount para `/home/user/app/data`.
2. **`o: "bind,uid=1000,gid=1000"`** garante permissões apropriadas.
3. **Serviços** `web` e `worker` compartilham o mesmo volume, mantendo os dados sincronizados.

---

## 9. Sugestões para Aprofundamento

- **Documentação Oficial de Volumes:** [https://docs.docker.com/compose/compose-file/volumes/](https://docs.docker.com/compose/compose-file/volumes/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/volumes/?utm_source=chatgpt.com))
- **Manpages de Sistemas de Arquivos:** `man mount`, `man mount.nfs`, `man mount.tmpfs`.
- **Artigos de Blog e Comunidade:** discussões no StackOverflow e fóruns Docker para casos de uso avançado.
- **Compose Specification no GitHub:** para entender a fundo o comportamento de cada chave.

---

*Com esta explicação, você possui a base teórica, sintática e prática para utilizar o atributo `driver_opts` em Docker Compose de forma avançada e segura.*