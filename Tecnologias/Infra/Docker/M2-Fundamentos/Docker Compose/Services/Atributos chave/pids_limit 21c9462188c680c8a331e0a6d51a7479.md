# pids_limit

# Entendendo o Atributo `pids_limit` em Docker Compose

## Introdução

O Docker Compose permite orquestrar múltiplos contêineres definidos em um único arquivo YAML. Entre seus recursos, está o controle de recursos de sistema via cgroups, incluindo o número máximo de processos (PIDs) que cada contêiner pode criar. O atributo `pids_limit` surgiu para mitigar ataques de *fork bomb* e garantir maior estabilidade dos nós Docker.

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **O que é `pids_limit`?**
    
    Permite limitar o número de processos (PIDs) que um contêiner pode gerar, evitando que um único serviço esgote o namespace de PIDs do host por meio de *fork bombs* ou outras explosões de processos. ([stackoverflow.com](https://stackoverflow.com/questions/62650455/what-is-the-impact-without-pids-limit-parameter-in-docker-compose-version-3-x-x?utm_source=chatgpt.com))
    
- **Origem e requisitos**
    
    Introduzido no Compose file v2.1 (requere Docker Engine ≥ 1.12 e Docker Compose ≥ 1.12) para o formato de arquivo 2.x. ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com))
    
- **Controle via cgroups PIDs**
    
    Baseado no controlador `pids` do Linux cgroups, disponível a partir do kernel 4.3. ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/3sx-8aj-uca/?utm_source=chatgpt.com))
    

---

## Sintaxe Detalhada e Uso Prático

### 1. Formato v2.x (yaml top-level `pids_limit`)

```yaml
version: '2.2'
services:
  web:
    image: nginx:alpine
    pids_limit: 100    # Limita a 100 processos

```

- Declaração direta sob cada serviço. ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com))

### 2. Formato v3.x com Swarm/Compose Plugin

```yaml
version: '3.8'
services:
  web:
    image: nginx:alpine
    deploy:
      resources:
        limits:
          pids: 100    # Limita a 100 processos

```

- Mecanismo unificado para deploy em Swarm e Compose (CLI plugin). ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))

### 3. Flags de CLI (`docker run` / `docker update`)

- `docker run --pids-limit 100 …` ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/create/?utm_source=chatgpt.com))
- `docker update --pids-limit 100 <container>` ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/update/?utm_source=chatgpt.com))

### 4. Valor padrão

- Se não especificado, não há restrição (valor `0` ou `1` indica ilimitado). ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/3sx-8aj-uca/?utm_source=chatgpt.com))

---

## Cenários de Restrição ou Não Aplicação

- **Versões Compose 3.x sem Swarm**: o campo top-level `pids_limit` é ignorado; use `deploy.resources.limits.pids`. ([github.com](https://github.com/docker/compose/issues/4792?utm_source=chatgpt.com))
- **Sistemas não-Linux** (p.ex. Windows/macOS sem cgroups): suporte limitado ou inexistente.
- **Ambientes legados** com Compose < 1.12 ou Engine < 1.12: não suportam `pids_limit`.

---

## Componentes Chave Associados

1. **`deploy.resources.limits.pids`**
    
    Controle de PIDs em Swarm/Compose plugin. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
    
2. **CLI flags**
    - `-pids-limit` em `docker run` e `docker update` ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/create/?utm_source=chatgpt.com))
3. **API Engine**
    
    Parâmetro `HostConfig.PidsLimit` na chamada de criação de contêiner.
    
4. **Cgroup PIDs Controller**
    
    Subsystem do kernel que impõe o limite de processos. ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/3sx-8aj-uca/?utm_source=chatgpt.com))
    

---

## Melhores Práticas e Padrões de Uso

- **Defina limites realistas**: baseie-se na carga esperada de cada serviço.
- **Teste incrementalmente**: ajuste o valor até repassar casos de pico sem esgotar recursos.
- **Monitore**: use métricas de PIDs para detectar aproximação do limite.
- **Combine com outras restrições**: CPU, memória e *oom_kill_disable* para maior robustez.

---

## Exemplo Prático Completo

```yaml
version: '3.8'
services:
  api:
    image: my-api:latest
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
          pids: 200                # Limite de 200 PIDs
    environment:
      - NODE_ENV=production

  worker:
    image: my-worker:latest
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
          pids: 100                # Limite de 100 PIDs
    command: ["node", "worker.js"]

```

1. O serviço **api** fica restrito a 200 processos simultâneos.
2. O serviço **worker** fica restrito a 100 processos simultâneos.
3. Outros recursos (CPU e memória) também estão limitados.

---

## Sugestões para Aprofundamento

- Leia sobre [control groups (cgroups) no Linux](https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html).
- Consulte a [documentação oficial de Deploy](https://docs.docker.com/compose/compose-file/deploy/) para recursos avançados.
- Explore ferramentas de monitoramento de contêineres (cAdvisor, Prometheus) e configure alertas de PID.

---

**Fim da Explicação Detalhada**