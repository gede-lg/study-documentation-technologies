# ulimits

# Entendendo o Atributo `ulimits` no Docker Compose

## Introdução

No Docker Compose, o atributo `ulimits` é um elemento de configuração de serviço que permite sobrepor os limites de recursos do sistema (como número máximo de arquivos abertos ou processos) aplicados ao container, usando sintaxe análoga à flag `--ulimit` do Docker CLI ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O comando `ulimit` é um recurso builtin do shell Linux que permite visualizar ou limitar a quantidade de recursos do sistema que processos podem consumir, como número de arquivos abertos, tamanho de memória, número de processos, entre outros ([phoenixnap.com](https://phoenixnap.com/kb/ulimit-linux-command?utm_source=chatgpt.com)).

Ele distingue **soft limits** (limites que podem ser ajustados dentro do valor máximo definido) e **hard limits** (limites absolutos que apenas o root pode aumentar) ([linuxconfig.org](https://linuxconfig.org/limit-user-environment-with-ulimit-linux-command?utm_source=chatgpt.com)).

Em um ambiente Docker, esses limites podem ser herdados do daemon se não especificados, via a opção `--default-ulimit` do `dockerd` (por exemplo `--default-ulimit nofile=1024:4096`) ([docs.aws.amazon.com](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-ulimit.html?utm_source=chatgpt.com)).

---

## Sintaxe Detalhada e Uso Prático

No Compose, `ulimits` é especificado no nível de serviço, logo abaixo de outras configurações como `image` ou `environment`:

```yaml
services:
  meu_servico:
    image: exemplo/minha-imagem:latest
    ulimits:
      nproc: 65535               # único valor: soft=hard=65535
      nofile:                    # mapeamento soft/hard separados
        soft: 20000
        hard: 40000

```

- **Forma Inteira:** `ulimits: <tipo>: <valor>` define soft e hard com o mesmo número.
- **Forma Mapeada:** `soft` e `hard` permitem valores diferentes para limites suaves e rígidos. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

Se omitido, o container usa os limites padrão do daemon, configuráveis via `dockerd --default-ulimit` ([docs.aws.amazon.com](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-ulimit.html?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Docker Swarm Mode:** Ao usar `docker stack deploy`, o Compose *ignora* opções de `ulimits` e exibe warning, pois não são suportadas em serviços de Swarm ([forums.docker.com](https://forums.docker.com/t/ulimits-not-set-with-docker-deploy-in-swarm-mode/33278?utm_source=chatgpt.com)).
- **Containers Windows:** Ulimits aplicam-se apenas a runtimes Linux, não tendo efeito em containers Windows.
- **Ambientes sem CAP_SYS_RESOURCE:** Se o usuário não tiver permissão de aumentar limites (sem capacidade `CAP_SYS_RESOURCE`), certos hard limits podem falhar.

---

## Componentes Chave Associados

O mapeamento `ulimits` no Compose reflete diferentes *tipos* de recursos limitáveis. Cada chave representa um tipo de limite:

- **`nofile`**: número máximo de descritores de arquivo
- **`nproc`**: número máximo de processos/threads
- **`memlock`**: quantidade de memória bloqueável
- **`core`**, **`cpu`**, **`data`**, **`fsize`**, **`locks`**, **`msgqueue`**, **`nice`**, **`rss`**, **`rtprio`**, **`rttime`**, **`sigpending`**, **`stack`**

Lista completa de tipos suportados:

`core | cpu | data | fsize | locks | memlock | msgqueue | nice | nofile | nproc | rss | rtprio | rttime | sigpending | stack` ([docs.aws.amazon.com](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ecs-taskdefinition-ulimit.html?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

- **Evite configurações desnecessárias:** use o comportamento padrão sempre que possível.
- **Alinhe soft/hard:** definir ambos iguais evita confusões de herança de limites.
- **Teste localmente:** valide em desenvolvimento antes de aplicar em produção.
- **Valores razoáveis:** evite números muito altos que possam sobrecarregar o host.
- **Ajustes pontuais:** manualmente apenas em cenários de tuning avançado e carga pesada ([docs.docker.com](https://docs.docker.com/build/bake/reference/?utm_source=chatgpt.com)).

---

## Exemplo Prático Completo

A seguir, um Compose minimalista para um nó de Elasticsearch, garantindo *memlock* ilimitado e alta contagem de arquivos abertos:

```yaml
version: "3.8"
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: "2G"

```

Neste cenário, o Elasticsearch pode bloquear memória (*memory_lock*) e abrir até 65.536 arquivos simultâneos, evitando erros de “Too many open files” ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sugestões para Aprofundamento

- Documentação oficial da [Compose Specification](https://github.com/compose-spec/compose-spec).
- Manual do Linux para `ulimit` (ex.: `man ulimit`).
- “How to Use the ulimit Linux Command” (PhoenixNAP) ([phoenixnap.com](https://phoenixnap.com/kb/ulimit-linux-command?utm_source=chatgpt.com)).
- Artigo “Ulimits Usage: why and how to set them” (Lucidworks).