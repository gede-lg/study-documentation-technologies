# healthcheck

# Atributo `healthcheck` no Docker Compose: Definição e Uso Completo

## Introdução

Em ambientes de containers orquestrados com Docker Compose, garantir que seus serviços não apenas estejam “Up”, mas realmente **prontos** é essencial. O atributo `healthcheck` permite ao Compose rodar comandos periódicos dentro do container para validar se a aplicação está operacional, evitando falhas silenciosas e problemas de dependência entre serviços ([last9.io](https://last9.io/blog/docker-compose-health-checks/?utm_source=chatgpt.com)).

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O atributo `healthcheck` declara um conjunto de verificações (checks) que são executadas dentro do container para determinar seu estado de saúde ("healthy" vs. "unhealthy"). Funciona da mesma forma, e com os mesmos valores padrão, que a instrução `HEALTHCHECK` no Dockerfile, mas permite sobrescrever qualquer configuração herdada da imagem ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

Ele oferece:

- **Liveness Probe**: detecta containers “travados” (processo vivo, mas sem capacidade de atender).
- **Readiness Probe**: sinaliza quando um serviço está apto a receber tráfego ou atender dependentes.

---

## Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    image: minha-imagem:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]      # Comando em lista (exec form)
      # Alternativamente: test: curl -f http://localhost || exit 1  # string → CMD-SHELL
      interval: 1m30s                                       # Frequência entre execuções (default 30s)
      timeout: 10s                                          # Tempo máximo de execução (default 30s)
      retries: 3                                            # Falhas consecutivas para 'unhealthy' (default 3)
      start_period: 40s                                     # Janela inicial isenta de falhas (default 0s)
      start_interval: 5s                                    # Intervalo durante start_period (default 5s)
      disable: false                                        # Desabilita o check (override)

```

Os atributos acima e suas descrições podem ser conferidos na documentação oficial do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

### Formas de `test`

- **Lista** (recomendada para clareza):
    
    ```yaml
    test: ["CMD", "pg_isready", "-U", "user", "-d", "db"]
    
    ```
    
- **String** (shell form):
    
    ```yaml
    test: pg_isready -U user -d db || exit 1
    
    ```
    
- **Especial**:
    - `["NONE"]` ou `disable: true` → desativa o healthcheck herdado da imagem.

---

## Cenários de Restrição ou Não Aplicação

- **Containers *one-off* ou batch**: usam-se apenas para tarefas pontuais, sem necessidade de monitoramento contínuo.
- **Imagens minimalistas**: sem ferramentas de verificação (ex.: `curl`, `pg_isready`) e não é viável instalá-las.
- **Ambientes de desenvolvimento rápidos**: ciclo de build/test pode ficar mais lento com healthchecks frequentes.
- **Checks com efeitos colaterais**: quando o comando de verificação pode alterar o estado do container ([warp.dev](https://www.warp.dev/terminus/docker-compose-health-check?utm_source=chatgpt.com)).

---

## Componentes Chave Associados

- **Dockerfile `HEALTHCHECK`**: define defaults que o Compose herda e pode sobrescrever ([docs.docker.com](https://docs.docker.com/reference/dockerfile/)).
- **`depends_on` com condição `service_healthy`**: para orquestrar a ordem de inicialização com base no healthcheck:
    
    ```yaml
    depends_on:
      db:
        condition: service_healthy
    ``` :contentReference[oaicite:5]{index=5}.
    
    ```
    
- **Políticas de reinício** (`restart: on-failure` / `unless-stopped`): reiniciam containers marcados como `unhealthy`.
- **Monitoramento**: `docker compose ps` exibe a coluna `Health` com status de cada serviço.

---

## Melhores Práticas e Padrões de Uso

1. **Minimalismo no comando**: use verificações rápidas e determinísticas.
2. **Ajuste de intervalos**: intervalos curtos demais podem sobrecarregar; longos, atrasam detecção.
3. **Uso de `start_period`**: essencial para aplicações que demoram a inicializar.
4. **Scripts dedicados**: mantenha lógica de healthcheck em scripts versionados.
5. **Combine com `depends_on: service_healthy`**: garante que dependentes só iniciem após estado saudável.
6. **Desabilitar quando necessário**: `disable: true` para desativar checks inapropriados.

---

## Exemplo Prático Completo

```yaml
version: '3.9'
services:
  db:
    image: postgres:13
    environment:
      POSTGRES_USER: example
      POSTGRES_DB: exampledb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build: .
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "80:80"
    healthcheck:
      test: curl -f http://localhost/ || exit 1
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

```

Neste cenário, o serviço `web` só é iniciado depois que o `db` estiver saudável, evitando erros de conexão.

---

## Sugestões para Aprofundamento

- [**Compose Specification**](https://docs.docker.com/reference/compose-file/): explore todos os atributos suportados.
- [**Dockerfile `HEALTHCHECK`**](https://docs.docker.com/reference/dockerfile/#healthcheck): aprofunde-se nas opções e defaults.
- **Orquestração Avançada**: readiness/liveness probes em Kubernetes.
- **Integração com Observabilidade**: conecte healthchecks a Prometheus, Grafana ou Last9 para alertas automatizados.