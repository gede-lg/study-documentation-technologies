# use_api_socket

**Título da Explicação:** Entendendo o atributo `use_api_socket` em serviços do Docker Compose

---

## Introdução

O atributo `use_api_socket` é uma extensão client-side do Docker Compose que permite expor o socket da API do Docker e as credenciais de autenticação dentro de containers, facilitando cenários de “Docker-in-Docker” sem necessidade de imagens especiais ou configurações manuais de volumes e variáveis de ambiente ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)). Introduzido na versão 2.37.2 do Docker Compose, ele simplifica a montagem do socket `/var/run/docker.sock` e a injeção do arquivo de configuração do Docker CLI diretamente no serviço ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **O que é a API Socket do Docker:** trata-se do socket Unix `/var/run/docker.sock` usado pelo Docker Engine para receber comandos API.
- **Por que montá-lo dentro do container:** permite que o container execute comandos `docker` diretamente contra o host, habilitando automação de build, deploy ou gerenciamento de containers a partir de dentro de um serviço.
- **Por que um atributo no Compose:** antes, era necessário definir manualmente `volumes` e variáveis de ambiente; com `use_api_socket`, o Compose faz isso automaticamente, reduzindo boilerplate e o risco de erro de configuração ([github.com](https://github.com/docker/compose/releases)).

---

## 2. Sintaxe Detalhada e Uso Prático

No seu `docker-compose.yml`, basta adicionar `use_api_socket: true` sob o serviço desejado:

```yaml
version: "3.9"
services:
  builder:
    image: docker:stable           # Imagem que inclui o CLI do Docker
    use_api_socket: true           # Habilita montagem automática do socket e config
    command: ["docker", "build", "."]
    # -- o Compose automaticamente adiciona:
    # 1) volume bind /var/run/docker.sock
    # 2) config com credenciais em /run/secrets/docker/config.json
    # 3) env var DOCKER_CONFIG=/run/secrets/docker

```

Sob o capô, o Compose:

1. Verifica se há **ao menos um** serviço com `use_api_socket: true`;
2. Lê as credenciais do `~/.docker/config.json` do host e cria um objeto `Config` interno (`#apisocket`);
3. Para cada serviço afetado:
    - Adiciona um **bind mount** do socket:
        
        ```go
        service.Volumes = append(service.Volumes, ServiceVolumeConfig{
          Type:   "bind",
          Source: "/var/run/docker.sock",
          Target: "/var/run/docker.sock",
        })
        
        ```
        
    - Define `DOCKER_CONFIG=/run/secrets/docker` caso não exista;
    - Monta o config gerado em `/run/secrets/docker/config.json` ([raw.githubusercontent.com](https://raw.githubusercontent.com/docker/compose/main/pkg/compose/apiSocket.go)).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Windows Docker Engine:** `use_api_socket` falha com erro, pois não há socket Unix ([raw.githubusercontent.com](https://raw.githubusercontent.com/docker/compose/main/pkg/compose/apiSocket.go)).
- **Serviços não confiáveis:** expor o socket concede privilégios totais ao host; evite em ambientes multi-tenant ou produção sem isolamento extra.
- **Alternativa manual:** se você precisar de controle fino sobre caminhos, variáveis ou nomes de configs, ainda pode usar `volumes` e `configs` explicitamente.

---

## 4. Componentes Chave Associados

- **`use_api_socket` (boolean):** chave do serviço que ativa todo o comportamento;
- **Volumes automáticos:** monta `/var/run/docker.sock` dentro do container;
- **Config `#apisocket`:** objeto temporário contendo o conteúdo de `config.json` do host;
- **Env var `DOCKER_CONFIG`:** aponta para `/run/secrets/docker`, de onde o CLI carrega as credenciais;
- **Implementação client-side:** não há suporte nativo do Engine (temporalmente até evolução futura) ([raw.githubusercontent.com](https://raw.githubusercontent.com/docker/compose/main/pkg/compose/apiSocket.go)).

---

## 5. Melhores Práticas e Padrões de Uso

- **Isolar apenas serviços necessários:** aplique `use_api_socket` só onde realmente for operacionalizar Docker via container.
- **Perfil Compose:** combine com `profiles:` para ativar em dev/test, mas não em prod.
- **Restrições de segurança:** use namespaces de usuário, AppArmor/SELinux, ou alternativas de socket proxy (como `docker-proxy`) para limitar operações.
- **Monitoramento e auditoria:** logue comandos que usam Docker API para rastreabilidade.

---

## 6. Exemplo Prático Completo

```yaml
version: "3.9"
services:
  app:
    image: alpine:latest
    command: ["sh", "-c", "echo 'Hello, World!'"]
  builder:
    image: docker:stable
    use_api_socket: true
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: ["sh", "-c", "docker build -t myapp ."]
    profiles:
      - build

```

1. `app` é um serviço normal.
2. `builder`, ativado apenas pelo profile `build`, terá:
    - Montagem de `/var/run/docker.sock`;
    - Credenciais em `/run/secrets/docker/config.json`;
    - `DOCKER_CONFIG` configurado.
        
        Para executá-lo:
        

```bash
docker compose --profile build up builder

```

---

## 7. Sugestões para Aprofundamento

- Documentação oficial de Compose File Reference ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- PR no Docker CLI experimental: docker/cli#5858
- Artigos sobre padrões “Docker-in-Docker” e segurança de exposição de socket
- Guia de melhores práticas de segurança no Docker Engine

> Nota: o uso de use_api_socket é uma conveniência poderosa, mas requer atenção ao modelo de segurança do seu ambiente.
>