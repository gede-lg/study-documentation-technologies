# devices

**Entendendo o atributo `devices` em serviços no Docker Compose**

---

## Introdução

No Docker Compose, cada serviço é um conjunto de containers configurados a partir de um arquivo YAML. O atributo `devices`, definido sob a chave `services`, permite mapear nós de dispositivo do host diretamente para dentro do contêiner, concedendo acesso a hardware como portas USB, GPUs ou outros dispositivos especiais ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O atributo `devices` serve para expor diretamente, dentro do contêiner, dispositivos presentes no host. Por trás dos panos, isso corresponde ao parâmetro `--device` do `docker run`, que informa ao runtime para adicionar nós de dispositivo ao cgroup do container, controlando permissão de leitura, escrita e mapeamento de nós ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

Sob o capô, o kernel Linux mantém um controlador de whitelist de dispositivos via cgroups, restringindo quais nós de `/dev` cada cgroup pode acessar. O Compose traduz o `devices:` para regras nesse controlador, sem necessidade de usar `--privileged` ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    image: alpine
    devices:
      - "/dev/ttyUSB0:/dev/ttyUSB0"        # mapeia host → container, permissões padrão
      - "/dev/sda:/dev/xvda:rwm"           # com cgroup permissions: read, write, mknod
      - "vendor.com/device=gpu"            # sintaxe CDI para dispositivos dinâmicos

```

- **Formato geral:** `HOST_PATH:CONTAINER_PATH[:CGROUP_PERMISSIONS]` ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **Permissões (`CGROUP_PERMISSIONS`):** combinação de `r` (read), `w` (write) e `m` (mknod)
- **Sin­taxe CDI:** permite referenciar dispositivos via Container Device Interface (CDI), um padrão que abstrai múltiplos nós ou operações adicionais necessárias para expor um dispositivo (ex.: GPUs) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [github.com](https://github.com/cncf-tags/container-device-interface))

Em Compose, `devices` pode ser:

- **Lista** (exemplo acima) ou
- **Valor único**, se houver somente um mapeamento.

---

## Cenários de Restrição ou Não Aplicação

- **Isolamento Windows:** o atributo `devices` só é suportado em containers process-isolated no Windows; em outras modalidades de isolamento falha ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/engine/reference/commandline/run/?utm_source=chatgpt.com)).
- **Ambientes sem cgroup:** sistemas que não usam cgroups (ex.: certos contêineres FreeBSD/jails) não suportam esse mapeamento.
- **Privileged vs. devices:** usar `privileged: true` expõe todos os dispositivos, mas elimina o controle granular de permissões; prefira `devices` para segurança refinada.
- **Dispositivos efêmeros:** para hot-plug de dispositivos (ex.: pendrives), `devices` não reage a conexões posteriores ao início do container; considere usar scripts de monitoramento.

---

## Componentes Chave Associados

- **device_cgroup_rules:** define regras avançadas de whitelist via strings no formato do kernel Linux ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **gpus:** atributo específico para GPUs, oferecendo contagem, driver e capacidades (substitui mapeios manuais via `devices` em muitos casos).
- **privileged:** concede acesso irrestrito a todos os dispositivos—cuidado com riscos de segurança.
- **security_opt / userns_mode:** em cenários com namespaces de usuário ou políticas SELinux, pode ser necessário ajustar essas opções para permitir mapeamento de dispositivos.
- **Container Device Interface (CDI):** especificação que padroniza a injeção de dispositivos complexos; Compose a suporta via sintaxe “vendor.com/device=nome” ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [github.com](https://github.com/cncf-tags/container-device-interface)).

---

## Melhores Práticas e Padrões de Uso

- **Minimize o escopo:** mapeie apenas os dispositivos necessários.
- **Use permissões mínimas:** prefira `r` ou `rw` em vez de `rwm`, a menos que mknod seja estritamente necessário.
- **Prefira CDI para hardware complexo:** para GPUs, NICs e FPGAs, usar CDI garante portabilidade e automatiza passos extra (compatibilidade, montagens).
- **Documente mapeamentos:** inclua comentários e referências ao equipamento no repositório.
- **Teste em ambientes de CI:** verifique se mapeamentos não falham em runners sem os dispositivos.
- **Considere `device_cgroup_rules` para regras avançadas:** quando precise de granularidade além de simples `devices`.

---

## Exemplo Prático Completo

```yaml
version: '3.8'
services:
  webcam-app:
    image: my-webcam-processor:latest
    devices:
      - "/dev/video0:/dev/video0:rwm"       # acesso à webcam principal
      - "/dev/video1:/dev/video1:rw"        # câmera secundária (apenas leitura)
    environment:
      - CAMERA_DEV=/dev/video0
    volumes:
      - ./app:/usr/src/app
    command: ["node", "index.js"]

```

Neste cenário, o contêiner `webcam-app` recebe acesso direto aos nós de vídeo do host, permitindo capturar frames usando bibliotecas que interagem com `/dev/video*`.

---

## Sugestões para Aprofundamento

- **Docker Compose – Compose File Reference** (atributos de serviços) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **Docker Engine CLI – `docker run`** (flag `-device`)
- **Spec. Container Device Interface (CDI)** ([github.com](https://github.com/cncf-tags/container-device-interface))
- **Kernel Docs – Control Groups Device Whitelist** (cgroup v1/v2)
- **NVIDIA Container Toolkit** (para GPUs sem mexer manualmente em `devices`)

---

Espero que essa explicação detalhada ajude você a compreender e utilizar o atributo `devices` no Docker Compose de forma segura e eficiente!