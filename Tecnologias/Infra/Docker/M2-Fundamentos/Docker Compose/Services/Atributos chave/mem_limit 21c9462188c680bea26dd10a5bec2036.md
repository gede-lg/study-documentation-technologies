# mem_limit

**Configuração do Atributo `mem_limit` em Docker Compose**

---

## Introdução

O Docker Compose permite definir aplicações multi-contêineres de forma declarativa, incluindo controle de recursos via atributos de configuração. Entre esses, o `mem_limit` especifica um limite rígido de memória para os contêineres de um serviço, evitando que um único serviço consuma toda a RAM do host e cause falhas do tipo **Out Of Memory** (OOM) no sistema operacional ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
    - Versão 2.x (`mem_limit`)
    - Versão 3.x (`deploy.resources.limits.memory`)
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Limite de Memória (Hard Limit):** determina a quantidade máxima de RAM que um contêiner pode usar. Se ultrapassado, o kernel do Linux encerra o processo para liberar memória, protegendo a estabilidade do host ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Unidades de Medida:** valores inteiros seguidos de sufixos (`b`, `k`, `m`, `g`) representam bytes, kilobytes, megabytes ou gigabytes, respectivamente ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Equivalência com Docker Run:** em Compose v2, `mem_limit` mapeia diretamente para a flag `-memory` do comando `docker run`, aplicando o mesmo comportamento de restrição de memória ([alexhyett.com](https://www.alexhyett.com/notes/setting-memory-limits-on-docker-containers/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Versão 2.x: `mem_limit`

Em arquivos Compose da versão 2.x, o atributo `mem_limit` é declarado diretamente sob o serviço:

```yaml
version: '2.4'

services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"
    mem_limit: 300m    # Limita uso de memória a 300 MiB

```

- **Obrigatoriedade de Versão:** disponível em `version: '2'` ou superior (até 2.4).
- **Mapeamento Interno:** resultará em `docker run -m 300m ...` para cada contêiner do serviço ([alexhyett.com](https://www.alexhyett.com/notes/setting-memory-limits-on-docker-containers/?utm_source=chatgpt.com)).

### Variações de Sintaxe

- **Unidades aceitas:** `k`, `m`, `g` (case-insensitive).
- **Valor inteiro obrigatório:** não aceita decimais (por exemplo, `2.4m` é inválido; use `2400k` em vez disso) ([bobcares.com](https://bobcares.com/blog/mem_limit-docker-compose/?utm_source=chatgpt.com)).

---

### 2.2 Versão 3.x: `deploy.resources.limits.memory`

A partir da versão 3.x (modo Swarm), o atributo `mem_limit` foi **removido** em favor de um bloco de recursos sob `deploy`:

```yaml
version: '3.8'

services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"
    deploy:
      resources:
        limits:
          memory: 300M      # Hard limit de 300 MiB
        reservations:
          memory: 100M      # Soft limit de 100 MiB

```

- **Necessário Swarm Mode:** para aplicar `deploy.resources.*` ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).
- **Hard vs Soft Limits:**
    - **limits.memory:** limite rígido de memória.
    - **reservations.memory:** reserva garantida (soft limit), usada em casos de contenda de recursos ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Compose versão >3.x em modo não-Swarm:** `deploy.resources` é ignorado; sem Swarm, não há enforcement de `limits.memory`.
- **Arquivos v3 sem `deploy`:** não suportam `mem_limit`; contêineres usarão memória ilimitada por padrão.
- **Hosts sem suporte a limitação de cgroup-memory:** kernels sem suporte a limites de memória podem ignorar `mem_limit` e expor contêineres ao OOM do host ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).

---

## 4. Componentes Chave Associados

- **`memswap_limit` (v2):** define o total de memória + swap permitidos; quando não configurado, o swap disponível é igual a `mem_limit`.
- **`mem_reservation` (v2):** soft limit equivalente a `-memory-reservation` no `docker run`.
- **`deploy.resources.reservations.memory` (v3):** soft limit em Swarm.
- **`docker stats`:** comando para inspecionar uso e limites de memória em tempo real ([alexhyett.com](https://www.alexhyett.com/notes/setting-memory-limits-on-docker-containers/?utm_source=chatgpt.com)).

---

## 5. Melhores Práticas e Padrões de Uso

- **Teste Antes de Produção:** use ambientes de staging para calibrar `mem_limit` segundo o perfil de consumo da aplicação.
- **Combinar Hard e Soft Limits:** defina `reservations.memory` para garantir recursos mínimos, e `limits.memory` para proteger o host de picos inesperados.
- **Monitoramento Contínuo:** integre `docker stats` ou soluções de observabilidade para acompanhar métricas de memória.
- **Evitar Ausência de Unidades:** sempre especifique sufixo; valores sem unidade são tratados como bytes (`512` = 512 B, não recomendado) ([alexhyett.com](https://www.alexhyett.com/notes/setting-memory-limits-on-docker-containers/?utm_source=chatgpt.com)).
- **Atualizar para `deploy.resources` em Swarm:** maximize compatibilidade e aproveite políticas de orquestração.

---

## 6. Exemplo Prático Completo

1. **Projeto simples com Nginx e Redis** em Compose v2:
    
    ```yaml
    version: '2.4'
    
    services:
      nginx:
        image: nginx:latest
        mem_limit: 200m
        memswap_limit: 300m
        ports:
          - "8080:80"
    
      redis:
        image: redis:6
        mem_limit: 150m
        mem_reservation: 100m
    
    ```
    
    - **`mem_limit`:** 200 MiB para Nginx, 150 MiB para Redis.
    - **`memswap_limit`:** 300 MiB total (200 MiB RAM + 100 MiB swap) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
2. **Mesma aplicação em Swarm (Compose v3.8):**
    
    ```yaml
    version: '3.8'
    
    services:
      nginx:
        image: nginx:latest
        ports:
          - "8080:80"
        deploy:
          resources:
            limits:
              memory: 200M
            reservations:
              memory: 100M
    
      redis:
        image: redis:6
        deploy:
          resources:
            limits:
              memory: 150M
            reservations:
              memory: 100M
    
    ```
    
    - **`deploy.resources.limits.memory`:** limite rígido.
    - **`deploy.resources.reservations.memory`:** reserva mínima.

---

## 7. Sugestões para Aprofundamento

- **Docker Engine Resource Constraints:** aprofundar flags de `docker run` em [https://docs.docker.com/engine/containers/resource_constraints/](https://docs.docker.com/engine/containers/resource_constraints/) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Compose Deploy Specification:** detalhes de `deploy.resources` em [https://docs.docker.com/reference/compose-file/deploy/](https://docs.docker.com/reference/compose-file/deploy/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).
- **Compose Specification no GitHub:** leia a especificação completa em [https://github.com/compose-spec/compose-spec/blob/master/spec.md](https://github.com/compose-spec/compose-spec/blob/master/spec.md).

---

Com isso, você tem uma visão completa do atributo `mem_limit` no contexto do Docker Compose, sua sintaxe, limitações e boas práticas para gerenciar memória de contêineres de forma eficiente e segura.