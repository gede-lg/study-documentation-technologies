# pull_policy

# Entendendo o atributo `pull_policy` na chave `services` do Docker Compose

## Introdução

O Docker Compose permite definir aplicações multi-contêineres em um arquivo YAML, no qual cada serviço é configurado sob a chave `services`. Um dos atributos mais importantes para controle de versão de imagens é o `pull_policy`, que determina quando e como o Compose deve buscar imagens em repositórios remotos, balanceando a necessidade de ter imagens atualizadas com a eficiência de cache local ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Valores Possíveis
3. Comportamento Padrão e Interação com Build
4. Cenários de Restrição ou Não Aplicação
5. Componentes Chave Associados e Flags de CLI
6. Melhores Práticas e Padrões de Uso
7. Exemplo Prático Completo
8. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

O atributo `pull_policy` define as decisões que o Docker Compose toma ao iniciar o processo de obtenção de imagens de contêineres, antes de criar ou executar os containers. Seu propósito principal é garantir que as imagens estejam na versão desejada — seja a mais recente do registro ou a cópia em cache local — evitando pulls desnecessários e otimizando desempenho na criação de containers ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## 2. Sintaxe Detalhada e Valores Possíveis

Abaixo, os valores aceitos pelo `pull_policy` no bloco de um serviço em `docker-compose.yml`:

```yaml
services:
  meu-servico:
    image: nginx:latest
    pull_policy: <valor>

```

Valores possíveis:

- **`always`**: sempre puxa a imagem do registro, mesmo que haja cópia em cache local.
- **`never`**: nunca puxa, dependendo exclusivamente da imagem em cache; falha se não existir localmente.
- **`missing`** (ou **`if_not_present`**): puxa apenas se não houver imagem local, padrão quando não se usa Compose Build Specification.
- **`build`**: força a construção da imagem; se já existir, reconstrói.
- **`daily`**: puxa apenas se a última tentativa de pull tiver ocorrido há mais de 24 horas.
- **`weekly`**: puxa apenas se a última tentativa de pull tiver ocorrido há mais de 7 dias.
- **`every_<duration>`**: puxa se a última tentativa for anterior ao `<duration>`, onde `<duration>` pode usar sufixos `w`, `d`, `h`, `m`, `s` ou combinações, por exemplo `every_12h`.

```yaml
services:
  teste:
    image: nginx
    pull_policy: every_12h

```

([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

## 3. Comportamento Padrão e Interação com Build

Se o atributo não for especificado, o Compose adota o comportamento de `missing` por padrão. Além disso, quando um serviço define simultaneamente `build` e `image`, o Compose segue as regras de `pull_policy`:

- **Sem `pull_policy`**: tenta primeiro o pull e, se não encontrar a imagem, constrói a partir do contexto de build.
- **Com `pull_policy: build`**: sempre constrói, mesmo que exista imagem.

Essa lógica garante flexibilidade em pipelines de CI/CD e desenvolvimentos locais, evitando builds redundantes ou pulls inesperados ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## 4. Cenários de Restrição ou Não Aplicação

Embora o Compose suporte `pull_policy`, nem todas as ferramentas que interpretam arquivos Docker Compose o fazem. Por exemplo, ao usar `docker stack deploy` para Swarm, o atributo `pull_policy` não é reconhecido e resulta em erro:

```
services.app-front Additional property pull_policy is not allowed

```

Isso ocorre porque o Swarm ainda não implementou essa parte da especificação ([github.com](https://github.com/docker/cli/issues/4688)).

---

## 5. Componentes Chave Associados e Flags de CLI

Além do atributo no arquivo, o Compose oferece flags de CLI para controle de pull:

- **`docker compose pull [SERVICE...]`**: força pull de imagens definidas sem iniciar containers. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/pull/?utm_source=chatgpt.com))
- **`docker compose up --pull <always|missing|never>`**: especifica policy de pull na execução, sobrepondo o valor em `docker-compose.yml`. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com))

---

## 6. Melhores Práticas e Padrões de Uso

- **Ambientes de Produção:** use `missing` para garantir que apenas imagens não existentes sejam buscadas.
- **Pipelines de CI/CD:** use `always` ou `daily` para garantir imagens atualizadas sem builds manuais.
- **Desenvolvimento Local:** combine `pull_policy: build` com `build` para atualizar imagens de forma controlada.
- **Versionamento de Imagens:** prefira tags fixas (por exemplo `v1.2.3`) em vez de `latest` para evitar ambiguidade.

---

## 7. Exemplo Prático Completo

Imagine um cenário com dois serviços: um frontend Node.js e um banco de dados PostgreSQL, onde:

- O frontend deve sempre baixar a versão mais recente da imagem oficial.
- O banco só deve baixar se não existir localmente.

Arquivo `docker-compose.yml`:

```yaml
version: '3.9'
services:
  frontend:
    image: node:18-alpine
    pull_policy: always
    ports:
      - '3000:3000'
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm start"

  db:
    image: postgres:15
    pull_policy: missing
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: appdb
    volumes:
      - db-data:/var/lib/postgresql/data

volumes:
  db-data:

```

### Operações comuns

1. **Iniciar containers com pull conforme policy:**
    
    ```bash
    docker compose up -d
    
    ```
    
2. **Forçar pull sem iniciar:**
    
    ```bash
    docker compose pull
    
    ```
    
3. **Executar com pull específico, ignorando o arquivo:**
    
    ```bash
    docker compose up --pull never
    
    ```
    

([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com))

---

## 8. Sugestões para Aprofundamento

- **Compose Build Specification:** detalha como build e pull interagem. ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com))
- **Compose CLI Reference:** flags `-pull` e `pull`. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com))
- **Compose File Reference:** visão completa de todos os atributos em `services`. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

Com esta explanação, você tem uma compreensão completa do atributo `pull_policy`, seus valores, usos e melhores práticas para controlar a obtenção de imagens no Docker Compose.