# memswap_limit

**Configuração do Atributo `memswap_limit` em Docker Compose**

---

## Introdução

O `memswap_limit` é o parâmetro que, em Compose v2, especifica o **total** de memória RAM **+ swap** que um contêiner pode usar. Na prática, ele mapeia diretamente para a flag `--memory-swap` do `docker run`, oferecendo uma “almofada” de swap quando o contêiner esgota sua RAM reservada ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
    - 2.1 Versão 2.x: `memswap_limit`
    - 2.2 Versão 3.x: Ausência e Alternativas
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **`-memory-swap` (`memswap_limit`):** define o **máximo** de memória física (RAM) **mais** swap que o contêiner pode consumir.
- **Comportamento padrão:**
    - Se `-memory-swap` não for especificado, ele assume o dobro de `-memory`, desde que o host tenha swap configurado.
    - Se `-memory-swap` for igual a `-memory`, o contêiner **não** terá acesso a swap (haverá apenas RAM) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).
- **Impacto no desempenho:** uso excessivo de swap pode causar latências severas, pois o disco é muito mais lento que a memória.

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Versão 2.x: `memswap_limit`

No Compose v2.x, configure diretamente no serviço:

```yaml
version: '2.4'

services:
  db:
    image: postgres:alpine
    mem_limit:       512m      # Hard limit de 512 MiB de RAM
    memswap_limit:   1g        # Até 1 GiB de RAM + swap

```

- **Equivalência CLI:**
    
    ```bash
    docker run --memory=512m --memory-swap=1g postgres:alpine
    
    ```
    
- **Unidades aceitas:** `b`, `k`, `m`, `g` (case-insensitive).
- **Requisitos:**
    - Somente funciona em Compose v2 (v3 ignora esse atributo).
    - O kernel deve suportar limitação de swap (ativado via `swapaccount=1`).

### 2.2 Versão 3.x: Ausência e Alternativas

- **Remoção do `memswap_limit`:** em Compose v3, não há substituto direto, pois o bloco `deploy.resources` não expõe parâmetro para swap ([stackoverflow.com](https://stackoverflow.com/questions/44325949/how-to-replace-memswap-limit-in-docker-compose-3)).
- **Alternativas:**
    - Use o comando `docker run` com `-memory-swap`.
    - Configure políticas de swap no nó Docker (via `daemon.json`) ou em nível de orquestração (Swarm/Kubernetes).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Compose v3 em modo não-Swarm:** todo atributo pré-v3 é ignorado; `memswap_limit` não surtirá efeito.
- **Host sem suporte a cgroup swap:** warnings de “No swap limit support” aparecem e swaps não são controlados.
- **Uso em ambiente crítico de desempenho:** aplicações sensíveis (bancos de dados, caches) podem sofrer degradação se swap não for bem calibrado.

---

## 4. Componentes Chave Associados

- **`mem_limit` / `-memory`:** teto rígido de RAM ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).
- **`mem_reservation` / `-memory-reservation`:** soft limit de RAM.
- **`mem_swappiness` / `-memory-swappiness`:** afinidade do kernel a usar swap.
- **`memswap_limit` / `-memory-swap`:** total de RAM + swap.

---

## 5. Melhores Práticas e Padrões de Uso

- **Defina `mem_limit` antes de `memswap_limit`:** garante que o soft limit não ultrapasse o hard limit.
- **Evite excesso de swap em produção:** use `memswap_limit` igual a `mem_limit` para bloquear swap em workloads de alta performance.
- **Monitore o uso de swap:** ferramentas como `docker stats` e APMs ajudam a detectar gargalos de I/O em disco.
- **Calibração em staging:** teste picos de carga para ajustar valores seguros.

---

## 6. Exemplo Prático Completo

```yaml
version: '2.4'

services:
  web:
    image: nginx:alpine
    mem_limit:       300m      # Apenas RAM
    memswap_limit:   600m      # 300m de swap extra
    mem_swappiness:  10        # Só usa swap com RAM quase esgotada

  db:
    image: postgres:13
    mem_limit:       1g        # RAM até 1 GiB
    memswap_limit:   1g        # sem swap (swap == RAM)
    mem_swappiness:  0         # nunca swap

```

- **Nginx:** permite picos de swap moderados (buffer de 300 MiB) para lidar com variações temporárias.
- **PostgreSQL:** bloqueia completamente o uso de swap, priorizando latência de memória.

---

## 7. Sugestões para Aprofundamento

- **Docker Engine Resource Constraints:** flags `-memory`, `-memory-swap` e demais em
    
    [https://docs.docker.com/engine/containers/resource_constraints/](https://docs.docker.com/engine/containers/resource_constraints/) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/))
    
- **Compose Specification no GitHub:** entenda as mudanças de v2 para v3 em
    
    [https://github.com/compose-spec/compose-spec/blob/master/spec.md](https://github.com/compose-spec/compose-spec/blob/master/spec.md)
    

---

Assim, você tem uma visão completa de como o `memswap_limit` funciona no Docker Compose, suas limitações em diferentes versões e as melhores práticas para gerenciar memória e swap de forma eficaz.