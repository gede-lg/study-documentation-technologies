# group_add

**Understanding o atributo `group_add` em Docker Compose Services**

---

## Introdução

O atributo `group_add` em um arquivo Docker Compose permite adicionar grupos suplementares ao usuário processual dentro do contêiner, facilitando cenários onde múltiplos contêineres precisam compartilhar arquivos ou sockets com permissões de grupo específicas ([matsuand.github.io](https://matsuand.github.io/docs.docker.jp.onthefly/compose/compose-file/)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes-Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

No Linux, cada processo pertence a um *usuário* (UID) e a um *grupo* principal (GID), mas pode pertencer a vários grupos suplementares. O `group_add` no Compose equivale à opção `--group-add` do `docker run`, instruindo o runtime OCI a incorporar esses grupos extras ao processo do contêiner ([docs.docker.com](https://docs.docker.com/reference/api/engine/version/v1.24/?utm_source=chatgpt.com)).

Isso é útil quando arquivos ou volumes montados têm permissões definidas por grupo—por exemplo, todos os contêineres precisam do grupo `docker` para acessar o socket do daemon ([matsuand.github.io](https://matsuand.github.io/docs.docker.jp.onthefly/compose/compose-file/)).

---

## 2. Sintaxe Detalhada e Uso Prático

```yaml
services:
  meu-servico:
    image: alpine:latest         # Imagem base
    user: "1000:1000"            # UID:GID principal
    group_add:                   # Grupos suplementares (nome ou ID)
      - "docker"                 # Exemplo por nome
      - 994                      # Exemplo por GID
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    command: ["sh", "-c", "echo Hello"]

```

- **Tipo de valores:** Cada item pode ser *string* (nome do grupo) ou *inteiro* (GID) ([matsuand.github.io](https://matsuand.github.io/docs.docker.jp.onthefly/compose/compose-file/)).
- **Interpolação:** Você pode usar variáveis de ambiente (por ex. `${MY_GROUP}`), mas cuidado: valores vazios causam falha no contêiner ([github.com](https://github.com/docker/compose/issues/9381?utm_source=chatgpt.com)).
- **Compose CLI:** Requer Compose V2 (1.27.0+) para suportar Linux-specific options do spec unificado ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/master/spec.md)).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Windows Containers:** Não suportam grupos Linux; `group_add` é simplesmente ignorado. ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/master/spec.md))
- **Grupo Ausente:** Se o grupo não existir no host **e** não estiver definido na imagem, a adição falha.
- **Imagens com PUID/PGID dinâmicos:** Algumas imagens reaplicam usuário/grupo em runtime e podem não respeitar grupos suplementares adicionados pelo host ([forums.docker.com](https://forums.docker.com/t/user-access-to-multiple-groups-within-containers/119689?utm_source=chatgpt.com)).

---

## 4. Componentes-Chave Associados

- **`group_add`:** Lista de grupos suplementares.
- **`user`:** Define o UID e GID principais.
- **OCI Runtime (`-group-add`):** Mapeia diretamente para a flag do docker run ([docs.docker.com](https://docs.docker.com/reference/api/engine/version/v1.24/?utm_source=chatgpt.com)).
- **Compose Spec:** Documento unificado que descreve opções Linux-specific a partir da versão 1.27.0 ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/master/spec.md)).

---

## 5. Melhores Práticas e Padrões de Uso

- **Use IDs para consistência:** Em ambientes heterogêneos, GIDs numéricos evitam conflitos de nomenclatura.
- **Valide existência de grupos:** Garanta que `/etc/group` na imagem e no host inclua o(s) grupo(s) desejado(s).
- **Princípio do menor privilégio:** Adicione apenas grupos estritamente necessários.
- **Documentação do projeto:** Liste no README quais grupos devem existir e para que servem.

---

## 6. Exemplo Prático Completo

```yaml
version: "2.4"
services:
  data-handler:
    image: myorg/data-handler:1.0.2
    user: "1000:1000"
    group_add:
      - docker
      - audio
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "data-volume:/data"
    working_dir: /data
    command: ["sh", "-c", "process-data.sh"]

volumes:
  data-volume:

```

Neste compose, o contêiner `data-handler`:

- **Acessa** o socket Docker (grupo `docker`).
- **Lê** arquivos de áudio em um volume cujo GID é `audio`.

---

## 7. Sugestões para Aprofundamento

- **Docker Run Reference:** seção sobre `-group-add` (Docker Engine v1.24+) ([docs.docker.com](https://docs.docker.com/reference/api/engine/version/v1.24/?utm_source=chatgpt.com))
- **Compose Specification:** Linux-specific options no spec unificado (1.27.0+) ([raw.githubusercontent.com](https://raw.githubusercontent.com/compose-spec/compose-spec/master/spec.md))
- **User Namespaces & Rootless Mode:** combine `group_add` com namespaces para isolar ainda mais privilégios.

---

Com isso, você dispõe de um guia completo para entender, configurar e aplicar o `group_add` no seu Docker Compose!