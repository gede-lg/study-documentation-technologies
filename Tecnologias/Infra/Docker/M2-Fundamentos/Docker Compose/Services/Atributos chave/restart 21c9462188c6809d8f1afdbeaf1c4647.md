# restart

**Título da Explicação:** Entendendo o atributo `restart` em serviços do Docker Compose

# Introdução

O Docker Compose permite definir multi‐containers de forma declarativa. Entre as configurações de cada serviço, o atributo `restart` especifica a política de reinício automática dos contêineres, garantindo maior resiliência e disponibilidade da aplicação.

# Sumário

- [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O atributo `restart` define como o Docker deve reagir quando um contêiner de um serviço terminar sua execução:

- **`no`**: não reinicia automaticamente (padrão).
- **`on-failure[:max-retries]`**: reinicia somente se o contêiner sair com código de erro (≠ 0); opcionalmente limita o número de tentativas.
- **`always`**: sempre reinicia o contêiner quando ele parar; se interrompido manualmente, só volta após reinício do daemon ou reinício manual do contêiner.
- **`unless-stopped`**: igual a `always`, exceto que não reinicia se o contêiner foi parado manualmente, mesmo após reinício do daemon. ([docs.docker.com](https://docs.docker.com/engine/containers/start-containers-automatically/))

Por padrão, o Docker considera que o contêiner “iniciou com sucesso” se mantiver-se em execução por pelo menos 10 segundos, evitando loops de reinício contínuos ([docs.docker.com](https://docs.docker.com/engine/containers/start-containers-automatically/)).

---

## Sintaxe Detalhada e Uso Prático

A declaração de `restart` faz parte da definição de cada serviço em seu arquivo `docker-compose.yml`.

**Forma curta**

```yaml
version: '3.8'
services:
  app:
    image: myapp:latest
    restart: always      # sempre reinicia o contêiner ao parar

```

- **`restart: no`**
    
    ```yaml
    restart: no          # não reinicia automaticamente
    
    ```
    
- **`restart: on-failure[:5]`**
    
    ```yaml
    restart: on-failure:3  # até 3 tentativas se houver falha (exit ≠ 0)
    
    ```
    
- **`restart: unless-stopped`**
    
    ```yaml
    restart: unless-stopped  # reinicia sempre, mas não após um stop manual
    
    ```
    

> Observação: o valor on-failure[:max-retries] não reinicia se o daemon for reiniciado; já always e unless-stopped aplicam-se mesmo após reinício do daemon. (docs.docker.com)
> 

---

## Cenários de Restrição ou Não Aplicação

- **Swarm Mode (`docker stack deploy`)**: o atributo `restart` na raiz do serviço é **ignorado**. Deve‐se usar `deploy.restart_policy` para definir políticas de reinício em serviços de swarm. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
- **Dependências**: dentro de `depends_on` (long syntax), existe outra opção `restart: true` que faz o Compose reiniciar o **serviço dependente** quando a dependência é atualizada — mas não controla a política de reinício do contêiner. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **Contêiner em foreground**: o CLI anexado ao contêiner encerra‐se quando o processo sai, independentemente da política de reinício; o serviço continua tentando reiniciar em background. ([docs.docker.com](https://docs.docker.com/engine/containers/start-containers-automatically/))

---

## Componentes Chave Associados

- **`deploy.restart_policy`**: define `condition`, `delay`, `max_attempts` e `window` para Swarm Mode. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
- **`depends_on` (long syntax)**: admite `condition`, `restart` e `required` para controlar ordem e reinício após atualizações de dependência ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **CLI `docker update --restart`**: permite alterar política de contêineres já criados, pois o Compose não reconfigura políticas em contêineres existentes automaticamente.

---

## Melhores Práticas e Padrões de Uso

1. **Evitar loops de reinício**: certifique‐se de que o serviço consegue iniciar em pelo menos 10 segundos antes de falhar.
2. **Testar localmente**: use `on-failure` em desenvolvimento para não mascarar problemas de inicialização.
3. **Documentar a política**: inclua comentários no `docker-compose.yml` para explicar o motivo da escolha de cada política.
4. **Não misturar com gerenciadores de processos**: use `systemd` ou similares apenas se políticas do Docker não atenderem ao seu caso, para evitar conflitos ([docs.docker.com](https://docs.docker.com/engine/containers/start-containers-automatically/)).

---

## Exemplo Prático Completo

```yaml
version: '3.8'

services:
  db:
    image: postgres:13
    restart: unless-stopped
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - db_data:/var/lib/postgresql/data

  api:
    build: ./api
    restart: on-failure:5
    depends_on:
      db:
        condition: service_healthy
        restart: true   # reinicia API se o banco for atualizado
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      retries: 3
    ports:
      - "8080:8080"

volumes:
  db_data:

```

---

## Sugestões para Aprofundamento

- **Compose Specification**: [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
- **Deploy Restart Policy (Swarm)**: seção `restart_policy` ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
- **Dependências avançadas**: uso de `condition`, `restart` em `depends_on` ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

Com essa estrutura, você terá total compreensão das possibilidades e limitações do atributo `restart` em seus serviços Docker Compose.