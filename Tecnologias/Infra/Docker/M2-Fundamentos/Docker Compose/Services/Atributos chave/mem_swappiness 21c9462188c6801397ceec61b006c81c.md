# mem_swappiness

**Configuração do Atributo `mem_swappiness` em Docker Compose**

---

## Introdução

O atributo `mem_swappiness` controla o comportamento de swap do kernel Linux para contêineres Docker, definindo a probabilidade de páginas anônimas serem movidas da RAM para o swap (disco). Valores próximos a 0 minimizam o uso de swap, priorizando a memória física; valores próximos a 100 permitem maior swap ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).

---

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
    - 2.1 Versão 2.x: `mem_swappiness`
    - 2.2 Versão 3.x: Limitações e Alternativas
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Swappiness do Kernel:** parâmetro do cgroup que define uma porcentagem (0–100) de tendência a usar swap; ajusta o equilíbrio entre RAM e swap ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Impacto no Desempenho:** uso excessivo de swap pode causar lentidão significativa, pois o acesso ao disco é muito mais lento que à RAM ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Versão 2.x: `mem_swappiness`

No Compose v2.x, basta declarar diretamente no serviço, mapeando-se para `--memory-swappiness` no `docker run`:

```yaml
version: '2.4'

services:
  app:
    image: my-app:latest
    mem_limit: 500m            # Hard limit de RAM
    memswap_limit: 1g          # Limite total de RAM+swap
    mem_swappiness: 10         # Swappiness de 10%

```

- **Mapeamento Interno:** equivale a `docker run --memory-swappiness=10 ...` ([github.com](https://github.com/docker/compose/issues/7594?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Unidades:** valor inteiro entre 0 e 100, sem sufixos.

### 2.2 Versão 3.x: Limitações e Alternativas

Em Compose v3.x (modo Swarm), o bloco `deploy.resources` **não** oferece suporte a `swappiness`. Declarações de `mem_swappiness` são ignoradas fora do contexto de Compose v2 ([github.com](https://github.com/docker/compose/issues/7594?utm_source=chatgpt.com)).

- **Alternativa em Swarm:** não há parâmetro equivalente; para controlar swap deve-se usar diretamente flags no nó ou configurar o daemon Docker (ex.: `daemon.json` com `"default-shm-size"` e ajustes de cgroup).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Hosts sem suporte a cgroup swap:** kernels desativados para `swapaccount=0` ignoram `mem_swappiness`, emitindo avisos de “No swap limit support” ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Compose v3 sem Swarm Mode:** todo bloco `deploy` (e, portanto, qualquer recurso avançado) é simplesmente ignorado pelo `docker-compose`.

---

## 4. Componentes Chave Associados

- **`mem_limit` (`-memory`):** hard limit de memória RAM.
- **`memswap_limit` (`-memory-swap`):** RAM + swap total permitido.
- **`mem_reservation` (`-memory-reservation`):** soft limit de RAM.
- **`mem_swappiness` (`-memory-swappiness`):** afinidade a swap, controla quando usar swap em excesso de memória.

---

## 5. Melhores Práticas e Padrões de Uso

- **Swappiness baixo para bancos de dados:** valores entre 0–10 recomendados para reduzir latência ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Combinar limites e reservas:** defina sempre `mem_limit` e `memswap_limit` junto a `mem_swappiness` para garantir tanto teto rígido quanto comportamento de swap coerente.
- **Testes de Carga:** ajuste `mem_swappiness` em ambiente de staging, simulando picos de uso para evitar comportamento indesejado em produção.
- **Monitoramento:** utilize `docker stats` ou ferramentas de APM para observar padrões de swap e RAM.

---

## 6. Exemplo Prático Completo

```yaml
version: '2.4'

services:
  web:
    image: nginx:alpine
    mem_limit:       300m       # Até 300 MiB de RAM
    memswap_limit:   400m       # Até 100 MiB de swap extra
    mem_swappiness:  20         # Troca para swap só quando RAM estiver muito carregada
    ports:
      - "8080:80"

  db:
    image: postgres:13
    mem_limit:       1g
    memswap_limit:   1g         # Desabilita swap (swap == RAM)
    mem_swappiness:  0          # Nunca usar swap
    environment:
      POSTGRES_PASSWORD: example

```

Neste cenário, o Nginx mantém um leve swap (20%) para amortecer picos, enquanto o PostgreSQL evita swap completamente, priorizando desempenho.

---

## 7. Sugestões para Aprofundamento

- **Docker Engine Resource Constraints:** flags de `docker run --memory-swappiness` e demais em [https://docs.docker.com/engine/containers/resource_constraints/](https://docs.docker.com/engine/containers/resource_constraints/) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com)).
- **Compose Specification Completa:** consulte o repositório oficial em [https://github.com/compose-spec/compose-spec](https://github.com/compose-spec/compose-spec).

---

Com isso, você dispõe de uma visão detalhada do `mem_swappiness` no Docker Compose, suas sintaxes, limitações em diferentes versões e práticas para otimizar o uso de memória e swap.