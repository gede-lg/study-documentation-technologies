# secrets

**Título da Explicação:** Compreendendo o atributo `secrets` na chave `services` do Docker Compose

---

## Introdução

No Docker Compose, o gerenciamento de informações sensíveis é feito por meio de “secrets”, que evitam a exposição de senhas, tokens e certificados em variáveis de ambiente ou em arquivos sem criptografia ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/)). O atributo `secrets` dentro da chave `services` permite conceder acesso granular a esses dados apenas aos containers que realmente necessitam deles ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/)).

## Sumário

- **Conceitos Fundamentais**
- **Sintaxe Detalhada e Uso Prático**
- **Cenários de Restrição ou Não Aplicação**
- **Componentes Chave Associados**
- **Melhores Práticas e Padrões de Uso**
- **Exemplo Prático Completo**
- **Sugestões para Aprofundamento**

---

## Conceitos Fundamentais

Um *secret* no contexto do Docker Compose é qualquer pedaço de dado sensível, como senha, certificado ou chave de API, que não deve ser transmitido nem armazenado sem criptografia em arquivos YAML, Dockerfiles ou código-fonte ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/engine/swarm/secrets/?utm_source=chatgpt.com)). O Compose trata *secrets* como um tipo especial de configuração (uma “flavor” de *configs*), montando-os como arquivos em tempo de execução dentro do container, garantindo que permaneçam fora de imagens, logs e do controle de versão do código-fonte ([docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/)).

---

## Sintaxe Detalhada e Uso Prático

1. **Declaração no nível superior**
    
    Primeiro, defina os *secrets* na raiz do arquivo `docker-compose.yml`, especificando sua origem:
    
    ```yaml
    secrets:
      db_password:
        file: ./db_password.txt
      api_token:
        environment: API_TOKEN_ENV_VAR
    
    ```
    
    - `file`: popula o segredo com o conteúdo de um arquivo local.
    - `environment`: popula o segredo com o valor de uma variável de ambiente do host. ([docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/))
2. **Referência no serviço (sintaxe curta)**
    
    Dentro do bloco `services`, adicione o atributo `secrets` com a lista de nomes de *secrets* a serem montados:
    
    ```yaml
    services:
      myapp:
        image: myapp:latest
        secrets:
          - db_password
          - api_token
    
    ```
    
    Isso monta cada segredo em `/run/secrets/<nome_do_secret>` como um arquivo somente leitura ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/?utm_source=chatgpt.com)).
    
3. **Sintaxe longa (apenas em Swarm/stack)**
    
    Você pode usar a sintaxe de mapa para customizar `source`, `target`, `uid`, `gid` e `mode`:
    
    ```yaml
    services:
      test:
        image: busybox
        secrets:
          - source: secret_file
            target: /root/mysecretfile
            uid: '101'
            gid: '101'
            mode: 0400
    secrets:
      secret_file:
        file: ./somefile.txt
    
    ```
    
    **Observação:** essa sintaxe longa só é suportada em implantações via Swarm/`docker stack deploy`. No `docker-compose up` padrão, o Compose ignora `uid`, `gid` e `mode` e mantém as permissões do host ([stackoverflow.com](https://stackoverflow.com/questions/73471106/how-to-use-mode-with-docker-secrets-mounted-with-files?utm_source=chatgpt.com), [forums.docker.com](https://forums.docker.com/t/only-root-user-has-access-to-the-secret/102774?utm_source=chatgpt.com)).
    

---

## Cenários de Restrição ou Não Aplicação

- **Modo standalone (não-Swarm):**
    - O Docker Compose monta os *secrets* como bind-mounts em `/run/secrets/` sem criptografia em trânsito ou em descanso;
    - A sintaxe longa *não* efetiva as permissões customizadas (`uid`, `gid`, `mode`) ([forums.docker.com](https://forums.docker.com/t/only-root-user-has-access-to-the-secret/102774?utm_source=chatgpt.com)).
- **Ambientes Windows:**
    
    O suporte a `uid`, `gid` e `mode` para *secrets* no Windows é limitado; apenas perfis de administrador podem acessá-los ([docs.docker.com](https://docs.docker.com/engine/swarm/secrets/?utm_source=chatgpt.com)).
    
- **Imagens sem convenção _FILE:**
    
    Alguns containers não adotam a convenção `ENV_VAR_FILE`, exigindo scripts de *entrypoint* para ler `/run/secrets/<nome>` manualmente ([stackoverflow.com](https://stackoverflow.com/questions/71011448/how-do-i-configure-a-secret-in-docker-compose?utm_source=chatgpt.com)).
    

---

## Componentes Chave Associados

- **`secrets` (top-level):** define ou referencia cada segredo e sua fonte (`file` ou `environment`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/)).
- **`services` → `secrets`:** lista de nomes de *secrets* ou mapas de configuração detalhada; o Compose garante acesso apenas aos serviços listados ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/?utm_source=chatgpt.com)).
- **Montagem no container:** cada segredo aparece como um arquivo em `/run/secrets/<nome>`; o container lê seu conteúdo via sistema de arquivos ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/?utm_source=chatgpt.com)).
- **Variáveis de ambiente _FILE:** convenção (e.g., `MYSQL_PASSWORD_FILE`) usada por imagens oficiais para apontar para `/run/secrets/…` ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/engine/swarm/secrets/?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

- **Não usar variáveis de ambiente para segredos:** evitam exposição em logs e no processo do container ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [phase.dev](https://phase.dev/blog/docker-compose-secrets?utm_source=chatgpt.com)).
- **Conceder acesso mínimo:** liste apenas os serviços que precisam de cada segredo, evitando escopo amplo demais ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/)).
- **Armazenar `docker-compose.yml` no controle de versão sem valores sensíveis:** apenas referências aos *secrets* aparecem no YAML ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/)).
- **Rotacionar *secrets* regularmente:** atualize arquivos ou variáveis de ambiente e recicle serviços para minimizar janela de exposição ([docs.docker.com](https://docs.docker.com/engine/swarm/secrets/?utm_source=chatgpt.com)).
- **Testar em Swarm/stack:** verifique permissões e criptografia em trânsito antes de mover para produção ([forums.docker.com](https://forums.docker.com/t/only-root-user-has-access-to-the-secret/102774?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/engine/swarm/secrets/?utm_source=chatgpt.com)).

---

## Exemplo Prático Completo

A seguir, um cenário simplificado para um stack WordPress + MySQL:

```yaml
version: '3.8'

services:
  db:
    image: mysql:8.0
    volumes:
      - db_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wp_user
      MYSQL_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_root_password
      - db_password

  wordpress:
    image: wordpress:latest
    depends_on:
      - db
    ports:
      - "8000:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wp_user
      WORDPRESS_DB_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - db_password

secrets:
  db_password:
    file: ./secrets/db_password.txt
  db_root_password:
    file: ./secrets/db_root_password.txt

volumes:
  db_data:

```

Nesse exemplo:

- Os *secrets* são declarados no nível superior e referenciados pelos serviços de forma explícita.
- Os arquivos `db_password.txt` e `db_root_password.txt` nunca aparecem em logs ou imagens de container.
- Cada serviço só monta os segredos de que precisa em `/run/secrets/…`. ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/?utm_source=chatgpt.com))

---

## Sugestões para Aprofundamento

- **Referência oficial**: Compose file reference – Secrets (top-level) / Secrets attribute para `services` ([docs.docker.com](https://docs.docker.com/reference/compose-file/secrets/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/))
- **Compose Specification**: GitHub – [09-secrets.md](https://github.com/compose-spec/compose-spec/blob/master/09-secrets.md)
- **Guia prático**: “Managing Secrets in Docker Compose” (Phase.dev) para melhores práticas avançadas ([phase.dev](https://phase.dev/blog/docker-compose-secrets?utm_source=chatgpt.com))
- **Blog de segurança**: “How to use secrets in Docker Compose” – passo a passo para ambientes de produção ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/))

Com estas orientações, você terá uma visão completa e detalhada do atributo `secrets` na chave `services` do Docker Compose, desde a teoria até a aplicação prática em ambientes de desenvolvimento e produção.