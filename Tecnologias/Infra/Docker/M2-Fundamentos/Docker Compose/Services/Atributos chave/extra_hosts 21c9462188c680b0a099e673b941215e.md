# extra_hosts

**Deep Dive no Atributo `extra_hosts` do Docker Compose**

## Introdução

O atributo `extra_hosts` do Docker Compose permite adicionar entradas personalizadas no arquivo de hosts dos containers (em Linux, `/etc/hosts`), mapeando nomes de host para endereços IP específicos. Isso é útil quando você precisa resolver manualmente nomes de máquinas ou serviços que não estão disponíveis via DNS interno do Docker. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Sintaxe Curta
    - Sintaxe Longa
    - Variações e IPv6
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Modificação de `/etc/hosts`:** Ao criar um container, o Docker monta um arquivo de hosts interno. O `extra_hosts` insere linhas adicionais neste arquivo, garantindo que determinadas resoluções de nome apontem para IPs personalizados ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Fallback ao DNS interno:** Por padrão, containers comunicam-se usando nomes de serviço via DNS do Docker (ex.: `db`, `redis`). Use `extra_hosts` apenas quando precisar de nomes externos ao escopo do Compose ou para sobrescrever resoluções DNS.
- **Camada de rede estática:** As entradas são estáticas — mudam somente ao recriar o container. Não substituem mecanismos dinâmicos de descoberta de serviço.
- **Integração com API do Docker Engine:** Por baixo dos panos, o Compose passa este mapeamento para o engine, que o aplica via campo `ExtraHosts` na API v1.24 ([docs.docker.com](https://docs.docker.com/reference/api/engine/version/v1.24/?utm_source=chatgpt.com)).

---

## Sintaxe Detalhada e Uso Prático

### Sintaxe Curta

Define-se uma lista de strings no formato `HOSTNAME=IP`. O separador `=` é o preferido:

```yaml
services:
  meu-servico:
    extra_hosts:
      - "algumhost=162.242.195.82"
      - "outrohost=50.31.209.229"
      - "meuv6=[::1]"

```

- IPv6 pode ser colocado entre colchetes.
- Também é possível usar `:` no lugar de `=` caso necessário. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

### Sintaxe Longa

Uma representação como mapa (mapping), mais legível quando há várias entradas:

```yaml
services:
  meu-servico:
    extra_hosts:
      algumhost: "162.242.195.82"
      outrohost: "50.31.209.229"
      meuv6:       "::1"

```

O Docker adiciona no `/etc/hosts` linhas como:

```
162.242.195.82  algumhost
50.31.209.229   outrohost
::1             meuv6
``` :contentReference[oaicite:4]{index=4}

### Versão e Introdução do Recurso
O `extra_hosts` em serviços foi introduzido no Compose **2.24.1** :contentReference[oaicite:5]{index=5}. Para builds (seção `build`) existe também um `extra_hosts`, mas que atua apenas em tempo de construção, não no container em execução :contentReference[oaicite:6]{index=6}.

---

## Cenários de Restrição ou Não Aplicação
- **`network_mode: host`:** Containers usam diretamente a rede do host; não há `/etc/hosts` isolado a ser modificado.
- **Ambientes de produção distribuída:** Prefira DNS interno (serviços, ingressos de malha de serviço) a mapeamentos estáticos.
- **Serviços dinâmicos:** Quando containers sobem e descem frequentemente, gerenciar IPs fixos em `/etc/hosts` pode ser frágil.

---

## Componentes Chave Associados
- **`dns`, `dns_search`, `dns_opt`:** Configuram servidores DNS e buscas, complementares ao `extra_hosts`.
- **`links` / `depends_on`:** Dependências e links implícitos; para comunicação dentro do mesmo projeto, não exigem `extra_hosts`.
- **`network_mode`:** Altera o modo de rede; em modo `host`, o `extra_hosts` fica irrelevante.
- **`build.extra_hosts`:** Versão para build-time, dentro da seção `build`.

---

## Melhores Práticas e Padrões de Uso
1. **Uso restrito a desenvolvimento:** Faça mapeamentos pontuais em dev ou testes locais, evitando misturar lógica de rede fixa em produção.
2. **Comentários claros:** Documente cada mapeamento com comentários no YAML para facilitar manutenção.
3. **Sintaxe longa para muitos hosts:** Facilita leitura e versionamento.
4. **Variáveis de ambiente:** Para IPs que mudam conforme ambiente, utilize `.env` ou `vars` em vez de codificar no Compose.
5. **Recriação consciente:** Lembre-se de que alterações em `extra_hosts` requerem `docker-compose up -d --force-recreate`.

---

## Exemplo Prático Completo

```yaml
version: '3.9'

services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"
    # Permitindo que 'api.local' aponte para um serviço externo de desenvolvimento:
    extra_hosts:
      api.local: "192.168.100.50"

  backend:
    build: ./backend
    environment:
      - DATABASE_HOST=db
      - CACHE_HOST=redis
    extra_hosts:
      # Acesso ao serviço de cache interno do host
      host.docker.internal:host-gateway    # :contentReference[oaicite:7]{index=7}

  db:
    image: postgres:14
    environment:
      POSTGRES_PASSWORD: exemplo
    networks:
      - default

  redis:
    image: redis:6
    networks:
      - default

networks:
  default:
    driver: bridge

```

Neste cenário:

- `web` resolve `api.local` no IP do servidor de API local.
- `backend` acessa um serviço no host via hostname especial `host.docker.internal`, mapeado automaticamente para o gateway da bridge. ([stackoverflow.com](https://stackoverflow.com/questions/70725881/what-is-the-equivalent-of-add-host-host-docker-internalhost-gateway-in-a-comp?utm_source=chatgpt.com))

---

## Sugestões para Aprofundamento

- Leia a [Referência Completa do Compose File](https://docs.docker.com/reference/compose-file/) para entender outros atributos de rede.
- Explore o [Compose Specification](https://docs.docker.com/compose/compose-file/compose-file-v3/) e os [Engine API v1.24](https://docs.docker.com/reference/api/engine/version/v1.24/) para detalhes de baixo nível.
- Artigos sobre [conectividade host↔container](https://dev.to/mjnaderi/accessing-host-services-from-docker-containers-1a97) oferecem casos de uso avançados.