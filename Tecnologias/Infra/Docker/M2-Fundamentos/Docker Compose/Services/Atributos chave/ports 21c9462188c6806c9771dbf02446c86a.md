# ports

**Guia Completo do Atributo `ports` em Docker Compose**

---

## Introdução

O atributo `ports` no contexto de um serviço definido em um arquivo Docker Compose especifica como as portas do contêiner devem ser publicadas (mapeadas) para portas do host, permitindo acesso a serviços em execução dentro dos contêineres a partir do ambiente externo. Ele difere de `expose`, que apenas torna portas acessíveis internamente à rede do Compose, sem publicá-las para o host ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Sintaxe Curta
    - Sintaxe Longa
    - Variações de Protocolo e IP
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O Compose agrupa configurações de contêineres em serviços, e o bloco `ports` dentro de cada serviço indica explicitamente quais portas do contêiner serão vinculadas a quais portas do host, viabilizando o acesso externo ao contêiner ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/?utm_source=chatgpt.com)).

- **Publicar portas:** Cria regras de NAT no host para direcionar o tráfego da porta do host para a porta do contêiner.
- **Expor portas (`expose`):** Apenas informa outras aplicações na mesma rede do Compose, sem publicar no host.

---

## Sintaxe Detalhada e Uso Prático

### Sintaxe Curta

```yaml
services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"         # Publica a porta 80 do contêiner na porta 8080 do host
      - "2022:22/udp"     # Publica a porta 22 (UDP) do contêiner na porta 2022 do host

```

- Formato: `<host_port>:<container_port>[/<protocol>]`
- **Protocolo Padrão:** TCP, caso não especificado ([stackoverflow.com](https://stackoverflow.com/questions/60061703/when-i-specify-ports-in-a-docker-compose-yml-file-is-it-tcp-or-udp?utm_source=chatgpt.com)).

### Sintaxe Longa

```yaml
services:
  api:
    image: my-api
    ports:
      - target: 5000        # Porta interna do contêiner
        published: 8000     # Porta do host
        protocol: tcp       # Protocolo (tcp ou udp)
        mode: host          # modo de publicação (host ou ingress em modo swarm)

```

- Campos:
    - `target` (obrigatório)
    - `published` (obrigatório)
    - `protocol` (opcional, default: `tcp`)
    - `mode` (opcional, default: `ingress` em swarm) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).

### Variações de Protocolo e IP

- **Especificar UDP:** `"5000:5000/udp"`.
- **Bind a IP específico do host:**
    
    ```yaml
    ports:
      - "127.0.0.1:9000:80"  # só acessível localmente
    
    ```
    
- **Portas Ephemeral:** Usar apenas `":80"` publica em uma porta aleatória disponível no host ([docs.docker.com](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Rede Interna Somente:** Para comunicação apenas entre contêineres, prefira `expose` ou confiar na rede padrão do Compose, sem publicar portas.
- **Ambientes Swarm/Kubernetes:** Em deploys orquestrados, utilize `deploy.endpoint_mode` e balanceadores de carga externos em vez de `ports` do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).
- **Conflito de Portas:** Em múltiplos serviços no mesmo host, evitar publicações conflituosas; considere redes isoladas ou alocar dinamicamente portas do host.

---

## Componentes Chave Associados

- **`expose`:** Define portas acessíveis apenas internamente.
- **`networks`:** Controla em quais redes um serviço participa.
- **`depends_on`:** Ordena inicialização de serviços relacionados.
- **`environment` / `env_file`:** Variáveis de ambiente para configuração de porta interna ou variável de bind.
- **`volumes`:** Persistência de dados, frequentemente usada em conjunto para bancos de dados que escutam em portas mapeadas.
- **`deploy`:** Configurações de orquestração (apenas em modo swarm).

---

## Melhores Práticas e Padrões de Uso

- **Minimizar portas públicas:** Só publique o estritamente necessário, reduzindo superfície de ataque e riscos de segurança ([docs.docker.com](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/run/?utm_source=chatgpt.com)).
- **Bind a localhost em dev:** `"127.0.0.1:...`" para restringir acesso externo acidental.
- **Documentar mapeamentos:** Comente cada entrada em `ports` brevemente, facilitando manutenção por outros desenvolvedores.
- **Usar `mode: host` com cautela:** Em ambientes críticos, o modo host pula NAT do Docker, podendo provocar conflitos.

---

## Exemplo Prático Completo

```yaml
version: '3.8'

services:
  web:
    image: nginx:latest
    ports:
      - "8080:80"           # Acesso HTTP externo via localhost:8080
    networks:
      - frontend

  api:
    build: ./api
    ports:
      - target: 5000        # Porta interna da API
        published: 5001     # Publica no host na porta 5001
        protocol: tcp
    environment:
      - NODE_ENV=production
    depends_on:
      - db
    networks:
      - frontend
      - backend

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - db_data:/var/lib/postgresql/data
    expose:
      - "5432"              # Apenas acesso interno
    networks:
      - backend

volumes:
  db_data:

networks:
  frontend:
  backend:

```

Este cenário exemplifica:

- Servidor web publicado (externo)
- API com mapeamento explícito via sintaxe longa
- Banco de dados acessível internamente sem expor para o host

---

## Sugestões para Aprofundamento

- **Compose Specification:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com))
- **Publicação de Portas com CLI:** [https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/) ([docs.docker.com](https://docs.docker.com/get-started/docker-concepts/running-containers/publishing-ports/?utm_source=chatgpt.com))
- **Orquestração em Swarm:** [https://docs.docker.com/reference/compose-file/deploy/](https://docs.docker.com/reference/compose-file/deploy/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
- **Networking no Compose:** [https://docs.docker.com/compose/how-tos/networking/](https://docs.docker.com/compose/how-tos/networking/) ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com))

Espero que este guia detalhado ajude na compreensão completa do atributo `ports` em Docker Compose!