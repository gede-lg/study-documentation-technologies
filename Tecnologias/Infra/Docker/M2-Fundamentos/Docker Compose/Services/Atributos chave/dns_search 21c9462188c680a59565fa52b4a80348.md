# dns_search

**Entendendo o atributo `dns_search` no Docker Compose**

---

## Introdução

No Docker Compose, cada serviço pode ter suas próprias configurações de DNS, que impactam diretamente como nomes de host são resolvidos dentro do contêiner. O atributo `dns_search` permite especificar domínios de busca personalizados, que serão adicionados à diretiva `search` do arquivo `/etc/resolv.conf` gerado no contêiner. Com isso, nomes não totalmente qualificados (short names) passam a ser automaticamente complementados pelos sufixos definidos em `dns_search`, simplificando a comunicação entre serviços em redes privadas ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sumário

- Conceitos Fundamentais
- Sintaxe Detalhada e Uso Prático
- Cenários de Restrição ou Não Aplicação
- Componentes Chave Associados
- Melhores Práticas e Padrões de Uso
- Exemplo Prático Completo
- Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Domínio de Busca (search domain):** lista de sufixos que o resolvedor DNS tenta automaticamente quando se faz uma consulta por um nome sem ponto (por exemplo, `db` vira `db.example.com`) ([stackoverflow.com](https://stackoverflow.com/questions/70160664/in-docker-compose-what-is-the-effect-purpose-of-dns-search?utm_source=chatgpt.com)).
- **Resolução dentro do contêiner:** por padrão, contêineres que usam uma *user-defined* network apontam o `nameserver` para o servidor DNS embutido do Docker (127.0.0.11), que por sua vez encaminha para os DNS configurados no host ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).
- **Interação com `ndots`:** o Docker configura `options ndots:0` por padrão, fazendo com que toda consulta seja tentada primeiro como um nome absoluto, depois com cada domínio de busca em sequência ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1. Formatos Suportados

- **Valor único (string):**
    
    ```yaml
    services:
      app:
        dns_search: example.com
    
    ```
    
- **Lista de valores:**
    
    ```yaml
    services:
      app:
        dns_search:
          - dc1.example.com
          - dc2.example.com
    
    ```
    

Ambas as formas são equivalentes, e permitem especificar múltiplos sufixos de busca ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

### 2.2. Equivalência com Flags CLI

O atributo `dns_search` corresponde à flag `--dns-search` do comando `docker run`, que tem o mesmo propósito de adicionar domínios de busca ao `/etc/resolv.conf` do contêiner ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).

### 2.3. Comentários em Exemplos

```yaml
version: "3.8"
services:
  web:
    image: nginx:latest
    # Define o servidor DNS interno do Docker
    dns:
      - 127.0.0.11
    # Sufixos de busca para resolver nomes não FQDN
    dns_search:
      - internal.svc.cluster.local
      - example.com
    command: cat /etc/resolv.conf

```

> Ao iniciar esse serviço, você verá no /etc/resolv.conf do contêiner linhas como:
> 
> 
> ```
> search internal.svc.cluster.local example.com
> nameserver 127.0.0.11
> options edns0 trust-ad ndots:0
> 
> ```
> 

---

## 3. Cenários de Restrição ou Não Aplicação

- **`network_mode: host`:** contêineres compartilham o namespace de rede do host, usando diretamente o `/etc/resolv.conf` do host; nesse caso, `dns_search` não é aplicado pelo Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Modo Swarm (`deploy`):** parâmetros de DNS em seções `deploy` (Swarm) são ignorados pelo Docker Compose; use `.yaml` específico para Swarm ou defina essas opções via CLI/Docker service ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Redes Default Bridge sem descoberta de serviço:** contêineres na *default bridge* herdando resolv.conf do host não usam DNS interno do Docker e, embora `dns_search` adicione sufixos, não há resolução automática de nomes de outros serviços dessa bridge ([forums.docker.com](https://forums.docker.com/t/dns-settings-ignored/138184?utm_source=chatgpt.com)).

---

## 4. Componentes Chave Associados

- **`dns`:** define servidores DNS (endereços IP) a usar no contêiner.
- **`dns_opt`:** opções do resolvedor, como `use-vc` ou `no-tld-query`.
- **`domainname`:** define um domínio customizado (`domainname: mydomain.com`), que complementa o hostname do contêiner.
- **`extra_hosts`:** adiciona entradas estáticas no `/etc/hosts`, útil para mapeamentos específicos.
- **`driver_opts`:** opções de driver para redes, podendo afetar indireta-mente a resolução se combinado com plugins de rede com DNS próprio ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## 5. Melhores Práticas e Padrões de Uso

- **Use lista curta de domínios:** muitos sufixos podem degradar performance de resolução.
- **Combine `dns` e `dns_search`:** especifique servidores customizados *e* domínios de busca para ambientes corporativos.
- **Favor sufixos relevantes:** por exemplo, apenas o namespace do cluster (e.g., `svc.cluster.local`) em arquiteturas Kubernetes integradas.
- **Monitore `/etc/resolv.conf`:** valide regularmente dentro do contêiner para garantir que as configurações foram aplicadas como esperado.
- **Evite sobreposição de domínios públicos:** sufixos que coincidem com domínios da Internet podem causar buscas desnecessárias e latência.

---

## 6. Exemplo Prático Completo

**Cenário:** microsserviços `web` e `db` em rede privada, com resolução simples via nomes curtos.

```yaml
version: "3.8"

networks:
  backend_net:
    driver: bridge

services:
  db:
    image: postgres:13
    container_name: db
    networks:
      - backend_net
    dns_search:
      - backend.local

  web:
    image: myapp:latest
    depends_on:
      - db
    networks:
      - backend_net
    dns_search:
      - backend.local
    environment:
      - DATABASE_HOST=db
    command: >
      sh -c "ping -c1 db
             && exec myapp"

```

**Como testar:**

1. `docker compose up -d`
2. Dentro do contêiner `web`:
    
    ```bash
    $ docker exec -it web cat /etc/resolv.conf
    # deve mostrar: search backend.local
    # em seguida:
    $ docker exec -it web ping -c1 db
    
    ```
    

Isso resolve `db` automaticamente como `db.backend.local`.

---

## 7. Sugestões para Aprofundamento

- RFC 1035: especificação de DNS e diretiva *search*
- Compose Specification (GitHub): explore as versões mais recentes do *Compose spec*
- Blogs Docker Networking: artigos sobre Docker Embedded DNS e `ndots`
- Ferramentas de diagnóstico: `dig +short host@resolver` dentro do contêiner para entender comportamento de busca.

---

**Conclusão:**

O atributo `dns_search` é fundamental para simplificar a resolução de nomes em ambientes Docker isolados, dispensando a necessidade de FQDNs completos e tornando o Compose mais flexível em redes privadas. Use-o com critério, combinando com `dns` e `dns_opt`, e sempre valide o efeito prático observando o conteúdo de `/etc/resolv.conf`.