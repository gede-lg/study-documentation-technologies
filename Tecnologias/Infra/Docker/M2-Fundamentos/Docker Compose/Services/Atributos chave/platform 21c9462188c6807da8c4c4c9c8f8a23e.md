# platform

**Título da Explicação:** Using the `platform` Attribute in Docker Compose Service Definitions

---

**Introdução**

O atributo `platform` permite especificar explicitamente o sistema operacional e a arquitetura em que um serviço Docker Compose deve ser executado, sobrescrevendo a seleção automática baseada no manifesto multi-arquitetura da imagem. Isso é fundamental em ambientes heterogêneos—por exemplo, ao rodar um serviço `linux/amd64` em um host Apple Silicon (ARM64) por meio de emulação—assegurando consistência entre desenvolvimento e produção ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/68434301/docker-compose-run-with-specified-platform?utm_source=chatgpt.com)).

---

**Sumário**

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **O que é:** Um serviço Compose é definido por imagem, build e diversos atributos de configuração. O `platform` foi introduzido no formato v2.4 e em specs posteriores para permitir selecionar manualmente `<os>/<arquitetura>[/<variant>]` ([stackoverflow.com](https://stackoverflow.com/questions/59756123/use-buildx-build-linux-arm64-in-docker-compose-file?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/68434301/docker-compose-run-with-specified-platform?utm_source=chatgpt.com)).
- **Por que importa:** Quando uma imagem possui múltiplas variantes (manifest list), o Docker normalmente escolhe a variante compatível com o host. O `platform` força uma escolha específica, essencial para testes cruzados e pipelines CI/CD que visam diferentes arquiteturas ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

A chave `platform` deve ficar no mesmo nível de `image` ou `build` dentro de um serviço:

```yaml
version: '3.8'
services:
  web:
    image: nginx:latest       # Imagem multi-arquitetura
    platform: linux/amd64     # Força o uso da variante AMD64
    ports:
      - "8080:80"

```

> Observações da sintaxe:
> 
> - `<os>` normalmente `linux` ou `windows`.
> - `<arquitetura>` como `amd64`, `arm64`, `arm/v7`.
> - Opcionalmente `<variant>`, ex.: `linux/arm64/v8`. ([stackoverflow.com](https://stackoverflow.com/questions/59756123/use-buildx-build-linux-arm64-in-docker-compose-file?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/68434301/docker-compose-run-with-specified-platform?utm_source=chatgpt.com))

---

## 3. Cenários de Restrição ou Não Aplicação

- **Swarm Mode (`docker stack deploy`):** Ignora o `platform` porque usa o formato legado v3; serviços em modo swarm não suportam essa chave ([stackoverflow.com](https://stackoverflow.com/questions/72203583/docker-compose-platform-option), [stackoverflow.com](https://stackoverflow.com/questions/59756123/use-buildx-build-linux-arm64-in-docker-compose-file?utm_source=chatgpt.com)).
- **Ausência de Emulação:** Em hosts sem QEMU/configuração de emulação, tentar usar uma plataforma não nativa pode falhar com erros de runtime ou pull.
- **Build vs. Run:** `platform` em nível de serviço afeta apenas o pull/run. Para builds multi-plataforma use `docker buildx build --platform` ou o campo `build.platform` no BuildKit.

---

## 4. Componentes Chave Associados

- **CLI Flags:**
    - `docker run --platform=<plat>` ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/65612411/forcing-docker-to-use-linux-amd64-platform-by-default-on-macos?utm_source=chatgpt.com))
    - `docker buildx build --platform=<plat>` ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com))
- **Variável de Ambiente:**
    - `DOCKER_DEFAULT_PLATFORM=linux/amd64` define padrão para comandos que aceitam `-platform` ([stackoverflow.com](https://stackoverflow.com/questions/65612411/forcing-docker-to-use-linux-amd64-platform-by-default-on-macos?utm_source=chatgpt.com))
- **Dockerfile `FROM --platform`:** Permite escolher plataforma durante o build de Dockerfile ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com))

---

## 5. Melhores Práticas e Padrões de Uso

- **Especifique apenas quando necessário:** Deixe o Docker escolher a variante padrão, a menos que haja incompatibilidade comprovada.
- **Use imagens multi-arquitetura:** Prefira imagens construídas para várias plataformas; só force quando a variante desejada não for selecionada corretamente.
- **Documente a necessidade:** Em equipes, explique por que um serviço exige `platform`, para evitar confusões futuras.
- **Combine com CI/CD:** Em pipelines, use `DOCKER_DEFAULT_PLATFORM` para consistência entre runners AMD64 e ARM64 ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/65612411/forcing-docker-to-use-linux-amd64-platform-by-default-on-macos?utm_source=chatgpt.com)).

---

## 6. Exemplo Prático Completo

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    image: myorg/api:latest
    platform: linux/amd64     # Força o uso de AMD64 em hosts ARM
    environment:
      - NODE_ENV=production
    volumes:
      - ./config:/app/config
    ports:
      - "3000:3000"

  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    platform: linux/arm64     # Roda a variante ARM64 para testes em Raspberry Pi
    depends_on:
      - api

```

**O que acontece ao executar `docker-compose up`:**

1. O Compose “pull” as imagens `myorg/api:latest` e a variante AMD64 do worker-builder.
2. Cria e inicia containers nos hosts, usando emulação quando necessário. ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/59756123/use-buildx-build-linux-arm64-in-docker-compose-file?utm_source=chatgpt.com))

---

## 7. Sugestões para Aprofundamento

- **Compose File Reference:** Especificação completa de atributos de serviço ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com))
- **Multi-platform Builds Guide:** Estratégias de build para várias plataformas ([docs.docker.com](https://docs.docker.com/build/building/multi-platform/?utm_source=chatgpt.com))
- **Docker Run Reference:** Documentação oficial de flags CLI, incluindo `-platform` (procure por “platform”)

---

Com isso, você dispõe de uma visão completa sobre o atributo `platform` no Docker Compose, desde o conceito até cenários avançados de aplicação.