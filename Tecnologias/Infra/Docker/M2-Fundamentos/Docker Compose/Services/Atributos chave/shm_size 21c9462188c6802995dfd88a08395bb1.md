# shm_size

**Entendendo o atributo `shm_size` no Docker Compose**

**Introdução**

O atributo `shm_size` configura o tamanho do sistema de arquivos de memória compartilhada (`/dev/shm`) utilizado pelo container Docker. Esse recurso, baseado em tmpfs, é fundamental para aplicações que usam intensamente comunicação via memória compartilhada (IPC), como bancos de dados e navegadores headless ([datawookie.dev](https://datawookie.dev/blog/2021/11/shared-memory-docker/?utm_source=chatgpt.com), [last9.io](https://last9.io/blog/how-to-configure-dockers-shared-memory-size-dev-shm/?utm_source=chatgpt.com)).

---

**Sumário**

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

### 1. Conceitos Fundamentais

- **Memória Compartilhada (`/dev/shm`)**: espaço em memória volátil, montado como `tmpfs`, usado para IPC entre processos ([datawookie.dev](https://datawookie.dev/blog/2021/11/shared-memory-docker/?utm_source=chatgpt.com), [last9.io](https://last9.io/blog/how-to-configure-dockers-shared-memory-size-dev-shm/?utm_source=chatgpt.com)).
- **Tamanho Padrão**: por padrão, o Docker limita esse espaço a 64 MB, o que pode causar erros “No space left on device” em aplicações que alocam buffers extensos em `/dev/shm` ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container), [datawookie.dev](https://datawookie.dev/blog/2021/11/shared-memory-docker/?utm_source=chatgpt.com)).
- **Importância**: essencial para bancos de dados como PostgreSQL (que usa `/dev/shm` para alocar `shared_buffers`) e ferramentas de teste de navegador headless (Chrome/Puppeteer) ([instaclustr.com](https://www.instaclustr.com/blog/postgresql-docker-and-shared-memory/?utm_source=chatgpt.com)).

---

### 2. Sintaxe Detalhada e Uso Prático

No `docker-compose.yml`, a partir das versões ≥ ‘2.1’ e ‘3.x’, define-se `shm_size` no nível de serviço:

```yaml
version: '3.5'
services:
  meu_servico:
    image: minha-imagem
    shm_size: '1gb'     # define o tamanho de /dev/shm em tempo de execução :contentReference[oaicite:4]{index=4}
    build:
      context: .
      dockerfile: Dockerfile
      shm_size: '1gb'   # define o tamanho durante o build :contentReference[oaicite:5]{index=5}

```

- **Formato**: aceita número seguido de unidade (`b`, `k`, `m`, `g`, case-insensitive) ou valor inteiro em bytes. Recomenda-se envolver em aspas para evitar ambiguidade no YAML ([bobcares.com](https://bobcares.com/blog/docker-shm-size/?utm_source=chatgpt.com)).
- **Equivalente CLI**: corresponde à flag `-shm-size` do `docker run`, por exemplo:
    
    ```bash
    docker run --shm-size=2gb my-app
    
    ```
    
    ([last9.io](https://last9.io/blog/how-to-configure-dockers-shared-memory-size-dev-shm/?utm_source=chatgpt.com))
    

---

### 3. Cenários de Restrição ou Não Aplicação

- **Docker Swarm**: ao usar `docker stack deploy`, o atributo `shm_size` não é suportado e será ignorado, pois o Swarm-mode não replica esse parâmetro ([reddit.com](https://www.reddit.com/r/docker/comments/dvqh2f/shared_memory_size_in_docker_compose/?utm_source=chatgpt.com)).
- **Docker Desktop (Mac/Windows)**: em ambientes macOS e Windows, o `/dev/shm` é implementado sobre o sistema de arquivos do host (osxfs), tornando o valor de `shm_size` muitas vezes ineficaz ([reddit.com](https://www.reddit.com/r/docker/comments/dvqh2f/shared_memory_size_in_docker_compose/?utm_source=chatgpt.com)).
- **BuildKit**: durante processos de build com BuildKit ativado (`DOCKER_BUILDKIT=1`), a opção `-shm-size` pode não ser reconhecida, exigindo desativar o BuildKit para que `build.shm_size` seja aplicado ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container)).

---

### 4. Componentes Chave Associados

- **`build.shm_size`**: aplica-se apenas ao processo de build, útil para imagens que compilam código que requer memória compartilhada ampliada ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container)).
- **`shm_size`**: escopo do container em execução, definindo o tmpfs montado em `/dev/shm` após o container iniciar ([stackoverflow.com](https://stackoverflow.com/questions/30210362/how-to-increase-the-size-of-the-dev-shm-in-docker-container)).
- **`tmpfs`** (alternativa): permite montar diretamente sistemas de arquivos voláteis com opções customizadas. Exemplo:
    
    ```yaml
    services:
      app:
        tmpfs:
          - /dev/shm:size=1gb
    
    ```
    
    Mas, para clareza, `shm_size` é preferível ([last9.io](https://last9.io/blog/how-to-configure-dockers-shared-memory-size-dev-shm/?utm_source=chatgpt.com)).
    

---

### 5. Melhores Práticas e Padrões de Uso

- **Estimativa de uso**: para bancos de dados, alocar ao menos 25–30 % da RAM disponível; para navegadores headless, 512 MB–1 GB por instância ([last9.io](https://last9.io/blog/how-to-configure-dockers-shared-memory-size-dev-shm/?utm_source=chatgpt.com)).
- **Consistência de unidades**: padronizar uso de `m` ou `g` (minúsculo) e usar aspas no YAML ([bobcares.com](https://bobcares.com/blog/docker-shm-size/?utm_source=chatgpt.com)).
- **Validação**: execute `docker inspect <container> | grep -i shm` para conferir o campo `"ShmSize"` em bytes ([datawookie.dev](https://datawookie.dev/blog/2021/11/shared-memory-docker/?utm_source=chatgpt.com)).
- **Limites sensatos**: não ultrapassar a memória física disponível, evitando swap ou falhas de alocação de tmpfs.

---

### 6. Exemplo Prático Completo

Configuração para uma aplicação Node.js com Puppeteer, que requer 1 GB de `/dev/shm`:

```yaml
version: '3.8'
services:
  puppeteer:
    image: my-node-app:latest
    shm_size: '1gb'
    environment:
      - NODE_ENV=production
    volumes:
      - ./:/app
    working_dir: /app
    command: npm start

```

**Validação**:

1. Suba o serviço:
    
    ```bash
    docker-compose up -d
    
    ```
    
2. Verifique o tamanho aplicado:
    
    ```bash
    docker inspect puppeteer | grep -i shm
    
    ```
    
    Saída esperada:
    
    ```
    "ShmSize": 1073741824
    
    ```
    
    ([datawookie.dev](https://datawookie.dev/blog/2021/11/shared-memory-docker/?utm_source=chatgpt.com))
    

---

### 7. Sugestões para Aprofundamento

- **Doc. oficial do Compose File Format (services)**:
    
    [https://docs.docker.com/compose/compose-file/#services](https://docs.docker.com/compose/compose-file/#services) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
    
- **Artigo “PostgreSQL®, Docker, and Shared Memory”** (Instaclustr): impacto de `shm_size` em bancos de dados ([instaclustr.com](https://www.instaclustr.com/blog/postgresql-docker-and-shared-memory/?utm_source=chatgpt.com))

---

Se precisar explorar casos mais avançados ou detalhes sobre otimização de performance e integração com Swarm/Kubernetes, estes recursos servirão como ponto de partida aprofundado.