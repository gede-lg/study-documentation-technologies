# extends

**Título da Explicação:** Entendendo o atributo `extends` em serviços do Docker Compose

---

## Introdução

O Docker Compose permite definir e executar aplicações multicontêiner de forma simples, centralizando toda a configuração em um ou mais arquivos YAML. Em projetos maiores, muitas vezes há serviços que compartilham configurações comuns (imagem base, volumes, variáveis de ambiente etc.). Para evitar duplicação e facilitar a manutenção, o atributo `extends` foi criado: ele permite “herdar” a definição de um serviço existente, seja no mesmo arquivo ou em um arquivo Compose separado ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    1. Extending de outro arquivo
    2. Extending no mesmo arquivo
    3. Encadeamento de `extends`
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Propósito:** Reutilizar configurações de serviços para evitar duplicação.
- **Funcionamento:** Ao utilizar `extends`, o Compose importa apenas as propriedades declaradas no serviço referenciado; configurações adicionais podem ser sobrescritas localmente ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).
- **Aplicabilidade:** Útil em monorepos, projetos com múltiplos ambientes (dev, staging, prod) e cenários onde se deseja manter um “serviço base” compartilhado.

---

## Sintaxe Detalhada e Uso Prático

### 1. Extending de outro arquivo

```yaml
services:
  web:
    extends:
      file: common-services.yml   # Arquivo que contém o serviço base
      service: webapp             # Nome do serviço a ser herdado
    image: nginx:latest           # Sobrescreve ou adiciona propriedades

```

Neste exemplo, todas as configurações de `webapp` em `common-services.yml` (build, ports, volumes etc.) são importadas para o serviço `web`, que pode então estender ou sobrescrever parâmetros ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).

### 2. Extending no mesmo arquivo

Também é possível estender um serviço definido no mesmo arquivo, usando a forma curta:

```yaml
services:
  webapp:
    environment:
      - DEBUG=1

  web:
    extends: webapp     # Herdando diretamente do serviço webapp
    image: alpine       # Adiciona nova propriedade

```

Aqui, `web` herda tudo de `webapp` e adiciona a imagem `alpine` ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).

### 3. Encadeamento de `extends`

Você pode encadear múltiplas heranças, combinando arquivo externo e serviço local:

```yaml
services:
  web:
    extends:
      file: common-services.yml
      service: webapp
    environment:
      - DEBUG=1
    cpu_shares: 5

  important_web:
    extends: web        # Estende o serviço web que já estende common-services.yml
    cpu_shares: 10

```

Essa flexibilidade permite criar variações do mesmo serviço base em diferentes níveis ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).

---

## Cenários de Restrição ou Não Aplicação

- **Não compartilhamento de `volumes_from` e `depends_on`:** Esses atributos **não** são herdados para evitar dependências implícitas; devem ser declarados localmente ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).
- **Unicidade de herança:** Ideal apenas quando você precisa compartilhar um único serviço; para cenários mais complexos ou “caixa-preta”, outras abordagens (ex.: [include] ou extensões `x-`) podem ser mais adequadas.
- **Limites de compatibilidade:** Em versões antigas do Compose v3 o `extends` chegou a ser removido, mas foi restaurado no Compose Specification (v4) e permanece suportado na CLI Compose V2 ([stackoverflow.com](https://stackoverflow.com/questions/76999450/extends-keyword-in-docker-compose-deprecated?utm_source=chatgpt.com)).

---

## Componentes Chave Associados

O objeto `extends` suporta dois campos principais:

| Campo | Tipo | Obrigatório | Descrição |
| --- | --- | --- | --- |
| `service` | string | Sim | Nome do serviço a herdar (dentro do mesmo arquivo ou no arquivo referenciado). |
| `file` | string | Não | Caminho relativo ou absoluto para outro arquivo Compose. Se omitido, busca no mesmo arquivo. |

Além destes, o serviço que recebe a herança pode declarar quaisquer outros atributos do Compose (como `image`, `environment`, `deploy` etc.), sobrescrevendo valores herdados.

---

## Melhores Práticas e Padrões de Uso

- **Manter hierarquias rasas:** Evite cadeias muito longas de herança para não criar complexidade desnecessária.
- **Usar `include` ou `x-`extensions para modularização:** Em aplicações grandes, prefira `include` (Docker Compose 2.20+) ou blocos personalizados `x-` para maior clareza e controle de versões ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/include/?utm_source=chatgpt.com)).
- **Documentar serviços base:** Mantenha o arquivo referenciado (`common-services.yml`) bem comentado e versionado.
- **Verificar modelo final:** Utilize `docker compose config` para inspecionar o resultado da mesclagem/extends antes de subir os serviços.

---

## Exemplo Prático Completo

**common-services.yml**:

```yaml
services:
  app-base:
    build: .
    environment:
      - CONFIG_PATH=/code/config
      - API_KEY=xxxyyy
    cpu_shares: 5

```

**compose.yml**:

```yaml
version: '2.4'

services:
  webapp:
    extends:
      file: common-services.yml
      service: app-base
    command: /code/run_web_app
    ports:
      - "8080:8080"
    depends_on:
      - db

  queue-worker:
    extends:
      file: common-services.yml
      service: app-base
    command: /code/run_worker
    depends_on:
      - queue

  db:
    image: postgres:15

```

Nesse cenário, `webapp` e `queue-worker` herdam toda a configuração de `app-base`, alteram apenas o comando e gerenciam suas dependências localmente ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/extends/)).

---

## Sugestões para Aprofundamento

- Guia “Use multiple Compose files / Extend” (Docker Docs)
- Seção **Include** no Compose Specification (Docker Docs)
- Módulo **Fragments** e **x-extensions** no Compose Specification
- Artigo “Improve Docker Compose Modularity with `include`” (Docker Blog)
- Ferramenta `docker compose config` para validação de mesclagens e heranças

---

Com essas informações, você terá um panorama completo do atributo `extends`, desde sua definição básica até exemplos avançados e boas práticas de uso em projetos reais.