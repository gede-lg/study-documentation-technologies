# oom_kill_disable

**Entendendo o atributo `oom_kill_disable` em Docker Compose**

---

## Introdução

Em ambientes de contêineres Docker, o **OOM killer** (Out-Of-Memory killer) é um mecanismo do kernel Linux que, sob pressão de memória, finaliza processos para liberar recursos. No entanto, existem cenários em que é desejável **desabilitar** essa proteção dentro de um contêiner específico — por exemplo, quando você quer garantir que um serviço não seja interrompido pelo OOM killer e que, em vez disso, passe a falhar internamente ao estourar seu limite de memória. É aí que entra o atributo `oom_kill_disable` do Docker Compose, disponível em arquivos de versão 2.1 ou superior.

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **OOM killer**: mecanismo do kernel Linux que mata processos quando a memória do sistema está esgotada.
- **cgroups**: subsistema do kernel que permite limitar e isolar recursos (CPU, memória etc.) entre grupos de processos.
- **`-oom-kill-disable`**: opção do `docker run` que desabilita o OOM killer para aquele contêiner. Em nível de cgroup, escreve `1` em `memory.oom_control`. ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/))
- **`oom_kill_disable` no Compose**: espelha `-oom-kill-disable`, mas só funciona em arquivos de Compose versão 2.1 e superiores. Foi introduzido no Compose 1.18.0 (dez/2017) ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com)).

---

## Sintaxe Detalhada e Uso Prático

Para habilitar a desativação do OOM killer em um serviço, defina no seu `docker-compose.yml`:

```yaml
version: '2.1'  # mínimo para suportar oom_kill_disable
services:
  meu_servico:
    image: minha/imagem:latest
    oom_kill_disable: true       # desabilita o OOM killer
    mem_limit: 512m              # obrigatório: define limite rígido de memória
    mem_reservation: 256m        # opcional: limite suave
    memswap_limit: 512m          # opcional: proíbe swap extra
    # ... outras configurações

```

- **Chave**: `oom_kill_disable` (underscore).
- **Valor**: `true` ou `false`.
- **Versão mínima**: `2.1` (apenas em formatos 2.x; não funciona em 3.x) ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com)).
- **Dependência**: sempre combine com `mem_limit` (ou equivalente) para evitar riscos de estabilidade do host ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).

---

## Cenários de Restrição ou Não Aplicação

- **Compose v3.x**: `oom_kill_disable` não é reconhecido em arquivos versão 3 ou superiores — retornará “Unsupported config option” ([github.com](https://github.com/docker/compose/issues/2901?utm_source=chatgpt.com)).
- **cgroup v2**: kernels que usam cgroup v2 não suportam `-oom-kill-disable`; o Docker emite aviso e ignora a configuração ([github.com](https://github.com/moby/moby/issues/42865?utm_source=chatgpt.com)).
- **Sem limite de memória**: usar sem `mem_limit` pode levar o host a ficar sem memória, pois o contêiner não será interrompido pelo OOM killer do cgroup, podendo destruir processos críticos do sistema ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).
- **Processos não-sistêmicos**: desabilitar o OOM killer em aplicações de usuário pode travar o contêiner indefinidamente; normalmente recomendado apenas para processos “críticos” que gerenciam internamente falhas de alocação.

---

## Componentes Chave Associados

- **`mem_limit` / `m`**: limite rígido de memória do contêiner.
- **`mem_reservation` / `-memory-reservation`**: limite suave ativado sob pressão de memória.
- **`memswap_limit` / `-memory-swap`**: total de memória + swap permitido.
- **`memory-swappiness`**: controle de swap do cgroup.
- **`kernel-memory`**: limite de memória do kernel dentro do contêiner.
- **Arquivo cgroup**: `/sys/fs/cgroup/memory/<cgroup>/memory.oom_control` recebe `1` para desativar.
- **`oom_score_adj`**: ajuste de prioridade do OOM killer; não substitui `oom_kill_disable`.

---

## Melhores Práticas e Padrões de Uso

1. **Sempre defina limite de memória** antes de desabilitar o OOM killer, para evitar instabilidade do host.
2. **Use apenas quando necessário** em serviços que possam tratar internamente falhas de alocação (ex.: bancos de dados com gerenciamento próprio de cache).
3. **Monitore uso de memória** com `docker stats` e métricas de cgroup.
4. **Teste em ambientes de staging** antes de aplicar em produção.
5. **Considere alternativas** como ajustar `oom_score_adj` ou otimizar o consumo de memória da aplicação antes de desabilitar totalmente o OOM killer.

---

## Exemplo Prático Completo

```yaml
version: '2.1'
services:
  webapp:
    image: minha/webapp:latest
    # Desabilita o OOM killer para esse contêiner
    oom_kill_disable: true
    # Limites de memória
    mem_limit: 512m
    mem_reservation: 256m
    memswap_limit: 512m
    # Reinício automático em caso de falha
    restart: on-failure
    ports:
      - "8080:80"
    environment:
      - NODE_ENV=production
    networks:
      - frontnet

networks:
  frontnet:
    driver: bridge

```

Neste cenário, se o processo da aplicação ultrapassar 512 MiB, ele não será morto pelo kernel; em vez disso, passará a falhar no nível da aplicação, respeitando o cgroup.

---

## Sugestões para Aprofundamento

- Leia a documentação completa de [Resource constraints](https://docs.docker.com/engine/containers/resource_constraints/) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/)).
- Explore o [Compose file reference v2](https://docs.docker.com/compose/compose-file/compose-file-v2/) para outras opções de recursos.
- Entenda melhor [cgroup v2 vs v1](https://github.com/moby/moby/issues/42865) e suporte a OOM kill ([github.com](https://github.com/moby/moby/issues/42865?utm_source=chatgpt.com)).

> Desabilitar o OOM killer pode ser útil em certos cenários, mas faça isso sempre com cautela e acompanhado de limites de memória adequados.
>