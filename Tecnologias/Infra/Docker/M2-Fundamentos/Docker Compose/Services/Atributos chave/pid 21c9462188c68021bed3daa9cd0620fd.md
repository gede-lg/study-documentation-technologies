# pid

**Entendendo o atributo `pid` no Docker Compose**

---

## Introdução

O atributo `pid` na definição de serviços do Docker Compose permite configurar o modo de namespace de processos (PID namespace) dos contêineres gerenciados. Esse recurso controla como os processos dentro do contêiner visualizam e interagem com o espaço de processos do sistema operacional hospedeiro ou de outros contêineres. Ajustar corretamente o `pid` pode ser crucial para debugar aplicações, monitorar processos ou compartilhar informações de processo entre contêineres e host. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **PID Namespace:** Mecanismo do Linux que isola o espaço de identificação de processos. Em um namespace separado, os PIDs reiniciam a partir de 1 e não expõem processos do host. ([linkedin.com](https://www.linkedin.com/pulse/how-pid-works-docker-containers-pankaj-bhagat-dfese?utm_source=chatgpt.com))
- **Compartilhamento de PID:** Ao usar `pid: "host"`, o contêiner compartilha o mesmo namespace de processos do host, podendo ver e interagir com todos os processos do sistema hospedeiro. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com))
- **Isolamento padrão:** Por padrão, cada contêiner recebe seu próprio namespace de PID (`container`), garantindo isolamento e segurança. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **Valores suportados:**
    - `host`: compartilha o namespace de PID do host.
    - `container:<nome_ou_id>`: compartilha o namespace de PID de outro contêiner específico.
    - Outros modos podem existir em plataformas específicas (e.g., Kubernetes). ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com))

---

## Sintaxe Detalhada e Uso Prático

No Compose, o atributo `pid` é definido ao mesmo nível de `image`, `ports` e demais configurações de um serviço:

```yaml
version: "3.8"
services:
  app:
    image: alpine:latest
    command: sleep 3600
    pid: "host"         # 1) Compartilha namespace de PID do host
    # ou
    # pid: "container:db"  # 2) Compartilha com o contêiner ‘db’

```

1. **`pid: "host"`**
    - Torna visíveis no contêiner todos os processos do host. Útil para debug com ferramentas como `htop` ou `strace`. ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com))
2. **`pid: "container:<serviço>"`**
    - Permite ao contêiner “app” monitorar processos do contêiner “db”. Exige privilégios de capacidade (`SYS_PTRACE`) e segurança ajustada (`seccomp=unconfined`). ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com))

> Observação:
> 
> 
> A configuração de `pid` funciona somente em plataformas que suportam namespaces de PID (tipicamente Linux). Em ambientes Windows, o atributo pode ser ignorado ou gerar erro. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
> 

---

## Cenários de Restrição ou Não Aplicação

- **Ambientes Windows:** Namespaces de PID não são suportados nativamente, logo `pid` pode ser ignorado. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com))
- **Segurança:** Compartilhar o namespace de PID reduz isolamento e aumenta superfície de ataque. Evite em produção sem necessidade real.
- **Compose V1 antiga:** Algumas versões legadas (2.x) podem não reconhecer `pid` e falhar ao subir serviços. Atualize para Compose V2 (>=1.27.0).

---

## Componentes Chave Associados

- **`network_mode`** e **`ipc`** / **`uts`**: Outros namespaces isoláveis (rede, IPC, hostnames) que seguem lógica similar ao `pid`.
- **Permissões e Capacidades**: Para usar `pid: "host"` ou `container:…`, pode ser necessário `cap_add: ["SYS_PTRACE"]` e ajustes em `security_opt`.
- **`deploy.resources.pids`**: No contexto de Swarm/Deploy, controla limite numérico de processos (`pids_limit`), diferente de `pid` que escolhe o namespace. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))

---

## Melhores Práticas e Padrões de Uso

- **Uso restrito a debug:** Prefira `pid: "host"` apenas em ambientes de desenvolvimento ou debug, não em produção.
- **Documentação clara:** Deixe comentários no Compose explicando por que compartilha namespace, para evitar surpresas em manutenção.
- **Combine com healthchecks:** Quando compartilha PID, monitore processos críticos usando `healthcheck` e scripts de verificação.
- **Manter Compose atualizado:** Utilize sempre versões recentes que garantem suporte e correções para configuração de namespaces.

---

## Exemplo Prático Completo

Crie um `docker-compose.yml` que ilustre um cenário de debug de banco de dados PostgreSQL:

```yaml
version: "3.8"
services:
  db:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: example
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      retries: 5

  debug:
    image: alpine:latest
    command: sh -c "apk add --no-cache htop strace && htop"
    pid: "container:db"         # Compartilha o namespace de PID do serviço 'db'
    cap_add:
      - SYS_PTRACE             # Permite uso de strace
    security_opt:
      - seccomp=unconfined
    depends_on:
      db:
        condition: service_healthy

```

**Fluxo de uso:**

1. `docker-compose up -d db`
2. `docker-compose up debug`
3. Dentro do contêiner `debug`, rode `strace -p 1` para anexar ao processo do PostgreSQL no PID 1 do namespace compartilhado ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com)).

---

## Sugestões para Aprofundamento

- **Namespaces no Linux:** artigos sobre `man 7 namespaces`
- **Docker Engine CLI – PID Settings:** Seção `docker run --pid` na [referência oficial] ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/run/?utm_source=chatgpt.com))
- **Segurança em Containers:** modelos de hardening envolvendo namespaces e capabilities
- **Compose Specification GitHub:** Repositório oficial da especificação do Compose

---

Com essa explanação detalhada, você deve ser capaz de compreender, configurar e aplicar o atributo `pid` em seus projetos Docker Compose de forma segura e eficaz.