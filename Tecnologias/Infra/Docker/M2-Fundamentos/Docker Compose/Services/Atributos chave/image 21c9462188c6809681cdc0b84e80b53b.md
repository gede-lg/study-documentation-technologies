# image

**Título da Explicação:**

Entendendo o atributo `image` na definição de serviços do Docker Compose

---

## Introdução

No Docker Compose, cada serviço é definido como um conjunto de configurações que indicam como iniciar e gerenciar um ou mais containers. Dentre essas configurações, o atributo `image` é fundamental, pois determina qual imagem será usada como base para criar o container de um serviço. Esta explicação detalhada aborda desde os conceitos básicos até exemplos práticos e recomendações de uso.

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Formato e variantes
    - Exemplos comentados
3. [Interação com `build` e `pull_policy`](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#intera%C3%A7%C3%A3o-com-build-e-pull_policy)
4. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
5. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
6. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
7. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
8. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O atributo `image` especifica qual imagem — seja do Docker Hub, de um registry privado ou de uma imagem local — será utilizada para criar o container do serviço. Ele deve seguir a especificação de imagem endereçável do Open Container Initiative:

> [<registry>/][<namespace>/]<image>[:<tag>|@<digest>] (docs.docker.com)
> 
- **Registry** (opcional): domínio e porta do repositório (ex.: `myregistry.com:5000/`)
- **Namespace/Projeto** (opcional): agrupamento de imagens dentro do registry
- **Imagem**: nome do repositório da imagem (ex.: `nginx`)
- **Tag** (opcional): versão “legível” (ex.: `:latest`, `:1.21.0`)
- **Digest** (opcional): identificação imutável baseada em hash (ex.: `@sha256:…`)

Se a imagem não estiver presente localmente, o Compose tentará puxá-la do registry conforme a política de pull configurada (por padrão, `pull_policy: if_not_present`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sintaxe Detalhada e Uso Prático

### Formato e Variantes

```yaml
services:
  web:
    image: nginx             # usa 'nginx:latest' por padrão
  api:
    image: redis:6.2          # especifica uma tag exata
  db:
    image: postgres@sha256:0a1b2c…  # usa digest para imutabilidade
  private:
    image: myregistry.local:5000/app/backend:1.0.0

```

- **Omite a tag:** assume `:latest`.
- **Usa digest:** garante que sempre será puxada a mesma imagem, mesmo se `latest` mudar.
- **Registry privado:** basta prefixar o endereço e a porta.

### Exemplos Comentados

```yaml
  # Serviço que usa a imagem oficial do NGINX
  web:
    image: nginx:1.21.0      # define versão fixa, evita surpresas no 'latest'
    ports:
      - "8080:80"

  # Serviço que referencia uma imagem construída localmente
  worker:
    build: ./worker
    image: myapp/worker      # tagueia após build como 'myapp/worker:latest'

  # Serviço que força sempre pull antes de iniciar
  crawler:
    image: mycrawler:2.0
    pull_policy: always      # disponível no Compose v2.38.0+ :contentReference[oaicite:2]{index=2}

```

---

## Interação com `build` e `pull_policy`

Quando um serviço declara simultaneamente `build` e `image`, o Compose segue a política de pull definida:

- **Sem `pull_policy`:** tenta primeiro `docker pull`; se falhar (imagem não existir), faz `docker build` do contexto especificado ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com)).
- **`pull_policy: never`:** ignora o pull e faz apenas o build.
- **`pull_policy: always`:** sempre faz pull antes de opcionalmente executar o build, dependendo da existência local.

Isso ajuda em workflows de CI/CD, garantindo que versões oficiais sejam baixadas, mas permitindo builds locais quando necessário.

---

## Cenários de Restrição ou Não Aplicação

- **Serviços puramente locais:** se o serviço só deve ser construído (e nunca puxado), use apenas `build` com `pull_policy: never`.
- **Ambientes isolados sem acesso a registries:** omita `image` e conte apenas com `build`.
- **Manutenção de cache de build:** em projetos com atualizações contínuas, evitar `latest` impede builds desnecessários.
- **Uso de plugins de desenvolvimento (`develop.watch`):** serviços que utilizam assistência de *hot reload* nem sempre precisam de `image`, pois o Compose injeta código diretamente.

---

## Componentes Chave Associados

- **`build`**: define contexto e Dockerfile, cria imagem localmente.
- **`pull_policy`**: controla quando puxar imagens externas ([docs.docker.com](https://docs.docker.com/reference/compose-file/build/?utm_source=chatgpt.com)).
- **`depends_on`**: ordena startup, mas não garante saúde (use `healthcheck`).
- **`healthcheck`**: garante que um container só será considerado pronto após testes declarados.
- **`labels` e `annotations`**: metadata que pode referenciar imagens para ferramentas de orquestração e monitoramento.
- **`platform`**: força qual arquitetura da imagem (ex.: `linux/amd64`).
- **`env_file` / `environment`**: variáveis de ambiente que podem influenciar processos dentro do container, mas não afetam diretamente o atributo `image`.

---

## Melhores Práticas e Padrões de Uso

1. **Travar versões:** evite `:latest` em produção; prefira tags específicas ou digests.
2. **Usar digest em ambientes críticos:** garante imutabilidade e rastreabilidade de builds.
3. **Centralizar configuração de registry:** use `.env` ou profiles para não espalhar credenciais.
4. **Definir `pull_policy` adequadamente:** em pipelines, `always` garante uso de imagens oficialmente publicadas.
5. **Nomear imagens uniformemente:** use convenções `<empresa>/<projeto>:<versão>` para clareza em registries.
6. **Limpar imagens locais com `docker system prune`:** mantém o ambiente de build leve.

---

## Exemplo Prático Completo

```yaml
version: "3.9"

services:
  web:
    image: nginx:1.21.0
    ports:
      - "8080:80"
    networks:
      - frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  api:
    build:
      context: ./api
      dockerfile: Dockerfile.prod
    image: myorg/api:2.5.1
    pull_policy: if_not_present
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgres://user:pass@db:5432/app
    networks:
      - backend

  db:
    image: postgres:13
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - backend

networks:
  frontend:
  backend:

volumes:
  db_data:

```

Neste exemplo:

- `web` usa imagem oficial e define `healthcheck`.
- `api` combina `build` e `image`, tagueando após o build e puxando apenas se não existir localmente.
- `db` puxa uma imagem PostgreSQL com tag fixa.

---

## Sugestões para Aprofundamento

- Explore a [**Compose Specification**](https://docs.docker.com/reference/compose-file/) para detalhes avançados.
- Entenda como funciona o **OCI Image Format** para criação e armazenamento de imagens.
- Avalie ferramentas de CI/CD (GitHub Actions, GitLab CI) integradas ao fluxo de build/push de imagens.
- Pesquise sobre **multi-stage builds** para otimização de tamanho de imagens e segurança.

---

Com este guia, você possui uma visão completa do atributo `image` no Docker Compose, desde sua definição até práticas avançadas de uso em cenários reais.