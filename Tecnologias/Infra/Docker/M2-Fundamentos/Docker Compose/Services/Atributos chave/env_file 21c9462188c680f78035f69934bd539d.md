# env_file

**Entendendo o atributo `env_file` no Docker Compose**

---

## 1. Introdução

O Docker Compose é uma ferramenta que simplifica a definição e o gerenciamento de ambientes multicontêiner através de um arquivo YAML. Nesse contexto, o atributo `env_file`, presente dentro de cada serviço, permite carregar variáveis de ambiente de arquivos externos diretamente para o contêiner, separando as configurações sensíveis do próprio `docker-compose.yml` e promovendo organização e reuso da configuração ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

---

## 2. Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## 3. Conceitos Fundamentais

- **O que é `env_file`:** é um atributo do serviço que especifica um ou mais arquivos contendo pares `CHAVE=VALOR`. Ao subir o serviço, o Compose injeta essas variáveis no ambiente do contêiner ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
- **Separação de responsabilidades:** em vez de repetir `environment:` para cada variável, mantém-se um arquivo dedicado (.env ou outro nome), facilitando manutenção e segurança (evita expor segredos no YAML).
- **Diferença para o `.env` de interpolação:** o `.env` na raiz do projeto é usado pelo CLI para interpolar variáveis no próprio `docker-compose.yml`, mas não é automaticamente carregado no contêiner — para isso, usa-se `env_file` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

---

## 4. Sintaxe Detalhada e Uso Prático

### 4.1. Formato Básico (string ou lista de strings)

```yaml
services:
  webapp:
    image: myapp:latest
    # Carrega variáveis de 'webapp.env'
    env_file: "webapp.env"

```

ou

```yaml
services:
  webapp:
    image: myapp:latest
    # Carrega múltiplos arquivos, em ordem
    env_file:
      - "./env/common.env"
      - "./env/webapp.env"

```

*As paths são relativas ao local do arquivo `docker-compose.yml` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).*

### 4.2. Forma Avançada (mapping)

A partir do Compose v2.24.0, é possível tornar o arquivo opcional e especificar formato personalizado:

```yaml
services:
  webapp:
    image: myapp:latest
    env_file:
      - path: ./default.env
        required: true    # padrão: erro se faltar
      - path: ./override.env
        required: false   # ignora se não existir
      - path: ./secrets.env
        format: dotenv    # v2.30.0+: permite escolha de formato

```

`*required: false` evita falhas em ambientes que não usam todos os arquivos ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).*

---

## 5. Cenários de Restrição ou Não Aplicação

- **Interpolação não suportada em `docker run`:** a interpolação (`${VAR}`) em arquivos passados por `-env-file` só funciona via CLI do Compose, não no `docker run --env-file` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
- **Variáveis sensíveis críticas:** para segredos (senhas, tokens), prefira o recurso de `secrets` em vez de arquivos `.env` visíveis no repositório ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
- **Conflitos de precedência:** variáveis definidas em `environment:` ou via `docker compose run -e` têm prioridade sobre `env_file` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

---

## 6. Componentes Chave Associados

| Componente | Descrição |
| --- | --- |
| **`.env` raiz** | Arquivo usado para interpolar variáveis no YAML (`${VAR}`), carregado automaticamente pelo CLI. |
| **`env_file`** | Atributo de serviço; injeta variáveis de arquivos externos no contêiner. |
| **`environment`** | Atributo de serviço; define variáveis inline ou repassa as do shell. |
| **`required`** | Subcampo de `env_file`; controla se falta do arquivo deve gerar erro ou ser ignorada. |
| **`format`** | Subcampo (v2.30.0+); permite especificar o formato do arquivo (ex.: `dotenv`, `json`). |
| **Interpolação** | Recurso do CLI para substituir `${VAR}` no YAML e em arquivos `.env` gerenciados pelo Compose. |

---

## 7. Melhores Práticas e Padrões de Uso

1. **Organização por ambiente:** mantenha arquivos como `.env.dev`, `.env.prod`, referenciados conforme o perfil de deploy.
2. **Evite expor segredos:** use `secrets:` para dados sensíveis, reservando `env_file` para configurações não críticas.
3. **Use `required: false` em CI/CD:** para evitar falhas em pipelines que não disponham de todos os arquivos locais.
4. **Combine com `environment:` para valores obrigatórios:** filtros ou valores gerados em runtime podem ficar no `environment:` enquanto o restante no `env_file`.
5. **Documente seus arquivos:** inclua comentários no próprio `.env` e no YAML, explicando a finalidade de cada variável.

---

## 8. Exemplo Prático Completo

Imagine um serviço web que necessita de credenciais de banco e algumas flags de debug:

```bash
# env/database.env
DB_HOST=db.prod.internal
DB_USER=admin
DB_PASS=SuperS3cret

```

```bash
# env/feature-flags.env
FEATURE_ALPHA=true
FEATURE_BETA=false

```

```yaml
# docker-compose.yml
version: '3.9'

services:
  web:
    image: minhaapi:latest
    env_file:
      - ./env/database.env
      - path: ./env/feature-flags.env
        required: false
    environment:
      # Valor inline de exemplo
      LOG_LEVEL: "${LOG_LEVEL:-info}"
    ports:
      - "8080:8080"
    depends_on:
      - db

  db:
    image: postgres:15
    env_file: ./env/database.env
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  db-data:

```

**Fluxo de execução:**

1. Ao `docker compose up`, o Compose carrega **database.env** e injeta as variáveis em ambos os serviços (`web` e `db`).
2. Tenta carregar **feature-flags.env** no `web`; se não existir, ignora sem erro (graças a `required: false`).
3. Variável `LOG_LEVEL` é avaliada com default `info` caso não definida no shell.

---

## 9. Sugestões para Aprofundamento

- **Interpolação de variáveis** (`${VAR}`) e precedência entre `environment`, `env_file` e shell ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/))
- **Uso de `secrets:`** para dados realmente sensíveis
- **Perfis de Compose (`profiles:`)** para alternar entre conjuntos de serviços e variáveis
- **Compose Specification** completa (seção `env_file`) em [https://docs.docker.com/compose/compose-file/compose-file-v3/#env_file](https://docs.docker.com/compose/compose-file/compose-file-v3/#env_file)
- **Como o Compose carrega `.env`**: detalhes em [https://docs.docker.com/compose/how-tos/environment-variables/interpolation/](https://docs.docker.com/compose/how-tos/environment-variables/interpolation/)