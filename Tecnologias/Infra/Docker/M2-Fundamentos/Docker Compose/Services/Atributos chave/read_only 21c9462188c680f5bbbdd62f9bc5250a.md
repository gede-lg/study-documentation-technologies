# read_only

**Título da Explicação:** Atributo `read_only` no Docker Compose (Services)

---

## Introdução

No Docker Compose, o atributo `read_only` aplicado em um serviço instrui o engine a montar o sistema de arquivos raiz do container em modo somente leitura, removendo a camada de escrita padrão. Isso reforça princípios de infraestrutura imutável e pode aumentar a segurança ao impedir modificações indesejadas no container durante a execução ([stackoverflow.com](https://stackoverflow.com/questions/19158810/docker-mount-volumes-as-readonly?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#1-conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#2-sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#3-cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#4-componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#5-melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#6-exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#7-sugest%C3%B5es-para-aprofundamento)

---

## 1. Conceitos Fundamentais

**1.1. Camadas de Sistema de Arquivos**

Cada container possui camadas sobrepostas: as camadas de imagem (imutáveis) e uma camada superior de container, onde ocorrem gravações. Ao ativar `read_only`, a camada de container deixa de existir, transformando o sistema de arquivos inteiro em somente leitura ([superuser.com](https://superuser.com/questions/1630894/how-to-setup-docker-in-read-only-mode-in-docker-compose?utm_source=chatgpt.com)).

**1.2. Segurança e Immutable Infrastructure**

Montar o filesystem como somente leitura reduz vetores de ataque, pois impede que processos maliciosos gravem arquivos arbitrários na raiz do container. Essa abordagem reforça práticas de infraestrutura imutável e atende controles como o CIS Docker Benchmark (controle 5.12) ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/byb-wyq-f3q/?utm_source=chatgpt.com)).

---

## 2. Sintaxe Detalhada e Uso Prático

### 2.1. Sintaxe no Compose (Short Form)

```yaml
version: "3.8"
services:
  meu_servico:
    image: minha/imagem:latest
    read_only: true     # monta o rootfs como somente leitura
    command: ["sleep", "3600"]

```

- **`version`**: a partir de 2.1 (com suporte completo em 3.x).
- **`read_only: true`**: sinaliza a engine a usar o equivalente a `docker run --read-only`.
- Escritas em qualquer diretório não montado falharão com erro “Read-only file system” ([superuser.com](https://superuser.com/questions/1630894/how-to-setup-docker-in-read-only-mode-in-docker-compose?utm_source=chatgpt.com)).

### 2.2. Equivalência na CLI

Para rodar sem Compose, o flag equivalente é:

```bash
docker run --read-only minha/imagem:latest sleep 3600

```

Aqui, o container perde seu layer de escrita, exigindo volumes ou tmpfs para diretórios que precisem ser graváveis ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/byb-wyq-f3q/?utm_source=chatgpt.com)).

### 2.3. Montagem de Volumes e tmpfs

Para contornar a restrição em diretórios específicos, use:

```yaml
services:
  meu_servico:
    image: minha/imagem:latest
    read_only: true
    volumes:
      - logs:/var/log/app     # named volume, gravável
    tmpfs:
      - /tmp                  # tmpfs, gravável em memória
volumes:
  logs:

```

Dessa forma, `/var/log/app` e `/tmp` permanecem graváveis, enquanto o restante do FS é somente leitura ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com)).

---

## 3. Cenários de Restrição ou Não Aplicação

- **Windows Containers:** não suporta rootfs somente leitura. Tentações de usar `-read-only` resultam em erro:
    
    ```
    Windows does not support root filesystem in read-only mode.
    
    ```
    
    ([forums.docker.com](https://forums.docker.com/t/windows-does-not-support-root-filesystem-in-read-only-mode/86382?utm_source=chatgpt.com)).
    
- **Aplicações Legadas:** frameworks que gravam diretamente no filesystem (logs, caches, PIDs) sem usar volumes verão falhas.
- **Orquestradores antigos:** versões muito antigas do Docker Swarm ou Compose podem ignorar `read_only`.

---

## 4. Componentes Chave Associados

- **`read_only` (Compose)**: atributo de serviço que monta o filesystem do container em modo somente leitura.
- **`-read-only` (CLI)**: flag de `docker run` equivalente.
- **Instrução `VOLUME` (Dockerfile)**: marca diretórios que a imagem espera graváveis, garantindo criação de volumes anônimos ([superuser.com](https://superuser.com/questions/1630894/how-to-setup-docker-in-read-only-mode-in-docker-compose?utm_source=chatgpt.com)).
- **Volumes / tmpfs**: montagens que permitem escrita em diretórios específicos mesmo com `read_only` ativo.

---

## 5. Melhores Práticas e Padrões de Uso

1. **Defina diretórios graváveis:** sempre monte `/tmp`, `/var/log`, `/run`, ou qualquer pasta de dados em volumes ou tmpfs.
2. **Use `VOLUME` no Dockerfile:** oriente usuários de sua imagem sobre locais de escrita esperados.
3. **Automatize auditoria:** valide configurações com
    
    ```bash
    docker inspect \
      --format '{{ .Name }}: ReadonlyRootfs={{ .HostConfig.ReadonlyRootfs }}' \
      $(docker ps -aq)
    
    ```
    
4. **Combine com CIS/DQ:** `read_only` alinha-se ao controle CIS 5.12 e reduz riscos de alteração não autorizada ([docs.datadoghq.com](https://docs.datadoghq.com/security/default_rules/byb-wyq-f3q/?utm_source=chatgpt.com)).
5. **Planeje volumes declarativos:** evite montagens impulsivas; prefira volumes named ou bind mounts com controle de permissão.

---

## 6. Exemplo Prático Completo

```yaml
version: "3.8"

services:
  webapp:
    image: nginx:alpine
    read_only: true            # monta rootfs somente leitura
    ports:
      - "8080:80"
    volumes:
      - logs:/var/log/nginx    # gravação persistente de logs
    tmpfs:
      - /tmp                   # escrita volátil em memória

volumes:
  logs:
    driver: local

```

**Explicações:**

- O container `webapp` roda com sistema de arquivos principal imutável.
- Logs do Nginx vão para o volume `logs`, garantindo persistência.
- `/tmp` é um sistema de arquivos em memória (tmpfs), ideal para dados temporários.

---

## 7. Sugestões para Aprofundamento

- **Compose Specification:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/?utm_source=chatgpt.com))
- **CIS Docker Benchmark:** Controle 5.12 - Immutability
- **Dockerfile Volumes:** entender a instrução `VOLUME`
- **Orquestração Avançada:** usar `read_only` em Swarm e Kubernetes (pod security policies)

Este guia cobre de forma detalhada o atributo `read_only` em serviços Docker Compose, mostrando desde sua fundamentação até exemplos práticos de uso.