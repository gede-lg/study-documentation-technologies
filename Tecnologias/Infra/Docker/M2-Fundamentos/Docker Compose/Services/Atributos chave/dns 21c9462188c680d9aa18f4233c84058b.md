# dns

**Título da Explicação:** Configuração do atributo `dns` na chave `services` do Docker Compose

---

**Introdução**

No Docker Compose, cada serviço definido na chave `services` pode herdar ou sobrescrever as configurações de DNS do host. Por padrão, containers utilizam os mesmos servidores DNS configurados no arquivo `/etc/resolv.conf` do host ou, quando conectados a redes customizadas, recorrem ao servidor DNS embutido do Docker que, por sua vez, repassa as consultas para os servidores do host ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)). O atributo `dns` permite especificar servidores DNS personalizados para cada container, mapeando diretamente para a flag `--dns` do comando `docker run` ([github.com](https://github.com/compose-spec/compose-spec/blob/main/05-services.md?utm_source=chatgpt.com)).

---

**Sumário**

- Conceitos Fundamentais
- Sintaxe Detalhada e Uso Prático
- Cenários de Restrição ou Não Aplicação
- Componentes Chave Associados
- Melhores Práticas e Padrões de Uso
- Exemplo Prático Completo
- Sugestões para Aprofundamento

---

### Conceitos Fundamentais

1. **DNS (Domain Name System):** Sistema responsável por traduzir nomes de domínio em endereços IP. Containers Docker, assim como sistemas tradicionais, dependem de servidores DNS para resolver nomes de host em redes internas e externas.
2. **Comportamento Padrão:**
    - **Rede *bridge* padrão:** O container recebe uma cópia do `/etc/resolv.conf` do host.
    - **Rede customizada:** O Docker insere um servidor DNS interno que resolve nomes de serviço dentro do *network* e encaminha demais consultas ao DNS do host ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).
3. **Atributo `dns`:** Define um ou vários servidores DNS que serão configurados no *network interface* do container. Essa definição sobrepõe completamente as configurações herdadas do host ([github.com](https://github.com/compose-spec/compose-spec/blob/main/05-services.md?utm_source=chatgpt.com)).

---

### Sintaxe Detalhada e Uso Prático

O atributo `dns` pode ser definido como:

- **Valor único (string):** Quando há apenas um servidor DNS.
- **Lista de valores (array de strings):** Para múltiplos servidores, avaliados em ordem.

```yaml
version: '3.8'
services:
  app:
    image: myimage:latest
    dns:
      - "192.168.1.100"  # Servidor DNS interno primário
      - "8.8.8.8"        # Fallback para DNS público

```

- **Comentário de cada linha:**
    - `dns:` inicia a definição de servidores.
    - Cada entrada dentro da lista (`"IP"`) corresponde a uma flag `-dns IP` na execução real do container.
- **Compatibilidade de versões:** Funciona nas versões 2.x e 3.x do Compose, bem como na especificação unificada do Compose V2 ([stackoverflow.com](https://stackoverflow.com/questions/41717180/docker-compose-container-using-host-dns-server?utm_source=chatgpt.com)) ([github.com](https://github.com/compose-spec/compose-spec/blob/main/05-services.md?utm_source=chatgpt.com)).

---

### Cenários de Restrição ou Não Aplicação

1. **Modo `network_mode: host`:** O container compartilha a stack de rede do host; atributos como `dns` não têm efeito, pois não há namespace de rede isolado ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).
2. **Deploy em Swarm com `endpoint_mode`:** Para descoberta de serviços em Swarm, usa-se `deploy.endpoint_mode: dnsrr` ou `vip`, não o atributo `dns` do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).
3. **Drivers de rede personalizados ou terceiros:** Alguns drivers podem ignorar ou sobrescrever as configurações de DNS aplicadas pelo Compose; é importante verificar a documentação do driver em uso.

---

### Componentes Chave Associados

- **`dns_search`:** Domínios de busca adicionais para resolver nomes não totalmente qualificados (flag `-dns-search`). Permite adicionar sufixos automáticos.
- **`dns_options`:** Opções específicas de resolução de DNS (flag `-dns-option`), como `ndots:2`.
- **`domainname`:** Define o domínio DNS do container (flag `-domainname`).
- **`extra_hosts`:** Mapeia nomes para IPs estáticos no `/etc/hosts` do container, complementando ou substituindo o DNS ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/41717180/docker-compose-container-using-host-dns-server?utm_source=chatgpt.com)).

---

### Melhores Práticas e Padrões de Uso

- **Use DNS interno para descoberta de serviços:** Para comunicação entre containers no mesmo *network*, confie no DNS interno do Docker em vez de servidores externos.
- **Somente defina `dns` para serviços que dependam de resoluções externas específicas:** Ex.: consultar serviços internos de empresa, serviços de nuvem privada ou servidores DNS corporativos.
- **Evite conflitar com o DNS do host:** Definir servidores públicos sem necessidade pode degradar performance; utilize variáveis de ambiente ou arquivos de configuração externa para parametrizar esses valores.
- **Combine `dns`, `dns_search` e `dns_options`:** Por exemplo, `dns_search: ["corp.local"]` e `dns_options: ["ndots:2"]` garantem que nomes curtos sejam corretamente qualificados sem múltiplos pontos ([github.com](https://github.com/compose-spec/compose-spec/blob/main/05-services.md?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).

---

### Exemplo Prático Completo

No cenário abaixo, temos um serviço que precisa resolver tanto domínios internos quanto públicos:

```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    dns:
      - "10.0.0.2"       # DNS interno da corporação
      - "8.8.4.4"        # Fallback DNS Google
    dns_search:
      - "corp.local"     # Sufixo para domínios internos
    dns_options:
      - "ndots:3"        # Reduz tentativas de fallback

```

No exemplo, as consultas a `service.part.corp.local` usarão primeiro `10.0.0.2`, aplicando o sufixo `corp.local` automaticamente, e só então recorrerão ao Google DNS como última instância ([github.com](https://github.com/compose-spec/compose-spec/blob/main/05-services.md?utm_source=chatgpt.com)).

---

### Sugestões para Aprofundamento

- **Documentação Oficial Docker Compose:**
    
    [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
    
- **Compose Specification (GitHub):**
    
    [https://github.com/compose-spec/compose-spec/blob/main/05-services.md](https://github.com/compose-spec/compose-spec/blob/main/05-services.md)
    
- **Networking no Docker Engine:**
    
    [https://docs.docker.com/engine/network/](https://docs.docker.com/engine/network/)
    

Caso precise de insights avançados, explore artigos sobre DNS embutido do Docker e sobre como o Swarm Mode gerencia descoberta de serviço via DNS.