# networks

**Título da Explicação:** Entendendo o atributo `networks` na chave `services` no Docker Compose

---

## Introdução

O Docker Compose permite orquestrar múltiplos containers de forma declarativa, agrupando definições de serviços, volumes e redes em um único arquivo YAML (`docker-compose.yml`). O atributo `networks`, inserido dentro de cada serviço, especifica a quais redes aquele serviço deve se conectar, controlando como os containers se comunicam entre si e com o ambiente externo ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Sintaxe Curta
    - Sintaxe Longa
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

O atributo `services.<nome_do_serviço>.networks` define quais redes — previamente declaradas no nível superior `networks` — aquele serviço irá integrar. Isso permite:

- **Segmentação de tráfego e isolamento**: Serviços em redes diferentes não se enxergam, garantindo segurança e organização de dependências ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)).
- **Descoberta de serviços**: Containers no mesmo namespace de rede podem se resolver por DNS usando o nome de serviço ou aliases configurados ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Controle avançado de configuração**: A sintaxe longa oferece atributos como `aliases`, `ipv4_address`, `interface_name` e prioridades de gateway, permitindo personalização fina de IPAM e interfaces ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## Sintaxe Detalhada e Uso Prático

### Sintaxe Curta

Lista simples de nomes de rede, referenciando entradas em `networks` no topo do arquivo:

```yaml
services:
  web:
    image: nginx:latest
    networks:
      - frontend
      - backend

```

- **Vantagem**: Clareza e simplicidade para a maioria dos casos de uso.
- **Referência**: ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

### Sintaxe Longa

Permite especificar configurações por rede *dentro* do serviço:

```yaml
services:
  api:
    image: my-api
    networks:
      frontend:
        aliases:
          - api.local
      backend:
        ipv4_address: 172.18.0.10
        interface_name: eth1
        gw_priority: 5

```

- **`aliases`**: Define nomes adicionais para resolução DNS na rede ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **`ipv4_address` / `ipv6_address`**: Atribui IPs estáticos, exigindo configuração de IPAM no nível top-level ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **`interface_name`**: Controla o nome da interface dentro do container (ex.: `eth1`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))
- **`gw_priority`**: Escolhe qual rede será gateway padrão, quando múltiplas redes estiverem presentes ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

## Cenários de Restrição ou Não Aplicação

- **Uso de `network_mode`**: Se `network_mode` (ex.: `host`, `none` ou `service:…`) for definido, o atributo `networks` não é permitido e o Compose rejeita o arquivo ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Rede implícita padrão**: Na ausência total de `networks`, cada serviço conecta-se automaticamente a uma rede `default` gerada pelo Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Contêiner isolado**: Para casos sem necessidade de rede (jobs one-shot, tarefas batch), usar `network_mode: none` em vez de declarar `networks`.

---

## Componentes Chave Associados

| Atributo | Descrição | Exemplo |
| --- | --- | --- |
| `aliases` | **DNS aliases** adicionais para o serviço na rede. | `aliases: ["db.local"]` |
| `ipv4_address` | **IP estático** IPv4 dentro do `subnet` configurado em IPAM no top-level `networks`. | `ipv4_address: 172.28.5.5` |
| `ipv6_address` | **IP estático** IPv6, requer IPAM com subnet IPv6. | `ipv6_address: "2001:db8::5"` |
| `interface_name` | Nome da **interface de rede** dentro do container (ex.: `eth0`, `eth1`). | `interface_name: eth1` |
| `link_local_ips` | Lista de **IPs link-local** para comunicação em sub-redes específicas. | `link_local_ips: ["169.254.1.2"]` |
| `mac_address` | **MAC address** configurada para a interface na rede. | `mac_address: "02:42:ac:11:65:43"` |
| `gw_priority` | Define qual rede será escolhida como **gateway padrão** (maior valor). | `gw_priority: 10` |
| `priority` | Ordem de **conexão** às redes (disciplina a sequência de attachments). | `priority: 1000` |

> Observação: Todos os componentes acima só funcionam com sintaxe longa, e alguns exigem versões mínimas do Docker Compose (docs.docker.com).
> 

---

## Melhores Práticas e Padrões de Uso

1. **Defina redes no nível top-level** (`networks`) e evite criar redes “inline” em serviços, para manter o arquivo organizado e reutilizável ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)).
2. **Use nomes descritivos** (ex.: `frontend`, `backend`, `db-network`) para facilitar manutenção e comunicação da equipe.
3. **Isolamento de ambientes**: em produção, separe redes por camada de aplicação (web, app, banco), garantindo segurança ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com)).
4. **Empregue IPAM customizado** quando precisar de controle rígido de sub-redes, evitando conflitos de IP e facilitando troubleshooting.
5. **Aliases e DNS**: prefira aliases para manter compatibilidade entre stacks e testes locais, sem precisar alterar configurações de aplicação.
6. **External networks**: use `external: true` para conectar serviços Compose a redes gerenciadas fora do Compose (ex.: rede de overlay em swarm) ([docs.docker.com](https://docs.docker.com/reference/compose-file/networks/?utm_source=chatgpt.com)).

---

## Exemplo Prático Completo

```yaml
version: "3.8"

services:
  proxy:
    image: nginx:alpine
    networks:
      public:
      internal:
        aliases:
          - proxy.local

  app:
    build: ./app
    networks:
      internal:
        ipv4_address: 172.20.0.10
        interface_name: eth0
        gw_priority: 5
      db_net:
        aliases:
          - app-db
        priority: 100

  db:
    image: postgres:14
    networks:
      db_net:
        ipv4_address: 172.30.0.5

networks:
  public:
    driver: bridge

  internal:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "172.20.0.0/16"

  db_net:
    driver: bridge
    ipam:
      config:
        - subnet: "172.30.0.0/24"

```

Neste cenário:

- O **proxy** expõe o frontend na rede pública e usa alias `proxy.local` na rede interna.
- A **app** tem IP estático na sub-rede interna (172.20.0.0/16) e participa de `db_net` com alias para comunicação direta com o banco.
- O **db** recebe IP estático na rede de banco (`db_net`).

---

## Sugestões para Aprofundamento

- Guia oficial de [Networking in Compose How-Tos](https://docs.docker.com/compose/how-tos/networking/) ([docs.docker.com](https://docs.docker.com/compose/how-tos/networking/?utm_source=chatgpt.com))
- [Compose Specification – Networking](https://github.com/compose-spec/compose-spec/blob/master/spec.md#networks)
- Documentação de [Docker Engine Networking](https://docs.docker.com/engine/reference/commandline/network/)

Espero que esta explicação detalhada ajude você a configurar e otimizar redes no Docker Compose de forma segura e eficiente!