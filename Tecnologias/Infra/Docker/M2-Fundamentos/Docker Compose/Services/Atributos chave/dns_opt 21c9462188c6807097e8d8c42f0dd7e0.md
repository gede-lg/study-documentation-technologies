# dns_opt

# Entendendo o atributo `dns_opt` em serviços do Docker Compose

## Introdução

No Docker Compose, a configuração de DNS de cada container é baseada no arquivo `/etc/resolv.conf`. O atributo `dns_opt` permite **personalizar as opções** passadas ao resolvedor de nomes dentro do container, ajustando seu comportamento de acordo com necessidades específicas de rede ou performance.

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#1-conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#2-sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#3-cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#4-componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#5-melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#6-exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#7-sugest%C3%B5es-para-aprofundamento)

---

## 1. Conceitos Fundamentais

- **Resolv.conf e opções de DNS**
    
    O arquivo `/etc/resolv.conf` controla como o stub resolver faz consultas DNS (por exemplo, servidores `nameserver`, domínios de busca e opções).
    
    As *options* são parâmetros que ajustam o algoritmo de resolução — como forçar TCP ao invés de UDP (`use-vc`), não tentar tratar nomes sem pontos como TLDs (`no-tld-query`), definir número mínimo de pontos (`ndots:5`), dentre outros ([man7.org](https://man7.org/linux/man-pages/man5/resolv.conf.5.html?utm_source=chatgpt.com)).
    
- **Propagação via Docker Compose**
    
    O Compose espelha essas configurações dentro do container, permitindo que você especifique:
    
    - Servidores DNS (`dns`)
    - Domínios de busca (`dns_search`)
    - Opções de DNS (`dns_opt`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Suporte por versões**
    
    Esse atributo foi introduzido no Compose file version 2.0 e está disponível em todas as versões do Compose que implementam a especificação unificada (>= 1.27.0). ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com))
    

---

## 2. Sintaxe Detalhada e Uso Prático

No `docker-compose.yml`, `dns_opt` é sempre uma **lista de strings**. Cada string corresponde a uma opção aceita por `resolv.conf`.

```yaml
version: '2.4'  # ou '3.x' em spec unificada
services:
  app:
    image: nginx:latest
    dns:            # servidores DNS (opcional)
      - 8.8.8.8
      - 8.8.4.4
    dns_search:     # domínios de busca (opcional)
      - example.com
      - corp.example.com
    dns_opt:        # opções de DNS
      - use-vc           # força uso de TCP em vez de UDP
      - no-tld-query     # não trata nomes sem pontos como TLD
      - ndots:5          # mínimo de 5 pontos antes de considerar FQDN
      - timeout:2        # timeout de 2 segundos por tentativa

```

- **List vs. Única entrada**
    
    Mesmo para uma única opção, use sempre o formato de lista:
    
    ```yaml
    dns_opt:
      - single-request
    
    ```
    
- **Valores aceitos**
    
    Consulte o manual do seu SO (`man resolv.conf`) para opções válidas ([man7.org](https://man7.org/linux/man-pages/man5/resolv.conf.5.html?utm_source=chatgpt.com)).
    

---

## 3. Cenários de Restrição ou Não Aplicação

1. **`network_mode: host`**
    
    Nesse modo, o container usa diretamente a pilha de rede do host, herdando seu `/etc/resolv.conf`; `dns_opt` não terá efeito.
    
2. **Redes com DNS embutido**
    
    Em redes customizadas (driver `bridge`, `overlay`), o Docker usa um DNS interno para resolução de nomes de containers; nem todas as opções do stub resolver podem ser respeitadas.
    
3. **Docker Swarm / `docker stack deploy`**
    
    A seção `dns_opt` em serviços não é aplicada pelo Swarm Mode (apenas via CLI `docker service create`).
    
4. **SO sem suporte à opção**
    
    Se a versão da glibc ou do resolvedor não reconhecer uma opção, ela será ignorada.
    

---

## 4. Componentes Chave Associados

- **`dns`** e **`dns_search`**: configuram, respectivamente, servidores DNS e domínios de busca.
- **`dns_opt`**: lista de *options* para `/etc/resolv.conf`.
- **CLI Flags**:
    - `-dns-opt` no `docker run` tem comportamento equivalente ([docs.docker.com](https://docs.docker.com/engine/network/?utm_source=chatgpt.com)).
- **`resolv.conf`**: onde as opções são efetivamente aplicadas.

---

## 5. Melhores Práticas e Padrões de Uso

- **Evitar sobreconfiguração**: só adicione opções realmente necessárias (p.ex. `ndots` para ambientes de múltiplos subdomínios).
- **Testar localmente**: valide o comportamento com `docker-compose up` e `docker exec CONTAINER cat /etc/resolv.conf`.
- **Documentar**: liste no README do projeto por que cada `dns_opt` foi inserido.
- **Fallback seguro**: garanta múltiplos servidores em `dns` para redundância.

---

## 6. Exemplo Prático Completo

Um cenário de microserviço que precisa de resolução rápida e robusta em rede corporativa:

```yaml
version: '2.4'
services:
  api:
    image: myorg/api:latest
    dns:
      - 10.0.0.10
      - 10.0.0.11
    dns_search:
      - corp.local
    dns_opt:
      - ndots:2
      - timeout:1
      - rotate
      - single-request
    networks:
      - backend
  db:
    image: postgres:14
    networks:
      - backend

networks:
  backend:
    driver: bridge

```

Nesse exemplo, definimos:

- **`ndots:2`**: reduz o número de consultas a domínios completos, melhorando performance interna.
- **`timeout:1`** e **`rotate`**: tenta cada servidor por 1s e alterna ao invés de sempre usar o primeiro.
- **`single-request`**: evita falhas em servidores que não suportam consultas paralelas IPv4/IPv6.

---

## 7. Sugestões para Aprofundamento

- [Compose Specification (GitHub)](https://github.com/compose-spec/compose-spec)
- [Documentação oficial de [resolv.conf]](https://man7.org/linux/man-pages/man5/resolv.conf.5.html) ([man7.org](https://man7.org/linux/man-pages/man5/resolv.conf.5.html?utm_source=chatgpt.com))
- Seção “Networking” da documentação Docker Engine
- Artigos sobre tuning de DNS em ambientes Linux

---

*Com esta explicação, você terá uma visão completa de como o Docker Compose manipula opções de DNS e como aproveitá-las para otimizar a resolução de nomes dentro de containers.*