# environment

**Título da Explicação:**

Entendendo o atributo **`environment`** em **`services`** do Docker Compose

---

## 1. Introdução

Em aplicações conteinerizadas, variáveis de ambiente são essenciais para configurar comportamentos de serviços sem alterar imagens ou código-fonte. No Docker Compose, o atributo `environment` define explicitamente essas variáveis dentro de cada serviço, garantindo portabilidade e consistência entre ambientes de desenvolvimento, teste e produção ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

---

## 2. Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 3. Conceitos Fundamentais

- **Variáveis de Ambiente:** pares *chave=valor* disponíveis dentro do processo do container, usadas para configurar desde níveis de *logging* até credenciais de serviços externos.
- **Atributo `environment`:** em `services`, é o mecanismo nativo do Compose para inserir essas variáveis diretamente no container ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
- **Importância:** isola configurações de ambiente do *build* da imagem, possibilita reuso de configurações em múltiplos serviços e facilita o versionamento do *deployment*.

---

## 4. Sintaxe Detalhada e Uso Prático

### 4.1. Formas de Declaração

- **Mapping (YAML):**
    
    ```yaml
    services:
      webapp:
        environment:
          DEBUG: "true"
          LOG_LEVEL: "info"
    
    ```
    
- **List (Strings):**
    
    ```yaml
    services:
      webapp:
        environment:
          - DEBUG=true
          - LOG_LEVEL=info
    
    ```
    

Ambas são equivalentes ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

### 4.2. Passagem de Variáveis do Host

É possível declará-las sem valor para replicar a variável do *shell*:

```yaml
services:
  web:
    environment:
      - DEBUG

```

O Compose injeta `DEBUG` do ambiente local no container, sem aviso se não definido ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

### 4.3. Interpolação com `.env`

Use `${VAR}` para interpolar valores de um arquivo `.env` ou do *shell*. Se `VAR` não existir, há opções de:

- `${VAR:-default}` → usa `default`
- `${VAR:?err}` → falha com erro `err`
    
    Exemplo:
    

```yaml
services:
  api:
    environment:
      - DATABASE_URL=${DATABASE_URL}

```

Gera aviso se `DATABASE_URL` não estiver definido ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).

### 4.4. Arquivo `.env` e `env_file`

- **`.env` (default):** colocado ao lado do `docker-compose.yml`, define variáveis para interpolação e pode ser referenciado em `environment`.
- **`env_file`:** lista de arquivos `.env` que o Compose carrega, mantendo o YAML mais limpo:
    
    ```yaml
    services:
      webapp:
        env_file:
          - webapp.env
          - override.env
    
    ```
    
    Os arquivos são avaliados em ordem e permitem sobreposição de valores ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
    

---

## 5. Cenários de Restrição ou Não Aplicação

- **Dados Sensíveis:** não usar `environment` para senhas ou chaves secretas; utilize Docker Secrets em modo Swarm ou Kubernetes Secrets ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/), [docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/)).
- **Muitos Parâmetros:** para projetos com dezenas de variáveis, prefira `env_file` ou sistemas externos de configuração.
- **Deploy em Swarm/Kubernetes:** use mecanismos nativos (`secrets`, `configs`), pois `environment` não oferece criptografia nem controle de acesso por container ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/)).

---

## 6. Componentes Chave Associados

- **`environment`:** define variáveis inline (mapping/list).
- **`env_file`:** referencia arquivos de variáveis, isolando-as do YAML.
- **Interpolação:** sintaxe `${...}` com fallback e obrigatoriedade.
- **`.env`:** arquivo padrão para composição e interpolação.
- **`secrets`:** bloco separado para gerenciar dados sensíveis em Swarm/Kubernetes.
- **Precedência de variáveis:** host > CLI `-env-file` > `environment` > `env_file` > `ENV` em `Dockerfile` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/envvars-precedence/?utm_source=chatgpt.com)).

---

## 7. Melhores Práticas e Padrões de Uso

- **Não versionar** arquivos `.env` com dados sensíveis; adicione-os ao `.gitignore`.
- **Use defaults** e `required` em `env_file` (Compose v2.24.0+) para garantir configurações mínimas.
- **Valide** configurações com `docker compose config --environment`.
- **Prefira** `secrets` para senhas e chaves em produção; o atributo `environment` é visível em logs e interfaces de orquestração ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/)).
- **Documente** no README quais variáveis são obrigatórias e seus significados.

---

## 8. Exemplo Prático Completo

```yaml
version: "3.9"

services:
  db:
    image: postgres:15
    env_file:
      - ./config/db.env      # Contém POSTGRES_USER, POSTGRES_PASSWORD
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - db-data:/var/lib/postgresql/data

  web:
    build: ./webapp
    env_file:
      - ./config/web.env     # Contém APP_ENV, API_URL
    environment:
      DEBUG: "${DEBUG:-false}"        # Fallback para false
      LOG_LEVEL: "${LOG_LEVEL:?Necessário definir LOG_LEVEL}"
    ports:
      - "8080:80"
    depends_on:
      - db

volumes:
  db-data:

```

- **`db.env`:**
    
    ```
    POSTGRES_USER=admin
    POSTGRES_PASSWORD=${DB_PASS:-changeme}
    
    ```
    
- **`web.env`:**
    
    ```
    APP_ENV=production
    API_URL=http://db:5432
    DEBUG=true
    
    ```
    
1. `db` injeta credenciais do arquivo, isolando YAML.
2. `web` combina `env_file`, interpolação com default e validação obrigatória.

---

## 9. Sugestões para Aprofundamento

- **Compose Specification:** [Compose file reference – services](https://docs.docker.com/compose/compose-file/)
- **Interpolação Avançada:** seção *Interpolation* ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/variable-interpolation/))
- **Docker Secrets:** *Use Secrets in Compose* ([docs.docker.com](https://docs.docker.com/compose/how-tos/use-secrets/))
- **Precedência de Variáveis:** *Environment variables precedence* ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/envvars-precedence/?utm_source=chatgpt.com))
- **Best Practices:** seção *Best practices* em How-tos do Compose ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/variable-interpolation/))---