# ipc

# Entendendo o atributo `ipc` em Docker Compose

## Introdução

O atributo `ipc` em um arquivo Docker Compose controla o **modo de isolamento do namespace IPC** (Inter-Process Communication) dos contêineres de um serviço. Por meio dele, você decide se o contêiner usa seu próprio namespace IPC isolado, compartilha com outros contêineres ou entra no namespace IPC de outro serviço ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **IPC Namespace**: isola recursos de comunicação como *System V IPC* (filas de mensagens, semáforos, memória compartilhada) e *POSIX mqueues*. Cada namespace possui seu conjunto próprio desses objetos; processos em namespaces diferentes não se enxergam ([man7.org](https://man7.org/linux/man-pages/man7/ipc_namespaces.7.html?utm_source=chatgpt.com)).
- **Por que isolar IPC?** Garante que contêineres não interfiram nem acessem recursos de IPC de outros, aumentando a segurança e previsibilidade de comportamento de aplicações paralelas.

---

## Sintaxe Detalhada e Uso Prático

O `ipc` é especificado dentro de cada serviço no arquivo `docker-compose.yml`. Foi introduzido no Docker Compose em versões iniciais (ex.: 1.4.x) e permite:

```yaml
services:
  meu-servico:
    image: alpine
    ipc: "shareable"         # Cria um namespace privado que pode ser compartilhado
    # ou
    ipc: "service:outro"     # Une-se ao namespace shareable do serviço 'outro'

```

- **Valores permitidos** (Compose V2/V3+) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)):
    - `shareable`
        - Cria um novo namespace IPC privado, mas que pode ser utilizado por outros contêineres via `ipc: "service:<nome>"`.
    - `service:<nome>`
        - Une o contêiner ao namespace IPC do serviço `<nome>`, este último **deve** ter `ipc: "shareable"`.
- **Observação**: Na CLI (`docker run`) existem ainda `-ipc=host`, que faz o contêiner usar o namespace IPC do host, e `-ipc=private`. Em Compose, `shareable` equivale a `private` com possibilidade de join. ([docs.docker.com](https://docs.docker.com/compose/releases/release-notes/?utm_source=chatgpt.com))

---

## Cenários de Restrição ou Não Aplicação

- **Ambientes Windows**: Namespaces IPC não são suportados em contêineres Windows, pois dependem de features do kernel Linux.
- **Uso de `ipc: "host"` não recomendado**: Expõe o contêiner a todos os recursos IPC do host, violando isolamento e potencialmente permitindo ataques entre processos.
- **Microserviços sem necessidade de comunicação direta**: Se serviços não trocam mensagens via IPC (ex.: usam apenas HTTP/REST), manter namespace isolado previne riscos e normalmente não há vantagem em compartilhá-lo.

---

## Componentes Chave Associados

Além de `ipc`, o Compose oferece outros atributos de namespace e isolamento:

| Atributo | Descrição | Exemplo |
| --- | --- | --- |
| `pid` | Define o namespace de processos (PID). Pode ser `host`, `container:<nome>` ou `service:<nome>`. | `pid: "host"` |
| `network_mode` | Controla o namespace de rede. Valores: `bridge`, `host`, `none`, `service:<nome>`, `container:<id>`. | `network_mode: "service:redis"` |
| `userns_mode` | (v2.3+) Permite remapear usuários dentro do contêiner usando user namespaces. | `userns_mode: "host"` |
| `sysctls` | Ajustes de parâmetros do kernel (`/proc/sys/*`) para o contêiner. | `sysctls: {"net.ipv4.ip_forward": 1}` |

*Esses atributos ajudam a compor estratégias de isolamento completas, combinando IPC, PID, rede e usuários.*

---

## Melhores Práticas e Padrões de Uso

- **Evite `service:<nome>` sem `shareable`**: sempre configure o serviço de origem com `ipc: "shareable"`.
- **Prefira isolamento por default**: use `shareable` apenas quando houver real necessidade de troca de memória ou semáforos entre contêineres coesos (ex.: workers de uma mesma aplicação).
- **Documente dependências de namespace**: deixe claro no Compose quais serviços estão interligados via IPC para facilitar manutenção e evitar configurações quebradas.
- **Audite riscos de segurança**: contêineres que compartilham IPC podem ler e manipular recursos de outros, planeje firewalls internos ou use outras formas de isolamento se necessário.

---

## Exemplo Prático Completo

```yaml
version: '3.8'

services:
  servidor-mq:
    image: rabbitmq:3-management
    ipc: "shareable"
    ports:
      - "15672:15672"
      - "5672:5672"

  worker-a:
    image: myapp-worker
    depends_on:
      - servidor-mq
    ipc: "service:servidor-mq"
    environment:
      MQ_HOST: servidor-mq

  worker-b:
    image: myapp-worker
    depends_on:
      - servidor-mq
    ipc: "service:servidor-mq"
    environment:
      MQ_HOST: servidor-mq

```

Neste cenário:

1. O serviço **servidor-mq** cria um namespace IPC privado e marcável (`shareable`).
2. **worker-a** e **worker-b** entram nesse mesmo namespace, podendo trocar mensagens em memória compartilhada ou semáforos criados por **servidor-mq**.

---

## Sugestões para Aprofundamento

- **Docker Compose Spec** (repositório oficial): explorar como o Compose lida com namespaces em [`05-services.md`](https://github.com/compose-spec/compose-spec)
- **Manual Linux IPC Namespaces**: detalhe técnico em [ipc_namespaces(7)](https://man7.org/linux/man-pages/man7/ipc_namespaces.7.html) ([man7.org](https://man7.org/linux/man-pages/man7/ipc_namespaces.7.html?utm_source=chatgpt.com))
- **Comparação com PID e Network Namespaces**: entender sinergias em [`pid`, `network_mode` e `userns_mode`] na documentação do Compose ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

Com esse panorama, você tem uma visão sólida de **o que** o `ipc` faz, **como** configurá-lo corretamente no Compose e **quando** evitá-lo para manter o máximo de segurança e isolamento nas suas aplicações conteinerizadas.