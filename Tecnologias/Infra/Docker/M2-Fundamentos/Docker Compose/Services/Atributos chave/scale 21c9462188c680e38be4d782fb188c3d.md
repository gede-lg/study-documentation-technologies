# scale

**Título da Explicação:** Entendendo o atributo `scale` na seção `services` do Docker Compose

## Introdução

No contexto do Docker Compose, “escalar” (scale) refere-se à capacidade de executar múltiplas instâncias de um mesmo serviço para distribuir carga, aumentar disponibilidade ou simular cenários de alta carga. Diferentemente de outros atributos configurados diretamente no arquivo `docker-compose.yml`, o dimensionamento de serviços é tratado principalmente pela CLI (`--scale`) ou, em contextos de orquestração Swarm, pela chave `deploy.replicas` dentro da definição de serviços ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com), [stackoverflow.com](https://stackoverflow.com/questions/63408708/how-to-scale-from-within-docker-compose-file?utm_source=chatgpt.com)).

## Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
    - Escalando via CLI (`-scale`)
    - Definindo `deploy.replicas` para Swarm
    - Status do atributo `scale` no arquivo Compose
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

## 1. Conceitos Fundamentais

### 1.1 Definição de escalabilidade em serviços

Escalar um serviço significa ajustar dinamicamente o número de contêineres em execução para atender a requisitos de carga, disponibilidade ou testes. No Docker Compose, isso não é feito por meio de um campo `scale` dentro da seção de serviços no arquivo YAML, mas sim pela CLI com a flag `--scale` ou, em ambientes Swarm, pela configuração `deploy.replicas` ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com)).

### 1.2 Histórico e evolução

- **Compose V1:** suportava o comando `docker-compose scale <serviço>=<n>`.
- **Compose V2:** o comando `docker-compose scale` foi deprecado em favor de `docker compose up --scale` ([docs.docker.com](https://docs.docker.com/compose/releases/migrate/?utm_source=chatgpt.com)).
- **Swarm Mode:** introduziu o campo `deploy.replicas` no YAML, que funciona **somente** com `docker stack deploy`, não com `docker compose up` ([stackoverflow.com](https://stackoverflow.com/questions/63408708/how-to-scale-from-within-docker-compose-file?utm_source=chatgpt.com)).

## 2. Sintaxe Detalhada e Uso Prático

### 2.1 Escalando via linha de comando (`-scale`)

A forma mais direta de escalar é usando a flag `--scale` no comando `docker compose up`. Por exemplo:

```bash
docker compose up -d --scale web=3

```

- `d`: executa em modo desacoplado (detached).
- `-scale web=3`: inicia 3 instâncias do serviço `web`, criando contêineres `projeto-web-1`, `projeto-web-2` e `projeto-web-3` ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com)).

### 2.2 Definindo `deploy.replicas` para Swarm

Em ambientes Docker Swarm, é possível especificar réplicas diretamente no YAML:

```yaml
version: "3.8"
services:
  web:
    image: nginx:latest
    deploy:
      replicas: 5

```

- `deploy.replicas`: número de réplicas desejadas.
- **Limitação:** só funciona com `docker stack deploy -c docker-compose.yml stackname`, sendo ignorado pelo `docker compose up` ([stackoverflow.com](https://stackoverflow.com/questions/63408708/how-to-scale-from-within-docker-compose-file?utm_source=chatgpt.com)).

### 2.3 Status do atributo `scale` no arquivo Compose

- **Atributo `scale`** não existe na especificação oficial do Compose para `services` (benefícios passados não persistiram) ou é ignorado se presente. Tentativas de uso resultam em erro ou são sobrepostas pela flag CLI ([github.com](https://github.com/docker/docker.github.io/issues/11716?utm_source=chatgpt.com)).

## 3. Cenários de Restrição ou Não Aplicação

- **Definição de `container_name`:** quando usada, impede que o serviço escale além de uma instância, pois nomes devem ser únicos ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com)).
- **Deploy em modo não-Swarm:** `deploy.replicas` não tem efeito no `docker compose up` ([stackoverflow.com](https://stackoverflow.com/questions/63408708/how-to-scale-from-within-docker-compose-file?utm_source=chatgpt.com)).
- **Orquestração alternativa:** em Kubernetes ou outros orquestradores, o Compose não gerencia réplicas — use o manifest nativo.

## 4. Componentes Chave Associados

- **`-scale` (CLI):** flag do comando `up` que ajusta réplicas no momento da criação ([docs.docker.com](https://docs.docker.com/reference/cli/docker/compose/up/?utm_source=chatgpt.com)).
- **`deploy.replicas`:** atributo no YAML, funcional apenas com o Swarm (`docker stack deploy`) ([stackoverflow.com](https://stackoverflow.com/questions/63408708/how-to-scale-from-within-docker-compose-file?utm_source=chatgpt.com)).
- **`docker service scale`:** comando para escalar serviços já implantados em Swarm via CLI ([docs.docker.com](https://docs.docker.com/reference/cli/docker/service/scale/?utm_source=chatgpt.com)).
- **`container_name`:** campo de serviço que, se usado, bloqueia o escalonamento acima de uma instância ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/?utm_source=chatgpt.com)).

## 5. Melhores Práticas e Padrões de Uso

1. **Ambiente de desenvolvimento:**
    - Use `docker compose up --scale` para testes e simulações de carga.
2. **Ambiente de produção com Swarm:**
    - Prefira `deploy.replicas` no YAML e `docker stack deploy` para CI/CD e orquestração robusta.
3. **Evitar `container_name` quando precisar escalar:**
    - Permita geração automática de nomes para múltiplas instâncias.
4. **Manter separação de configurações:**
    - Utilize múltiplos arquivos Compose (`f base.yml -f prod.yml`) para diferentes perfis ([docs.docker.com](https://docs.docker.com/compose/releases/migrate/?utm_source=chatgpt.com)).
5. **Revisão de logs e healthchecks:**
    - Combine escalonamento com `healthcheck` e políticas de reinício (`restart`) para garantir resiliência.

## 6. Exemplo Prático Completo

1. Crie o arquivo `docker-compose.yml`:
    
    ```yaml
    version: "3.8"
    services:
      web:
        image: nginx:latest
        ports:
          - "8080:80"
      db:
        image: postgres:15
        environment:
          POSTGRES_PASSWORD: example
    
    ```
    
2. Inicie o projeto com 1 instância de cada:
    
    ```bash
    docker compose up -d
    
    ```
    
3. Escale o serviço `web` para 4 instâncias:
    
    ```bash
    docker compose up -d --scale web=4
    
    ```
    
4. Verifique os contêineres:
    
    ```bash
    docker ps --filter "name=$(basename $(pwd))_web"
    
    ```
    
    Você deverá ver `web-1`, `web-2`, `web-3` e `web-4` em execução.
    

## 7. Sugestões para Aprofundamento

- **Compose Specification:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
- **Swarm Mode:** [https://docs.docker.com/engine/swarm/](https://docs.docker.com/engine/swarm/)
- **Transição para Kubernetes:** Kompose e Docker App

---

Esse guia detalhado esclarece como funciona o “atributo” `scale` em serviços Docker Compose, suas limitações, melhores práticas e diferentes formas de aplicação em múltiplos contextos.