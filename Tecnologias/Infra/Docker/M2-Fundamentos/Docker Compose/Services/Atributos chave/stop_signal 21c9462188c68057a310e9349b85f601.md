# stop_signal

**Understanding the `stop_signal` Attribute in Docker Compose Services**

---

## Introdução

No ciclo de vida de containers gerenciados pelo Docker Compose, a parada ordenada de serviços é tão importante quanto o seu início. Por padrão, o Compose envia o sinal `SIGTERM` para solicitar que o processo principal dentro do container finalize suas operações. O atributo `stop_signal`, disponível na seção de **services** do arquivo de Compose, permite personalizar esse comportamento, especificando qual sinal Unix será enviado quando você executar comandos como `docker compose stop` ou `docker compose down`. ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

## Sumário

1. **Conceitos Fundamentais**
2. **Sintaxe Detalhada e Uso Prático**
3. **Cenários de Restrição ou Não Aplicação**
4. **Componentes Chave Associados**
5. **Melhores Práticas e Padrões de Uso**
6. **Exemplo Prático Completo**
7. **Sugestões para Aprofundamento**

---

## 1. Conceitos Fundamentais

- **Sinais Unix em Containers:** Em sistemas Unix, processos recebem sinais para controlar comportamento (por exemplo, `SIGTERM` para término gracioso e `SIGKILL` para término forçado). Quando você executa `docker stop`, o Docker envia inicialmente `SIGTERM` ao PID 1 do container e, após um período de tolerância, `SIGKILL` se o processo não parar por conta própria ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/stop/?utm_source=chatgpt.com)).
- **Default no Compose:** Se `stop_signal` não estiver definido, o Compose utiliza `SIGTERM` como sinal de parada ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **Importância do `stop_signal`:** Algumas aplicações não tratam `SIGTERM` corretamente ou precisam de sinais específicos (por exemplo, `SIGUSR1` para desligamento ordenado). `stop_signal` torna possível alinhar o comportamento do container ao tratamento de sinais do seu aplicativo.

---

## 2. Sintaxe Detalhada e Uso Prático

O atributo `stop_signal` é um **scalar** dentro da definição de um serviço:

```yaml
version: "3.9"

services:
  minha_aplicacao:
    image: minha_imagem:latest  # imagem base
    stop_signal: SIGUSR1        # sinal enviado ao parar
    # stop_signal também pode ser numérico: 10 equivale a SIGUSR1

```

- **Formato:**
    - String: nome do sinal, sempre precedido por `SIG` (ex.: `SIGINT`, `SIGQUIT`, `SIGUSR1`).
    - Número inteiro: código do sinal (ex.: `2` para `SIGINT`, `15` para `SIGTERM`, `10` para `SIGUSR1`) ([docs.docker.com](https://docs.docker.com/reference/cli/docker/container/stop/?utm_source=chatgpt.com)).
- **Como funciona:**
    1. Compose envia o sinal definido em `stop_signal`.
    2. Aguarda o tempo definido em `stop_grace_period` (padrão: 10s).
    3. Se o container ainda estiver ativo, envia `SIGKILL`.

Exemplo completo com `stop_grace_period`:

```yaml
version: "3.9"

services:
  app:
    image: myapp:latest
    stop_signal: SIGINT         # sinal primário
    stop_grace_period: 30s      # tempo máximo para término gracioso

```

([docs.docker.com](https://docs.docker.com/reference/compose-file/services/))

---

## 3. Cenários de Restrição ou Não Aplicação

- **Docker Swarm / Stack Deploy:** Atualmente, `stop_signal` não é suportado pelo comando `docker stack deploy` ao usar Compose em modo Swarm ([github.com](https://github.com/docker/cli/issues/370?utm_source=chatgpt.com)).
- **Processos sem tratamento de sinal:** Se o processo principal não intercepta sinais (e.g., não usa *trap* em scripts shell), `stop_signal` tem efeito limitado — a parada será forçada após `stop_grace_period`.
- **Orquestradores externos:** Plataformas como Kubernetes ignoram `stop_signal` do Compose, usando suas próprias configurações de *terminationGracePeriodSeconds*.

---

## 4. Componentes Chave Associados

- **`stop_grace_period`:** Tempo de espera após o `stop_signal` antes de enviar `SIGKILL`.
- **Instrução `STOPSIGNAL` no Dockerfile:** Define o sinal padrão embutido na imagem; `-stop-signal` no `docker run` ou `stop_signal` no Compose podem sobrescrever esse valor ([stackoverflow.com](https://stackoverflow.com/questions/50898134/what-does-docker-stopsignal-do?utm_source=chatgpt.com)).
- **Hooks de ciclo de vida (`pre_stop` / `post_start`):** A partir do Docker Compose v2.30.0, é possível executar comandos antes e depois de parar/iniciar (mas não alteram o sinal enviado) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## 5. Melhores Práticas e Padrões de Uso

1. **Use o formato exec de `CMD`/`ENTRYPOINT`:** Garante que o PID 1 receba diretamente sinais, sem impedimentos de shell ([docs.docker.com](https://docs.docker.com/compose/support-and-feedback/faq/?utm_source=chatgpt.com)).
2. **Trate o sinal no seu aplicativo:** Implemente *signal handlers* para fechar conexões, liberar recursos e fazer *cleanup* antes de sair.
3. **Combine `stop_signal` e `stop_grace_period`:** Defina um tempo de tolerância realista para o encerramento completo, evitando `SIGKILL` prematuro.
4. **Teste localmente:** Use `docker compose stop -t <segundos>` para simular diferentes tempos de parada e ajustar `stop_grace_period`.
5. **Documente no Compose:** Deixe comentários explicando por que determinado sinal foi escolhido, facilitando a manutenção.

---

## 6. Exemplo Prático Completo

Suponha uma aplicação em **Python** que precisa interceptar `SIGUSR1` para finalizar conexões antes de parar:

```
FROM python:3.10-slim

WORKDIR /app
COPY requeriments.txt ./
RUN pip install -r requeriments.txt
COPY app.py ./

# Expõe o sinal que queremos usar por padrão na imagem
STOPSIGNAL SIGUSR1

CMD ["python", "app.py"]

```

```python
import signal
import time
import sys

def handle_stop_signal(signum, frame):
    print("Recebido SIGUSR1, finalizando recursos...")
    # Aqui: fechar sockets, liberar DB, etc.
    sys.exit(0)

# Registra handler para SIGUSR1
signal.signal(signal.SIGUSR1, handle_stop_signal)

print("Aplicação iniciada. PID:", os.getpid())
while True:
    time.sleep(1)

```

```yaml
version: "3.9"

services:
  web:
    build: .
    ports:
      - "8080:8080"
    # Sobrescreve STOPSIGNAL para reforçar no Compose
    stop_signal: SIGUSR1
    # Dá 20s para o tratamento de sinal
    stop_grace_period: 20s

```

**Fluxo de parada:**

1. Executa `docker compose up -d`.
2. Para com `docker compose stop`.
3. O Compose envia `SIGUSR1` ao container (app.py imprime mensagem e fecha recursos).
4. Se, após 20s, o processo não sair, `SIGKILL` é enviado.

---

## 7. Sugestões para Aprofundamento

- **Compose Specification:** [https://github.com/compose-spec/compose-spec](https://github.com/compose-spec/compose-spec)
- **Docker Compose Reference:** [https://docs.docker.com/reference/compose-file/services/](https://docs.docker.com/reference/compose-file/services/)
- **Docker CLI `stop` e `kill`:** [https://docs.docker.com/engine/reference/commandline/stop/](https://docs.docker.com/engine/reference/commandline/stop/)
- **Dockerfile `STOPSIGNAL`:** [https://docs.docker.com/engine/reference/builder/#stopsignal](https://docs.docker.com/engine/reference/builder/#stopsignal)

Com isso, você tem uma visão completa do atributo `stop_signal` no Docker Compose, seus fundamentos, sintaxe, restrições e um exemplo prático para aplicar imediatamente.