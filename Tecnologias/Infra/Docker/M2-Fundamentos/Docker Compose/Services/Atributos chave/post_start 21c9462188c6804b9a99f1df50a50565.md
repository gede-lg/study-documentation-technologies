# post_start

# Entendendo o Atributo `post_start` em Docker Compose

## Introdução

A partir da versão **2.30.0** do Docker Compose, foi introduzido o atributo `post_start` no escopo de um serviço, permitindo executar comandos *dentro* do container **após** sua inicialização. Essa funcionalidade faz parte dos **lifecycle hooks**, que se dividem em pontos de ativação pré e pós execução do `ENTRYPOINT`/`COMMAND` do container ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/), [stackoverflow.com](https://stackoverflow.com/questions/47615751/docker-compose-run-a-script-after-container-has-started?utm_source=chatgpt.com)).

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Services Lifecycle Hooks**: comandos que o Docker Compose executa em pontos específicos do ciclo de vida de um container, separando tarefas especializadas do `ENTRYPOINT` e `COMMAND`.
- **`post_start`**: hook acionado **depois** do container atingir o estado de “iniciado”, mas sem garantia de momento exato em relação à execução do `ENTRYPOINT`. É útil para tarefas que exigem privilégios ou preparações adicionais, como ajuste de permissões em volumes montados ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).

---

## Sintaxe Detalhada e Uso Prático

Dentro de um `docker-compose.yml`, `post_start` é uma **lista** de objetos contendo:

- `command`: array ou string com o comando a ser executado.
- `user` (opcional): usuário ou UID/GID com o qual o comando será rodado.

```yaml
version: '3.8'
services:
  app:
    image: backend:latest
    user: "1001"               # usuário principal do container
    volumes:
      - data:/data
    post_start:
      - command: ["chown", "-R", "1001:1001", "/data"]
        user: "root"           # executa com privilégios elevados
      - command: ["chmod", "-R", "755", "/data"]
        user: "root"
volumes:
  data: {}

```

Neste exemplo:

1. **Volume criado** com dono root por padrão.
2. Container inicia como usuário 1001.
3. Dois hooks `post_start` ajustam, sequencialmente, propriedade e permissões do diretório `/data`.
4. Só após a conclusão dos hooks é que a aplicação efetivamente prossegue ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).

---

## Cenários de Restrição ou Não Aplicação

- **Versões anteriores à 2.30.0**: o Compose simplesmente rejeita a chave `post_start` com erro `Additional property post_start is not allowed` ([help.ente.io](https://help.ente.io/self-hosting/troubleshooting/docker?utm_source=chatgpt.com)).
- **Timing não determinístico**: se sua aplicação requer ações exatamente **antes** do `ENTRYPOINT` ou espera uma ordem de inicialização estrita, considere usar `ENTRYPOINT` customizado ou `healthcheck` em vez de hooks.
- **Containers efêmeros** (que sobem e descem rapidamente): o hook pode não ter tempo para executar antes do container encerrar.

---

## Componentes Chave Associados

- **`services`**: seção raiz onde cada serviço declara suas configurações.
- **`post_start`**: array de hooks executados pós-início.
- **`command`**: comando ou script a executar.
- **`user`**: define o contexto de usuário do hook.
- **Outros hooks**: `pre_stop` roda antes de parar o container, ideal para limpeza ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).

---

## Melhores Práticas e Padrões de Uso

- **Idempotência**: garanta que o hook pode ser executado múltiplas vezes sem efeitos colaterais ([dev.to](https://dev.to/idsulik/managing-container-lifecycles-with-docker-compose-lifecycle-hooks-mjg?utm_source=chatgpt.com)).
- **Monitoramento de falhas**: como falhas em um hook abortam os seguintes, escreva logs claros e trate erros localmente.
- **Separação de responsabilidades**: evite sobrecarregar o `ENTRYPOINT` e use hooks para tarefas privilegiadas (e.g., ajustes de permissão) ([baeldung.com](https://www.baeldung.com/ops/docker-compose-run-script-on-start?utm_source=chatgpt.com)).
- **Segurança**: minimize execução como `root`; limite as permissões estritamente ao necessário.

---

## Exemplo Prático Completo

Imagine um cenário onde um serviço `db` precisa de inicialização de esquema após estar “up”:

```yaml
version: '3.8'
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: secret
    volumes:
      - db-data:/var/lib/postgresql/data

  app:
    image: myapp:latest
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://appuser:secret@db:5432/appdb
    post_start:
      - command: ["sh", "-c", "psql $DATABASE_URL -f /migrations/init.sql"]
        user: "postgres"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      retries: 5

volumes:
  db-data: {}

```

**Fluxo de execução**:

1. `db` sobe e sinaliza saudável.
2. `app` inicia, aguarda `db`.
3. Após `ENTRYPOINT`, o hook `post_start` roda o script de migração.
4. Só então o serviço `app` fica pronto para receber tráfego. ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/))

---

## Sugestões para Aprofundamento

- **Documentação Oficial de Lifecycle Hooks** (inclui referência completa de `post_start` e `pre_stop`): [https://docs.docker.com/compose/how-tos/lifecycle/](https://docs.docker.com/compose/how-tos/lifecycle/) ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/))
- **Artigo “Managing Container Lifecycles with Docker Compose Lifecycle Hooks”** (casos de uso avançados): dev.to/idsulik/... ([dev.to](https://dev.to/idsulik/managing-container-lifecycles-with-docker-compose-lifecycle-hooks-mjg?utm_source=chatgpt.com))
- **Guia Baeldung sobre post_start hooks** (exemplos adicionais e dicas de segurança): baeldung.com/... ([baeldung.com](https://www.baeldung.com/ops/docker-compose-run-script-on-start?utm_source=chatgpt.com))