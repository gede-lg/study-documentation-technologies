# oom_score_adj

## Ajuste de OOM Score em Docker Compose (`oom_score_adj`)

### Introdução

O atributo `oom_score_adj` faz parte das opções de configuração de serviços no Docker Compose, permitindo ajustar dinamicamente a pontuação do Out-Of-Memory Killer (OOM Killer) do Linux para os processos dentro dos contêineres. Ele corresponde diretamente ao flag `--oom-score-adj` do comando `docker run`, que ajusta o valor presente em `/proc/[pid]/oom_score_adj` para cada processo principal de contêiner, influenciando as decisões do kernel sobre qual processo matar em situações de falta de memória ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [stackoverflow.com](https://stackoverflow.com/questions/44393107/adjust-oom-killer-for-subprocess-in-docker-container?utm_source=chatgpt.com)).

### Sumário

- **Conceitos Fundamentais**
- **Sintaxe Detalhada e Uso Prático**
- **Cenários de Restrição ou Não Aplicação**
- **Componentes Chave Associados**
- **Melhores Práticas e Padrões de Uso**
- **Exemplo Prático Completo**
- **Sugestões para Aprofundamento**

### Conceitos Fundamentais

O OOM Killer é um mecanismo do kernel Linux que entra em ação quando o sistema fica sem memória disponível. Cada processo recebe uma “pontuação de badness” calculada com base em seu uso de memória, à qual é somado o valor de `oom_score_adj` (inteiro de -1000 a 1000). Valores negativos reduzem a chance de um processo ser escolhido, chegando a `-1000` para desabilitar totalmente a chance de ser morto; valores positivos o aumentam, até `1000` para máxima prioridade de término ([man7.org](https://man7.org/linux/man-pages/man5/proc_pid_oom_score_adj.5.html?utm_source=chatgpt.com), [askubuntu.com](https://askubuntu.com/questions/60672/how-do-i-use-oom-score-adj?utm_source=chatgpt.com)).

### Sintaxe Detalhada e Uso Prático

No Docker Compose, `oom_score_adj` é definido diretamente no nível de serviço, como um inteiro:

```yaml
services:
  nome_do_servico:
    image: minha-imagem:latest
    oom_score_adj: -500  # Ajusta o score OOM do processo para -500

```

Internamente, o Compose converte essa chave para a propriedade `OomScoreAdj` do `HostConfig` na API do Docker Engine (campo `OomScoreAdj` em `/api/v1.24/containers/create`), garantindo que o container seja criado com o ajuste de score especificado ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docker-docs.uclv.cu](https://docker-docs.uclv.cu/engine/api/v1.24/?utm_source=chatgpt.com)).

### Cenários de Restrição ou Não Aplicação

- **Plataformas sem cgroups Linux:** Em hosts Windows ou kernels sem suporte a cgroups, o ajuste de OOM não tem efeito, pois não há `/proc/[pid]/oom_score_adj` disponível ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com), [askubuntu.com](https://askubuntu.com/questions/60672/how-do-i-use-oom-score-adj?utm_source=chatgpt.com)).
- **Swarm e Deploy:** Ao usar `docker stack deploy` (modo Swarm) com arquivos versão 3.x, chaves top-level que não pertençam ao bloco `deploy` podem ser ignoradas pelo orquestrador. Nesse caso, deve-se usar flags específicas do Swarm (`docker service create --oom-score-adj`) em vez de depender do Compose local.
- **Versões anteriores do Compose:** Suporte a `oom_score_adj` foi introduzido após a versão inicial do Compose (pós 2016), portanto, versões muito antigas podem não reconhecer a chave.

### Componentes Chave Associados

- **`oom_kill_disable`**: bool que desativa por completo o OOM Killer para o container (equivalente ao `-oom-kill-disable` do `docker run`).
- **`oom_score_adj`**: inteiro na faixa [-1000,1000], mapeado para `HostConfig.OomScoreAdj` na API do Docker ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/engine/api/v1.24/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
- **`HostConfig` (Docker Engine API)**: objeto JSON enviado em `POST /containers/create`, contendo campos `OomScoreAdj` e `OomKillDisable` que definem o comportamento de OOM do kernel para o novo container.

### Melhores Práticas e Padrões de Uso

- **Proteção de serviços críticos:** Use valores negativos (ex.: `500` ou `1000`) para bancos de dados, filas ou componentes vitais, reduzindo o risco de serem terminados em caso de OOM.
- **Prioridade de processos secundários:** Defina valores positivos para jobs batch ou tarefas não críticas que possam ser sacrificadas sem impacto imediato no sistema.
- **Não desabilite completamente o OOM sem cautela:** `1000` desativa o mecanismo de OOM para aquele container, o que pode levar a instabilidade do host se combinado com limites de memória insuficientes (swap insuficiente etc.) ([docs.docker.com](https://docs.docker.com/engine/containers/resource_constraints/?utm_source=chatgpt.com), [man7.org](https://man7.org/linux/man-pages/man5/proc_pid_oom_score_adj.5.html?utm_source=chatgpt.com)).
- **Combine com limites de memória:** Sempre defina `mem_limit` e `mem_reservation` para impor restrições de uso de memória, evitando cenários de uso excessivo que exijam ajustes de OOM.

### Exemplo Prático Completo

```yaml
version: "2.4"
services:
  banco_de_dados:
    image: postgres:13
    mem_limit: 1g
    oom_score_adj: -800         # Protege fortemente o PostgreSQL
    oom_kill_disable: false     # Keep OOM Killer enabled
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass

  batch_job:
    image: my-batch:latest
    mem_limit: 512m
    oom_score_adj: 500          # Torna o job batch mais suscetível a OOM
    oom_kill_disable: false
    command: ["./run-job.sh"]

```

Neste cenário, o serviço `banco_de_dados` recebe um ajuste agressivo (`-800`), tornando muito improvável que seja sacrificado, enquanto `batch_job` é configurado com `500` para priorizá-lo como candidato a encerramento em casos de pressão de memória ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/), [docker-docs.uclv.cu](https://docker-docs.uclv.cu/engine/api/v1.24/?utm_source=chatgpt.com)).

### Sugestões para Aprofundamento

- Leia a especificação completa do Compose File Reference:
    
    [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
    
- Estude o funcionamento interno do OOM Killer no Linux:
    
    [https://man7.org/linux/man-pages/man5/proc_pid_oom_score_adj.5.html](https://man7.org/linux/man-pages/man5/proc_pid_oom_score_adj.5.html)
    
- Consulte as Directivas de Resource Constraints do Docker Engine:
    
    [https://docs.docker.com/engine/containers/resource_constraints/](https://docs.docker.com/engine/containers/resource_constraints/)
    

Espero que esta explicação detalhada ajude a entender e aplicar corretamente o atributo `oom_score_adj` em seus projetos com Docker Compose!