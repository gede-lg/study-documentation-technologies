# provider

**Título da Explicação:** Entendendo o Atributo `provider` em Serviços do Docker Compose

## Introdução

No Docker Compose, cada serviço é definido na chave superior `services` de um arquivo YAML. O atributo `provider` permite que um serviço seja gerenciado por um provedor externo — um plugin ou binário — em vez de ser executado como um container local pelo Compose em si ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).

## Sumário

- **Conceito de Provider Services**
- **Sintaxe Detalhada**
- **Fluxo de Trabalho e Injeção de Variáveis**
- **Cenários Onde Não Se Aplica**
- **Componentes-Chave**
- **Melhores Práticas**
- **Exemplo Prático Completo**
- **Sugestões para Aprofundamento**

## Conceitos Fundamentais

1. **O que são Provider Services?**
    - São serviços que representam capacidades da plataforma (como bancos de dados gerenciados, caches em nuvem, modelos de IA, etc.) em vez de instâncias de container ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
2. **Por que usar?**
    - Elimina a necessidade de configurar manualmente recursos externos.
    - Consolida todas as dependências (containers + serviços gerenciados) em um único Compose file ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).

## Sintaxe Detalhada e Uso Prático

Para declarar um provider service, adiciona-se dentro do serviço o bloco `provider`, contendo pelo menos `type` e, opcionalmente, `options`:

```yaml
services:
  database:
    # Define que 'database' é um provider service
    provider:
      type: awesomecloud        # Nome do plugin CLI (docker-model) ou binário 'awesomecloud'
      options:
        type: mysql              # Opção específica do provedor
        foo: bar                 # Mais configurações conforme a API do provedor
  app:
    image: myapp
    depends_on:
      - database                # Garante provisão antes de iniciar 'app'

```

- **`provider.type`**: identifica o plugin ou binário que fará a provisão ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
- **`provider.options`**: mapa livre de parâmetros específicos do provedor ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
- **`depends_on`**: sinaliza que `app` aguarda o provedor estar pronto antes de subir ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).

## Fluxo de Trabalho e Injeção de Variáveis

Durante `docker compose up`, o Compose:

1. Detecta serviços com `provider` e invoca o plugin/binário.
2. Provedor retorna informações de acesso (URL, token, credenciais).
3. Essas informações são injetadas como *environment variables* para serviços dependentes, usando o padrão:
    
    ```
    <NOME_DO_SERVIÇO>_<VARIÁVEL>=<valor>
    
    ```
    
    Exemplo: `DATABASE_URL`, `DATABASE_TOKEN`, etc. ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
    

## Cenários de Restrição ou Não Aplicação

- **Versões anteriores ao Compose 2.36.0**: não suportam o atributo `provider` ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
- **Aplicações puramente container-based**: quando não há necessidade de recursos gerenciados, usar `image` ou `build`.
- **Ambientes sem o plugin/binary instalado**: o Compose falhará ao localizar o provedor.

## Componentes Chave Associados

- **`provider`**: bloco principal que define o serviço como gerenciado externamente.
- **`type`**: string apontando para o nome do plugin CLI (`docker-<type>`) ou binário no PATH ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
- **`options`**: mapa de configurações passadas ao provedor na invocação.
- **`depends_on`**: controladora de ordem de inicialização entre serviços tradicionais e providers.
- **Variáveis de Ambiente**: mecanismo padrão de passagem de informações dos providers para os containers.

## Melhores Práticas e Padrões de Uso

1. **Nomeclatura Consistente**: use nomes claros para serviços providers (ex: `db_provider`, `cache_provider`).
2. **Declare Todas as Dependências**: mesmo que o serviço app compreenda a injeção, especifique `depends_on` para garantir a ordem correta ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
3. **Mantenha Plugins Atualizados**: verifique versões compatíveis do Compose e dos plugins para evitar incompatibilidades.
4. **Isolamento de Configurações**: agrupe opções específicas do provider em `options` para facilitar manutenção.
5. **Fallback para Containers**: se o provider falhar, considere fallback local usando `image`/`build`.

## Exemplo Prático Completo

```yaml
version: '3.9'

services:
  # Serviço gerenciado por um provedor de Postgres na nuvem
  postgres_provider:
    provider:
      type: cloudsql-plugin
      options:
        engine: postgres
        version: "13"
        storage: "20Gi"
        region: us-central1

  # Aplicação que depende do Postgres provisionado
  webapp:
    image: example/webapp:latest
    depends_on:
      - postgres_provider
    environment:
      # Recebe automaticamente variáveis como POSTGRES_PROVIDER_HOST, POSTGRES_PROVIDER_PASSWORD
      DATABASE_URL: ${POSTGRES_PROVIDER_HOST}
      DATABASE_PASSWORD: ${POSTGRES_PROVIDER_PASSWORD}
    ports:
      - "8080:80"

```

Neste cenário, basta rodar `docker compose up` para que o provedor crie o banco e injete as variáveis em `webapp`.

## Sugestões para Aprofundamento

- **Compose Extensions**: aprenda a criar providers customizados em [https://github.com/docker/compose-extensions](https://github.com/docker/compose-extensions) ([docs.docker.com](https://docs.docker.com/compose/how-tos/provider-services/)).
- **Docker Model Runner**: veja como integrar modelos de IA via Compose em [https://docs.docker.com/compose/how-tos/provider-services/#reference](https://docs.docker.com/compose/how-tos/provider-services/#reference).
- **Compose Deploy Specification**: entenda práticas avançadas de deployment em [https://docs.docker.com/reference/compose-file/deploy](https://docs.docker.com/reference/compose-file/deploy).

---

Com esta visão detalhada você tem base para explorar e implementar providers em seus projetos Docker Compose de forma declarativa e integrada.