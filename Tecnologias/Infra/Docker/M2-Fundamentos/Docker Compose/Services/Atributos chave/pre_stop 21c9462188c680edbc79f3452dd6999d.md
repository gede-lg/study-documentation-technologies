# pre_stop

**Título da Explicação:**

Entendendo o Atributo `pre_stop` em Serviços no Docker Compose

---

### Introdução

A partir da versão **2.30.0** do Docker Compose, tornou-se possível definir *lifecycle hooks* em serviços, como o atributo `pre_stop`, que permite executar comandos **antes** de um contêiner ser parado pelo Compose. Esses hooks são úteis para tarefas de limpeza, liberação de recursos ou sincronização de estado, sem sobrecarregar o `ENTRYPOINT` ou o `COMMAND` do contêiner em si ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).

---

### Sumário

1. Conceitos Fundamentais
2. Sintaxe Detalhada e Uso Prático
3. Cenários de Restrição ou Não Aplicação
4. Componentes Chave Associados
5. Melhores Práticas e Padrões de Uso
6. Exemplo Prático Completo
7. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Lifecycle Hooks vs. ENTRYPOINT/COMMAND:**
    
    O Docker Compose tradicionalmente usa `ENTRYPOINT` e `COMMAND` para controlar o início e a parada dos contêineres. *Lifecycle hooks* separam essas preocupações, executando comandos logo após o start (`post_start`) ou logo antes do stop (`pre_stop`) do contêiner ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).
    
- **Privilégios Elevados:**
    
    Hooks podem rodar com privilégios maiores (por exemplo, como `root`), mesmo que o serviço em si opere com usuário restrito, permitindo tarefas como alteração de permissões em volumes ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).
    

---

## 2. Sintaxe Detalhada e Uso Prático

No arquivo `docker-compose.yml`, `pre_stop` é definido no nível de serviço, como uma lista de blocos que contêm pelo menos a chave `command`. Exemplo mínimo:

```yaml
services:
  app:
    image: backend:latest
    pre_stop:
      - command: ./data_flush.sh

```

- **command** (obrigatório): script ou comando a ser executado.
- **user** (opcional): permite especificar um usuário diferente (por exemplo, `root`) para rodar o hook, se necessário:

```yaml
services:
  app:
    image: backend:latest
    pre_stop:
      - command: ./cleanup.sh
        user: root

```

> Observação: Para tarefas pós-início, existe o hook post_start, com sintaxe e propósitos semelhantes (docs.docker.com).
> 

---

## 3. Cenários de Restrição ou Não Aplicação

- **Não será executado se:**
    - O contêiner **crashar** ou for morto de forma abrupta (por exemplo, `docker kill`, falha interna, OOM).
    - O contêiner encerrar-se sozinho por erro no próprio processo, sem sinal de parada do Compose.
- **É executado apenas quando:**
    - Você executa `docker compose down`, `docker compose stop` ou interrompe via `Ctrl+C`. ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/))

---

## 4. Componentes Chave Associados

- **Seção `services`**
    
    O atributo `pre_stop` integra a lista de configurações de serviço suportadas pelo Compose, conforme referência oficial ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **Interação com sinais de parada**
    - `stop_signal`: define qual sinal (por exemplo, `SIGTERM`) será enviado ao contêiner.
    - `stop_grace_period`: determina o tempo de espera após o hook antes de forçar o kill.
- **Estrutura do bloco**
    
    Cada item em `pre_stop` é um mapa com chaves como `command` e possivelmente `user`. Não há outras propriedades específicas para esses hooks.
    

---

## 5. Melhores Práticas e Padrões de Uso

- **Mantenha hooks curtos e rápidos:**
    
    Hooks muito demorados podem ser interrompidos pelo `terminationGracePeriod` do Compose ou pelo timeout do Docker Engine ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).
    
- **Use para tarefas de limpeza e flush de buffers:**
    
    Exemplos típicos incluem descarregar caches em disco, fechar conexões de banco de dados ou sincronizar logs antes de parar.
    
- **Combine com `stop_grace_period`:**
    
    Ajuste esse valor para acomodar a duração estimada do seu hook, garantindo tempo suficiente para a execução completa ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **Teste em condições de parada controlada:**
    
    Verifique se o hook funciona corretamente tanto em paradas manuais (`docker compose stop`) quanto em desligamentos de serviço.
    

---

## 6. Exemplo Prático Completo

```yaml
version: '3.8'

services:
  webapp:
    image: myorg/webapp:latest
    ports:
      - "8080:80"
    volumes:
      - logs:/var/log/webapp
    # Ao iniciar, corrige permissões do volume de logs
    post_start:
      - command: chown -R /var/log/webapp 1001:1001
        user: root
    # Antes de parar, envia logs para storage externo
    pre_stop:
      - command: /usr/local/bin/flush_logs.sh
        user: root
    stop_signal: SIGTERM
    stop_grace_period: 30s

volumes:
  logs: {}

```

Neste cenário, toda vez que o `docker compose down` ou `stop` for chamado, o script `flush_logs.sh` será executado com privilégios de root, garantindo que todos os logs sejam enviados antes que o contêiner receba o sinal de encerramento ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/), [docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).

---

## 7. Sugestões para Aprofundamento

- **Documentação Oficial Compose File Reference** (Services):
    
    Explora todos os atributos disponíveis em Serviços (incluindo `post_start`, `pre_stop`, `stop_signal` e `stop_grace_period`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/services/)).
    
- **Como-tos: Use lifecycle hooks**:
    
    Guia prático de uso de `post_start` e `pre_stop` com exemplos adicionais ([docs.docker.com](https://docs.docker.com/compose/how-tos/lifecycle/)).
    
- **Boas práticas de shutdown graceful em containers**:
    
    Artigos e posts sobre como lidar com encerramentos controlados vs. falhas súbitas em ambientes de produção.