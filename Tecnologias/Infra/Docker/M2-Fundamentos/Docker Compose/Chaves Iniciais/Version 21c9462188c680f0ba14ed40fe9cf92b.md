# Version

**Título da Explicação: Compreendendo o Elemento Top-level `version` no Docker Compose**

---

## 1. Introdução

O arquivo `docker-compose.yml` é o coração do Docker Compose, permitindo definir e orquestrar múltiplos contêineres de forma declarativa. Entre os elementos top-level (no nível mais alto do documento), o campo `version` tem papel crucial: ele indica a versão do **Compose file format** a ser utilizada, influenciando quais recursos de sintaxe e quais opções de configuração estarão disponíveis.

---

## 2. Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Compose File Format vs. Docker Compose CLI**
    
    O campo `version` não se refere diretamente à versão do Docker Compose (CLI), mas sim ao **formato** do arquivo YAML. Ex.: `version: "3.8"` corresponde ao Compose file format 3.8, suportado pelo Docker Engine 19.03+ e Docker Compose 1.27+.
    
- **Schema-Driven**
    
    Cada versão de formato define um schema: quais top-level keys (como `services`, `networks`, `volumes`, `configs`, `secrets`) e quais configurações cada serviço pode ter (p. ex. `deploy` só existe no v3).
    
- **Evolução**
    - **v1**: implícito (antes do campo `version`, Compose < 1.6).
    - **v2** (2.0 a 2.4): trouxe suporte a networks customizadas e volumes nomeados.
    - **v3** (3.0 a 3.9+): foco em orquestração com Swarm, introduziu `deploy`, `configs`, `secrets`.
    - **Compose Specification** (2020+): unificou e permitiu omitir o campo `version` em favor do spec-driven format, mas muitas equipes ainda o mantêm para clareza.

---

## Sintaxe Detalhada e Uso Prático

```yaml
# Exemplo básico com version 3.8
version: "3.8"             # Define o formato do arquivo (Compose file format 3.8)

services:                  # Top-level obrigatório: definição dos contêineres
  web:
    image: nginx:1.19      # Imagem Docker
    ports:
      - "80:80"            # Mapeamento de portas host → contêiner
    environment:
      - NGINX_HOST=localhost
    volumes:
      - ./html:/usr/share/nginx/html

  db:
    image: postgres:13
    restart: always        # Reiniciar on-failure
    environment:
      POSTGRES_PASSWORD: example

networks:                  # Redes customizadas (v2+)
  front-tier:
  back-tier:

volumes:                   # Volumes nomeados (v2+)
  db-data:

```

### Variações de Sintaxe por Versão

| Formato | Introduzido em | Destaques |
| --- | --- | --- |
| `"2.4"` | Docker Compose 1.12+ | Configuração avançada de healthchecks; suporte a `profiles`. |
| `"3.3"` | Docker Compose 1.13+ | `secrets` e `configs` (apenas em Swarm mode). |
| `"3.8"` | Docker Compose 1.27+ | Compatibilidade com API 1.40 do Engine; `long syntax` para `ports`. |

---

## Cenários de Restrição ou Não Aplicação

- **Swarm Mode vs. Standalone**
    
    Formatos ≥ 3.0 ativam instruções de orquestração (`deploy`, `secrets`), mas essas **não** são aplicáveis em modo standalone (Compose CLI puro).
    
- **Recursos Avançados**
    
    Se você precisar de recursos de Compose Specification (build tradicional, `depends_on` healthcheck, `profiles`), recomenda-se usar **versão 2.4** ou especificar o Compose spec sem `version`.
    
- **Compatibilidade de Ferramentas**
    
    Algumas ferramentas de CI/CD ou IDEs podem não suportar versões muito antigas (v2.0) ou muito recentes (3.9+). Verifique compatibilidade antes de padronizar.
    

---

## Componentes Chave Associados

O campo `version` afeta diretamente quais top-level e sub-keys você pode usar:

1. **Top-level Keys**
    - `services`, `networks`, `volumes`, `configs`, `secrets`
2. **Sub-keys em `services`**
    - `build` (context, dockerfile, args)
    - `ports` (short e long syntax)
    - `deploy` (replicas, update_config, resources) — *v3+* e Swarm
    - `depends_on` (condições de healthcheck em v2.4+)
3. **Objetos de Orquestração**
    - `configs`, `secrets` — definem arquivos e credenciais gerenciados pelo Swarm
4. **Profiles** *(v2.4+)*
    - Permitem ativar/desativar grupos de serviços conforme ambiente

---

## Melhores Práticas e Padrões de Uso

- **Escolha da Versão**
    - Para **ambientes de desenvolvimento standalone**, prefira **v2.4** ou adote o Compose Spec sem `version`.
    - Para projetos que usam **Docker Swarm**, utilize **v3.8** ou superior.
- **Manter Consistência**
    
    Padronize a mesma versão em toda a base de código para evitar conflitos de schema.
    
- **Comentários e Documentação**
    
    Comente seções críticas, especialmente onde há dependências de versão (ex.: “`# deploy só funciona no Swarm mode`”).
    
- **Omissão do Campo `version`**
    
    A partir da Compose Spec oficial, você pode omitir `version`; o parser inferirá o spec atual. Porém, explicite em projetos colaborativos para clareza.
    

---

## Exemplo Prático Completo

Um cenário simples de aplicação web com banco de dados e cache:

```yaml
# docker-compose.yml
version: "3.8"  # Compose format 3.8: ideal para Swarm e Compose CLI modernos

services:
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        - RAILS_ENV=production
    image: meuapp:latest
    depends_on:
      db:
        condition: service_healthy   # Healthcheck only in v2.4+, mas reconhecido no spec
    ports:
      - target: 3000                # Long syntax
        published: 3000
        protocol: tcp
        mode: host
    environment:
      DATABASE_URL: postgres://user:pass@db:5432/meubanco
      REDIS_URL: redis://cache:6379
    networks:
      - backend
      - frontend

  db:
    image: postgres:13
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - backend

  cache:
    image: redis:6-alpine
    restart: unless-stopped
    networks:
      - backend

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  db-data:
    driver: local

```

**Como executar**

```bash
docker-compose up -d

```

- O Compose verificará o campo `version` e aplicará o schema correspondente.
- Serviços com healthcheck só ficarão “prontos” quando as condições forem atendidas.
- Em Swarm mode (`docker stack deploy`), o bloco `deploy:` poderia controlar **replicas**, **update_config** e **resources**.

---

## Sugestões para Aprofundamento

- **Documentação Oficial Docker Compose**
    
    Explore as notas de versão para cada Compose file format:
    
    [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/)
    
- **Compose Specification**
    
    Repositório unificado com o spec e exemplos avançados:
    
    [https://github.com/compose-spec/compose-spec](https://github.com/compose-spec/compose-spec)
    
- **Tutorial Swarm Mode**
    
    Exemplos de `deploy` e orquestração:
    
    [https://docs.docker.com/engine/swarm/](https://docs.docker.com/engine/swarm/)
    
- **Ferramentas de Validação**
    
    Use o VSCode com extensão Docker para validar schema e auto-completar.
    

---

> Conclusão
> 
> 
> O campo top-level `version` em `docker-compose.yml` determina o schema de validação e quais recursos de orquestração, networking e volumes estão disponíveis. A escolha adequada da versão garante compatibilidade e evita comportamentos inesperados durante a criação dos ambientes Docker.
>