# rollback_config

## Entendendo o `rollback_config` na Chave `Deploy` do Docker Compose

Este documento visa proporcionar uma explicação detalhada e completa sobre o atributo `rollback_config` dentro da chave `deploy` em arquivos Docker Compose, especificamente no contexto de gerenciamento de serviços no Docker.

### Sumário

O `rollback_config` é um sub-atributo crucial dentro da seção `deploy` de um serviço no Docker Compose, utilizado para definir o comportamento de reversão automática (rollback) caso uma atualização de serviço falhe. Ele oferece controle granular sobre como e quando os contêineres devem ser revertidos para uma versão anterior, minimizando o tempo de inatividade e garantindo a estabilidade da aplicação. Abordaremos seus conceitos fundamentais, sintaxe detalhada, cenários de uso, componentes associados e melhores práticas, culminando em um exemplo prático.

### Introdução

No universo do Docker e, mais especificamente, do Docker Compose, a orquestração e o gerenciamento de aplicações multicontainer são tarefas essenciais. O Docker Compose simplifica a definição e a execução de ambientes complexos através de um único arquivo YAML. Quando se trata de atualizações de serviços, especialmente em ambientes de produção, a capacidade de lidar com falhas de forma robusta é vital. É aqui que o `rollback_config` se torna indispensável. Ele faz parte das configurações de `deploy`, que são aplicadas quando o Docker Compose gerencia serviços em um ambiente de swarm (orquestração de clusters Docker).

### Conceitos Fundamentais

O `rollback_config` é projetado para automatizar o processo de recuperação de um serviço após uma atualização malsucedida. Sem ele, uma falha na atualização poderia deixar seu serviço em um estado inconsistente ou completamente indisponível, exigindo intervenção manual.

**Propósito:** O principal propósito do `rollback_config` é fornecer um mecanismo de segurança automatizado para reverter um serviço para sua configuração anterior e funcional em caso de falha durante um processo de `docker service update` ou `docker stack deploy`. Isso é particularmente importante em arquiteturas de microsserviços e ambientes de alta disponibilidade, onde a resiliência é primordial.

**Importância:**

- **Redução do tempo de inatividade:** Ao automatizar o rollback, o tempo que o serviço permanece em um estado problemático é drasticamente reduzido.
- **Aumento da confiabilidade:** Garante que falhas de atualização não levem a interrupções prolongadas ou à corrupção do ambiente.
- **Operações mais seguras:** Permite que as equipes de DevOps implementem atualizações com maior confiança, sabendo que existe um plano de contingência automático.
- **Automação e padronização:** Padroniza o comportamento de rollback para todos os serviços configurados, garantindo consistência.

### Sintaxe Detalhada e Uso Prático

O `rollback_config` é um sub-atributo da chave `deploy` dentro da definição de um serviço. A chave `deploy` só é efetiva quando você implanta seu aplicativo em um swarm Docker (usando `docker stack deploy`).

Aqui está a sintaxe detalhada e a explicação de seus parâmetros:

```yaml
version: '3.8'
services:
  my-web-app:
    image: my-web-app:latest
    deploy:
      replicas: 3
      update_config: # Configurações para a atualização (rolling update)
        parallelism: 1
        delay: 10s
        failure_action: rollback # Se a atualização falhar, inicie o rollback
        monitor: 5s
        max_failure_ratio: 0.1
        order: stop-first
      rollback_config: # Configurações para o rollback
        parallelism: 1 # Número de contêineres para reverter por vez
        delay: 5s      # Tempo de espera entre cada grupo de contêineres revertidos
        failure_action: pause # Ação se o rollback falhar (continue ou pause)
        monitor: 10s    # Duração após cada tarefa revertida para monitorar falhas
        max_failure_ratio: 0.2 # Taxa de falha tolerável durante o rollback
        order: start-first # Ordem das operações durante o rollback (stop-first ou start-first)
    ports:
      - "80:80"

```

**Parâmetros do `rollback_config`:**

- **`parallelism`**:
    - **Tipo:** Inteiro
    - **Descrição:** O número de contêineres (réplicas) a serem revertidos simultaneamente.
    - **Valor Padrão:** Geralmente, não há um padrão explícito, mas muitas vezes é interpretado como 1 se não especificado. Se definido como `0`, todos os contêineres revertem ao mesmo tempo.
    - **Exemplo:** `parallelism: 1` (reverte um contêiner por vez) ou `parallelism: 0` (reverte todos simultaneamente).
- **`delay`**:
    - **Tipo:** Duração (ex: `ns`, `us`, `ms`, `s`, `m`, `h`)
    - **Descrição:** O tempo de espera entre a reversão de grupos de contêineres. Isso ajuda a propagar a reversão e a monitorar o estado de saúde do serviço.
    - **Valor Padrão:** `0s` (0 segundos).
    - **Exemplo:** `delay: 5s` (espera 5 segundos entre a reversão de cada grupo).
- **`failure_action`**:
    - **Tipo:** String (`continue` ou `pause`)
    - **Descrição:** Define o que o Docker deve fazer se o processo de rollback em si falhar (por exemplo, se um contêiner não iniciar corretamente após ser revertido).
        - `continue`: O Docker continuará tentando reverter os contêineres restantes, mesmo após uma falha.
        - `pause`: O Docker pausará o processo de rollback após a primeira falha, permitindo a intervenção manual.
    - **Valor Padrão:** `pause`.
    - **Exemplo:** `failure_action: pause`.
- **`monitor`**:
    - **Tipo:** Duração (ex: `ns`, `us`, `ms`, `s`, `m`, `h`)
    - **Descrição:** A duração após cada tarefa (contêiner) ser revertida para monitorar sua saúde e estabilidade. Se uma falha for detectada dentro deste período, o rollback pode ser pausado ou uma ação de falha pode ser acionada.
    - **Valor Padrão:** `0s` (0 segundos).
    - **Exemplo:** `monitor: 10s` (monitora por 10 segundos após cada reversão de contêiner).
- **`max_failure_ratio`**:
    - **Tipo:** Float (0.0 a 1.0)
    - **Descrição:** A proporção máxima de falhas toleradas durante o processo de rollback, expressa como um número decimal entre 0 e 1. Se a taxa de falhas exceder este valor, o rollback pode ser interrompido, dependendo da `failure_action`.
    - **Valor Padrão:** `0` (0%).
    - **Exemplo:** `max_failure_ratio: 0.2` (tolera até 20% de falhas durante o rollback).
- **`order`**:
    - **Tipo:** String (`stop-first` ou `start-first`)
    - **Descrição:** A ordem das operações durante o rollback:
        - `stop-first`: O contêiner antigo é parado antes que o novo (revertido) seja iniciado. Isso minimiza o uso de recursos, mas pode levar a um breve período de inatividade se não houver outras réplicas funcionando.
        - `start-first`: O contêiner novo (revertido) é iniciado primeiro, e as tarefas em execução se sobrepõem brevemente. Isso garante disponibilidade contínua, mas requer mais recursos durante a transição.
    - **Valor Padrão:** `stop-first`.
    - **Exemplo:** `order: start-first`.

### Cenários de Restrição ou Não Aplicação

O `rollback_config` é uma funcionalidade poderosa, mas sua aplicação é específica para ambientes Docker Swarm.

- **Não aplicável em modo de contêiner único/Docker Standalone:** Se você estiver executando o Docker Compose em um único host sem o modo Swarm ativado (ou seja, apenas com `docker compose up`), a seção `deploy` (incluindo `rollback_config`) será ignorada pelo Docker Compose. Essas configurações são específicas para o orquestrador Swarm e são aplicadas quando um `stack` é implantado.
- **Ambientes de Desenvolvimento/Teste Local:** Para ambientes de desenvolvimento e teste local onde a orquestração Swarm não é utilizada, a configuração `rollback_config` não terá efeito. Nesses casos, o controle de versão e reversão é geralmente feito manualmente ou através de scripts de CI/CD.
- **Complexidade Innecessária:** Para aplicações muito simples com pouquíssimas dependências ou que não exigem alta disponibilidade, a configuração detalhada do `rollback_config` pode adicionar uma complexidade desnecessária ao arquivo Compose, embora não cause problemas.

### Componentes Chave Associados

O `rollback_config` não opera isoladamente; ele está intrinsecamente ligado à chave `deploy` e, por extensão, ao `update_config`.

- **`deploy` Chave:** É a chave de nível superior onde todas as configurações de implantação para um serviço são definidas. Isso inclui escalabilidade (`replicas`), estratégias de atualização (`update_config`), e, claro, estratégias de rollback (`rollback_config`). A `deploy` chave é utilizada pelo orquestrador Docker Swarm para gerenciar o ciclo de vida do serviço.
- **`update_config` Chave:** Esta chave, também dentro de `deploy`, define como as atualizações de serviço (rolling updates) devem ser realizadas. Inclui parâmetros como `parallelism`, `delay`, `failure_action`, `monitor`, `max_failure_ratio`, e `order`, que são espelhados em `rollback_config`. A diferença fundamental é que `update_config` rege o *processo de atualização*, enquanto `rollback_config` rege o *processo de reversão* se a atualização falhar (especialmente se `update_config.failure_action` for definido como `rollback`).
    - **`update_config.failure_action: rollback`**: É crucial notar que para o `rollback_config` ser acionado automaticamente, o `failure_action` dentro do `update_config` do serviço *deve* estar configurado para `rollback`. Se for `pause` ou `continue`, o sistema não iniciará um rollback automático em caso de falha de atualização.

### Melhores Práticas e Padrões de Uso

1. **Sempre defina `update_config.failure_action` como `rollback`**: Para que o `rollback_config` seja ativado automaticamente, garanta que seu `update_config` esteja configurado para iniciar um rollback em caso de falha de atualização.
2. **Teste seus rollbacks**: Não espere até a produção para descobrir se suas configurações de rollback funcionam. Simule falhas de atualização em ambientes de staging para validar o comportamento de rollback.
3. **Monitore a saúde do serviço**: Use as métricas de `monitor` e `max_failure_ratio` tanto em `update_config` quanto em `rollback_config` para garantir que o Docker Swarm tenha tempo suficiente para detectar problemas e agir.
4. **Escolha a `order` adequada**:
    - `stop-first`: Ideal para serviços que podem tolerar um breve período de inatividade ou onde os recursos são limitados.
    - `start-first`: Preferível para serviços de alta disponibilidade, onde a interrupção zero é crítica, mas exige que você tenha recursos de CPU/memória suficientes para as tarefas antigas e novas coexistirem brevemente.
5. **Use `delay` com sabedoria**: Um `delay` adequado pode evitar sobrecarregar o sistema com reversões simultâneas e dar tempo para que os serviços se estabilizem entre as etapas do rollback.
6. **Ajuste `parallelism`**: Comece com um valor baixo (e.g., 1) e aumente gradualmente se o seu ambiente puder suportar mais reversões simultâneas. `parallelism: 0` pode ser arriscado em ambientes de produção, pois uma falha pode afetar todas as instâncias simultaneamente.
7. **Defina `failure_action: pause` para `rollback_config`**: Durante o rollback, se algo der errado (por exemplo, a imagem para a qual você está revertendo está corrompida ou não inicia), é geralmente melhor que o sistema pause (`pause`) para que você possa investigar, em vez de continuar a reverter sem sucesso (`continue`).

### Exemplo Prático Completo

Vamos considerar um cenário onde você tem uma aplicação web e um serviço de banco de dados, ambos implantados em um Docker Swarm. Você quer garantir que, se uma atualização do seu aplicativo web falhar, ele seja revertido automaticamente para a versão anterior de forma controlada.

```yaml
version: '3.8'
services:
  web-app:
    image: gededev/my-web-app:1.0.0 # Versão inicial
    ports:
      - "80:80"
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback # Se a atualização do web-app falhar, inicie o rollback
        monitor: 15s # Monitora por 15s após cada tarefa atualizada
        max_failure_ratio: 0.2 # Tolera 20% de falha durante a atualização
        order: stop-first
      rollback_config:
        parallelism: 1 # Reverte um contêiner por vez
        delay: 5s      # Espera 5s entre cada reversão
        failure_action: pause # Se o rollback falhar, pause para inspeção
        monitor: 10s    # Monitora por 10s após cada tarefa revertida
        max_failure_ratio: 0.1 # Tolera 10% de falha durante o rollback
        order: start-first # Novo contêiner (revertido) inicia antes do antigo ser parado
    healthcheck: # Exemplo de healthcheck para o serviço web-app
      test: ["CMD", "curl", "-f", "<http://localhost/health>"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  database:
    image: postgres:13
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - db-data:/var/lib/postgresql/data
    deploy:
      replicas: 1 # Bancos de dados geralmente com uma única réplica ou HA configurada externamente
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d mydb"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db-data:

```

**Como funciona neste exemplo:**

1. Inicialmente, a `web-app` está na versão `1.0.0` com 3 réplicas.
2. Imagine que você tenta implantar uma nova versão: `docker stack deploy -c docker-compose.yml myappstack`. Você atualiza a imagem para `gededev/my-web-app:1.0.1` no seu `docker-compose.yml`.
3. O Swarm iniciará a atualização, atualizando um contêiner por vez (`update_config.parallelism: 1`) e esperando 10 segundos entre cada atualização (`update_config.delay: 10s`).
4. Durante o processo de atualização, se uma nova instância da `web-app:1.0.1` falhar em passar no `healthcheck` dentro do período de `monitor` (15s) e a taxa de falha exceder `0.2` (20%), o `update_config.failure_action: rollback` será acionado.
5. O Docker Swarm iniciará o processo de rollback. Ele reverterá a aplicação para a versão anterior (`1.0.0`).
6. O rollback também será feito um contêiner por vez (`rollback_config.parallelism: 1`), com um atraso de 5 segundos (`rollback_config.delay: 5s`) entre cada reversão.
7. A ordem será `start-first` (`rollback_config.order: start-first`), o que significa que as instâncias da versão `1.0.0` começarão a subir antes que as instâncias falhas da `1.0.1` sejam totalmente derrubadas, garantindo que o serviço permaneça disponível.
8. Se, por algum motivo, o processo de rollback em si falhar (por exemplo, uma das instâncias `1.0.0` não conseguir iniciar após a reversão), o `rollback_config.failure_action: pause` garantirá que o processo de rollback seja interrompido, permitindo que você investigue e resolva o problema manualmente.

### Sugestões para Aprofundamento

Para um entendimento ainda mais aprofundado, recomendo explorar os seguintes tópicos na documentação oficial do Docker:

- **Docker Swarm Mode:** Entenda como o Docker Swarm funciona como um orquestrador para aproveitar ao máximo os recursos de `deploy`, `update_config` e `rollback_config`.
    - [Docker Swarm Overview](https://docs.docker.com/engine/swarm/)
- **Docker Compose File Reference - Deploy:** Revise a documentação completa da chave `deploy` para conhecer todas as opções disponíveis.
    - [Compose Deploy Specification - Docker Docs](https://docs.docker.com/reference/compose-file/deploy/)
- **Docker Service Commands:** Explore os comandos CLI relacionados a serviços (e.g., `docker service update`, `docker service rollback`) para gerenciar serviços manualmente ou para script.
    - [docker service update](https://docs.docker.com/reference/cli/docker/service/update/)
    - [docker service rollback](https://docs.docker.com/reference/cli/docker/service/rollback/)
- **Healthchecks em Serviços Docker:** Aprender a configurar `healthchecks` robustos é fundamental, pois eles são a base para o Docker Swarm determinar a saúde de um serviço e acionar atualizações/rollbacks.
    - [Healthcheck in Dockerfile](https://www.google.com/search?q=https://docs.docker.com/engine/reference/builder/%23healthcheck) e [Compose Healthchecks](https://www.google.com/search?q=https://docs.docker.com/compose/compose-file/07-healthcheck/)