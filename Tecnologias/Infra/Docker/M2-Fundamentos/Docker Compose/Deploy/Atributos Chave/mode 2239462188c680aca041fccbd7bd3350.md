# mode

**Título da Explicação:** Entendendo o atributo `mode` na chave `deploy` do Docker Compose

---

## Introdução

No Docker Compose, a seção `deploy` é utilizada para definir comportamentos de implantação quando você utiliza o Docker em modo Swarm. O atributo `mode` dentro de `deploy` especifica o *modelo de replicação* ou de execução de *jobs* para um serviço, controlando quantas tarefas (containers) serão executadas e como elas serão distribuídas pelos nós do cluster ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

---

## Sumário

1. Conceitos Fundamentais
2. Modelos de `mode` e seus Significados
    - `replicated`
    - `global`
    - `replicated-job`
    - `global-job`
3. Sintaxe Detalhada e Exemplos
4. Cenários de Restrição ou Não Aplicação
5. Componentes Chave Associados
6. Melhores Práticas e Padrões de Uso
7. Exemplo Prático Completo
8. Sugestões para Aprofundamento

---

## 1. Conceitos Fundamentais

- **Deploy em Swarm:** A seção `deploy` do Compose é ignorada pelo Docker Engine “standalone” e só tem efeito em modo Swarm ou quando se utiliza `docker stack deploy`.
- **Tarefa (Task):** Unidade de trabalho agendada em um nó, baseada em um container.
- **Service vs. Job:** Services são de longa duração; jobs são executados até a conclusão (exit code 0).

O atributo `mode` define como essas tarefas serão criadas e gerenciadas pelo Swarm ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

---

## 2. Modelos de `mode` e seus Significados

### 2.1 `replicated` (Padrão)

- **O que faz:** Mantém um número fixo de réplicas em todo o cluster.
- **Como funciona:** Você especifica `replicas: N`; o Swarm garante que sempre haja N tarefas ativas.
- **Uso típico:** Serviços web ou APIs onde você quer escalar horizontalmente ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

### 2.2 `global`

- **O que faz:** Garante exatamente uma tarefa em cada nó participante do Swarm.
- **Como funciona:** Quando um novo nó entra no cluster, automaticamente recebe uma instância do serviço.
- **Uso típico:** Daemons de infraestrutura (por exemplo, logs, monitoramento) que devem rodar em todos os nós ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

### 2.3 `replicated-job`

- **O que faz:** Executa um número definido de tarefas que completam e encerram (exit 0).
- **Como funciona:** Baseado em `replicas: N`, o Swarm cria N tarefas de job e, quando todas completam, considera o job concluído.
- **Detalhe:** Não há `max-concurrent` no Compose (só via CLI) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

### 2.4 `global-job`

- **O que faz:** Executa uma única tarefa de job por nó, que ao completar não é reiniciada.
- **Como funciona:** Igual ao `global`, mas para jobs com estado final. Novos nós também executam o job automaticamente.
- **Uso típico:** Rotinas de manutenção que devem rodar uma vez em cada nó (por exemplo, limpeza de cache local) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

---

## 3. Sintaxe Detalhada e Uso Prático

```yaml
version: '3.8'
services:
  web:
    image: nginx:alpine
    deploy:
      mode: replicated        # modelo de réplica
      replicas: 3             # número de tarefas

  logger:
    image: custom/logger
    deploy:
      mode: global            # uma instância por nó

  batch:
    image: data/processor
    deploy:
      mode: replicated-job   # job com 5 tarefas
      replicas: 5

  cleanup:
    image: util/cleanup
    deploy:
      mode: global-job       # job rodado em cada nó

```

- **Observação:** Se `mode` não for especificado, o padrão é `replicated` ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

---

## 4. Cenários de Restrição ou Não Aplicação

- **Ambiente não-Swarm:** A seção `deploy` é totalmente ignorada.
- **Teste local com `docker-compose up`:** Deploy não se aplica, use `docker-compose scale` para replicação em ambiente único host.
- **Jobs intensivos em recursos:** Evite usar `global-job` em clusters muito grandes sem particionamento, pois pode sobrecarregar todos os nós simultaneamente.

---

## 5. Componentes Chave Associados

- **`replicas`**
– Funciona apenas com `mode: replicated` e `replicated-job`.
- **Job-specific (CLI-only)**
– `max-concurrent`: limita quantas tarefas podem rodar simultaneamente (disponível via CLI) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).
- **Integração com `placement`**
– É comum combinar `mode` com `placement.constraints` para controlar onde as tarefas rodam.

---

## 6. Melhores Práticas e Padrões de Uso

- **Use `replicated` para serviços stateless e escaláveis**, definindo `replicas` conforme demanda de carga.
- **Use `global` para agentes de infraestrutura**, garantindo cobertura total do cluster.
- **Reserve `_job` para tarefas pontuais** (backups, migrações), evitando misturar com serviços contínuos.
- **Combine com `resources` e `placement`** para balancear desempenho e atender requisitos de nodes específicos.
- **Teste localmente** em Swarm antes de mover para produção, usando `docker stack deploy`.

---

## 7. Exemplo Prático Completo

Imagine um cenário de aplicação microservices com:

- **Frontend**: 3 réplicas.
- **Worker de filas**: Job de 10 tarefas.
- **Monitor**: Agente em cada nó.
- **Limpeza**: Job global de limpeza de logs.

```yaml
version: '3.8'
services:
  frontend:
    image: company/frontend:latest
    ports:
      - "80:80"
    deploy:
      mode: replicated
      replicas: 3
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

  queue-worker:
    image: company/worker:latest
    deploy:
      mode: replicated-job
      replicas: 10

  node-monitor:
    image: company/monitor:latest
    deploy:
      mode: global

  log-cleaner:
    image: company/cleaner:latest
    deploy:
      mode: global-job

```

Para implantar no Swarm:

```bash
docker swarm init
docker stack deploy -c docker-compose.yml mystack

```

---

## 8. Sugestões para Aprofundamento

- **Docker CLI docs sobre modos de job:** entenda `max-concurrent`, `failure-action`, etc.
- **Seção de `placement`** no Compose: aprenda a espalhar ou agrupar tarefas.
- **Atualização e rollback:** explore `update_config` e `rollback_config` para deploys contínuos.

---

Com este guia, você possui uma visão completa e detalhada do atributo `mode` na seção `deploy` do Docker Compose, sua sintaxe, cenários de uso, limites e boas práticas para orquestrar serviços e jobs em um cluster Swarm.