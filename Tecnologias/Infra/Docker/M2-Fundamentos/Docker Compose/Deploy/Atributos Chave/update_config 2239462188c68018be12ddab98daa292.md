# update_config

**Título da Explicação: Rolling Updates com `update_config` no Deploy do Docker Compose**

---

## 1. Introdução

O bloco `deploy` em um arquivo Docker Compose (versão 3+) permite definir políticas de implantação para serviços em um Swarm, controlando réplicas, balanceamento de carga, políticas de reinício, rollback e atualizações (rolling updates). Dentro desse bloco, o atributo `update_config` especifica **como** e **quando** as atualizações de containers devem ocorrer, ajudando a minimizar downtime e gerenciar falhas durante deploys. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/))

---

## 2. Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#3-conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#4-sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#5-cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#6-componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#7-melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#8-exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#9-sugest%C3%B5es-para-aprofundamento)

---

## 3. Conceitos Fundamentais

- **Rolling Update**: estratégia de deploy onde apenas parte dos containers é atualizada de cada vez, mantendo alguns em execução para atender requisições.
- **`update_config`**: definição no Compose para controlar essa estratégia (número de containers por lote, atraso entre lotes, comportamento em falhas etc.).
- **Swarm Mode**: o `deploy` (e, por consequência, `update_config`) só surtirá efeito quando aplicado via `docker stack deploy` em um Swarm de nós; `docker-compose up` ignora o bloco `deploy`. ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/?utm_source=chatgpt.com))

---

## 4. Sintaxe Detalhada e Uso Prático

```yaml
services:
  minha-app:
    image: minha-imagem:latest
    deploy:
      mode: replicated       # padrão: 'replicated'
      replicas: 4            # número total de containers
      update_config:
        parallelism: 2       # quantos containers atualizar por grupo
        delay: 10s           # espera entre grupos
        order: stop-first    # 'stop-first' ou 'start-first'
        failure_action: rollback  # ação em caso de falha: 'continue' | 'rollback' | 'pause'
        monitor: 30s         # tempo para monitorar cada container após update
        max_failure_ratio: 0.25  # taxa máxima de falhas tolerada

```

- **`parallelism`** (inteiro): número de containers a serem atualizados simultaneamente.
- **`delay`** (duração): tempo de espera entre cada grupo de atualização.
- **`order`** (string):
    - `stop-first`: para um container antigo antes de iniciar o novo (default).
    - `start-first`: inicia nova instância antes de parar a antiga (minimiza downtime, mas gera sobreposição).
- **`failure_action`** (string):
    - `pause` (default): interrompe o processo de update até intervenção manual.
    - `continue`: prossegue mesmo após falhas.
    - `rollback`: reverte as alterações do lote que falhou.
- **`monitor`** (duração): intervalo que cada container atualizado permanece em observação para detectar falhas.
- **`max_failure_ratio`** (float): proporção de tasks que podem falhar sem abortar o rollout.

> Observação: se update_config não estiver definido, o Swarm usará valores padrão (parallelism=1; order=stop-first; failure_action=pause; monitor=0s; max_failure_ratio=0).
> 

([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/))

---

## 5. Cenários de Restrição ou Não Aplicação

- **Modo não-Swarm**: `docker-compose up` NÃO aplica `deploy` nem `update_config` — use apenas em Swarm com `docker stack deploy`. ([docker-docs.uclv.cu](https://docker-docs.uclv.cu/compose/compose-file/?utm_source=chatgpt.com))
- **Ambientes de teste**: quando não há necessidade de alta disponibilidade, atualizações simples podem usar `docker-compose pull` + `up -d` sem `update_config`.
- **Serviços stateless pequenos**: se startup e shutdown forem rápidos (<1s), o overhead de rolling updates pode não ser justificável.

---

## 6. Componentes Chave Associados

Além de `update_config`, o bloco `deploy` inclui:

- **`mode`** e **`replicas`**: define modelo de réplica (global vs. replicado) e quantas instâncias. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/))
- **`rollback_config`**: configura rollback automático em caso de falhas em atualizações.
- **`restart_policy`**: gerencia reinício de containers que falharam após deploy.
- **`placement`**: restringe quais nós podem receber containers.

Cada componente impacta a disponibilidade e resiliência do serviço em produção.

---

## 7. Melhores Práticas e Padrões de Uso

1. **Comece com `parallelism=1`**: garante controle total; aumente gradualmente conforme estabilidade.
2. **Defina `delay`** baseado no tempo de readiness probe de sua aplicação.
3. **Use `start-first`** para serviços que suportam conexões persistentes sem interrupção.
4. **Configure `monitor`** para >= healthcheck interval + grace period.
5. **Combine `failure_action=rollback`** com testes em staging para reduzir riscos.
6. **Documente** a política de deploy no README do repositório.

---

## 8. Exemplo Prático Completo

Suponha uma API web com probe de saúde em `/health` e tolerância zero a downtime:

```yaml
version: "3.8"

services:
  api:
    image: minha-api:stable
    ports:
      - "80:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 2s
      retries: 3

    deploy:
      mode: replicated
      replicas: 4
      update_config:
        parallelism: 1              # um container por vez
        delay: 30s                  # aguarda readiness
        order: start-first          # inicia novo antes de parar o antigo
        failure_action: rollback    # reverte lote em falhas
        monitor: 1m                 # monitora por 1 minuto
        max_failure_ratio: 0.10     # até 10% podem falhar sem abortar tudo

      rollback_config:
        parallelism: 1
        delay: 15s
        failure_action: pause
        monitor: 30s

```

**Passos para deploy:**

1. `docker swarm init` (se ainda não for Swarm).
2. `docker stack deploy -c docker-compose.yml minha_pilha`.
3. O Swarm atualizará um container por vez, aguardando 30 s após cada start para verificar `/health`. Em caso de falha, reverte o último lote. ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/))

---

## 9. Sugestões para Aprofundamento

- Leia a especificação completa de [Compose Deploy Specification](https://docs.docker.com/reference/compose-file/deploy/) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/))
- Estude o funcionamento de [Docker Swarm Updates CLI](https://docs.docker.com/engine/reference/commandline/service_update/)
- Pratique em um cluster multi-nó para observar efeitos de `placement` + `update_config`.
- Explore ferramentas de CI/CD (GitLab CI, GitHub Actions) integrando `docker stack deploy` para automação de rolling updates.

---

Com isso, você dispõe de uma visão aprofundada de como o atributo `update_config` gerencia rolling updates no Docker Swarm via Docker Compose. Qualquer dúvida ou ajuste adicional, basta chamar!