# replicas

**Atributo `replicas` em `deploy` no Docker Compose: guia completo**

---

## Introdução

No contexto do Docker Compose, especialmente quando integrado ao Docker Swarm ou ao Compose V2 em modo “stack”, o bloco `deploy` permite definir como os serviços devem ser orquestrados em um cluster. Dentro desse bloco, o atributo `replicas` controla o número de instâncias idênticas (containers) de um serviço que devem estar sempre em execução, garantindo alta disponibilidade e balanceamento de carga automático ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Modo de Replicação (`mode: replicated`)**
    
    Por padrão, serviços no Docker Swarm operam em modo `replicated`, onde um número fixo de tarefas (containers) é mantido ativo ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).
    
- **`replicas`**
    
    Especifica quantas instâncias do container devem estar rodando simultaneamente. Se uma falhar, o orquestrador cria outra até que o número desejado seja atingido ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).
    
- **Por que é importante?**
    - **Alta disponibilidade:** múltiplas instâncias reduzem pontos únicos de falha.
    - **Escalabilidade horizontal:** fácil ajuste do nível de serviço apenas alterando um número.
    - **Balanceamento automático:** o Docker Swarm distribui as instâncias pelos nós do cluster.

---

## Sintaxe Detalhada e Uso Prático

```yaml
version: "3.8"

services:
  webapp:
    image: example/webapp:latest
    deploy:
      mode: replicated        # Define o modo de replicação
      replicas: 4             # Número desejado de instâncias
      update_config:          # Configurações de atualização
        parallelism: 2        # Atualiza 2 containers por vez
        delay: 10s            # Aguarda 10s entre grupos
      restart_policy:
        condition: on-failure # Reinicia apenas em falhas

```

1. **`mode`**: pode ser `global` ou `replicated` (padrão).
2. **`replicas`**: inteiro ≥ 0.
3. **`update_config`** e **`restart_policy`** são frequentemente utilizados em conjunto para gerenciar rolling updates e reinícios condicionais.

> Dica: Você pode parametrizar replicas via variável de ambiente:
> 
> 
> ```yaml
> deploy:
>   replicas: ${WEBAPP_REPLICAS:-3}
> 
> ```
> 
> Assim, define-se `WEBAPP_REPLICAS` no `.env`, com fallback para 3.
> 

---

## Cenários de Restrição ou Não Aplicação

- **Uso via `docker-compose up` local**
    
    O Compose CLI ignora completamente o bloco `deploy` em contextos não-Swarm. Ou seja, `replicas` não tem efeito em ambiente de desenvolvimento sem Swarm ([devops.stackexchange.com](https://devops.stackexchange.com/questions/6233/how-to-create-replicas-in-docker-compose-when-scale-is-deprecated?utm_source=chatgpt.com)).
    
- **Modo `global`**
    
    Quando `mode: global`, `replicas` é irrelevante, pois sempre roda uma instância por nó.
    
- **Orquestradores não suportados**
    
    Plataformas que não implementem a Compose Specification de forma completa podem não respeitar `replicas`.
    

---

## Componentes Chave Associados

- **`mode`**
    - `replicated` (padrão) → usa `replicas`.
    - `global` → ignora `replicas`.
- **`placement`**
    
    Define restrições e preferências de onde cada réplica será executada (e.g., `node.labels.zone`) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/)).
    
- **`resources`**
    
    Limites e reservas de CPU/memória para cada réplica, garantindo que o agendamento considere requisitos de hardware.
    
- **`update_config`** e **`rollback_config`**
    
    Controlam estratégias de rolling update e reversão, para atualizar serviços sem downtime.
    
- **`restart_policy`**
    
    Define quando e como reiniciar réplicas que terminam por falha ou sucesso.
    

---

## Melhores Práticas e Padrões de Uso

1. **Defina sempre o `mode` explicitamente**, para evitar surpresas em migrações de versões de Compose.
2. **Use variáveis de ambiente** para parametrizar `replicas`, facilitando pipelines de CI/CD e configurações por ambiente.
3. **Combine com `placement`** para distribuir réplicas de forma inteligente em múltiplos AZs ou racks.
4. **Configure `update_config`** com `parallelism` e `delay` para reduzir o impacto de atualizações.
5. **Teste localmente sem `deploy`**, usando múltiplos comandos `docker-compose up --scale`, entendendo que é apenas um hack para desenvolvimento.

---

## Exemplo Prático Completo

1. **Arquivo `docker-stack.yml`**
    
    ```yaml
    version: "3.8"
    services:
      api:
        image: myorg/api:1.2
        ports:
          - "8080:80"
        deploy:
          mode: replicated
          replicas: 3
          placement:
            constraints:
              - node.role == worker
          update_config:
            parallelism: 1
            delay: 5s
          restart_policy:
            condition: on-failure
          resources:
            limits:
              cpus: "0.50"
              memory: 256M
            reservations:
              cpus: "0.25"
              memory: 128M
    networks:
      webnet:
        driver: overlay
    
    ```
    
2. **Comandos**
    
    ```bash
    docker swarm init                   # Inicializa Swarm
    docker stack deploy -c docker-stack.yml mystack
    docker service ls                   # Verifica o número de réplicas
    docker service ps mystack_api       # Inspeciona cada tarefa
    docker service scale mystack_api=5  # Escala manualmente
    
    ```
    
    Ao escalar, o Swarm provisiona ou remove containers para corresponder ao valor de `replicas`.
    

---

## Sugestões para Aprofundamento

- **Compose Specification**: explore o repositório oficial para entender todas as opções de `deploy` (e.g., [GitHub Compose Spec](https://github.com/compose-spec/compose-spec)).
- **Docker Swarm CLI**: pratique comandos de inspeção (`docker service inspect`) e monitoração.
- **Comparação com Kubernetes**: examine como `replicas` em Compose se relaciona ao campo `replicas` em um Deployment do Kubernetes.

---

Com isso, você tem uma visão completa e detalhada do atributo `replicas` em `deploy` no Docker Compose, desde sua definição básica até cenários de uso avançados em produção.