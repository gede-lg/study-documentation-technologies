# restart_policy

**Entendendo o `restart_policy` na cláusula `deploy` do Docker Compose**

---

## 1. Introdução

No contexto do Docker Compose em modo Swarm, a seção `deploy` permite configurar comportamentos avançados de orquestração, incluindo como um serviço deve reagir a falhas. O atributo `restart_policy` controla **quando** e **como** o Docker reinicia automaticamente containers que param de forma inesperada, trazendo maior resiliência ao seu cluster ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).

---

## 2. Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#3-conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#4-sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#5-cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave de `restart_policy`](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#6-componentes-chave-de-restart_policy)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#7-melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#8-exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/c/68643ab0-9380-8013-9dcd-2bcdd85ddd40#9-sugest%C3%B5es-para-aprofundamento)

---

## 3. Conceitos Fundamentais

- **Reinício automático de containers:** garante que serviços críticos permaneçam disponíveis mesmo após falhas pontuais.
- **Distinção entre `restart` e `restart_policy`:**
    - `restart` (top-level) funciona em modo standalone (não Swarm), aplicando políticas simplificadas.
    - `deploy.restart_policy` é parte do **Docker Swarm**, oferecendo opções granulares como delays, janelas de observação e número máximo de tentativas ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).
- **Importância:** em um ambiente de produção, evita downtime prolongado, melhora a tolerância a falhas e auxilia em atualizações contínuas de serviços.

---

## 4. Sintaxe Detalhada e Uso Prático

```yaml
version: "3.8"

services:
  web:
    image: nginx:latest
    deploy:
      restart_policy:
        condition: on-failure    # Quando tentar reiniciar (ver detalhes abaixo)
        delay: 5s                # Tempo de espera entre tentativas
        max_attempts: 3          # Máximo de tentativas antes de considerar a tarefa como falha permanente
        window: 120s             # Janela de observação para contabilizar falhas

```

- **Variações & Comentários:**
    - Omita `delay`, `max_attempts` ou `window` para usar os valores padrão (`0`, ilimitado e `0s`, respectivamente).
    - Se `restart_policy` não for definido, o Compose usa o comportamento do campo `restart` do serviço ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).

---

## 5. Cenários de Restrição ou Não Aplicação

- **Modo não-Swarm (Compose “standalone”):**
    - A seção `deploy` (e, portanto, `restart_policy`) é **ignorada**. Use o campo top-level `restart` no lugar.
- **Containers rodando interativamente (foreground):**
    - Políticas de reinício não se aplicam até que o container esteja “vivo” por pelo menos 10 segundos, evitando loops de reinício sem sucesso ([docs.docker.com](https://docs.docker.com/engine/containers/start-containers-automatically/?utm_source=chatgpt.com)).
- **Quando não usar:**
    - Serviços de curta duração (ex.: jobs batch) que devem falhar rapidamente.
    - Se você não estiver ou não puder usar Swarm.

---

## 6. Componentes Chave de `restart_policy`

| Campo | Descrição | Valores e Padrões |
| --- | --- | --- |
| `condition` | Define **quando** reiniciar. | `none`, `on-failure`, `any` (default) |
| `delay` | Intervalo de tempo entre tentativas de reinício. | Qualquer duração válida (e.g., `5s`, `1m`) |
| `max_attempts` | Número máximo de tentativas de reinício que podem falhar dentro de uma janela. | Inteiro ≥ 1 (padrão: ilimitado) |
| `window` | Período de tempo para contabilizar falhas antes de resetar a contagem de `max_attempts`. | Qualquer duração válida (e.g., `120s`) |

Cada tentativa só conta contra `max_attempts` se o container não se mantiver em execução por pelo menos a duração especificada em `window` ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com)).

---

## 7. Melhores Práticas e Padrões de Uso

- **Escolha de `condition`:**
    - `on-failure`: ótimo para detectar falhas inesperadas.
    - `any`: útil para serviços que **não** podem parar, mesmo que voluntariamente.
    - `none`: para jobs controlados externamente, sem reinício automático.
- **Defina `delay`:** evite reinícios muito rápidos que sobrecarregam o host ou logs. Um valor entre 5s e 30s é comum.
- **Estabeleça `max_attempts` e `window`:** previne loops intermináveis. Por exemplo, `max_attempts: 5` e `window: 1m` limita a cinco falhas por minuto antes de a tarefa entrar em estado “failed”.
- **Use healthchecks em conjunto:** combine `restart_policy` com `healthcheck` para reiniciar containers que fiquem em estado de saúde ruim.
- **Documente no repositório:** registre as políticas adotadas para facilitar a manutenção de equipe e auditorias.

---

## 8. Exemplo Prático Completo

```yaml
version: "3.8"

services:
  api:
    image: myorg/api:latest
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 60s

```

**O que acontece neste exemplo?**

1. O serviço `api` roda 3 réplicas no Swarm.
2. Cada container passa por healthchecks periódicos.
3. Se um container falhar (exit code ≠ 0 **ou** healthcheck falhar repetidamente), o Swarm espera 10s (`delay`), tenta até 5 vezes em 60s (`window`), e só então marca a tarefa como “failed” permanentemente.

---

## 9. Sugestões para Aprofundamento

- Documentação oficial do Compose Specification sobre [`deploy.restart_policy`](https://docs.docker.com/reference/compose-file/deploy/#restart_policy) ([docs.docker.com](https://docs.docker.com/reference/compose-file/deploy/?utm_source=chatgpt.com))
- Artigo “Resilience patterns for containerized applications”
- Livros/recursos sobre Docker Swarm e orquestração avançada

---

Com isso, você dispõe de uma visão completa do atributo `restart_policy`: desde seus conceitos, passando pela sintaxe, até um exemplo real de aplicação. Se precisar de mais detalhes ou de um cenário específico, é só avisar!