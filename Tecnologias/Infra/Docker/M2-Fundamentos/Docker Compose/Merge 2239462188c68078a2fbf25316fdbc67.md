# Merge

**Merging Docker Compose Files: Guia Detalhado**

---

## Sumário

1. [Introdução](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#introdu%C3%A7%C3%A3o)
2. [Conceitos Fundamentais](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
3. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
4. [Regras de Merge (Merging Rules)](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#regras-de-merge)
5. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
6. [Componentes Chave Associados](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
7. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
8. [Exemplo Prático Completo](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
9. [Sugestões para Aprofundamento](https://chatgpt.com/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## 1. Introdução

Docker Compose fornece uma forma de definir e executar aplicações multi-container via arquivos YAML. Muitas vezes, você precisa customizar configurações para diferentes ambientes (desenvolvimento, testes, produção) ou combinar fragmentos de configuração de várias equipes. O **merge** de arquivos Compose permite compor esses YAMLs de modo que configurações compartilhadas sejam definidas no “base” e sobrepostas ou estendidas nos arquivos subsequentes, resultando em um único modelo de aplicação ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/?utm_source=chatgpt.com)).

---

## 2. Conceitos Fundamentais

- **Base & Override**: Por convenção, `docker-compose.yml` contém a configuração base; `docker-compose.override.yml` (opcional) contém ajustes para seu ambiente local.
- **Composição Sequencial**: Compose lê múltiplos arquivos na ordem especificada pelo `f` ou pela variável `COMPOSE_FILE`, aplicando cada um sobre o anterior ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/?utm_source=chatgpt.com)).
- **Merge vs Override**:
    - *Override* (substituição): para opções de valor único (ex.: `image`, `command`), o valor do arquivo posterior substitui o anterior ([docs.docker.com](https://docs.docker.com/reference/compose-file/merge/?utm_source=chatgpt.com)).
    - *Merge* (concatenação/união): para listas e mapas, entradas novas são adicionadas sem remover as existentes, respeitando restrições de unicidade ([docs.docker.com](https://docs.docker.com/reference/compose-file/merge/?utm_source=chatgpt.com)).

---

## 3. Sintaxe Detalhada e Uso Prático

### 3.1. Especificando múltiplos arquivos

```bash
# Usando -f na CLI (ordem importa)
$ docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Via variável de ambiente
$ export COMPOSE_FILE="docker-compose.yml:docker-compose.local.yml"
$ docker compose up

```

- **Importante**: caminhos são sempre relativos ao primeiro arquivo especificado ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/?utm_source=chatgpt.com)).

### 3.2. Exemplo comentado

```yaml
# docker-compose.yml (base)
services:
  web:
    image: myapp:latest
    ports:
      - "80:80"
    volumes:
      - "./src:/app"

# docker-compose.debug.yml (override)
services:
  web:
    environment:
      - DEBUG=true    # adiciona variável, lista é mesclada
    command: ["npm", "run", "start:dev"]  # sobrescreve command

```

Após executar

```bash
docker compose -f docker-compose.yml -f docker-compose.debug.yml up

```

o serviço `web` terá:

- `image: myapp:latest`
- `ports: ["80:80"]`
- `volumes: ["./src:/app"]`
- `environment: ["DEBUG=true"]`
- `command: ["npm","run","start:dev"]` ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/reference/compose-file/merge/?utm_source=chatgpt.com))

---

## 4. Regras de Merge

| Tipo de Atributo | Comportamento |
| --- | --- |
| **Valores Simples** | Substituição pelo valor do arquivo posterior. |
| **Mapas (maps)** | Mesclagem profunda; chaves novas são adicionadas ou sobrescritas. |
| **Listas (arrays)** | Itens novos são **adicionados** ao final, **exceto** quando chave única se repete. |
| **Recursos únicos** | `ports`, `volumes`, `secrets`, `configs` respeitam chaves únicas (ex.: `target`) e substituem entradas conflitantes. |
| **!reset** | Tag YAML personalizada para **remover** elementos e resetar ao valor default/null. ([docs.docker.com](https://docs.docker.com/reference/compose-file/merge/?utm_source=chatgpt.com)) |

---

## 5. Cenários de Restrição ou Não Aplicação

- **Arquivos inválidos isolados**: override files podem conter apenas fragmentos e, portanto, não precisam ser arquivos Compose completos. Caminhos relativos podem quebrar se não respeitarem a base.
- **Complexidade excessiva**: múltiplos níveis de overrides podem confundir; em casos críticos, prefira utilizar ferramentas de templating (ex.: Helm, Kustomize) ou `include` ao invés de merges complexos ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/?utm_source=chatgpt.com)).
- **Casos de performance**: merge com listas muito grandes (ex.: dezenas de volumes/ports) pode tornar a resolução lenta em projetos monolíticos.

---

## 6. Componentes Chave Associados

- **Variável COMPOSE_FILE**: define sequência de arquivos.
- **Flag `f`**: sobrepõe COMPOSE_FILE em linha de comando.
- **Comando `docker compose config`**: exibe o YAML resultante do merge, útil para depurar caminhos e merges impróprios ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/?utm_source=chatgpt.com)).
- **Tag YAML `!reset`**: reseta listas ou valores definidos anteriormente.
- **Seção `include`** (Compose V2+): alternativa modular que carrega arquivos completos e resolve recursivamente caminhos, evitando algumas armadilhas de merge ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/include/?utm_source=chatgpt.com)).

---

## 7. Melhores Práticas e Padrões de Uso

- **Mantenha o base limpo**: defina apenas o mínimo necessário no arquivo base (`docker-compose.yml`).
- **Ambientes separados**: crie arquivos distintos para `dev`, `test`, `staging` e `prod`, usando nomes consistentes (ex.: `docker-compose.dev.yml`).
- **Documente a ordem de merge**: inclua comentários no repositório explicando a sequência `f` ou a variável `COMPOSE_FILE`.
- **Use `docker compose config`**: sempre valide o YAML resultante antes de subir em CI/CD.
- **Evite excesso de merges aninhados**: se a lógica de override ficar muito complexa, avalie separar responsabilidades em micro-serviços ou usar `include`.
- **Normalize caminhos**: prefira paths relativos e valide-os contra o diretório do projeto-base.

---

## 8. Exemplo Prático Completo

Imagine uma aplicação com três ambientes:

```bash
project/
├── docker-compose.yml                # base
├── docker-compose.dev.yml            # desenvolvimento local
├── docker-compose.ci.yml             # integração contínua
└── docker-compose.prod.yml           # produção

```

**docker-compose.yml**

```yaml
version: "3.9"
services:
  app:
    image: myorg/app:latest
    ports: ["8080:80"]
    environment:
      - APP_ENV=base

```

**docker-compose.dev.yml**

```yaml
services:
  app:
    environment:
      - APP_ENV=development
    volumes:
      - "./src:/app"           # habilita hot-reload

```

**docker-compose.ci.yml**

```yaml
services:
  app:
    environment:
      - APP_ENV=ci
    command: ["npm", "test"]   # executa testes no CI

```

**docker-compose.prod.yml**

```yaml
services:
  app:
    environment:
      - APP_ENV=production
    deploy:
      replicas: 3
    volumes:                     # produção não monta código local
      - "app-data:/app/data"
volumes:
  app-data:

```

**Uso para produção**:

```bash
docker compose \
  -f docker-compose.yml \
  -f docker-compose.prod.yml \
  up -d

```

Resultado:

- `image: myorg/app:latest`
- `ports: ["8080:80"]`
- `environment: ["APP_ENV=production"]`
- `deploy.replicas: 3`
- `volumes: ["app-data:/app/data"]`

---

## 9. Sugestões para Aprofundamento

- **Compose Specification**: leia a seção de [múltiplos arquivos na especificação oficial](https://docs.docker.com/compose/how-tos/multiple-compose-files/) ([docs.docker.com](https://docs.docker.com/compose/how-tos/multiple-compose-files/?utm_source=chatgpt.com)).
- **`docker compose config --resolve-image-digests`**: valida imagens e paths no merge.
- **Ferramentas complementares**: explore Helm (Kubernetes), Kustomize ou Ansible para cenários de infraestrutura mais complexa.
- **Artigos e comunidades**: acompanhe blogs como o Docker Blog e fóruns StackOverflow para casos de uso reais.

---

*Conta comigo para qualquer dúvida adicional ou exemplos práticos específicos!*