# USER

# Instrução `USER` em Dockerfile

## Introdução

A instrução `USER` especifica o usuário e o grupo sob os quais comandos subsequentes (`RUN`, `CMD`, `ENTRYPOINT`, etc.) serão executados dentro do contêiner. Isso é fundamental para segurança, evitando que processos rodem como root e garantindo permissões apropriadas.

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Usuário no contêiner:** Por padrão, o Docker executa comandos como root (UID 0), o que pode representar riscos de segurança em produção.
- **Isolamento de privilégios:** Definir um usuário não privilegiado impede que processos comprometedores afetem o sistema host ou se expandam dentro do contêiner.
- **Herança de contexto:** A instrução afeta todas as instruções seguintes até outro `USER` ser declarado.

---

## Sintaxe Detalhada e Uso Prático

```
USER <usuário>[:<grupo>]

```

- `<usuário>`: Nome ou UID do usuário.
- `<grupo>` (opcional): Nome ou GID do grupo.

### Exemplos

1. **Definir usuário e grupo por nome**
    
    ```
    RUN groupadd -r appgroup && useradd -r -g appgroup appuser
    USER appuser:appgroup
    
    ```
    
2. **Usar UID/GID diretamente**
    
    ```
    USER 1001:1001
    
    ```
    
3. **Alternar temporariamente para root**
    
    ```
    USER root
    RUN apt-get update && apt-get install -y curl
    USER appuser
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Ações que requerem privilégios:** Instalação de pacotes ou modificações de sistema demandam usuário root.
- **Imagens de uso único:** Em cenários de protótipos locais, manter root pode agilizar o desenvolvimento, embora não seja recomendado.
- **Ausência de usuários adicionais:** Se a imagem base não definir usuários além do root, é necessário criá-los com `RUN useradd` antes de usar `USER`.

---

## Componentes Chave Associados

- **Instruções `RUN` anteriores:** Devem incluir comandos para criar usuários/grupos (`useradd`, `groupadd`).
- **Permissões de arquivos:** Arquivos e diretórios copiados devem ter dono/grupo compatíveis com o usuário definido.
- **Volumes montados:** Volumes herdados do host podem ter permissões que impedem escrita por usuários não root.

---

## Melhores Práticas e Padrões de Uso

1. **Criar usuário e grupo dedicados:** Evita usar o mesmo UID/GID de privilégios elevados.
2. **Atribuir permissões corretas:** Use `chown` em `COPY` para ajustar dono e grupo dos arquivos:
    
    ```
    COPY --chown=appuser:appgroup . /app
    
    ```
    
3. **Minimizar uso de root:** Execute apenas as etapas de instalação como root e retorne a um usuário restrito para demais comandos.
4. **Documentar usuários:** Declare no README qual usuário deve ser utilizado para executar processos.
5. **Verificar permissions de runtime:** Teste o contêiner simulando o usuário configurado.

---

## Exemplo Prático Completo

```
FROM node:18-alpine

# Criar usuário não privilegiado
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

WORKDIR /app

# Copiar código com dono correto
COPY --chown=appuser:appgroup . .

# Instalar dependências como root
USER root
RUN npm ci --only=production

# Retornar para usuário não privilegiado
USER appuser

EXPOSE 3000
CMD ["node", "server.js"]

```

1. Cria `appuser` e `appgroup` sem privilégios de root.
2. Copia arquivos com `chown` para evitar problemas de permissões.
3. Executa instalação de dependências como root.
4. Retorna a `appuser` para rodar a aplicação em modo restrito.

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [`USER`](https://docs.docker.com/engine/reference/builder/#user)
- Artigos sobre **segurança de contêineres** e **princípio de menor privilégio**
- Ferramentas de scanning como **Trivy** para verificar uso de root em imagens

---

*Documento gerado para explicar detalhadamente a instrução `USER` em Dockerfile.*