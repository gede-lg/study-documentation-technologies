# ENV

## Instrução `ENV` no Dockerfile: definição, sintaxe e uso prático

---

## Introdução

A instrução `ENV` em um **Dockerfile** serve para **definir variáveis de ambiente** que persistirão no contêiner em tempo de build e também estarão disponíveis em tempo de execução. Essas variáveis podem configurar o comportamento da aplicação ou do processo dentro do container, além de influenciar outras instruções do Dockerfile que façam substituição de variáveis ([docs.docker.com](https://docs.docker.com/get-started/docker-concepts/building-images/writing-a-dockerfile/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
    - Declaração de variáveis
    - Substituição e escopo
    - Diferença entre `ENV` e `ARG`
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Persistência:** variáveis definidas com `ENV` ficam gravadas como metadados na imagem e estarão disponíveis ao container e a instruções subsequentes do Dockerfile ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).
- **Substituição de variáveis:** o Docker substitui qualquer ocorrência de `$VAR` ou `${VAR}` nas instruções **após** a definição de `ENV`; mudanças só valem para instruções posteriores ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).
- **Camadas de imagem:** cada `ENV` gera uma nova camada; alterar valores faz invalidar o cache das camadas seguintes ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).

---

## Sintaxe Detalhada e Uso Prático

### 1. Declaração de variáveis

- **Formato recomendado (key=value):**
    
    ```
    ENV NOME_VARIAVEL=valor
    
    ```
    
    Evita ambiguidades e segue o padrão moderno ([docs.docker.com](https://docs.docker.com/reference/build-checks/legacy-key-value-format/?utm_source=chatgpt.com)).
    
- **Formato legado (key value):**
    
    ```
    ENV NOME_VARIAVEL valor
    
    ```
    
    **Depreciado**, presente apenas para compatibilidade ([docs.docker.com](https://docs.docker.com/reference/build-checks/legacy-key-value-format/?utm_source=chatgpt.com)).
    
- **Declarações múltiplas em uma linha:**
    
    ```
    ENV VAR1=valor1 VAR2=valor2 VAR3=valor3
    
    ```
    
    Conveniente para agrupar variáveis relacionadas ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).
    

### 2. Substituição e escopo

- **Escopo sequencial:**
    
    ```
    ENV A=hello
    ENV B=$A-world
    ENV C=${A}_again
    
    ```
    
    - `B` → `hello-world`
    - `C` → `hello_again` ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).
- **Uso em outras instruções:**
    
    ```
    ENV HOME=/app
    WORKDIR $HOME           # equivale a WORKDIR /app
    COPY . $HOME            # copia para /app
    ``` :contentReference[oaicite:8]{index=8}.
    
    ```
    

### 3. Diferença entre `ENV` e `ARG`

- **`ARG`:** variável de build, **não** persiste na imagem final (ideia: parâmetro de build) ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com)).
- **`ENV`:** variável de ambiente, persiste na imagem e está disponível em tempo de execução ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com)).
- **Segurança:** não use `ENV` para segredos (são expostos na imagem); para credenciais, prefira **secret mounts** ou variáveis externas via `docker run -e` e/ou Compose ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Segredos e credenciais sensíveis:** evita `ENV` para senhas ou tokens, pois ficam registradas na imagem ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com)).
- **Valores dinâmicos em tempo de build:** se precisa parametrizar seu build pela CLI, use `ARG` e depois `ENV` para propagar valores quando necessário ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com)).
- **Substituições complexas:** para lógica condicional ou múltiplos steps, considere usar scripts em `RUN` em vez de depender exclusivamente de variáveis do Dockerfile.

---

## Componentes Chave Associados

- **`ARG`:** define variável para build; pode ser passada via `-build-arg` e então propagada a `ENV`.
- **`WORKDIR`:** frequentemente combinado com `ENV` para definir diretórios de trabalho dinâmicos.
- **`ENTRYPOINT` / `CMD`:** variáveis definidas podem parametrizar scripts e comandos de inicialização.
- **`docker run -e` / `-env-file`:** permite sobrescrever ou complementar variáveis em tempo de execução, sem a necessidade de rebuild.

---

## Melhores Práticas e Padrões de Uso

1. **Use `ENV` para configurar comportamento padrão**, como porta, diretório ou modo de execução.
2. **Agrupe declarações relacionadas** em uma única instrução para reduzir camadas e otimizar cache.
3. **Prefira key=value** em vez do formato legado.
4. **Não exponha segredos** por `ENV`; utilize mecanismos seguros de secret management (Docker secrets, Compose secrets, mounts) ([docs.docker.com](https://docs.docker.com/build/building/variables/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/?utm_source=chatgpt.com)).
5. **Documente variáveis** no `README`, informando o que pode ser sobrescrito pelo usuário e valores padrões.

---

## Exemplo Prático Completo

```
FROM python:3.12-slim

# 1. Variáveis de configuração
ENV APP_HOME=/usr/src/app \
    PYTHONUNBUFFERED=1 \
    PORT=8000

# 2. Diretório de trabalho
WORKDIR $APP_HOME

# 3. Instalação de dependências
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 4. Cópia do código-fonte
COPY . .

# 5. Porta padronizada e comando de inicialização
EXPOSE $PORT
CMD ["gunicorn", "app:app", "--bind", "0.0.0.0:${PORT}"]

```

- **Explicação resumida:**
    1. Define `APP_HOME` e configura Python para não bufferizar saídas.
    2. Usa `WORKDIR` com variável.
    3. Instala dependências.
    4. Expõe porta dinâmica por `ENV`.
    5. Inicia servidor Gunicorn usando `${PORT}`.

---

## Sugestões para Aprofundamento

- **Dockerfile reference – ENV:** documentação oficial do Docker ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com))
- **Building best practices:** orientações para otimizar camadas e cache ([docs.docker.com](https://docs.docker.com/build/building/best-practices/?utm_source=chatgpt.com))
- **Build secrets & variables:** uso de `ARG`, `ENV` e Docker secrets para segurança ([docs.docker.com](https://docs.docker.com/build/building/secrets/?utm_source=chatgpt.com))
- **Compose e variáveis:** guia de variáveis em Docker Compose via `environment` e `env_file` ([docs.docker.com](https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/?utm_source=chatgpt.com))

---

Com isso, você tem um panorama completo sobre a instrução `ENV` em Dockerfile, conhecendo sua sintaxe, escopo, boas práticas e quando (não) utilizá-la.