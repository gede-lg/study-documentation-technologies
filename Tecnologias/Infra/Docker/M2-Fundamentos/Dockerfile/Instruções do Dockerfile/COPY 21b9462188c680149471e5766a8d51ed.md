# COPY

## Instrução `COPY` no Dockerfile: definição, sintaxe e uso prático

---

## Introdução

A instrução `COPY` em um **Dockerfile** permite transferir arquivos e diretórios **do contexto de build** (diretório local onde o `docker build` é executado) para o sistema de arquivos da imagem em construção. Ao contrário de `ADD`, o `COPY` é limitado a operações de cópia simples, tornando seu comportamento mais previsível e seguro ([docker.com](https://www.docker.com/blog/docker-best-practices-understanding-the-differences-between-add-and-copy-instructions-in-dockerfiles/?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/build/concepts/dockerfile/?utm_source=chatgpt.com)).

---

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Formas de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-formas-de-uso)
    - Cópia simples
    - Uso de curingas e múltiplas fontes
    - Sintaxe `-from` para multi-stage builds
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Contexto de build:** diretório local enviado ao daemon Docker; `COPY` só pode acessar caminhos dentro desse contexto ([docs.docker.com](https://docs.docker.com/build/concepts/dockerfile/?utm_source=chatgpt.com)).
- **Camadas de imagem:** cada `COPY` cria uma nova camada; otimizar quantas e quais arquivos são copiados impacta o tamanho e cache do build ([docs.docker.com](https://docs.docker.com/build/building/best-practices/?utm_source=chatgpt.com)).
- **Diferença para `ADD`:** `ADD` pode baixar URLs e descompactar arquivos `.tar`; `COPY` é mais transparente, lidando apenas com arquivos locais ([docker.com](https://www.docker.com/blog/docker-best-practices-understanding-the-differences-between-add-and-copy-instructions-in-dockerfiles/?utm_source=chatgpt.com)).

---

## Sintaxe Detalhada e Formas de Uso

### 1. Cópia Simples

```
COPY <src> <dest>

```

- `<src>`: caminho relativo (ou curingas) no contexto de build.
- `<dest>`: caminho dentro da imagem; se terminar em `/`, preserva o nome do arquivo/diretório ([docker.com](https://www.docker.com/blog/docker-best-practices-understanding-the-differences-between-add-and-copy-instructions-in-dockerfiles/?utm_source=chatgpt.com)).

### 2. Uso de Curingas e Múltiplas Fontes

```
COPY ["*.js", "config/*.json", "/app/"]

```

- Permite vários padrões (`<src>...`) em **exec form** (JSON-array) para caminhos contendo espaços ou curingas ([github.com](https://github.com/docker/docs/issues/19922?utm_source=chatgpt.com)).

### 3. COPY com `-from` (Multi-Stage Builds)

```
FROM builder AS build-stage
RUN make /app

FROM alpine
COPY --from=build-stage /app/bin/myapp /usr/local/bin/

```

- Copia artefatos de outra **fase nomeada** ou imagem externa, sem expor ferramentas de build no estágio final ([stackoverflow.com](https://stackoverflow.com/questions/66353510/what-is-from-as-used-in-copy-command-in-dockerfile?utm_source=chatgpt.com), [docs.docker.com](https://docs.docker.com/build/building/multi-stage/?utm_source=chatgpt.com)).

---

## Cenários de Restrição ou Não Aplicação

- **Fora do contexto de build:** não consegue copiar arquivos fora da pasta onde o `docker build` foi executado.
- **URLs ou arquivos remotos:** para esses casos, `ADD` ou comandos `RUN curl|wget` são necessários.
- **Arquivos comprimidos:** não descompacta automaticamente; use `ADD` ou scripts de descompressão em `RUN`.

---

## Componentes Chave Associados

- **`WORKDIR`:** afeta caminhos relativos de `COPY`; se não existir, será criado ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com)).
- **`ARG` / `ENV`:** variáveis podem ser usadas em `COPY` apenas em shell form, ou combinando `RUN` e `mv`.
- **Cache de build:** alterar arquivos copiados invalida cache das camadas subsequentes; agrupe instruções para otimizar ([docs.docker.com](https://docs.docker.com/build/building/best-practices/?utm_source=chatgpt.com)).

---

## Melhores Práticas e Padrões de Uso

1. **Prefira `COPY` sobre `ADD`** sempre que não precisar de descompressão ou download automático ([phoenixnap.com](https://phoenixnap.com/kb/docker-add-vs-copy?utm_source=chatgpt.com)).
2. **Use exec form** (`COPY ["src","dest"]`) para lidar com nomes que contenham espaços e evitar interpretações errôneas pelo shell ([github.com](https://github.com/docker/docs/issues/19922?utm_source=chatgpt.com)).
3. **Minimize o número de instruções:** combine múltiplos arquivos em um único `COPY` quando possível, para reduzir camadas.
4. **Separe dependências estáticas de artefatos em multi-stage builds**, copiando apenas o indispensável para o estágio final.

---

## Exemplo Prático Completo

```
# Etapa 1: compilação
FROM golang:1.21 AS builder
WORKDIR /src
COPY go.mod go.sum .                 # Copia dependências
RUN go mod download
COPY . .                              # Copia restante do código
RUN CGO_ENABLED=0 GOOS=linux go build -o app ./cmd/app

# Etapa 2: imagem final enxuta
FROM alpine:latest
WORKDIR /app
COPY --from=builder /src/app .        # Copia binário compilado
COPY config/*.yaml ./config/         # Copia configurações
EXPOSE 8080
USER nobody
ENTRYPOINT ["./app"]

```

**Fluxo explicado:**

1. **Builder:** resolve dependências e gera binário.
2. **Final:** traz apenas o binário e arquivos de configuração, resultando em imagem menor.

---

## Sugestões para Aprofundamento

- **Documentação oficial Dockerfile:** seção COPY ([docs.docker.com](https://docs.docker.com/reference/dockerfile/?utm_source=chatgpt.com))
- **Best practices de build:** como agrupar instruções para otimizar cache ([docs.docker.com](https://docs.docker.com/build/building/best-practices/?utm_source=chatgpt.com))
- **Guia de multi-stage builds:** para reduzir tamanho e melhorar segurança ([docs.docker.com](https://docs.docker.com/build/building/multi-stage/?utm_source=chatgpt.com))

---

Com esta exploração detalhada, você compreenderá quando e como usar a instrução `COPY` em seus Dockerfiles, garantindo imagens mais limpas, seguras e eficientes.