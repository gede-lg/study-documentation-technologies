# HEALTHCHECK

# Instrução `HEALTHCHECK` em Dockerfile

## Introdução

A instrução `HEALTHCHECK` permite definir comandos que o Docker executa periodicamente dentro do contêiner para verificar se a aplicação está saudável (pronta e funcionando). Isso melhora a confiabilidade de orquestrações e sistemas de monitoramento, detectando falhas de forma automatizada.

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Saúde do contêiner:** Permite diferenciar contêineres em execução (UP) daqueles que, apesar de ativos, não respondem corretamente.
- **Integração com orquestradores:** Kubernetes, Docker Swarm e ECS podem reiniciar ou remover contêineres cujo health status esteja `unhealthy`.
- **Evitar falsos positivos/negativos:** Parâmetros como `interval`, `timeout` e `start-period` calibram a frequência e sensibilidade das checagens.

A presença de `HEALTHCHECK` em um Dockerfile adiciona uma camada extra de resiliência à arquitetura de microserviços, pois sinais de falha são detectados internamente.

---

## Sintaxe Detalhada e Uso Prático

```
HEALTHCHECK [OPTIONS] CMD <comando>
# ou
HEALTHCHECK NONE

```

- `CMD <comando>`: Define o comando que retorna:
    - `0` em caso de sucesso (`healthy`)
    - `1` em caso de falha (`unhealthy`)
    - `2` em caso de estado `starting` (opcional)
- `NONE`: Desabilita qualquer checagem de saúde herdada da imagem base.

### Opções

- `-interval=DURATION` (padrão: `30s`): Tempo entre cada execução do comando.
- `-timeout=DURATION` (padrão: `30s`): Tempo máximo para o comando completar.
- `-start-period=DURATION` (padrão: `0s`): Período inicial de tolerância após o contêiner iniciar.
- `-retries=N` (padrão: `3`): Número de vezes que o comando pode falhar antes de marcar `unhealthy`.

### Exemplos

1. **Checagem simples de HTTP**
    
    ```
    HEALTHCHECK --interval=1m --timeout=10s --start-period=30s \
      CMD curl -f http://localhost:8080/health || exit 1
    
    ```
    
2. **Checagem de script personalizado**
    
    ```
    COPY healthcheck.sh /usr/local/bin/
    HEALTHCHECK --interval=45s CMD ["/usr/local/bin/healthcheck.sh"]
    
    ```
    
3. **Desabilitar checagem**
    
    ```
    HEALTHCHECK NONE
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Contêineres efêmeros e de curta duração:** Para tarefas one-shot (ex.: migrações de banco), o healthcheck pode ser desnecessário.
- **Aplicações sem interface de rede ou endpoints definidos:** Se não houver como verificar via HTTP ou TCP, exigir scripts internos.
- **Hospedagem em ambientes sem suporte a healthchecks do orquestrador:** Alguns sistemas legados ignoram o status `unhealthy`.

---

## Componentes Chave Associados

- **Script de saúde:** Arquivo shell, Python ou binário instalado na imagem que retorna códigos apropriados.
- **Ferramentas de rede:** `curl`, `wget`, `nc` ou bibliotecas client-side para TCP/HTTP.
- **Variáveis de ambiente:** Podem parametrizar endpoints, portas e credenciais.

---

## Melhores Práticas e Padrões de Uso

1. **Uso de `-start-period`:** Defina um período de espera para serviços que demoram a iniciar (ex.: bancos de dados).
2. **Comandos idempotentes:** Garanta que o healthcheck não altere estado interno.
3. **Falhas tolerantes:** Configure `-retries` e `-timeout` condizentes ao comportamento normal da aplicação.
4. **Logs claros:** Em scripts personalizados, registre falhas para facilitar debugging.
5. **Monitoring externo:** Combine healthchecks internos com métricas expostas via Prometheus ou similares.
6. **Documentação:** Descreva no README do projeto o endpoint e lógica do healthcheck.

---

## Exemplo Prático Completo

```
# Imagem base com curl instalado
FROM golang:1.21-alpine

# Aplicação Go simples que expõe /health
WORKDIR /app
COPY . .
RUN go build -o myservice

# Definição do healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=5 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1

# CMD padrão
CMD ["./myservice"]

```

1. **Build**: Compila o serviço Go.
2. **Healthcheck**: Tenta acessar `/health` a cada 30s, aguardando até 5s por resposta. Após 10s de start, considera 5 falhas consecutivas para `unhealthy`.
3. **Reação do orquestrador**: Kubernetes reiniciará o pod marcado como `unhealthy`.

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [`HEALTHCHECK`](https://docs.docker.com/engine/reference/builder/#healthcheck)
- Artigos sobre **práticas de healthchecks em microserviços**
- Integração de healthchecks com **Kubernetes liveness e readiness probes**

---

*Documento gerado para explicar detalhadamente o uso da instrução `HEALTHCHECK` em Dockerfile.*