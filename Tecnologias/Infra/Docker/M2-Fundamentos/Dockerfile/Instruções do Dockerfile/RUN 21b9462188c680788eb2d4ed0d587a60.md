# RUN

# Instrução `RUN` em Dockerfile

## Introdução

A instrução `RUN` executa comandos no sistema de arquivos da imagem durante o processo de build, criando uma nova camada a cada execução. É essencial para instalar pacotes, compilar código e preparar o ambiente do contêiner.

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Camadas de imagem**: Cada `RUN` cria uma camada imutável, contribuindo para o cache de build.
- **Cache de build**: Se o comando e contexto não mudarem, o Docker reutiliza camadas anteriores, acelerando builds.
- **Modo Shell vs exec**: Permite escolher entre interpretar comandos em shell ou executá-los diretamente.

---

## Sintaxe Detalhada e Uso Prático

```
RUN <comando_shell>
# ou
RUN ["executable", "param1", "param2", ...]

```

- **Shell form**: Interpreta o comando em `/bin/sh -c` (padrão). Permite encadear comandos com operadores (`&&`, `||`).
- **Exec form**: Executa diretamente o executável, sem envolver shell, evitando expansão de variáveis e caracteres especiais.

### Exemplos

1. **Instalar pacotes em imagem Ubuntu (shell form)**
    
    ```
    RUN apt-get update && apt-get install -y \
        curl \
        ca-certificates \
      && rm -rf /var/lib/apt/lists/*
    
    ```
    
2. **Criar diretório e copiar arquivos (exec form)**
    
    ```
    RUN ["mkdir", "-p", "/app/logs"]
    
    ```
    
3. **Rodar script de setup**
    
    ```
    COPY setup.sh /usr/local/bin/
    RUN chmod +x /usr/local/bin/setup.sh && \
        /usr/local/bin/setup.sh
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Quantidade excessiva de camadas**: Muitos `RUN` separados sem otimização podem inflar a imagem.
- **Dependência de contexto local**: Comandos que dependem de arquivos ausentes no contexto de build falham.
- **Comandos interativos**: `RUN` não suporta prompts interativos; use parâmetros não interativos (ex.: `DEBIAN_FRONTEND=noninteractive`).

---

## Componentes Chave Associados

- **Cache de camadas**: Otimiza builds ao pular passos inalterados.
- **Chaves de build args e env**: Variáveis definidas com `ARG` e `ENV` são avaliadas no momento de `RUN`.
- **Shell padrão**: Variável `SHELL` pode alterar o shell usado para a shell form (`bash`, `powershell`).

---

## Melhores Práticas e Padrões de Uso

1. **Minimizar número de camadas**: Agrupe comandos relacionados em um único `RUN` usando `&&`.
2. **Limpar caches**: Remova arquivos temporários após instalações para reduzir tamanho.
3. **Usar exec form para segurança**: Evita problemas de parsing de shell quando possível.
4. **Definir `SHELL` quando necessário**: Por exemplo, usar `SHELL ["powershell", "-Command"]` em imagens Windows.
5. **Evitar variáveis não definidas**: Use `ARG` antes de `RUN` para parâmetros de build.

---

## Exemplo Prático Completo

```
FROM ubuntu:20.04
# Definir shell bash
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Instalar e limpar em um único passo
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y \
       curl \
       python3-pip \
    && pip3 install --no-cache-dir flask \
    && apt-get purge -y --auto-remove \
       python3-pip \
    && rm -rf /var/lib/apt/lists/*

COPY . /app
WORKDIR /app
RUN pip3 install --no-cache-dir -r requirements.txt

CMD ["python3", "app.py"]

```

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [`RUN`](https://docs.docker.com/engine/reference/builder/#run)
- Artigos sobre **otimização de camadas** e **build caching**
- Exemplos de uso de `SHELL` para diferentes ambientes de build

---

*Documento gerado para explicar detalhadamente a instrução `RUN` em Dockerfile.*