# ARG

## Introdução

A instrução `ARG` no Dockerfile permite definir *build-time variables*, ou seja, variáveis que somente existem durante o processo de construção da imagem. Elas não são incluídas no *runtime* da imagem, diferentemente das variáveis definidas por `ENV`. O uso de `ARG` traz flexibilidade ao parametrizar versões, caminhos e opções de compilação, sem precisar modificar o Dockerfile sempre que um parâmetro muda.

## Sumário

1. [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
2. [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
3. [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
4. [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
5. [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
6. [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
7. [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Escopo de Build:** Variáveis `ARG` existem apenas durante o *build* da imagem. Após a construção, elas não ficam disponíveis no *container* em execução.
- **Substituição de Valores:** É possível passar valores diferentes em tempo de build usando a opção `-build-arg` do comando `docker build`.
- **Escopo em Múltiplos Estágios (Multi-stage builds):** Cada estágio de build herda os `ARG` definidos antes do primeiro `FROM`. Se definidos dentro de um estágio, só valem naquele estágio.
- **Segurança:** Argumentos não devem ser usados para segredos, pois ficam registrados no histórico de camadas.

---

## Sintaxe Detalhada e Uso Prático

```
# Definição básica de ARG com valor padrão
ARG NOME_VARIAVEL=valor_padrao

# Exemplo simples sem valor padrão
ARG BUILD_NUMBER

# ARG pode ser usado em instruções posteriores
RUN echo "Build número: ${BUILD_NUMBER}"

```

### Detalhes:

1. **Posicionamento:**
    - Antes ou após o `FROM`. Se estiver antes do primeiro `FROM`, torna-se global e pode ser usado em instruções `FROM` (desde Docker 17.05).
    - Se definido após um `FROM`, só está disponível dentro daquele estágio.
2. **Passagem de Valores no Build:**

```bash
docker build \
  --build-arg NOME_VARIAVEL=meu_valor \
  -t minha-imagem:latest .

```

1. **Uso em `FROM`:**

```
# Define globalmente antes do FROM
ARG BASE_VERSION=3.14
FROM alpine:${BASE_VERSION}

```

1. **Comportamento em Multi-stage Builds:**

```
# ARG global
ARG APP_VERSION=1.0.0
FROM node:18 AS builder
ARG BUILD_DIR=/app
WORKDIR ${BUILD_DIR}
COPY . .
RUN npm install && npm run build

# Novo estágio herda APP_VERSION, mas não BUILD_DIR
FROM nginx:alpine
ARG DEST_DIR=/usr/share/nginx/html
COPY --from=builder /app/build ${DEST_DIR}

```

---

## Cenários de Restrição ou Não Aplicação

- **Variáveis de Ambiente de Runtime:** Se precisar passar configurações para o container em execução, use `ENV` ou `docker run -e`.
- **Uso de Segredos:** Não utilize `ARG` para senhas, tokens ou chaves, pois elas ficam expostas no histórico de construção.
- **Imagens Leves (`scratch`):** Em imagens baseadas em `scratch`, não há shell ou comandos para interpolar variáveis, limitando o uso de `ARG` em `RUN`.
- **Cache de Build Sensível:** Mudar valores de `ARG` invalida camadas de cache, o que pode impactar performance se não for gerenciado corretamente.

---

## Componentes Chave Associados

- **`-build-arg`:** Flag do `docker build` para sobrescrever valores de `ARG`.
- **`ENV`:** Define variáveis persistentes no container (*runtime*).
- **`LABEL`:** Metainformação que pode incluir versões ou metadados estáticos.
- **`ONBUILD ARG`:** Em *base images*, instrui imagens-filhas a receber esse `ARG`.
- **BuildKit:** Suporta cache avançado e *secrets* em multistage builds (usando `-secret` em vez de `ARG`).

---

## Melhores Práticas e Padrões de Uso

1. **Defina Defaults Claros:** Sempre atribua valores padrão razoáveis em `ARG` para facilitar builds locais.
2. **Documente no README:** Liste todos os argumentos aceitos e seus propósitos.
3. **Nomeação Consistente:** Use convenções como letras maiúsculas e underscores (ex.: `APP_PORT`).
4. **Minimize o Escopo:** Defina `ARG` dentro de estágios específicos se só serão usados lá.
5. **Combine com Multi-stage:** Use `ARG` para parametrizar versões de compiladores e otimizar imagens finais.
6. **Evite para Segredos:** Prefira recursos de *secret management* do BuildKit (`-secret`) para chaves privadas.

---

## Exemplo Prático Completo

Imagine um projeto em Node.js que precisa ser construído e servido via Nginx:

```
# 1) Parâmetros globais para versão de Node
ARG NODE_VERSION=18-alpine

# 2) Estágio de build
FROM node:${NODE_VERSION} AS builder
ARG APP_DIR=/usr/src/app
WORKDIR ${APP_DIR}

# 3) Instalando dependências
COPY package*.json ./
RUN npm install --production

# 4) Build da aplicação
COPY . .
RUN npm run build

# 5) Estágio final
FROM nginx:alpine
ARG DIST_DIR=/usr/src/app/build

# 6) Copiando artefatos do builder
COPY --from=builder ${DIST_DIR} /usr/share/nginx/html

# 7) Expondo porta e definindo variáveis de runtime
EXPOSE 80

```

### Passo a passo

1. **Definir `NODE_VERSION`:** Permite trocar facilmente a versão do Node.js via `-build-arg NODE_VERSION=20-alpine`.
2. **Customizar `APP_DIR` e `DIST_DIR`:** Facilita reorganização de diretórios no build.
3. **Multi-stage build:** Gera imagem final enxuta sem dependências de compilação.
4. **Reprodução de Builds:** Parâmetros claros garantem builds reproduzíveis.

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [ARG | Dockerfile reference](https://docs.docker.com/engine/reference/builder/#arg)
- Guia sobre BuildKit e secrets: [Docker Build Secrets](https://docs.docker.com/develop/develop-images/build_enhancements/)
- Artigo sobre multi-stage builds e caches avançados