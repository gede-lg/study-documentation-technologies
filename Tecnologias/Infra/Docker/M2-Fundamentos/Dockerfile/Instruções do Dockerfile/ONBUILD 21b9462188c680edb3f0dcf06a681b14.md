# ONBUILD

# Instrução `ONBUILD` em Dockerfile

## Introdução

A instrução `ONBUILD` permite adicionar *gatilhos* (*triggers*) a uma imagem Docker que serão executados **somente quando aquela imagem for usada como base** em um Dockerfile subsequente. Em outras palavras, define ações “adormecidas” que disparam durante o build de um contêiner filha.

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **Gatilhos de Build:** `ONBUILD` registra instruções que não são executadas no momento da criação da imagem base, mas sim quando essa imagem é referenciada por outro Dockerfile via `FROM`.
- **Modularidade e Extensibilidade:** Útil para criar imagens base genéricas (por exemplo, uma imagem para aplicações Node.js) que já definem etapas comuns de cópia e instalação de dependências sem expor detalhes ao usuário final.
- **Encapsulamento de Pipelines:** Permite que mantenedores de imagens definam pipelines de build padronizados, garantindo consistência em projetos derivados.

---

## Sintaxe Detalhada e Uso Prático

```
ONBUILD <instrução>

```

- `<instrução>`: Qualquer instrução válida de Dockerfile, como `COPY`, `ADD`, `RUN`, `ENV`, etc.

### Exemplos

1. **Copiar código e instalar dependências em imagem base**
    
    ```
    FROM node:18-alpine
    ONBUILD COPY package*.json /app/
    ONBUILD WORKDIR /app
    ONBUILD RUN npm install
    
    ```
    
    - Quando outro Dockerfile usar `FROM minha-imagem-node`, as três instruções `ONBUILD` serão executadas neste ponto.
2. **Adicionar trigger de build para projetos Python**
    
    ```
    FROM python:3.11-slim
    ONBUILD COPY requirements.txt /requirements.txt
    ONBUILD RUN pip install --no-cache-dir -r /requirements.txt
    ONBUILD COPY . /app
    
    ```
    
3. **Uso de ARG dentro de ONBUILD**
    
    ```
    FROM golang:1.21
    ARG APP_DIR=/go/src/app
    ONBUILD RUN mkdir -p ${APP_DIR}
    ONBUILD COPY . ${APP_DIR}
    ONBUILD RUN go build -o /usr/local/bin/app ${APP_DIR}
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Surpresa para usuários:** Pode gerar builds inesperados, pois instruções são ocultas até o build do filho.
- **Manutenção de imagens legadas:** Ao atualizar uma imagem com `ONBUILD`, projetos filhos podem quebrar silenciosamente.
- **Multi-stage builds extensos:** Gatilhos se aplicam ao estágio onde `FROM` é declarado, mas podem não ser adequados para complexos pipelines de estágios múltiplos.

---

## Componentes Chave Associados

- **Imagem Base com ONBUILD:** Imagem que define gatilhos.
- **Dockerfile Filho:** Arquivo que referencia `FROM` na imagem com `ONBUILD`, disparando os triggers.
- **Chamadas de Trigger:** Execução automática das instruções ONBUILD no ponto em que aparecem no Dockerfile filho.

---

## Melhores Práticas e Padrões de Uso

1. **Documentar gatilhos** no README para que usuários saibam o que será executado.
2. **Usar para scaffolding** de projetos — criar imagens base destinadas a frameworks específicos.
3. **Evitar em imagens públicas genéricas** — prefira `ENTRYPOINT` e `CMD` para flexibilidade.
4. **Teste contínuo** das imagens base e de imagens filhas para capturar quebras inesperadas.
5. **Limitar número de ONBUILD** — muitos triggers podem deixar o build confuso.

---

## Exemplo Prático Completo

**Imagem Base `myorg/node-app-base`**

```
# Stage 1: base
FROM node:18-alpine
LABEL maintainer="Equipe DevOps <devops@myorg.com>"
WORKDIR /app

# Definindo triggers para projetos Node.js
ONBUILD COPY package*.json ./
ONBUILD RUN npm ci --only=production
ONBUILD COPY . ./

# Exposição da porta
EXPOSE 3000
CMD ["node", "index.js"]

```

**Dockerfile de Projeto Filho**

```
FROM myorg/node-app-base
# Aqui os ONBUILD são acionados:
# 1. copia package*.json
# 2. instala dependências
# 3. copia código

# Podemos adicionar customizações adicionais:
ENV NODE_ENV=production

# Feito! A imagem já está pronta para rodar.

```

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [`ONBUILD`](https://docs.docker.com/engine/reference/builder/#onbuild)
- Artigos sobre **scaffolding de imagens** e **padrões de images base**
- Discussões no GitHub sobre prós e contras do uso de `ONBUILD`

---

*Documento gerado para explicar detalhadamente a instrução `ONBUILD` em Dockerfile.*