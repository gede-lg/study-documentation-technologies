# STOPSIGNAL

# Instrução `STOPSIGNAL` em Dockerfile

## Introdução

A instrução `STOPSIGNAL` define qual sinal do sistema operacional deve ser enviado para o processo principal (PID 1) dentro do contêiner quando o comando `docker stop` ou APIs equivalentes solicitam a parada. Permite controlar o comportamento de desligamento, garantindo limpeza adequada de recursos.

## Sumário

- [Conceitos Fundamentais](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#conceitos-fundamentais)
- [Sintaxe Detalhada e Uso Prático](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sintaxe-detalhada-e-uso-pr%C3%A1tico)
- [Cenários de Restrição ou Não Aplicação](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#cen%C3%A1rios-de-restri%C3%A7%C3%A3o-ou-n%C3%A3o-aplica%C3%A7%C3%A3o)
- [Componentes Chave Associados](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#componentes-chave-associados)
- [Melhores Práticas e Padrões de Uso](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#melhores-pr%C3%A1ticas-e-padr%C3%B5es-de-uso)
- [Exemplo Prático Completo](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#exemplo-pr%C3%A1tico-completo)
- [Sugestões para Aprofundamento](https://chatgpt.com/g/g-p-68596a64c76c819185e08bdb9bacec85-infra/c/6859817f-01e8-8013-9e5a-cbb14e4c689f#sugest%C3%B5es-para-aprofundamento)

---

## Conceitos Fundamentais

- **PID 1 no contêiner:** Processo principal que recebe sinais de parada.
- **Sinal padrão:** Sem `STOPSIGNAL`, o Docker envia `SIGTERM` seguido de `SIGKILL` após o tempo de espera definido.
- **Customização:** Fundamental para aplicações que precisam de um sinal específico, como `SIGINT` ou `SIGQUIT`, para tratar shutdown graceful.

---

## Sintaxe Detalhada e Uso Prático

```
STOPSIGNAL <sinal>

```

- `<sinal>`: Nome ou número do sinal (ex.: `SIGTERM`, `SIGINT`, `SIGQUIT`, `9`).

### Exemplos

1. **Usar `SIGINT` para Python**
    
    ```
    FROM python:3.11-slim
    STOPSIGNAL SIGINT
    COPY app.py /app.py
    CMD ["python", "/app.py"]
    
    ```
    
2. **Definir pelo número**
    
    ```
    FROM node:18-alpine
    # SIGTERM = 15, SIGKILL = 9
    STOPSIGNAL 15
    ENTRYPOINT ["node", "/usr/src/app/index.js"]
    
    ```
    

---

## Cenários de Restrição ou Não Aplicação

- **Processos que ignoram sinais:** Alguns serviços podem ignorar sinais diferentes do padrão.
- **Contêineres de curto ciclo de vida:** Se não houver necessidade de shutdown graceful.
- **Usos em Linux vs Windows:** Docker on Windows pode não suportar sinais POSIX.

---

## Componentes Chave Associados

- **Tempo de espera (`stop_grace_period`)** no Compose ou ALIAS CLI: intervalo entre `SIGTERM` e `SIGKILL`.
- **ENTRYPOINT/CMD:** Processo que irá receber o sinal.
- **Traps no código:** Handlers implementados pela aplicação para capturar e tratar sinais.

---

## Melhores Práticas e Padrões de Uso

1. **Tratar sinais na aplicação:** Implemente *signal handlers* para cleanup (fechar conexões, salvar estado).
2. **Sincronizar com `stop_grace_period`:** Defina `-stop-grace-period` no `docker run` ou `stop_grace_period` no Compose para dar tempo ao processo.
3. **Evitar `SIGKILL`:** Use apenas quando o processo não responde a sinais de shutdown.
4. **Testar desligamento:** Valide que a aplicação encerra corretamente quando recebe o sinal configurado.
5. **Documentar no Dockerfile:** Explique por que o sinal escolhido é necessário.

---

## Exemplo Prático Completo

```
FROM golang:1.21-alpine
WORKDIR /app
COPY . .
RUN go build -o server

# Processa SIGQUIT para dump de perfil antes de sair
STOPSIGNAL SIGQUIT

ENTRYPOINT ["/app/server"]

```

No `docker-compose.yml`:

```yaml
services:
  web:
    build: .
    stop_grace_period: 30s

```

1. O Docker enviará `SIGQUIT` ao binário Go.
2. A aplicação pode capturar `SIGQUIT` para gerar logs de diagnóstico.
3. Após 30 segundos, se não encerrar, o Docker enviará `SIGKILL`.

---

## Sugestões para Aprofundamento

- Documentação oficial Docker: [`STOPSIGNAL`](https://docs.docker.com/engine/reference/builder/#stopsignal)
- Artigos sobre **graceful shutdown** em containers
- Exemplos de handlers de sinal em Go, Node.js e Python

---

*Documento gerado para explicar detalhadamente a instrução `STOPSIGNAL` em Dockerfile.*