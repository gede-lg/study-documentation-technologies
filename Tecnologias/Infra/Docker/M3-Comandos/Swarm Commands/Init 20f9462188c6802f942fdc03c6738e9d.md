# Init

---

## 1. Finalidade do `docker swarm init`

O **`docker swarm init`** transforma o seu host Docker em um **manager** de um **Swarm** — o sistema de orquestração nativo do Docker. Ao inicializar um Swarm, você:

1. Cria um cluster de nós (nodes) capaz de agendar serviços distribuídos.
2. Gera tokens de junção (join tokens) para **managers** e **workers** entrarem no cluster.
3. Habilita recursos de alta disponibilidade, balanceamento de carga e rolling updates nativos.

---

## 2. Sintaxe básica

```bash
docker swarm init [OPTIONS]

```

- **`docker swarm init`**: inicia um novo Swarm no nó atual, tornando-o **manager**.
- Se outros nós desejarem participar, usarão `docker swarm join` com o token gerado.

---

## 3. Opções detalhadas

| Opção | Tipo | Padrão | Descrição |
| --- | --- | --- | --- |
| `--advertise-addr string` | string | host IP automático | Endereço/IP (ou interface) via o qual este manager será acessível por outros nós. Pode incluir porta, ex.: `192.168.1.10:2377` ou `eth0`. |
| `--listen-addr node-addr` | string | `0.0.0.0:2377` | Endereço/IP e porta onde o manager escutará conexões de **join** (padrão TCP 2377). |
| `--data-path-addr string` | string | host IP automático | Endereço/IP (ou interface) para tráfego de dados (overlay networks). |
| `--data-path-port uint32` | uint32 | `4789` | Porta UDP usada para o tráfego VXLAN do overlay (default 4789). |
| `--default-addr-pool ipNetSlice` | CIDR list | `[]` | Pools CIDR para automaticamente alocar sub-redes de overlay. Ex.: `--default-addr-pool 10.0.0.0/8` |
| `--default-addr-pool-mask-length uint32` | uint32 | `24` | Máscara de sub-rede dentro de cada default-addr-pool (padrão /24). |
| `--dispatcher-heartbeat duration` | duration | `5s` | Intervalo de heartbeat do dispatcher (entre managers e workers). |
| `--autolock` | boolean | `false` | Habilita **autolock** do manager: exige chave para *unlock* após reinício, protegendo dados de raft. |
| `--cert-expiry duration` | duration | `2160h0m0s` (90d) | Tempo de validade (lifetime) para certificados TLS dos nós. |
| `--external-ca external-ca` | spec | — | Configura CAs externas para rotação de certificados (ex.: HSM ou PKI externa). |
| `--force-new-cluster` | boolean | `false` | Força a criação de um novo cluster usando o estado atual do raft, descartando configurações antigas (cuidado: pode causar perda de quorum em clusters existentes). |
| `--max-snapshots uint` | uint | `0` | Quantidade de snapshots do raft além do snapshot mais recente a manter (por padrão apenas o mais recente). |
| `--snapshot-interval uint` | uint | `10000` | Quantidade de entradas de log entre snapshots consecutivos do raft. |
| `--task-history-limit int` | int | `5` | Quantas tarefas antigas manter no histórico de cada serviço. |

---

## 4. Exemplos de uso

1. **Inicializar Swarm padrão**
    
    ```bash
    docker swarm init
    # Saída: Swarm initialized: current node (ID) is now a manager.
    # Para adicionar workers: docker swarm join --token <token> <manager-ip>:2377
    
    ```
    
2. **Especificar endereço de anúncio e escuta**
    
    ```bash
    docker swarm init \
      --advertise-addr 192.168.1.10 \
      --listen-addr 192.168.1.10:2377
    
    ```
    
3. **Definir pool de endereços customizado para overlays**
    
    ```bash
    docker swarm init \
      --default-addr-pool 10.10.0.0/16 \
      --default-addr-pool-mask-length 24
    
    ```
    
4. **Habilitar autolock e customizar TTL de certificado**
    
    ```bash
    docker swarm init \
      --autolock \
      --cert-expiry 72h
    
    ```
    

---

## 5. Tabela de referência rápida

| Componente | Sintaxe / Valor | Descrição |
| --- | --- | --- |
| Comando base | `docker swarm init [OPTIONS]` | Inicializa um novo Swarm; nó atual vira manager. |
| Endereço de anúncio | `--advertise-addr <ip | iface>[:port]` |
| Endereço de escuta | `--listen-addr <ip | iface>[:port]` |
| Overlay data path | `--data-path-addr`, `--data-path-port` | IP/interface e porta para rede overlay. |
| Pools de rede | `--default-addr-pool`, `--default-addr-pool-mask-length` | CIDRs e máscara para sub-redes automáticas. |
| Segurança / certs | `--autolock`, `--cert-expiry`, `--external-ca` | Proteções adicionais e TTL de certificados. |
| Raft snapshots | `--snapshot-interval`, `--max-snapshots` | Configuração de snapshots do banco de dados Raft. |
| Dispatcher heartbeat | `--dispatcher-heartbeat` | Frequência de heartbeats de orquestração. |
| Histórico de tarefas | `--task-history-limit` | Quantas tarefas finalizadas manter no histórico. |
| Forçar novo cluster | `--force-new-cluster` | Recomissiona um novo cluster a partir do estado. |

---

Com estas informações, você pode **configurar** e **inicializar** seu Swarm de acordo com suas necessidades de rede, segurança e desempenho. Se precisar ajustar cenários avançados (PKI externa, pools de endereços complexos, etc.), é só avisar!