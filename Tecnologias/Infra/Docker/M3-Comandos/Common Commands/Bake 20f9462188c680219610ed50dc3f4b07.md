# Bake

---

## 1. O que faz o `docker bake`

O **`docker bake`** (parte do plugin Buildx) permite **orquestrar múltiplos builds** definidos em um arquivo de composição (por padrão `docker-bake.hcl` ou `docker-compose.yml`). Ele:

- Lê definições de *targets* (equivalentes a serviços) com configurações de build.
- Executa builds em paralelo ou de forma encadeada, conforme dependências.
- Centraliza flags comuns, evitando repetição de comandos `buildx build`.

É ideal para projetos com vários contêineres ou estágios de build, garantindo consistência e reuso de configuração.

---

## 2. Sintaxe básica

```bash
docker buildx bake [OPTIONS] [TARGET...]
# Alias:
docker bake [OPTIONS] [TARGET...]

```

- **`[TARGET...]`**: nomes ou padrões de *targets* a executar.
- Se omitido, executa todos os *targets* listados no arquivo.

---

## 3. Principais opções e categorias

### 3.1 Arquivo de definição

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `-f, --file stringArray` | `-f docker-bake.hcl` | Arquivo(s) que contêm definições de *targets* e variáveis (HCL, YAML ou JSON). |

### 3.2 Seleção e invocação

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `[TARGET...]` | `app backend frontend` | Especifica quais *targets* executar (pode usar glob patterns). |
| `--list string` | `--list targets--list vars` | Lista *targets* (`targets`) ou variáveis (`vars`) disponíveis no(s) arquivo(s). |
| `--print` | `--print` | Exibe as configurações que seriam usadas, sem executar efetivamente os builds. |
| `--call string` | `--call=check` | Modo de avaliação:- `build` (padrão)- `check` (valida configuração)- `outline` (exibe ordem). |
| `--check` | (atalho) | Atalho para `--call=check`. |

### 3.3 Builder e ambiente

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `--builder string` | `--builder mybuilder` | Escolhe instância Buildx (pod, container, remoto) diferente da `default`. |
| `--allow stringArray` | `--allow network.host` | Concede entitlements especiais a todos os builds (ex.: acesso `network.host`). |

### 3.4 Cache e performances

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `--no-cache` | `--no-cache` | Desativa totalmente o uso de cache de camadas. |
| (Buildx também herda flags de cache de `buildx build`, mas normalmente se define no próprio *target*.) |  |  |

### 3.5 Saída, carregamento e publicação

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `--load` | `--load` | Carrega as imagens resultantes direto no Docker local (equivale a `output=type=docker`). |
| `--push` | `--push` | Envia as imagens para o registry conforme configurado no *target* (`output=type=registry`). |
| `--set stringArray` | `--set frontend.output=type=local,dest=./out` | Sobrescreve dinamicamente valores de *target* (ex.: output, tags, platforms). |

### 3.6 Atestações e metadados

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `--sbom string` | `--sbom cyclonedx` | Atalho para adicionar SBOM a todos os *targets*. |
| `--provenance string` | `--provenance=somefmt` | Atalho para adicionar proveniência a todos os *targets*. |
| `--metadata-file string` | `--metadata-file build.json` | Grava JSON com resultados (tags, digests, status) em arquivo. |

### 3.7 Depuração e progresso

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `-D, --debug` | `--debug` | Habilita logs detalhados de debug. |
| `--progress string` | `--progress=plain` | Define estilo de progresso:`auto`, `plain`, `tty`, `quiet`, `rawjson`. |

### 3.8 Fluxo sem execução

| Opção | Sintaxe | Finalidade |
| --- | --- | --- |
| `--print` | `--print` | Exibe as configurações compiladas, sem disparar builds. |

---

## 4. Exemplos de uso

1. **Build de todos os *targets***
    
    ```bash
    docker bake
    
    ```
    
2. **Build somente do `frontend` e `backend`**
    
    ```bash
    docker bake frontend backend
    
    ```
    
3. **Usar arquivo específico e exibir targets disponíveis**
    
    ```bash
    docker bake -f ci-bake.hcl --list targets
    
    ```
    
4. **Ver ordens de execução sem build**
    
    ```bash
    docker bake --call=outline
    
    ```
    
5. **Imprimir config sem build**
    
    ```bash
    docker bake --print
    
    ```
    
6. **Forçar load local e debug**
    
    ```bash
    docker bake --load -D
    
    ```
    
7. **Sobrescrever output e adicionar SBOM**
    
    ```bash
    docker bake --set app.output=type=local,dest=./out --sbom cyclonedx
    
    ```
    

---

## 5. Tabela de referência rápida

| Categoria | Opções principais |
| --- | --- |
| Arquivo | `-f, --file` |
| Seleção | `[TARGET...]`, `--list`, `--call`, `--print` |
| Builder/Entitlements | `--builder`, `--allow` |
| Cache | `--no-cache` |
| Saída | `--load`, `--push`, `--set` |
| Atestação | `--sbom`, `--provenance`, `--metadata-file` |
| Debug/Progress | `-D, --debug`, `--progress` |

---

Com isto, você tem um panorama completo de todas as opções do **`docker bake`**, suas finalidades, sintaxes e exemplos de aplicação. Se precisar de mais detalhes sobre o formato HCL/YAML de definição ou cenários de uso avançados, fique à vontade para perguntar!