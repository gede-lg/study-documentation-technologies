# 7. Healthcheck

---

Os parâmetros de healthcheck permitem que o Docker monitore a saúde do processo em execução no contêiner, facilitando políticas de reinício e integração com orquestradores.

---

### 7.1 `-health-cmd string`

- **Sintaxe**
    
    ```bash
    --health-cmd="<comando_shell>"
    
    ```
    
- **Descrição**
    
    Define o comando (shell) a ser executado periodicamente para verificar se a aplicação está saudável.
    
- **Conceito de Uso**
    
    Geralmente usa um cliente HTTP (`curl`), script de verificação ou comando de exit code:
    
    - **Sucesso (exit 0)** → contêiner saudável.
    - **Falha (exit ≠ 0)** → contêiner não saudável.
- **Propriedades Internas**
    - Configura `Config.Healthcheck.Test` no JSON de criação do contêiner, ex.:
        
        ```json
        "Healthcheck": {
          "Test": ["CMD-SHELL", "curl -f http://localhost/ || exit 1"],
          ...
        }
        
        ```
        
- **Exemplo**
    
    ```bash
    docker run -d \
      --health-cmd="curl --fail http://localhost/health || exit 1" \
      nginx
    
    ```
    

---

### 7.2 `-health-interval duration`

- **Sintaxe**
    
    ```bash
    --health-interval=30s
    --health-interval=1m0s
    
    ```
    
- **Descrição**
    
    Intervalo entre execuções do comando de healthcheck.
    
- **Valor Padrão**
    
    `30s` (30 segundos).
    
- **Conceito de Uso**
    
    Ajuste para casos em que checagens muito frequentes impactam performance ou são desnecessárias.
    
- **Propriedades Internas**
    - Preenche `Config.Healthcheck.Interval` (em nanossegundos) no spec OCI.
- **Exemplo**
    
    ```bash
    docker run --health-cmd="pg_isready" --health-interval=10s postgres
    
    ```
    

---

### 7.3 `-health-timeout duration`

- **Sintaxe**
    
    ```bash
    --health-timeout=5s
    
    ```
    
- **Descrição**
    
    Tempo máximo que o comando de healthcheck pode levar antes de ser abortado e considerado falho.
    
- **Valor Padrão**
    
    `30s`.
    
- **Conceito de Uso**
    
    Evita que checks travem indefinidamente, principalmente em comandos que podem bloquear (conexões lentas).
    
- **Propriedades Internas**
    - Define `Config.Healthcheck.Timeout`.
- **Exemplo**
    
    ```bash
    docker run \
      --health-cmd="curl -f http://localhost/" \
      --health-timeout=3s \
      my-app
    
    ```
    

---

### 7.4 `-health-retries int`

- **Sintaxe**
    
    ```bash
    --health-retries=3
    
    ```
    
- **Descrição**
    
    Número de falhas consecutivas do healthcheck necessárias para que o contêiner seja marcado como **unhealthy**.
    
- **Valor Padrão**
    
    `3` tentativas.
    
- **Conceito de Uso**
    
    Suaviza falsos-positivos: evita marcar o contêiner como unhealthy por falhas intermitentes.
    
- **Propriedades Internas**
    - Ajusta `Config.Healthcheck.Retries`.
- **Exemplo**
    
    ```bash
    docker run \
      --health-cmd="curl -f http://localhost/" \
      --health-retries=5 \
      my-service
    
    ```
    

---

### 7.5 `-health-start-period duration`

*(alias `--health-start-interval`)*

- **Sintaxe**
    
    ```bash
    --health-start-period=1m
    --health-start-interval=1m
    
    ```
    
- **Descrição**
    
    Período inicial após a criação do contêiner durante o qual falhas não contam para a contagem de retries.
    
- **Valor Padrão**
    
    `0s` (sem período de graça).
    
- **Conceito de Uso**
    
    Esperar que a aplicação inicialize (por exemplo, boot de banco de dados) antes de considerar falhas.
    
- **Propriedades Internas**
    - Popula `Config.Healthcheck.StartPeriod`.
- **Exemplo**
    
    ```bash
    docker run \
      --health-cmd="curl -f http://localhost/" \
      --health-start-period=30s \
      my-db
    
    ```
    

---

### 7.6 `-no-healthcheck`

- **Sintaxe**
    
    ```bash
    --no-healthcheck
    
    ```
    
- **Descrição**
    
    Desabilita por completo qualquer instrução de HEALTHCHECK especificada no Dockerfile da imagem.
    
- **Conceito de Uso**
    
    Quando você quer ignorar o check da imagem (por exemplo, em debugging ou override de imagem legacy).
    
- **Propriedades Internas**
    - Define `Config.Healthcheck` como vazio (`NONE`).
- **Exemplo**
    
    ```bash
    docker run --no-healthcheck my-legacy-image
    
    ```
    

---

## Observações

- **Fluxo de Estados**
    1. **starting** durante o `StartPeriod`.
    2. **healthy** se o comando retornou sucesso.
    3. **unhealthy** após `Retries` falhas após o `StartPeriod`.
- **Integração com Orquestradores**
    - Kubernetes e Swarm usam o status para redeploy ou redirecionamento de tráfego.
- **Combinações Importantes**
    - Sempre combine `-health-cmd` com timeouts e retries adequados ao seu serviço.
    - Use `-no-healthcheck` apenas quando necessário; prefira ajustar parâmetros à configuração do seu container.

Com isso, você tem controle total sobre como e quando o Docker verifica a saúde dos seus contêineres!