# 4. Rede e DNS

---

Os parâmetros de rede e DNS configuram como o contêiner se conecta a redes Docker, como expõe portas e como resolve nomes DNS. A seguir, uma análise detalhada de cada opção:

---

### 4.1 `-network string`

- **Sintaxe**
    
    ```bash
    --network=bridge
    --network=host
    --network=none
    --network=my-custom-net
    
    ```
    
- **Descrição**
    
    Conecta o contêiner a uma rede Docker existente.
    
- **Conceito de Uso**
    - **`bridge`** (padrão): rede isolada criada localmente, com NAT para acesso externo.
    - **`host`**: compartilha a pilha de rede do host (sem isolamento).
    - **`none`**: sem interface de rede, útil para contêineres que não precisam de comunicação de rede.
    - **`<custom>`**: redes definidas por `docker network create`, podendo ser `bridge`, `overlay`, `macvlan` etc.
- **Propriedades Internas**
    - Define `HostConfig.NetworkMode` na API Engine.
    - Se `host`, pula criação de namespaces de rede e não configura portas.
    - Se rede custom, associa o contêiner ao driver e às opções (sub-rede, gateway) definidos.
- **Exemplo**
    
    ```bash
    # Usar rede criada anteriormente
    docker network create --driver overlay my-net
    docker run --network=my-net myapp
    
    ```
    

---

### 4.2 `p`, `-publish list`

- **Sintaxe**
    
    ```bash
    -p 8080:80
    --publish=127.0.0.1:8080:80/tcp
    --publish=443:443/udp
    
    ```
    
- **Descrição**
    
    Mapeia uma porta do host para uma porta do contêiner.
    
- **Conceito de Uso**
    
    Expor serviços do contêiner (web servers, bancos, APIs) para o host ou rede externa.
    
- **Formato e Sub-propriedades**
    
    ```
    [<host_ip>:]<host_port>:<container_port>[/<protocol>]
    
    ```
    
    - **`host_ip`** opcional: limita o binding a um IP específico no host.
    - **`protocol`**: `tcp` ou `udp` (padrão: `tcp`).
- **Propriedades Internas**
    - Preenche `HostConfig.PortBindings` e `NetworkSettings.Ports`.
    - Cria regras de NAT no iptables do host para redirecionar o tráfego.
- **Exemplo**
    
    ```bash
    docker run -d -p 8080:80 nginx
    # Acessível em http://localhost:8080 → porta 80 no contêiner.
    
    ```
    

---

### 4.3 `P`, `-publish-all`

- **Sintaxe**
    
    ```bash
    -P
    --publish-all
    
    ```
    
- **Descrição**
    
    Publica todas as portas expostas pela imagem (`EXPOSE`) em portas aleatórias disponíveis no host.
    
- **Conceito de Uso**
    
    Útil para testes rápidos quando não há necessidade de portas fixas, evitando conflitos manuais.
    
- **Propriedades Internas**
    - Para cada porta exposta, aloca uma porta dinâmica no host (faixa alta > 32768).
    - Registra bindings em `HostConfig.PortBindings`.
- **Exemplo**
    
    ```bash
    docker run -d -P mysql
    docker port <container_id>
    # Mostra algo como 3306/tcp → 32768
    
    ```
    

---

### 4.4 `-dns list`

- **Sintaxe**
    
    ```bash
    --dns=8.8.8.8
    --dns=1.1.1.1 --dns=9.9.9.9
    
    ```
    
- **Descrição**
    
    Define servidores DNS customizados para resolução dentro do contêiner (em vez de herdar `/etc/resolv.conf` do host).
    
- **Conceito de Uso**
    
    Forçar uso de DNS interno de cluster, serviços de DNS privados ou servidores públicos específicos.
    
- **Propriedades Internas**
    - Atualiza `ResolvConf` gerado no ponto de montagem `/etc/resolv.conf` no contêiner.
    - Substitui totalmente as entradas de DNS herdadas.
- **Exemplo**
    
    ```bash
    docker run --dns=10.0.0.2 myapp
    cat /etc/resolv.conf  # verá apenas 10.0.0.2
    
    ```
    

---

### 4.5 `-dns-option list`

- **Sintaxe**
    
    ```bash
    --dns-option=ndots:0
    --dns-option=timeout:1 --dns-option=rotate
    
    ```
    
- **Descrição**
    
    Adiciona opções ao resolver DNS, como `ndots`, `timeout`, `attempts`, `rotate`.
    
- **Conceito de Uso**
    
    Ajustar comportamento de queries DNS para minimizar latência ou falhas, por exemplo `ndots:0` evita buscas de domínios completos.
    
- **Propriedades Internas**
    - Acrescenta linhas `options ...` em `/etc/resolv.conf`.
- **Exemplo**
    
    ```bash
    docker run --dns=8.8.8.8 --dns-option=ndots:0 busybox nslookup example.com
    
    ```
    

---

### 4.6 `-dns-search list`

- **Sintaxe**
    
    ```bash
    --dns-search=example.com
    --dns-search=svc.cluster.local --dns-search=example.com
    
    ```
    
- **Descrição**
    
    Define domínios de busca DNS adicionados ao final de consultas não-fully-qualified.
    
- **Conceito de Uso**
    
    Em ambientes de orquestração (Kubernetes, Swarm), resolve nomes curtos de serviços sem especificar FQDN completo.
    
- **Propriedades Internas**
    - Gera linhas `search <domain1> <domain2>` em `/etc/resolv.conf`.
- **Exemplo**
    
    ```bash
    docker run --dns-search=example.local busybox ping serviceA
    # Resolve serviceA.example.local
    
    ```
    

---

### 4.7 `-add-host list`

- **Sintaxe**
    
    ```bash
    --add-host=db:192.168.0.5
    --add-host=db:192.168.0.5 --add-host=cache:10.0.0.10
    
    ```
    
- **Descrição**
    
    Adiciona entradas personalizadas no `/etc/hosts` do contêiner.
    
- **Conceito de Uso**
    
    Simular DNS estático ou para contêineres que não usam DNS interno. Ótimo para testes de conectividade ou ambientes legados.
    
- **Propriedades Internas**
    - Incrementa o conteúdo do arquivo `hosts` no ponto de montagem do contêiner antes da inicialização.
- **Exemplo**
    
    ```bash
    docker run --add-host=db:192.168.0.5 myapp
    cat /etc/hosts  # verá “192.168.0.5 db”
    
    ```
    

---

### 4.8 `-link list` *(legado)*

- **Sintaxe**
    
    ```bash
    --link db:db
    --link redis:cache
    
    ```
    
- **Descrição**
    
    Cria aliases de host e variáveis de ambiente para comunicação entre contêineres por nome.
    
- **Conceito de Uso**
    
    Mecanismo antigo de descoberta de serviços; hoje desencorajado em favor de redes definidas (Docker networks).
    
- **Propriedades Internas**
    - Atualiza `/etc/hosts` do contêiner ligado e define variáveis como `<ALIAS>_PORT` no ambiente.
- **Exemplo**
    
    ```bash
    docker run --link mysql:db myapp
    # Dentro de myapp: conecta-se em host “db” pela porta exposta.
    
    ```
    

---

### 4.9 `-link-local-ip list`

- **Sintaxe**
    
    ```bash
    --link-local-ip="169.254.0.4"
    --link-local-ip="169.254.0.4,169.254.0.5"
    
    ```
    
- **Descrição**
    
    Permite que o contêiner tenha um ou mais endereços link-local (range 169.254.0.0/16).
    
- **Conceito de Uso**
    
    Para serviços que usam protocolos de descoberta em link-local, como alguns sistemas de automação ou testes de rede.
    
- **Propriedades Internas**
    - Atribui entradas em `NetworkSettings.Networks[<network>].LinkLocalIPv4Address`.
- **Exemplo**
    
    ```bash
    docker run --network=bridge --link-local-ip=169.254.1.5 myapp
    
    ```
    

---

### 4.10 `h`, `-hostname string`

- **Sintaxe**
    
    ```bash
    -h container01
    --hostname=web-frontend
    
    ```
    
- **Descrição**
    
    Define o hostname do contêiner (o que aparece em prompts e `uname -n`).
    
- **Conceito de Uso**
    
    Facilita identificação em logs e dentro de aplicações distribuídas que exibem o nome do host.
    
- **Propriedades Internas**
    - Ajusta o campo `Config.Hostname` na criação do contêiner.
- **Exemplo**
    
    ```bash
    docker run -h db-server mysql
    
    ```
    

---

### 4.11 `-domainname string`

- **Sintaxe**
    
    ```bash
    --domainname=example.com
    
    ```
    
- **Descrição**
    
    Define o domínio NIS (domain name) do contêiner, usado em conjunto com `--hostname` para formar o FQDN.
    
- **Conceito de Uso**
    
    Para que o contêiner se apresente como `hostname.domainname` dentro da rede.
    
- **Propriedades Internas**
    - Ajusta `Config.Domainname`.
- **Exemplo**
    
    ```bash
    docker run -h web --domainname=example.com nginx
    # Dentro: hostname “web.example.com”
    
    ```
    

---

### 4.12 `-ip string`

- **Sintaxe**
    
    ```bash
    --ip=172.18.0.22
    
    ```
    
- **Descrição**
    
    Atribui um IP estático IPv4 ao contêiner em redes do tipo `bridge` ou customizadas.
    
- **Conceito de Uso**
    
    Necessário quando você precisa de mapeamentos ou regras de firewall fixas.
    
- **Propriedades Internas**
    - Define `EndpointSettings.IPAddress` na rede específica.
    - Deve estar dentro do range/subnet da rede Docker.
- **Exemplo**
    
    ```bash
    docker network create --subnet=172.18.0.0/16 my-net
    docker run --network=my-net --ip=172.18.0.50 myapp
    
    ```
    

---

### 4.13 `-ip6 string`

- **Sintaxe**
    
    ```bash
    --ip6=2001:db8::53
    
    ```
    
- **Descrição**
    
    Atribui um IP estático IPv6 ao contêiner em redes habilitadas para IPv6.
    
- **Conceito de Uso**
    
    Para ambientes que utilizam IPv6 nativo ou dual-stack.
    
- **Propriedades Internas**
    - Define `EndpointSettings.GlobalIPv6Address`.
    - A rede precisa ter `-ipv6` habilitado na criação.
- **Exemplo**
    
    ```bash
    docker network create --ipv6 --subnet=2001:db8::/64 ipv6-net
    docker run --network=ipv6-net --ip6=2001:db8::53 myapp
    
    ```
    

---

### 4.14 `-network-alias list`

- **Sintaxe**
    
    ```bash
    --network-alias=web
    --network-alias=api --network-alias=backend
    
    ```
    
- **Descrição**
    
    Cria aliases adicionais para o contêiner dentro da rede, facilitando descoberta por múltiplos nomes.
    
- **Conceito de Uso**
    
    Permite que outros contêineres se refiram a este por `web`, `api` ou qualquer alias definido.
    
- **Propriedades Internas**
    - Popula `EndpointSettings.Aliases` no esquema de rede.
- **Exemplo**
    
    ```bash
    docker run --network=front-tier --network-alias=webapp nginx
    
    ```
    

---

### 4.15 `-restart string`

- **Sintaxe**
    
    ```bash
    --restart=no
    --restart=on-failure
    --restart=on-failure:5
    --restart=always
    --restart=unless-stopped
    
    ```
    
- **Descrição**
    
    Política de reinício do contêiner quando ele terminar ou falhar.
    
- **Opções**
    - `no` (padrão): nunca reinicia.
    - `on-failure[:N]`: reinicia somente se o código de saída for ≠ 0; opcionalmente até N tentativas.
    - `always`: reinicia sempre, mesmo após desligamento manual.
    - `unless-stopped`: como `always`, mas não reinicia se o contêiner tiver sido parado manualmente.
- **Conceito de Uso**
    
    Essencial para garantir alta disponibilidade de serviços em produção.
    
- **Propriedades Internas**
    - Define `HostConfig.RestartPolicy` com `Name` e `MaximumRetryCount`.
- **Exemplo**
    
    ```bash
    docker run -d --restart=on-failure:3 myapp
    
    ```
    

---

## Observações e Boas Práticas

1. **Ordem e Conflitos**
    - `-network=host` ignora todos os mapeamentos `p`.
    - `-publish-all` não mapeia portas UDP por padrão, especifique protocolo se necessário.
2. **Segurança**
    - Evite `-network=host` se o contêiner executar código não confiável.
    - Use `-add-host` apenas para debug; em produção, prefira DNS interno em redes orquestradas.
3. **Isolamento**
    - `-link` é legado; use redes customizadas e aliases modernos.
    - `-cgroupns` combinado com `-network=host` remove isolamento de rede e cgroup.
4. **Orquestração**
    - Em Kubernetes ou Swarm, grande parte dessas configurações é gerenciada pelo orchestrator; use Docker puro para desenvolvimento local ou casos específicos.

Com este guia, você tem um panorama completo das opções de rede e DNS do `docker container run`. Estou à disposição para esclarecer qualquer detalhe ou cenários de uso!