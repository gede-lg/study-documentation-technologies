# 3. Memória e swap

---

## 3. Memória e swap

Os parâmetros de memória controlam quanta RAM e swap um contêiner pode usar, além de comportamentos de gerenciamento de memória no nível do kernel. A seguir, cada opção em detalhe:

---

### 3.1 `m`, `-memory bytes`

- **Sintaxe**
    
    ```bash
    -m 512m
    --memory=2g
    
    ```
    
- **Descrição**
    
    Define um **hard limit** para a memória RAM do contêiner. Se o processo ultrapassar esse valor, será imediatamente finalizado pelo OOM-killer do cgroup.
    
- **Conceito de Uso**
    
    Garante que um contêiner não consuma mais do que X bytes de RAM, protegendo o host e outros contêineres de esgotamento de memória.
    
- **Propriedades Internas**
    - Em **cgroup v1**: escrito em `/sys/fs/cgroup/memory/<cgroup>/memory.limit_in_bytes`.
    - Em **cgroup v2**: corresponde a `memory.max`.
    - Suporta sufixos `b` (bytes), `k` (kilobytes), `m` (megabytes), `g` (gigabytes), e versões em maiúsculas.
- **Exemplo**
    
    ```bash
    # Limita o contêiner a 1 GB de RAM
    docker run -d -m 1g nginx
    
    ```
    

---

### 3.2 `-memory-reservation bytes`

- **Sintaxe**
    
    ```bash
    --memory-reservation=300m
    
    ```
    
- **Descrição**
    
    Define um **soft limit** de memória. O contêiner **pode** consumir mais até o hard limit (`--memory`), mas ao ultrapassar esse valor entra na fila para ser trocado ou encerrado se o sistema estiver sob pressão.
    
- **Conceito de Uso**
    
    Garante que, em situações de estresse de memória, o kernel penalize primeiro os contêineres que excederam sua reserva, sem interromper imediatamente sua execução.
    
- **Propriedades Internas**
    - Em **cgroup v1**: corresponde a `/sys/fs/cgroup/memory/<cgroup>/memory.soft_limit_in_bytes`.
    - Em **cgroup v2**: mapeado para `memory.low`.
- **Exemplo**
    
    ```bash
    # Garante 300 MB antes de começar a trocar página ou OOM
    docker run -d -m 1g --memory-reservation=300m myapp
    
    ```
    

---

### 3.3 `-memory-swap bytes`

- **Sintaxe**
    
    ```bash
    --memory-swap=1.5g
    
    ```
    
- **Descrição**
    
    Define o limite total de **RAM + swap** para o contêiner.
    
    - Se `-memory-swap` for igual a `-memory`, **swap fica desabilitado**.
    - Se `-memory-swap` for `1`, permite **swap ilimitado** (restrito apenas pelo host).
- **Conceito de Uso**
    
    Controla o uso conjunto de RAM e swap, evitando que o contêiner acumule trocas excessivas que degradam performance.
    
- **Propriedades Internas**
    - Em **cgroup v1**: configurado em `/sys/fs/cgroup/memory/<cgroup>/memory.memsw.limit_in_bytes`.
    - Em **cgroup v2**: equivalente a `memory.swap.max`.
    - Deve ser ≥ `-memory`, caso contrário o Docker retorna erro.
- **Exemplo**
    
    ```bash
    # Limita RAM a 1 GB e swap total a 1.5 GB
    docker run -d -m 1g --memory-swap=1.5g redis
    
    ```
    

---

### 3.4 `-memory-swappiness int`

- **Sintaxe**
    
    ```bash
    --memory-swappiness=30
    
    ```
    
- **Descrição**
    
    Ajusta o parâmetro de **swappiness** (0–100) para o cgroup do contêiner. Quanto menor o valor, menos o kernel tende a trocar páginas de RAM por swap.
    
- **Conceito de Uso**
    
    Em workloads sensíveis à latência (bancos de dados, caches), recomenda-se valores baixos (por exemplo, `10`), reduzindo I/O de disco.
    
- **Propriedades Internas**
    - Em **cgroup v1**: escrito em `/sys/fs/cgroup/memory/<cgroup>/memory.swappiness`.
    - Em **cgroup v2**: não suportado diretamente; o kernel usa configurações globais ou `memory.low`.
    - Valor padrão é herdado do host (normalmente `60`).
- **Exemplo**
    
    ```bash
    # Minimiza o uso de swap
    docker run -d -m 2g --memory-swappiness=10 mydb
    
    ```
    

---

### 3.5 `-kernel-memory bytes`

- **Sintaxe**
    
    ```bash
    --kernel-memory=50m
    
    ```
    
- **Descrição**
    
    Limita a memória reservada ao **kernel** usada pelo contêiner (buffers, caches do kernel).
    
- **Conceito de Uso**
    
    Impede que processos do kernel acionados dentro do contêiner esgotem memória global do host, útil em casos de debug de módulos ou network-heavy workloads.
    
- **Propriedades Internas**
    - **Apenas cgroup v1**: mapeado para `/sys/fs/cgroup/memory/<cgroup>/memory.kmem.limit_in_bytes`.
    - **cgroup v2** não oferece limite de kernel-memory; opção é ignorada.
- **Exemplo**
    
    ```bash
    # Limita buffers e caches do kernel a 50 MB
    docker run -d --kernel-memory=50m ubuntu dmesg
    
    ```
    

---

## Observações e Boas Práticas

1. **Ordem de Precedência**
    - `-memory` estabelece o hard limit.
    - `-memory-reservation` deve ser ≤ `-memory`.
    - `-memory-swap` ≥ `-memory`; igual desabilita swap, `1` libera swap ilimitado.
2. **Interações**
    - Sem `-memory-swap`, o contêiner pode usar swap até infinito (host permitting).
    - Ajustar `-memory-swappiness` complementa `-memory-swap` para controle fino de trocas.
3. **Compatibilidade**
    - Em sistemas só com **cgroup v2**, `-kernel-memory` e `-memory-swappiness` podem ser ignorados ou ter comportamento limitado.
    - Sempre verifique `/sys/fs/cgroup` no host para confirmar quais controladores estão ativos.
4. **Recomendações**
    - Use `m` e `-memory-swap` juntos para evitar swap indesejado — por exemplo:
        
        ```bash
        docker run -d -m 4g --memory-swap=4g ...
        
        ```
        
    - Defina `-memory-reservation` para garantir qualidade de serviço em clusters multi-tenant.

Com estas definições, você tem total controle sobre como o Docker aloca e gerencia memória e swap para seus contêineres. Qualquer cenário específico, estou à disposição!