# Build

A seguir, uma visão completa e estruturada do comando **`docker buildx build`** (aliás, **`docker build`**) — sua finalidade, sintaxe básica, parâmetros, categorias de opções, exemplos e uma tabela de referência rápida.

---

## 1. Finalidade do `docker build`

O **`docker build`** (via plugin Buildx, invocado por `docker buildx build`) serve para **montar** (build) uma **imagem Docker** a partir de um conjunto de instruções num `Dockerfile` e de um contexto de filesystem. Ele:

1. Lê o **Dockerfile** (e quaisquer Dockerfiles adicionais indicados).
2. Executa cada instrução (`FROM`, `RUN`, `COPY`, etc.) dentro de etapas isoladas.
3. Gera camadas e monta a imagem final.
4. Opcionalmente, armazena em cache, exporta para registro (registry), salva localmente ou gera artefatos (SBOM, proveniência, etc.).

---

## 2. Sintaxe básica

```bash
docker buildx build [OPTIONS] PATH|URL|-
# Equivalente a:
docker build [OPTIONS] PATH|URL|-

```

- **`PATH|URL|-`**
    - `PATH` — diretório local com o Dockerfile e contexto.
    - `URL` — repositório Git remoto.
    - — contexto via stdin (tar stream).

---

## 3. Parâmetros e opções

### 3.1 Contexto e Dockerfile

- **`f, --file string`**
    
    Nome ou caminho do Dockerfile (padrão `PATH/Dockerfile`).
    
- **`-build-context stringArray`**
    
    Contextos adicionais nomeados, ex.: `--build-context name=path/to/dir`.
    
- **`-add-host strings`**
    
    Mapeia host extra no `/etc/hosts` durante o build, ex.: `--add-host host:ip`.
    

### 3.2 Variáveis e metadados

- **`-build-arg stringArray`**
    
    Variáveis `ARG` para o build, ex.: `--build-arg VERSION=1.2.3`.
    
- **`-label stringArray`**
    
    Labels Docker na imagem gerada, ex.: `--label maintainer=you`.
    
- **`-annotation stringArray`**
    
    Anotações arbitrárias no manifesto OCI.
    

### 3.3 Cache

- **`-cache-from stringArray`**
    
    Fontes de cache externas, ex.: `type=registry,ref=user/app:cache`.
    
- **`-cache-to stringArray`**
    
    Destinos de cache, ex.: `type=local,dest=./cache-dir`.
    
- **`-no-cache`**
    
    Desabilita totalmente o uso de cache.
    
- **`-no-cache-filter stringArray`**
    
    Instruções ou estágios a não armazenar em cache.
    

### 3.4 Builder e execução

- **`-builder string`**
    
    Nome da instância Buildx a usar (padrão `default`).
    
- **`-platform stringArray`**
    
    Plataforma(s) alvo, ex.: `linux/amd64`, `linux/arm64`.
    
- **`-network string`**
    
    Modo de rede para instruções `RUN`, ex.: `default`, `host`, `none`.
    
- **`-cgroup-parent string`**
    
    Cgroup pai para etapas `RUN`.
    
- **`-allow stringArray`**
    
    Entitlements extras (privileges), p.ex. `"network.host"`.
    

### 3.5 Saída e distribuição

- **`o, --output stringArray`**
    
    Destino de saída:
    
    - `type=docker` (load local),
    - `type=registry` (push),
    - `type=local,dest=./out`,
    - `type=tar,dest=image.tar`, etc.
- **`-load`**
    
    Atalho para `--output=type=docker` (carrega imagem no Docker local).
    
- **`-push`**
    
    Atalho para `--output=type=registry` (envia para registry).
    
- **`t, --tag stringArray`**
    
    Nome(s) e tag(s) para a nova imagem, ex.: `-t user/app:1.0`.
    
- **`-iidfile string`**
    
    Grava o ID da imagem em arquivo (útil em pipelines CI/CD).
    

### 3.6 Segurança e segredos

- **`-secret stringArray`**
    
    Segredos para `RUN --mount=type=secret`, ex.:
    
    - `-secret id=mysecret,src=/path/secret.txt`.
- **`-ssh stringArray`**
    
    Encaminha agente SSH ou chaves, ex.:
    
    - `-ssh default` ou `-ssh id=git,src=/home/user/.ssh/id_rsa`.

### 3.7 Attestação e SBOM

- **`-attest stringArray`**
    
    Gera atestações (SBOM, provenance), ex.:
    
    - `-attest type=sbom,generator=image`.
- **`-sbom string`**
    
    Atalho para `--attest=type=sbom`.
    
- **`-provenance string`**
    
    Atalho para `--attest=type=provenance`.
    
- **`-metadata-file string`**
    
    Grava metadados do build (JSON) em arquivo.
    

### 3.8 Infra e debug

- **`D, --debug`**
    
    Ativa logs de debug.
    
- **`-progress string`**
    
    Tipo de progresso: `auto`, `plain`, `tty`, `quiet`, `rawjson`.
    
- **`-pull`**
    
    Tenta sempre puxar as imagens base (`FROM`) mesmo se já existentes.
    
- **`q, --quiet`**
    
    Silencia o output normal e imprime só o ID da imagem.
    
- **`-shm-size bytes`**
    
    Tamanho de `/dev/shm` durante o build (ex.: `--shm-size 64m`).
    
- **`-ulimit ulimit`**
    
    Define limites de ulimit (`nofile=1024:2048`).
    

---

## 4. Exemplos de uso

1. **Build simples no diretório atual**
    
    ```bash
    docker build -t minha-app:latest .
    
    ```
    
2. **Build multi-plataforma e push**
    
    ```bash
    docker buildx build \
      --platform linux/amd64,linux/arm64 \
      --push \
      -t registry.io/meu/app:1.0 \
      .
    
    ```
    
3. **Usando cache remoto e carregando local**
    
    ```bash
    docker buildx build \
      --cache-from type=registry,ref=user/app:cache \
      --cache-to type=local,dest=./cache \
      --load \
      -t app:ci \
      .
    
    ```
    
4. **Injetando segredo e SSH**
    
    ```bash
    docker buildx build \
      --secret id=mytoken,src=/home/user/.token \
      --ssh default \
      -t secured-app .
    
    ```
    
5. **Gerando SBOM e gravando metadata**
    
    ```bash
    docker buildx build \
      --sbom cyclonedx \
      --metadata-file build-info.json \
      -t app:sbom .
    
    ```
    

---

## 5. Tabela de referência rápida

| Categoria | Opções principais |
| --- | --- |
| Contexto | `-f`, `--build-context`, `--add-host` |
| Variáveis/Metadados | `--build-arg`, `--label`, `--annotation` |
| Cache | `--cache-from`, `--cache-to`, `--no-cache` |
| Builder/Execução | `--builder`, `--platform`, `--network`, `--cgroup-parent` |
| Saída | `-o/--output`, `--load`, `--push`, `-t/--tag`, `--iidfile` |
| Segredos/SSH | `--secret`, `--ssh` |
| Attestação/SBOM | `--attest`, `--sbom`, `--provenance`, `--metadata-file` |
| Infra/Debug | `-D/--debug`, `--progress`, `--pull`, `-q/--quiet`, `--shm-size` |

---

Com isso, você tem um panorama **detalhado** de **todas** as opções do `docker build` (Buildx), suas sintaxes de uso e casos de aplicação. Se precisar de exemplos adicionais ou de cenários específicos, é só avisar!