# History

# **Análise Completa: `docker image history`**

---

## **Introdução**

O comando `docker image history` permite visualizar o histórico de camadas (**layers**) que compõem uma imagem Docker. Ele mostra, de forma detalhada, como a imagem foi construída — cada instrução no Dockerfile, quem criou a camada, quando foi criada, qual comando originou, o tamanho, entre outros detalhes.

Esse comando é essencial para:

- **Auditar e rastrear** alterações realizadas em imagens.
- **Entender o crescimento do tamanho** da imagem.
- **Diagnosticar problemas** de build, cache ou excessos de camadas.

---

## **Sintaxe Inicial**

```
docker image history [OPTIONS] IMAGE

```

ou simplesmente:

```
docker history [OPTIONS] IMAGE

```

- `IMAGE`: Nome ou ID da imagem para inspecionar.

---

## **Finalidade**

- Visualizar **todas as camadas** (layers) criadas durante o build da imagem.
- Entender a ordem das instruções aplicadas.
- Analisar o impacto de cada etapa no tamanho da imagem.
- Auxiliar na **otimização e troubleshooting** de builds Docker.

---

## **Tabela dos Parâmetros do `docker image history`**

| Flag/Opcional | Descrição | Exemplo de Uso |
| --- | --- | --- |
| `--format` | Formata a saída usando templates Go. Pode ser `table`, `json` ou um template customizado. | `--format table`, `--format json` |
| `-H`, `--human` | Exibe tamanhos/datas em formato legível para humanos (`true` por padrão). | `--human=false` |
| `--no-trunc` | Não trunca (corta) o output. Mostra o comando completo usado em cada camada, IDs e detalhes inteiros. | `--no-trunc` |
| `--platform` | Mostra histórico para uma plataforma específica (útil para imagens multi-plataforma). | `--platform linux/amd64` |
| `-q`, `--quiet` | Mostra **apenas** os IDs das imagens/camadas (útil para scripts, pipelines). | `--quiet` |

---

## **Detalhamento dos Parâmetros**

### 1. `-format string`

Permite personalizar a saída:

- **`table`**: Tabela padrão com cabeçalhos (default).
- **`table TEMPLATE`**: Tabela formatada com template Go.
- **`json`**: Saída em JSON, ideal para scripts ou integrações.
- **`TEMPLATE`**: Usa template Go customizado.

**Exemplos:**

```
docker image history nginx --format table
docker image history nginx --format json
docker image history nginx --format "{{.ID}}\t{{.Size}}\t{{.CreatedBy}}"

```

**Principais placeholders Go disponíveis:**

- `.ID` – ID da camada
- `.CreatedBy` – Comando/instrução responsável
- `.CreatedSince` / `.CreatedAt` – Data de criação (desde/absoluta)
- `.Size` – Tamanho da camada
- `.Comment` – Comentários
- `.Tags` – Tags associadas

---

### 2. `H, --human`

- **Finalidade**: Exibe datas e tamanhos em formatos mais “amigáveis” (ex: `3 hours ago`, `42MB`).
- **Padrão**: `true`
- **Desligando**: Para output “bruto” (bytes e datas unix).

```
docker image history nginx --human=false

```

---

### 3. `-no-trunc`

- **Finalidade**: Mostra informações completas sem corte.
- **Útil para**: Visualizar comandos longos do Dockerfile, IDs completos de camadas.

```
docker image history nginx --no-trunc

```

---

### 4. `-platform string`

- **Finalidade**: Em imagens multi-plataforma (ex: ARM, x86), permite filtrar a plataforma desejada.
- **Formato**: `"os/arch/variant"`
- **Exemplo**: `"linux/amd64"` ou `"linux/arm64/v8"`

```
docker image history --platform linux/arm64 nginx

```

---

### 5. `q, --quiet`

- **Finalidade**: Mostra **apenas os IDs** das camadas.
- **Uso típico**: Scripts de automação, quando só interessa o ID (para deletar, auditar, etc).

```
docker image history nginx --quiet

```

---

## **Exemplo Prático: Analisando a História de uma Imagem**

```
docker image history nginx

```

**Saída padrão:**

```
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
af9da9b3c8d2   2 weeks ago    /docker-entrypoint.sh nginx                     0B
<missing>      2 weeks ago    /bin/sh -c #(nop)  CMD ["nginx" "-g" "daemon…   0B
<missing>      2 weeks ago    /bin/sh -c #(nop)  EXPOSE 80                    0B
<missing>      2 weeks ago    /bin/sh -c #(nop)  ENTRYPOINT ["/docker-entr…   0B
...

```

- Cada linha representa uma **camada**.
- O comando criado pelo Dockerfile está em `CREATED BY`.
- O tamanho incremental em `SIZE`.
- `IMAGE` mostra o hash da camada (ou `<missing>` para camadas herdadas).

### Usando o `-no-trunc` para detalhes completos:

```
docker image history nginx --no-trunc

```

Agora os comandos de criação, IDs e argumentos aparecem completos.

---

### Usando o `-format` para customizar saída

Exemplo: IDs, tamanho e comando responsável:

```
docker image history nginx --format "table {{.ID}}\t{{.Size}}\t{{.CreatedBy}}"

```

Saída:

```
ID            SIZE     CREATED BY
af9da9b3c8d2  0B       /docker-entrypoint.sh nginx
...

```

---

### Usando `-human=false` para dados “crus”:

```
docker image history nginx --human=false

```

Agora datas e tamanhos vêm em valores exatos, úteis para scripts ou auditorias precisas.

---

### Usando o `q` para pegar apenas IDs:

```
docker image history nginx -q

```

Retorna só os hashes, um por linha.

---

## **Campos que Aparecem no Output Padrão**

| Campo | Significado |
| --- | --- |
| IMAGE | ID da camada (ou `<missing>` para layers herdadas/base) |
| CREATED | Quando a camada foi criada (ex: “4 days ago”) |
| CREATED BY | Comando/instrução do Dockerfile que gerou a camada |
| SIZE | Tamanho da camada adicionada |
| COMMENT | Comentário opcional (geralmente em builds manuais/avançados) |

---

## **Melhores Práticas no Uso de `docker image history`**

- Use para **auditar builds** e descobrir comandos ou etapas que aumentaram o tamanho.
- Combine com `-no-trunc` para análise de comandos longos ou para debugar builds customizados.
- Com imagens multi-plataforma, especifique sempre `-platform` para garantir que está analisando a layer correta.
- Use `-format` para integrar o output a outros scripts ou gerar relatórios customizados.
- Combine com `docker image inspect` para análises ainda mais profundas.

---

## **Cenários Onde NÃO É Tão Útil**

- Não mostra *mudanças em arquivos específicos*, apenas camadas e comandos.
- Não é útil para rastrear *conteúdo interno* de cada camada (para isso, use `dive` ou crie containers a partir das camadas).
- Para imagens base herdadas, muitas vezes parte do histórico aparece como `<missing>`.

---

## **Sugestões para Aprofundamento**

- [Documentação oficial: docker image history](https://docs.docker.com/engine/reference/commandline/image_history/)
- Ferramenta [dive](https://github.com/wagoodman/dive): inspeciona camadas de imagem de forma gráfica e detalhada.
- Estude [multi-stage builds](https://docs.docker.com/build/building/multi-stage/) para gerar históricos mais limpos e eficientes.
- Combine scripts de shell com `-format` e `q` para automatizar auditorias de imagens.

---

## **Resumo**

O comando `docker image history` é uma ferramenta poderosa para rastrear, auditar e entender como uma imagem Docker foi formada, camada a camada. Saber utilizar suas flags corretamente te ajuda a otimizar builds, manter imagens seguras e enxutas, e ter mais controle sobre o ciclo de vida das suas aplicações conteinerizadas.

Se quiser ver exemplos em outros contextos, integração com scripts, ou análise de imagens multi-stage, só avisar!