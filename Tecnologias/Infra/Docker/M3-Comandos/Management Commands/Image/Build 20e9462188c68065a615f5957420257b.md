# Build

Perfeito, Gustavo! Vamos **destrinchar todos os parâmetros do comando `docker image build`** (que na verdade é um alias para o novo `docker buildx build`) detalhando **sintaxe**, **finalidade**, **quando usar**, **exemplos práticos**, e uma **tabela-resumo** para consulta rápida.

---

# docker image build: Guia Completo de Parâmetros

---

## Introdução

O comando `docker image build` é usado para construir imagens Docker a partir de um contexto (diretório, URL ou STDIN) e um Dockerfile. Com a evolução do Docker, a ferramenta `buildx` ampliou as possibilidades, adicionando suporte a múltiplas plataformas, caching avançado, multi-stage, autenticações, exportações diversas, etc.

Conhecer todos os parâmetros permite que você:

- Otimize builds
- Integre com CI/CD
- Crie imagens multi-plataforma
- Controle caching, logs, segurança, etc

---

## Sintaxe Básica

```bash
docker image build [OPTIONS] PATH

```

- **PATH**: Caminho para o diretório contendo o Dockerfile e contexto.
- **OPTIONS**: Parâmetros para customização do processo de build.

---

## Tabela-Resumo dos Parâmetros

| Parâmetro | Tipo / Alias | Finalidade / Uso | Exemplo |
| --- | --- | --- | --- |
| `--add-host` | string | Adiciona mapeamento host/IP customizado (útil para DNS interno em build) | `--add-host dev-db:10.10.0.1` |
| `--allow` | stringArray | Permite entitlements privilegiados, ex: network.host, security.insecure | `--allow network.host` |
| `--annotation` | stringArray | Adiciona anotações à imagem (metadados, ex: CI info) | `--annotation key=value` |
| `--attest` | stringArray | Parâmetros para atestação (ex: SBOM, provenance) | `--attest type=sbom` |
| `--build-arg` | stringArray | Passa variáveis de build (ARG no Dockerfile) | `--build-arg JAR_NAME=app.jar` |
| `--build-context` | stringArray | Adiciona contextos de build extras (multi-contextos) | `--build-context name=dir` |
| `--builder` | string | Define builder instance (multi-builder setups) | `--builder mybuilder` |
| `--cache-from` | stringArray | Fonte externa de cache para acelerar build (imagens, diretórios) | `--cache-from user/app:cache` |
| `--cache-to` | stringArray | Destino para exportar cache gerado | `--cache-to type=local,dest=path/` |
| `--call` | string | Modo de avaliação: build/check/outline/targets | `--call check` |
| `--cgroup-parent` | string | Define cgroup parent para instruções RUN (controle de recursos) | `--cgroup-parent mygroup` |
| `--check` |  | Shorthand para `--call=check` | `--check` |
| `-D, --debug` | flag | Habilita log de debug | `--debug` |
| `-f, --file` | string | Nome do Dockerfile (padrão: PATH/Dockerfile) | `-f Dockerfile.dev` |
| `--iidfile` | string | Salva o Image ID gerado em um arquivo | `--iidfile imageid.txt` |
| `--label` | stringArray | Adiciona metadados (LABEL) na imagem | `--label author=gedelg` |
| `--load` | flag | Carrega a imagem no Docker local após build (shorthand para `--output=type=docker`) | `--load` |
| `--metadata-file` | string | Salva metadados do build em arquivo | `--metadata-file meta.json` |
| `--network` | string | Define modo de rede para instruções RUN durante o build (default: default) | `--network host` |
| `--no-cache` | flag | Não usa cache no build (tudo é reconstruído) | `--no-cache` |
| `--no-cache-filter` | stringArray | Desabilita cache para estágios específicos do build | `--no-cache-filter stage1,stage2` |
| `-o, --output` | stringArray | Define destino do output (ex: `type=local,dest=...`, `type=registry`, `type=docker`) | `-o type=local,dest=out/` |
| `--platform` | stringArray | Define plataforma de build (ex: linux/amd64, linux/arm64) | `--platform linux/arm64` |
| `--progress` | string | Define formato de saída do progresso: auto, tty, plain, quiet, rawjson | `--progress plain` |
| `--provenance` | string | Atalho para `--attest=type=provenance` | `--provenance` |
| `--pull` | flag | Sempre tenta puxar imagens base do registry | `--pull` |
| `--push` | flag | Envia a imagem para registry (shorthand para `--output=type=registry`) | `--push` |
| `-q, --quiet` | flag | Silencia logs do build, mostrando só o image ID | `--quiet` |
| `--sbom` | string | Atalho para `--attest=type=sbom` | `--sbom` |
| `--secret` | stringArray | Exponibiliza segredo no build (ex: id=mysecret,src=local) | `--secret id=mysecret,src=/tmp/secret.txt` |
| `--shm-size` | bytes | Define o tamanho da memória compartilhada para containers de build (default: 64M) | `--shm-size 1g` |
| `--ssh` | stringArray | Expõe agente SSH ou chaves ao build (clone privado, etc) | `--ssh default` |
| `-t, --tag` | stringArray | Nome/tag da imagem gerada (`nome:tag`) | `-t gedelg/meuapp:dev` |
| `--target` | string | Define o estágio alvo do build (multi-stage Dockerfile) | `--target build` |
| `--ulimit` | ulimit | Define limites de recursos do sistema | `--ulimit nofile=1024:1024` |

---

## Descrição Detalhada dos Principais Parâmetros

### -add-host

- **O que faz?** Adiciona mapeamentos de nome de host para IP em `/etc/hosts` durante o build.
- **Quando usar?** Quando o build precisa acessar hosts específicos ou mocks internos.

---

### -allow

- **O que faz?** Permite entitlements privilegiados, como acesso total à rede do host ou modos inseguros.
- **Quando usar?** Build de imagens que precisam de acesso avançado a recursos do host (debugging, perfis especiais).

---

### -attest / --sbom / --provenance

- **O que faz?** Gera informações de segurança e origem do build (Software Bill of Materials/SBOM, provenance, etc).
- **Quando usar?** CI/CD, compliance, supply chain security.

---

### -build-arg

- **O que faz?** Injeta variáveis para o build (usadas como `ARG` no Dockerfile).
- **Quando usar?** Customização de build sem alterar o Dockerfile.

---

### -build-context

- **O que faz?** Permite adicionar múltiplos contextos de build, úteis em builds multi-stage complexos.
- **Quando usar?** Compartilhar arquivos entre stages de builds diferentes.

---

### -cache-from / --cache-to

- **O que faz?** Permite usar/extrair cache externo para acelerar builds.
- **Quando usar?** CI, builds otimizados, reuso de cache em pipelines.

---

### f / --file

- **O que faz?** Especifica qual Dockerfile usar (padrão é `PATH/Dockerfile`).
- **Quando usar?** Repositórios com múltiplos Dockerfiles (dev, prod, etc).

---

### -load / --push / --output

- **O que faz?** Define para onde enviar a imagem após build (carregar local, enviar para registro, exportar para pasta).
- **Quando usar?**
    - `-load`: precisa usar a imagem localmente após build.
    - `-push`: CI, deploy automático em registro remoto.
    - `-output`: exportar como tar, arquivos, OCI, etc.

---

### -platform

- **O que faz?** Define a arquitetura alvo (amd64, arm64, etc).
- **Quando usar?** Builds multi-plataforma, IoT, distribuição para múltiplos ambientes.

---

### -no-cache / --no-cache-filter

- **O que faz?** Ignora cache para todo o build ou para estágios específicos.
- **Quando usar?** Build clean, build de stages críticos, forçar rebuild de etapas específicas.

---

### -network

- **O que faz?** Define a configuração de rede das instruções RUN durante o build.
- **Quando usar?** Builds que precisam de rede host, isolamento de rede.

---

### t / --tag

- **O que faz?** Define nome/tag para imagem (pode múltiplas tags).
- **Quando usar?** Versionamento, múltiplas distribuições, tagging semântico.

---

### -target

- **O que faz?** Em Dockerfiles multi-stage, compila somente até o estágio especificado.
- **Quando usar?** Testar ou extrair artefatos de estágios intermediários.

---

### -secret

- **O que faz?** Injeta arquivos/variáveis secretas em tempo de build (NUNCA vão para a imagem final).
- **Quando usar?** Builds que precisam de chaves de API, tokens, sem expor no resultado final.

---

### -ssh

- **O que faz?** Injeta SSH-agent ou chaves privadas durante o build.
- **Quando usar?** Clonar repositórios privados, builds dependentes de acesso SSH.

---

### -quiet / --progress

- **O que faz?** Controla nível e formato de logs de progresso.
- **Quando usar?** CI, logs limpos, debugging detalhado.

---

### Outros Parâmetros Notáveis

- **-shm-size**: Define memória compartilhada (útil para apps que usam muito `/dev/shm`, como bancos ou Chrome headless).
- **-ulimit**: Controla limites de recursos para builds pesados.
- **-label**: Metadados úteis para rastreabilidade, automação.

---

## Exemplos Práticos

### Build padrão

```
docker image build -t meuapp:latest .

```

### Build com Dockerfile alternativo, argumentos e cache externo

```
docker image build \\
  -f Dockerfile.prod \\
  --build-arg APP_ENV=production \\
  --cache-from ghcr.io/gedelg/meuapp:cache \\
  -t meuapp:prod .

```

### Build multi-plataforma e push direto para registro

```
docker buildx build \\
  --platform linux/amd64,linux/arm64 \\
  -t gedelg/meuapp:multiarch \\
  --push .

```

### Build com segredo (ex: token NPM)

```
docker buildx build \\
  --secret id=npm_token,src=$HOME/.npm-token \\
  -t gedelg/nodeapp:secret .

```

---

## Sugestões para Aprofundamento

- [Docker Buildx docs](https://docs.docker.com/build/buildx/)
- [BuildKit advanced features](https://docs.docker.com/build/building/buildkit/)
- [Docker multi-stage builds](https://docs.docker.com/develop/develop-images/multistage-build/)
- [Segredos no build](https://docs.docker.com/build/guide/secrets/)
- [Cache em CI/CD com Docker](https://docs.docker.com/build/cache/backends/)

---

## Resumo

Dominar os parâmetros do `docker image build` te permite personalizar builds, acelerar pipelines, proteger segredos, criar builds multi-plataforma, melhorar rastreabilidade e distribuir suas imagens de forma eficiente e segura.

Se quiser exemplos de casos reais de uso de cada parâmetro, cenários avançados ou integração com ferramentas de CI/CD, só pedir!