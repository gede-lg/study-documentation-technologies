# Run

Olá Gedê!

Com certeza! O comando `docker compose run` é extremamente útil para executar tarefas pontuais em seus serviços, como rodar um script de migração de banco de dados, executar testes ou abrir um shell interativo dentro de um contêiner.

Vamos detalhar cada um dos seus parâmetros.

### Uso Básico

A sintaxe fundamental do comando é:

```bash
docker compose run [OPÇÕES] NOME_DO_SERVIÇO [COMANDO] [ARGUMENTOS...]

```

- **`NOME_DO_SERVIÇO`**: É o nome do serviço definido no seu arquivo `docker-compose.yml` que você deseja usar para criar e rodar um contêiner. **(Obrigatório)**
- **`[COMANDO]`**: Um comando opcional que você deseja executar dentro do contêiner. Se não for especificado, ele executará o `command` definido para o serviço no `docker-compose.yml`.
- **`[ARGUMENTOS...]`**: Argumentos adicionais para o `[COMANDO]` que você está executando.

A principal característica do `docker compose run` é que ele cria um **novo contêiner** a cada execução para rodar uma tarefa específica. Ele não inicia os outros serviços definidos no `docker-compose.yml` por padrão, a menos que eles sejam dependências do serviço que você está rodando.

---

### Tabela de Opções (OPTIONS)

Aqui está uma tabela detalhada com todas as opções (`flags`) que você pode usar com o `docker compose run`.

| Opção (Curta/Longa) | Sintaxe de Uso | Finalidade |
| --- | --- | --- |
| `--build` | `docker compose run --build web` | Força a construção (build) da imagem do serviço antes de iniciar o contêiner. Útil quando você faz alterações no Dockerfile. |
| `--cap-add` | `docker compose run --cap-add=SYS_ADMIN api` | Adiciona "capabilities" do kernel do Linux ao contêiner, concedendo permissões específicas que não são dadas por padrão. |
| `--cap-drop` | `docker compose run --cap-drop=NET_ADMIN api` | Remove "capabilities" do kernel do Linux, restringindo permissões. |
| `-d`, `--detach` | `docker compose run -d worker` | Roda o contêiner em segundo plano (detached mode) e imprime o ID do contêiner. |
| `--dry-run` | `docker compose run --dry-run web` | Exibe os passos que seriam executados sem realmente rodá-los. Ótimo para depuração. |
| `--entrypoint` | `docker compose run --entrypoint="/bin/sh" web` | Sobrescreve o `ENTRYPOINT` da imagem. Útil para rodar um comando de depuração em um contêiner que normalmente iniciaria um servidor. |
| `-e`, `--env` | `docker compose run -e DEBUG=1 web` | Define ou sobrescreve uma variável de ambiente dentro do contêiner. |
| `--env-from-file` | `docker compose run --env-from-file .env.test web` | Define variáveis de ambiente a partir de um arquivo. |
| `-i`, `--interactive` | `docker compose run -i web /bin/bash` | Mantém o `STDIN` aberto, permitindo interatividade, mesmo que você não esteja "anexado" (attached) ao contêiner. O padrão já é `true`. |
| `-l`, `--label` | `docker compose run -l "com.example.version=1.0" web` | Adiciona ou sobrescreve metadados (labels) no contêiner. |
| `--name` | `docker compose run --name meu_teste web` | Atribui um nome específico ao contêiner temporário que será criado. |
| `-T`, `--no-TTY` | `docker compose run -T db psql -U user -d db` | Desabilita a alocação de um pseudo-TTY. Útil para scripts automatizados onde um terminal não é necessário. |
| `--no-deps` | `docker compose run --no-deps web` | Não inicia os serviços dos quais o serviço principal depende (`depends_on`). |
| `-p`, `--publish` | `docker compose run -p 8080:80 web` | Publica (mapeia) uma porta do contêiner para uma porta no seu host. `HOST:CONTAINER`. |
| `--pull` | `docker compose run --pull=always web` | Define a política para baixar a imagem: `always` (sempre), `missing` (só se não existir localmente), `never` (nunca). |
| `-q`, `--quiet` | `docker compose run -q web` | Suprime a saída padrão (STDOUT) do comando. |
| `--quiet-build` | `docker compose run --build --quiet-build web` | Suprime a saída de progresso durante o processo de build da imagem. |
| `--quiet-pull` | `docker compose run --pull=always --quiet-pull web` | Baixa a imagem sem imprimir as informações de progresso. |
| `--remove-orphans` | `docker compose up -d --remove-orphans` | Remove contêineres para serviços que não estão mais definidos no seu arquivo Compose. (Mais comum com `up`). |
| `--rm` | `docker compose run --rm web` | Remove automaticamente o contêiner assim que o comando é finalizado. **É uma prática altamente recomendada para evitar o acúmulo de contêineres parados.** |
| `-P`, `--service-ports` | `docker compose run -P web` | Publica todas as portas definidas na seção `ports` do serviço no `docker-compose.yml`, mas em portas aleatórias no host. |
| `--use-aliases` | `docker compose run --use-aliases web` | Usa os aliases de rede do serviço para que outros contêineres na mesma rede possam se conectar a este contêiner temporário pelo nome do serviço. |
| `-u`, `--user` | `docker compose run -u "node" web` | Executa o comando dentro do contêiner com um nome de usuário ou UID específico. |
| `-v`, `--volume` | `docker compose run -v $(pwd):/app web` | Monta um volume, mapeando um diretório do host para um diretório dentro do contêiner. `HOST:CONTAINER`. |
| `-w`, `--workdir` | `docker compose run -w "/app/src" web` | Define o diretório de trabalho padrão dentro do contêiner para o comando que será executado. |

---

### Exemplos Práticos

Imaginando que você tenha um `docker-compose.yml` como este:

```yaml
services:
  app:
    build: .
    volumes:
      - .:/app
    command: python manage.py runserver 0.0.0.0:8000
    depends_on:
      - db
  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass

```

1. **Abrir um shell interativo no contêiner `app`:**
    
    ```bash
    # O --rm é crucial aqui para não deixar o contêiner "lixo" para trás.
    # O comando "bash" sobrescreve o "command" padrão do serviço.
    gedelg@gedelg:~$ docker compose run --rm app bash
    
    ```
    
2. **Rodar migrações do banco de dados:**
    
    ```bash
    # Este comando irá iniciar o serviço "db" (pois "app" depende dele),
    # depois rodará o comando de migração e, ao final, removerá o contêiner.
    gedelg@gedelg:~$ docker compose run --rm app python manage.py migrate
    
    ```
    
3. **Executar um comando sem iniciar as dependências (`db`):**
    
    ```bash
    # Útil para rodar testes unitários que não precisam do banco.
    gedelg@gedelg:~$ docker compose run --rm --no-deps app pytest
    
    ```
    
4. **Rodar o serviço em uma porta diferente e com uma variável de ambiente:**
    
    ```bash
    # Roda o serviço "app", mapeia a porta 8080 do host para a 8000 do contêiner
    # e define a variável de ambiente DEBUG como 1.
    gedelg@gedelg:~$ docker compose run --rm -p 8080:8000 -e DEBUG=1 app
    
    ```
    

Espero que esta explicação bem estruturada ajude você a dominar o `docker compose run`, Gedê! É uma ferramenta poderosa para o dia a dia de desenvolvimento. Se tiver mais alguma dúvida, pode perguntar!