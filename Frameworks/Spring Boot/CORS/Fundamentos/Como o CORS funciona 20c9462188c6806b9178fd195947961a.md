# Como o CORS funciona

---

## 1. Introdução

O CORS (Cross-Origin Resource Sharing) é um mecanismo de segurança implementado pelos navegadores para controlar requisições HTTP entre origens diferentes. Ele evita que páginas web façam chamadas não autorizadas a domínios distintos daquele de onde foram carregadas.

---

## 2. Sumário

1. Conceitos Fundamentais
2. Requisições Simples (Simple Requests)
3. Preflight Requests e o método OPTIONS
4. Principais Cabeçalhos HTTP Envolvidos
5. Quando CORS não se Aplica ou é Limitado
6. Componentes Chave no Spring Boot
7. Melhores Práticas e Padrões de Uso
8. Sugestões para Aprofundamento

---

## 3. Conceitos Fundamentais

- **Origem (Origin):** combinação de protocolo + host + porta.
- **Mesma Origem (Same-Origin):** só há restrição de CORS quando a página e a API estão em origens diferentes.
- **Decisão do Navegador:** cabe ao browser bloquear ou permitir, com base nos cabeçalhos que recebe do servidor.

---

## 4. Requisições Simples

- **Quando Ocorrem:**
    - Métodos: `GET`, `HEAD` ou `POST`.
    - Content-Type limitado a `application/x-www-form-urlencoded`, `multipart/form-data` ou `text/plain`.
    - Sem cabeçalhos personalizados além de `Accept`, `Accept-Language`, etc.
- **Fluxo Básico:**
    1. Browser envia requisição normal incluindo o cabeçalho `Origin`.
    2. Servidor responde com `Access-Control-Allow-Origin` (origem permitida ou ).
    3. Browser libera o acesso ao JS caso a origem seja autorizada.

---

## 5. Preflight Requests (`OPTIONS`)

- **Quando São Disparadas:**
    - Métodos além de `GET`/`HEAD`/`POST` (por exemplo, `PUT`, `DELETE`).
    - Uso de cabeçalhos customizados (ex.: `X-Auth-Token`, `Content-Type: application/json`).
- **Fluxo Preflight:**
    1. **OPTIONS** → browser envia um pedido “prévio” contendo:
        - `Origin`
        - `Access-Control-Request-Method` (o método real)
        - `Access-Control-Request-Headers` (lista de cabeçalhos adicionais)
    2. Servidor responde incluindo cabeçalhos como `Access-Control-Allow-Methods` e `Access-Control-Allow-Headers`.
    3. Se aprovado, o browser dispara a requisição real.

---

## 6. Principais Cabeçalhos HTTP Envolvidos

| Cabeçalho | Direção | Função |
| --- | --- | --- |
| `Origin` | Cliente → API | Informa a origem da requisição. |
| `Access-Control-Allow-Origin` | API → Cliente | Origem(s) permitida(s) — pode ser um domínio ou `*`. |
| `Access-Control-Allow-Methods` | API → Cliente | Métodos HTTP autorizados (ex.: `GET, POST, PUT`). |
| `Access-Control-Allow-Headers` | API → Cliente | Cabeçalhos customizados permitidos. |
| `Access-Control-Allow-Credentials` | API → Cliente | Se `true`, permite envio de cookies e credenciais. |
| `Access-Control-Expose-Headers` | API → Cliente | Cabeçalhos que o JS pode ler na resposta. |
| `Access-Control-Max-Age` | API → Cliente | Tempo (em segundos) que o preflight pode ser cacheado. |

---

## 7. Quando CORS Não se Aplica ou é Limitado

- **Requisições Same-Origin:** navegadores não bloqueiam.
- **Credenciais + Wildcard:** não é permitido usar `Access-Control-Allow-Origin: *` junto com `Allow-Credentials: true`.
- **Ambientes não-HTTP:** CORS é um padrão HTTP(S); não há papel em WebSockets ou outros protocolos sem HTTP de handshake CORS.

---

## 8. Componentes Chave no Spring Boot

- **`@CrossOrigin`** (em controladores ou métodos):
    - Permite configurar, de forma declarativa, origens, métodos, cabeçalhos e credenciais.
- **`CorsConfiguration`** + **`UrlBasedCorsConfigurationSource`**:
    - Definem programaticamente políticas de CORS.
- **`CorsFilter`**:
    - Filtro que aplica as regras antes de chegar ao controlador.
- **`WebMvcConfigurer`** (método `addCorsMappings`):
    - Integração por JavaConfig para permitir CORS globalmente.

---

## 9. Melhores Práticas e Padrões de Uso

- **Restringir Origens** em produção a domínios específicos.
- **Permitir Apenas os Métodos e Cabeçalhos Necessários** para reduzir superfície de ataque.
- **Cachear Preflight** (`Access-Control-Max-Age`) para reduzir latência.
- **Validar Credenciais** separadamente (tokens, cookies), não confiar apenas em CORS.
- **Monitorar** em logs tentativas bloqueadas para detectar abusos.

---

## 10. Sugestões para Aprofundamento

- Documentação oficial do MDN sobre CORS.
- Guia do Spring sobre “Securing RESTful Services” com CORS.
- Exemplos de configuração em aplicações multi-módulo.

---

*Com este panorama você terá uma visão clara de como o navegador e o servidor interagem para habilitar (ou bloquear) requisições cross-origin, e como aplicar essas regras de forma eficaz em um projeto Spring Boot.*