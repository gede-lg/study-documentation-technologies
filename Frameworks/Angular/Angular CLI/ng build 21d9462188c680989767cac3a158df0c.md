# ng build

Com certeza, Gedê\! Como A.R.I.A, vou te dar uma explicação super detalhada sobre o comando `ng build` do Angular CLI, que é fundamental para qualquer desenvolvedor frontend como você, mesmo que seu foco seja backend.

---

## O Comando `ng build`: Preparando sua Aplicação Angular para Produção

### Introdução

O comando `ng build` é um dos pilares do desenvolvimento com Angular CLI. Ele é o responsável por **compilar sua aplicação Angular** e **empacotá-la** em arquivos estáticos otimizados que podem ser implantados em qualquer servidor web. Em termos simples, é a mágica que transforma seu código-fonte Angular (TypeScript, HTML, CSS) em algo que um navegador pode entender e executar de forma eficiente.

### Sumário

Nesta explicação, vamos mergulhar no `ng build`, compreendendo seu propósito, explorando sua sintaxe, seus diversos argumentos e opções, e discutindo as melhores práticas para otimizar suas builds para diferentes ambientes.

---

### Conceitos Fundamentais

O `ng build` vai muito além de uma simples compilação. Ele executa uma série de otimizações e transformações para garantir que sua aplicação seja **pequena, rápida e segura** em produção. Alguns dos conceitos fundamentais por trás desse comando incluem:

- **Compilação Ahead-of-Time (AOT):** Ao contrário da compilação Just-in-Time (JIT), onde o navegador compila o código em tempo de execução, a compilação AOT é realizada durante o processo de build. Isso resulta em:
    - **Inicialização mais rápida:** O navegador recebe código JavaScript já compilado, pronto para ser executado.
    - **Menos requisições assíncronas:** Não há necessidade de baixar o compilador Angular em tempo de execução.
    - **Detecção precoce de erros:** Erros de template e TypeScript são identificados durante a build, não em tempo de execução.
    - **Maior segurança:** Não é necessário carregar o compilador no cliente.
- **Tree Shaking:** É um processo de otimização que remove código não utilizado da sua aplicação. Isso significa que apenas o código Angular e de bibliotecas de terceiros que sua aplicação realmente usa é incluído no bundle final, reduzindo drasticamente o tamanho do arquivo.
- **Minificação e Uglificação:** Esses processos removem espaços em branco, comentários e encurtam nomes de variáveis e funções no código JavaScript, CSS e HTML. O objetivo é reduzir o tamanho dos arquivos sem alterar a funcionalidade, tornando o download e a execução mais rápidos.
- **Bundling:** O `ng build` agrupa os arquivos da sua aplicação (JavaScript, CSS, HTML, assets) em um número menor de pacotes (bundles). Isso reduz o número de requisições HTTP que o navegador precisa fazer para carregar a aplicação, melhorando o tempo de carregamento.
- **Cache Busting:** Ao gerar nomes de arquivo com hashes únicos (ex: `main.js?h=abcdef123`), o `ng build` garante que, após uma nova implantação, os navegadores dos usuários baixem as versões mais recentes dos arquivos, evitando problemas de cache desatualizado.

---

### Sintaxe e Uso

A sintaxe básica do comando `ng build` é bem direta:

```bash
ng build [project] [options]

```

- `[project]`: (Opcional) O nome do projeto a ser construído, conforme definido em seu arquivo `angular.json`. Se sua aplicação tiver apenas um projeto ou você estiver no diretório raiz do projeto principal, ele será construído por padrão.
- `[options]`: (Opcional) Uma série de flags que modificam o comportamento da build.

### Exemplos Práticos:

1. **Build básica para produção:**
    
    ```bash
    ng build --configuration production
    # Ou a forma curta (deprecated em versões mais recentes, mas ainda comum):
    ng build --prod
    
    ```
    
    - **Comentário:** Este é o comando mais comum para preparar sua aplicação para implantação. Ele aplica todas as otimizações de produção por padrão (AOT, tree shaking, minificação, etc.).
2. **Build para desenvolvimento (sem otimizações):**
    
    ```bash
    ng build
    
    ```
    
    - **Comentário:** Se você rodar apenas `ng build` sem o `-configuration production` (ou `-prod`), ele fará uma build menos otimizada, o que é útil para depuração e testes locais, pois a build é mais rápida. O output geralmente vai para o diretório `dist/project-name/`.
3. **Build para um ambiente específico (por exemplo, "staging"):**
    
    ```bash
    ng build --configuration=staging
    
    ```
    
    - **Comentário:** Assumindo que você configurou um ambiente "staging" no seu `angular.json` (por exemplo, para diferentes URLs de API).
4. **Gerar um bundle específico (ex: apenas a versão em português):**
    
    ```bash
    ng build --configuration=production --localize=pt
    
    ```
    
    - **Comentário:** Se você estiver usando internacionalização (i18n), pode gerar bundles específicos para cada idioma.

---

### Restrições de Uso

O `ng build` é uma ferramenta poderosa, mas há cenários onde seu uso direto pode não ser o mais adequado, ou onde você precisa considerar alternativas:

- **Durante o desenvolvimento ativo (em vez de `ng serve`):** Para o desenvolvimento diário, depuração e visualização de mudanças em tempo real, **nunca use `ng build`**. O comando correto é `ng serve`. O `ng serve` compila a aplicação em memória e inicia um servidor de desenvolvimento que recarrega automaticamente o navegador a cada mudança no código, tornando o fluxo de trabalho muito mais ágil. Usar `ng build` repetidamente durante o desenvolvimento seria extremamente ineficiente e lento.
- **Para testes unitários ou de integração (`ng test`):** Embora os testes precisem do código compilado, o `ng test` já cuida disso internamente, usando o Karma e o Jasmine. Você não precisa executar `ng build` antes de `ng test`.
- **Para testes end-to-end (`ng e2e`):** Similar aos testes unitários, o `ng e2e` (usando Cypress ou Protractor) geralmente orquestra a build necessária internamente para rodar os testes contra a aplicação.
- **Quando você precisa de uma aplicação que não será implantada (ex: um componente isolado):** Se você está apenas construindo um componente isolado para ser consumido por outra aplicação (como uma biblioteca), pode ser mais adequado usar ferramentas como o **Angular Package Format** ou bibliotecas como o **Nx** para criar packages reutilizáveis, em vez de uma build completa de uma aplicação.
- **Em pipelines de CI/CD para "testar" a build:** Em pipelines de integração contínua/entrega contínua (CI/CD), você **deve** usar `ng build` para criar os artefatos que serão implantados. A restrição aqui é que, após a build, o `ng build` *não* inicia um servidor para que você possa "testar" a aplicação construída. Para isso, você precisaria de um servidor estático separado (como `serve` ou Nginx) rodando sobre os arquivos da pasta `dist`.

---

### Argumentos

O comando `ng build` aceita poucos argumentos posicionais, sendo o principal o nome do projeto.

- `project`: Define o projeto a ser construído. Se o seu `angular.json` tiver múltiplos projetos, você pode especificar qual deles deseja construir.
    - **Tipo:** String
    - **Padrão:** O projeto padrão definido no `angular.json` (geralmente o que está em `projects.<nome-do-projeto-principal>`).
    - **Exemplo:** `ng build my-admin-app --configuration=production`

---

### Opções

As opções (ou flags) são o que realmente tornam o `ng build` flexível e poderoso. Elas controlam o comportamento da build, as otimizações aplicadas e o output.

| Opção | Alias | Tipo | Padrão | Descrição |
| --- | --- | --- | --- | --- |
| `--configuration` | `-c` | `string[]` | `development` | Especifica a configuração de build a ser usada, conforme definida em `angular.json`. É o principal meio de controlar otimizações, variáveis de ambiente e outras configurações específicas para diferentes ambientes (produção, staging, etc.). Pode ser uma lista separada por vírgulas. Ex: `--configuration=production,es2015`. |
| `--output-path` | `-o` | `string` | `dist/<project-name>` | O caminho onde os arquivos de build serão gerados. É relativo à raiz do projeto. |
| `--base-href` |  | `string` | `/` | A URL base para a qual todos os assets da aplicação serão relativos. Essencial para aplicações que são servidas de um subdiretório (ex: `https://meusite.com/meu-app/`). Define o atributo `<base href="..." />` no `index.html`. |
| `--prod` |  | `boolean` | `false` | **DEPRECATED\! Use `--configuration production`**. Ativa as otimizações de produção. Isso inclui AOT, tree shaking, minificação, cache busting, etc. |
| `--aot` |  | `boolean` | `true` (prod) / `false` (dev) | Compila a aplicação usando AOT (Ahead-of-Time compilation). Sempre `true` para builds de produção. |
| `--build-optimizer` |  | `boolean` | `true` (prod) / `false` (dev) | Otimiza a saída para builds de produção. Isso aplica o Tree Shaking e outras otimizações. Sempre `true` para builds de produção. |
| `--source-map` |  | `boolean` | `true` | Gera arquivos de mapeamento de código-fonte (`.map`). Útil para depuração em produção, permitindo ver o código original no navegador. Geralmente `false` para produção para evitar que o código-fonte seja facilmente visível. |
| `--named-chunks` |  | `boolean` | `false` | Adiciona nomes de chunks para melhor depuração. Aumenta o tamanho dos arquivos. |
| `--output-hashing` |  | `string` | `all` | Define como o hashing de saída é aplicado. Opções: `none`, `all`, `media`, `bundles`. Usado para cache busting. `all` é o padrão para produção. |
| `--extract-css` |  | `boolean` | `true` (prod) | Extrai CSS para arquivos separados em vez de embuti-lo no JavaScript. Pode melhorar o desempenho inicial da página. |
| `--extract-licenses` |  | `boolean` | `true` (prod) | Extrai as licenças de terceiros para um arquivo separado (`3rdpartylicenses.txt`). |
| `--localize` |  | `boolean` ou `string[]` | `false` | Gera bundles separados para cada localidade configurada em seu `angular.json` ou para as localidades especificadas. Útil para internacionalização (i18n). |
| `--stats-json` |  | `boolean` | `false` | Gera um arquivo `stats.json` que pode ser usado para analisar o tamanho e o conteúdo dos bundles da sua aplicação. Ótimo para otimização de desempenho. |
| `--delete-output-path` |  | `boolean` | `true` | Limpa o diretório de saída antes de construir. |
| `--preserve-symlinks` |  | `boolean` | `false` | Não resolve symlinks. Útil em alguns cenários específicos de monorepo. |
| `--watch` | `-w` | `boolean` | `false` | Observa mudanças nos arquivos e reconstrói automaticamente. Útil para builds incrementais rápidas durante o desenvolvimento ou para gerar builds continuamente em um ambiente de staging local. Não é recomendado para pipelines de CI/CD. |
| `--verbose` |  | `boolean` | `false` | Habilita o modo verboso para mais detalhes sobre o processo de build. |
| `--progress` |  | `boolean` | `true` | Exibe o progresso da build no console. |
| `--color` |  | `boolean` | `true` | Habilita/desabilita a colorização da saída do console. |
| `--named-projects` |  | `boolean` | `true` | Habilita a exibição dos nomes dos projetos durante a build, caso haja múltiplos. |
| `--ssr` |  | `boolean` | `false` | Habilita a construção para Server-Side Rendering (SSR). Requer setup adicional. |
| `--prerender` |  | `boolean` | `false` | Habilita a prerenderização de rotas. Usado em conjunto com `--ssr`. |
| `--output-paths` |  | `object` | `{}` | Um objeto que mapeia nomes de projeto para caminhos de saída. |

---

### Melhores Práticas e Casos de Uso

1. **Sempre use `-configuration=production` para builds de produção:** É a regra de ouro. Isso garante que todas as otimizações necessárias sejam aplicadas, resultando em uma aplicação leve e performática.
    
    ```bash
    ng build --configuration=production
    
    ```
    
2. **Gerencie ambientes com `angular.json`:** Use o arquivo `angular.json` para definir diferentes configurações de build. Isso permite, por exemplo, ter URLs de API diferentes para desenvolvimento, staging e produção.
    
    ```json
    // angular.json
    "architect": {
        "build": {
            "builder": "@angular-devkit/build-angular:browser",
            "options": { /* ... */ },
            "configurations": {
                "production": {
                    "optimization": true,
                    "outputHashing": "all",
                    // ...
                },
                "staging": {
                    "optimization": false, // Talvez não queira otimização total para staging
                    "fileReplacements": [
                        {
                            "replace": "src/environments/environment.ts",
                            "with": "src/environments/environment.staging.ts"
                        }
                    ]
                }
            }
        }
    }
    
    ```
    
    Para usar:
    
    ```bash
    ng build --configuration=staging
    
    ```
    
3. **Monitore o tamanho dos bundles com `-stats-json`:** Use esta opção para gerar um arquivo JSON com estatísticas detalhadas sobre sua build. Ferramentas como o [Webpack Bundle Analyzer](https://webpack.github.io/analyse/) podem consumir este arquivo para visualizações gráficas que ajudam a identificar grandes dependências e oportunidades de otimização.
    
    ```bash
    ng build --configuration=production --stats-json
    
    ```
    
    Depois, instale o `webpack-bundle-analyzer` e use-o:
    
    ```bash
    npm install -g webpack-bundle-analyzer
    webpack-bundle-analyzer dist/<project-name>/stats.json
    
    ```
    
4. **Ajuste o `base-href` para implantações em subdiretórios:** Se sua aplicação Angular não estiver na raiz do seu domínio (ex: `https://meusite.com/dashboard/`), use `-base-href` para garantir que os assets sejam carregados corretamente.
    
    ```bash
    ng build --configuration=production --base-href=/dashboard/
    
    ```
    
5. **Internacionalização (i18n) com `-localize`:** Para aplicações multilíngues, `-localize` é essencial para gerar bundles otimizados por idioma.
    
    ```bash
    ng build --configuration=production --localize
    # Ou para idiomas específicos:
    ng build --configuration=production --localize=en,pt-BR
    
    ```
    
    Lembre-se de configurar os idiomas em `angular.json` e ter os arquivos de tradução.
    
6. **Integração em Pipelines de CI/CD:** O `ng build --configuration=production` é o comando chave em qualquer script de CI/CD para gerar os artefatos implantáveis. Certifique-se de que o ambiente de build tenha todas as dependências Node.js e Angular CLI instaladas.

---

### Exemplo Completo

Vamos imaginar um cenário onde você tem uma aplicação Angular com múltiplos ambientes (desenvolvimento, staging, produção) e também suporte a internacionalização para inglês e português.

### 1\. Estrutura de `environments`:

```
src/
├── environments/
│   ├── environment.ts          // Padrão (dev)
│   ├── environment.prod.ts     // Para produção
│   └── environment.staging.ts  // Para staging

```

`src/environments/environment.ts`

```tsx
export const environment = {
  production: false,
  apiUrl: '<http://localhost:3000/api>'
};

```

`src/environments/environment.prod.ts`

```tsx
export const environment = {
  production: true,
  apiUrl: '<https://api.meuapp.com/v1>'
};

```

`src/environments/environment.staging.ts`

```tsx
export const environment = {
  production: false, // Pode ser false para facilitar debug no staging
  apiUrl: '<https://api-staging.meuapp.com/v1>'
};

```

### 2\. Configuração no `angular.json`:

```json
{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "version": 1,
  "newProjectRoot": "projects",
  "projects": {
    "meu-app": {
      "projectType": "application",
      "schematics": {},
      "root": "",
      "sourceRoot": "src",
      "prefix": "app",
      "architect": {
        "build": {
          "builder": "@angular-devkit/build-angular:browser",
          "options": {
            "outputPath": "dist/meu-app",
            "index": "src/index.html",
            "main": "src/main.ts",
            "polyfills": [
              "zone.js"
            ],
            "tsConfig": "tsconfig.app.json",
            "assets": [
              "src/favicon.ico",
              "src/assets"
            ],
            "styles": [
              "src/styles.css"
            ],
            "scripts": []
          },
          "configurations": {
            "production": {
              "budgets": [
                {
                  "type": "initial",
                  "maximumWarning": "500kb",
                  "maximumError": "1mb"
                },
                {
                  "type": "anyComponentStyle",
                  "maximumWarning": "2kb",
                  "maximumError": "4kb"
                }
              ],
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.prod.ts"
                }
              ],
              "outputHashing": "all",
              "sourceMap": false,
              "namedChunks": false,
              "optimization": true,
              "extractLicenses": true,
              "vendorChunk": false,
              "buildOptimizer": true
            },
            "staging": {
              "fileReplacements": [
                {
                  "replace": "src/environments/environment.ts",
                  "with": "src/environments/environment.staging.ts"
                }
              ],
              "optimization": false, // Menos otimizações para build mais rápida no staging
              "sourceMap": true,    // Mapeamento para debug no staging
              "namedChunks": true
            },
            "development": {
              "buildOptimizer": false,
              "optimization": false,
              "vendorChunk": true,
              "extractLicenses": false,
              "sourceMap": true,
              "namedChunks": true
            }
          },
          "defaultConfiguration": "production"
        }
      }
    }
  },
  "cli": {
    "analytics": false
  },
  "i18n": {
    "sourceLocale": "en-US",
    "locales": {
      "pt": "src/locale/messages.pt.xlf",
      "en": "src/locale/messages.en.xlf"
    }
  }
}

```

### 3\. Exemplos de Comandos `ng build`:

- **Build para Produção (padrão):**
    
    ```bash
    ng build
    # Isso usará a configuração 'production' por padrão, conforme definido em "defaultConfiguration": "production"
    
    ```
    
    Output: `dist/meu-app/` com arquivos minificados, hashed, etc.
    
- **Build para Staging:**
    
    ```bash
    ng build --configuration=staging
    
    ```
    
    Output: `dist/meu-app/` com a API do ambiente de staging, e com source maps para facilitar a depuração.
    
- **Build para Produção com Base HREF para um Subdiretório:**
Se sua aplicação será implantada em `https://meusite.com/painel/`:
    
    ```bash
    ng build --configuration=production --base-href=/painel/
    
    ```
    
    O `index.html` gerado terá `<base href="/painel/">`.
    
- **Build para Produção com Internacionalização (Português e Inglês):**
    
    ```bash
    ng build --configuration=production --localize
    
    ```
    
    Output:
    
    - `dist/meu-app/en/` com a versão em inglês
    - `dist/meu-app/pt/` com a versão em português

---

### Tópicos Relacionados para Aprofundamento

Para você que já manja de Java e quer se aprofundar no mundo do frontend, especialmente no contexto de deploy e performance, sugiro os seguintes tópicos:

- **Otimização de Performance Web:** Aprofunde-se em conceitos como Core Web Vitals, lazy loading de módulos e componentes, estratégias de cache, compressão (Gzip, Brotli) e CDNs (Content Delivery Networks).
- **Implantação de Aplicações Angular:** Explore opções de hospedagem como Netlify, Vercel, Firebase Hosting, AWS S3 + CloudFront, ou como configurar Nginx para servir sua aplicação Angular.
- **Server-Side Rendering (SSR) com Angular Universal:** Entenda como pré-renderizar sua aplicação Angular no servidor para melhorar SEO e o tempo de carregamento inicial.
- **Progressive Web Apps (PWAs) com Angular:** Aprenda a transformar sua aplicação Angular em um PWA, habilitando funcionalidades offline, notificações push e instalação na tela inicial.
- **Monorepos com Nx:** Para projetos maiores ou múltiplas aplicações Angular, explore o Nx para gerenciar seu workspace de forma eficiente.

Espero que esta explicação super detalhada ajude você, Gedê, a dominar o `ng build`\! Se tiver mais alguma dúvida, A.R.I.A está aqui para ajudar.