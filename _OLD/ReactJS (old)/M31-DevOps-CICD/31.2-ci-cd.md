# CI/CD (Continuous Integration / Continuous Deployment)

## üéØ Introdu√ß√£o e Defini√ß√£o

### Defini√ß√£o Conceitual

**CI/CD** √© a pr√°tica de **automatizar build, teste e deploy** de aplica√ß√µes atrav√©s de **pipelines**, garantindo que **c√≥digo sempre funciona** e **deploys s√£o frequentes e confi√°veis**. Conceitualmente, representa **linha de montagem automatizada** - c√≥digo entra, testes rodam, build acontece, deploy ocorre, tudo sem interven√ß√£o manual.

### Problema que Resolve

**Sem CI/CD**:
- Testes manuais (lentos, esquecidos)
- Build quebrado descoberto tarde
- Deploy manual (erro-prone)
- Rollback complicado

**Com CI/CD**:
- Testes autom√°ticos em cada commit
- Build quebrado detectado imediatamente
- Deploy automatizado e confi√°vel
- Rollback f√°cil (reverter commit)

---

## üîÑ CI (Continuous Integration)

### Conceito

```
Commit ‚Üí CI Pipeline:
‚îú‚îÄ‚îÄ 1. Install dependencies
‚îú‚îÄ‚îÄ 2. Lint code
‚îú‚îÄ‚îÄ 3. Type check
‚îú‚îÄ‚îÄ 4. Run tests
‚îú‚îÄ‚îÄ 5. Build
‚îî‚îÄ‚îÄ 6. Report results

Se FALHAR ‚Üí Block PR
Se PASSAR ‚Üí Allow merge
```

### GitHub Actions - CI Pipeline

```yaml
# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Lint
      - name: ESLint
        run: npm run lint

      # 5. Format check
      - name: Prettier
        run: npm run format:check

      # 6. Type check
      - name: TypeScript
        run: npm run type-check

      # 7. Tests
      - name: Unit tests
        run: npm run test

      # 8. Build
      - name: Build
        run: npm run build

      # 9. Upload coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: true
```

### Matrix Build (M√∫ltiplas Vers√µes)

```yaml
jobs:
  test:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [16, 18, 20]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - run: npm ci
      - run: npm test
```

---

## üöÄ CD (Continuous Deployment)

### Deploy Autom√°tico

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - run: npm ci

      # Build com env vars de produ√ß√£o
      - name: Build
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: npm run build

      # Deploy para Vercel
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
```

---

## üì¶ Deploy Strategies

### 1. Deploy para Vercel

```yaml
# .github/workflows/deploy-vercel.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
```

**Preview Deploys** (autom√°tico para PRs):
```yaml
on:
  pull_request:
    branches: [main]

# ... mesmo c√≥digo, mas remove --prod
vercel-args: ''
# Cria preview URL: https://my-app-pr-123.vercel.app
```

### 2. Deploy para Netlify

```yaml
# .github/workflows/deploy-netlify.yml
name: Deploy to Netlify

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm ci
      - run: npm run build

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './dist'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
```

### 3. Deploy para AWS S3 + CloudFront

```yaml
# .github/workflows/deploy-aws.yml
name: Deploy to AWS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm ci
      - run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload to S3
        run: |
          aws s3 sync dist/ s3://${{ secrets.S3_BUCKET }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/*"
```

### 4. Deploy para GitHub Pages

```yaml
# .github/workflows/deploy-gh-pages.yml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'

      - run: npm ci
      - run: npm run build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
```

---

## üéØ Advanced CI/CD Patterns

### Parallel Jobs

```yaml
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm ci
      - run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm ci
      - run: npm test

  build:
    runs-on: ubuntu-latest
    needs: [lint, test]  # S√≥ roda se lint e test passarem
    steps:
      - uses: actions/checkout@v3
      - run: npm ci
      - run: npm run build
```

### Caching

```yaml
# Cache node_modules para speed up
- uses: actions/setup-node@v3
  with:
    node-version: '18'
    cache: 'npm'  # Automaticamente cachea node_modules

# Cache customizado
- name: Cache dependencies
  uses: actions/cache@v3
  with:
    path: ~/.npm
    key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
    restore-keys: |
      ${{ runner.os }}-node-
```

### Environment Segregation

```yaml
# Deploy para staging
on:
  push:
    branches: [develop]

env:
  ENVIRONMENT: staging

# Deploy para production
on:
  push:
    branches: [main]

env:
  ENVIRONMENT: production

# Usar secrets diferentes por ambiente
- name: Build
  env:
    VITE_API_URL: ${{ secrets[format('{0}_API_URL', env.ENVIRONMENT)] }}
  run: npm run build
```

### Manual Approval (Production)

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://example.com

    steps:
      # ...deploy steps
```

**GitHub Settings**:
- Settings ‚Üí Environments ‚Üí production
- Add required reviewers
- Pipeline pausa e aguarda approval manual

---

## üìä Monitoring & Notifications

### Slack Notifications

```yaml
- name: Slack Notification
  if: always()  # Roda mesmo se falhar
  uses: rtCamp/action-slack-notify@v2
  env:
    SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    SLACK_MESSAGE: |
      Deploy ${{ job.status }}
      Commit: ${{ github.sha }}
      Author: ${{ github.actor }}
```

### Discord Notifications

```yaml
- name: Discord Notification
  if: success()
  uses: sarisia/actions-status-discord@v1
  with:
    webhook: ${{ secrets.DISCORD_WEBHOOK }}
    title: "Deploy Successful"
    description: "Deployed to production"
```

---

## üîê Secrets Management

### GitHub Secrets

```
Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret

Secrets:
- VERCEL_TOKEN
- NETLIFY_AUTH_TOKEN
- AWS_ACCESS_KEY_ID
- AWS_SECRET_ACCESS_KEY
- SENTRY_DSN
```

### Uso em Workflow

```yaml
steps:
  - name: Build
    env:
      VITE_API_URL: ${{ secrets.API_URL }}
      VITE_API_KEY: ${{ secrets.API_KEY }}
    run: npm run build
```

---

## üöÄ Conclus√£o

CI/CD inclui:
- **CI**: Lint, Type check, Tests, Build em cada PR
- **CD**: Deploy automatizado para produ√ß√£o
- **Platforms**: Vercel, Netlify, AWS, GitHub Pages
- **Strategies**: Preview deploys, manual approval, parallel jobs
- **Notifications**: Slack, Discord on success/failure
- **Secrets**: Gerenciar via GitHub Secrets

**Benefits**:
- ‚úÖ Bugs capturados antes de merge
- ‚úÖ Deploy instant√¢neo (push ‚Üí live em 2min)
- ‚úÖ Rollback f√°cil (revert commit)
- ‚úÖ Preview URLs para cada PR
- ‚úÖ Confidence em deploys

CI/CD transforma deploy de evento estressante em n√£o-evento rotineiro.
