# Monitoring e Observability

## üéØ Introdu√ß√£o e Defini√ß√£o

### Defini√ß√£o Conceitual

**Monitoring** √© a pr√°tica de **observar comportamento da aplica√ß√£o em produ√ß√£o**, coletando **m√©tricas, logs e traces** para **detectar problemas**, **entender performance** e **melhorar experi√™ncia do usu√°rio**. Conceitualmente, representa **sistema nervoso da aplica√ß√£o** - sentir o que est√° acontecendo, reagir a problemas e aprender com dados.

### Problema que Resolve

**Sem Monitoring**:
- Bugs descobertos por usu√°rios
- Performance ruim invis√≠vel
- Crashes silenciosos
- Sem dados para decis√µes

**Com Monitoring**:
- Bugs detectados antes de usu√°rios reportarem
- Performance monitorada e otimizada
- Crashes alertados instantaneamente
- Dados para tomar decis√µes

---

## üêõ Error Monitoring (Sentry)

### Setup

```bash
npm install @sentry/react
```

```tsx
// main.tsx
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.MODE,

  // Set sample rate (0.0 - 1.0)
  tracesSampleRate: 1.0,

  // Capture console errors
  integrations: [
    new Sentry.BrowserTracing(),
    new Sentry.Replay({
      maskAllText: true,
      blockAllMedia: true
    })
  ],

  // Session Replay
  replaysSessionSampleRate: 0.1, // 10% of sessions
  replaysOnErrorSampleRate: 1.0 // 100% when error occurs
});

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

### Error Boundary com Sentry

```tsx
import { ErrorBoundary } from '@sentry/react';

function App() {
  return (
    <ErrorBoundary
      fallback={<ErrorFallback />}
      showDialog
      onError={(error, errorInfo) => {
        console.error('Caught by boundary:', error, errorInfo);
      }}
    >
      <Router />
    </ErrorBoundary>
  );
}

function ErrorFallback() {
  return (
    <div>
      <h1>Something went wrong</h1>
      <p>We've been notified and will fix it soon.</p>
      <button onClick={() => window.location.reload()}>
        Reload page
      </button>
    </div>
  );
}
```

### Manual Error Capture

```tsx
try {
  await riskyOperation();
} catch (error) {
  Sentry.captureException(error, {
    tags: {
      section: 'checkout'
    },
    extra: {
      userId: user.id,
      cartItems: cart.items.length
    }
  });
}

// Custom messages
Sentry.captureMessage('User clicked deprecated feature', 'warning');

// Breadcrumbs (context before error)
Sentry.addBreadcrumb({
  category: 'auth',
  message: 'User logged in',
  level: 'info'
});
```

### User Context

```tsx
function App() {
  const { user } = useAuth();

  useEffect(() => {
    if (user) {
      Sentry.setUser({
        id: user.id,
        email: user.email,
        username: user.name
      });
    } else {
      Sentry.setUser(null);
    }
  }, [user]);

  return <Router />;
}
```

---

## üìä Analytics (Google Analytics)

### Setup GA4

```bash
npm install react-ga4
```

```tsx
// lib/analytics.ts
import ReactGA from 'react-ga4';

export const initGA = () => {
  ReactGA.initialize(import.meta.env.VITE_GA_MEASUREMENT_ID, {
    gtagOptions: {
      send_page_view: false // Manual page views
    }
  });
};

export const logPageView = (path: string, title: string) => {
  ReactGA.send({
    hitType: 'pageview',
    page: path,
    title
  });
};

export const logEvent = (
  category: string,
  action: string,
  label?: string,
  value?: number
) => {
  ReactGA.event({
    category,
    action,
    label,
    value
  });
};

// App.tsx
import { initGA, logPageView } from './lib/analytics';

function App() {
  const location = useLocation();

  useEffect(() => {
    initGA();
  }, []);

  useEffect(() => {
    logPageView(location.pathname, document.title);
  }, [location]);

  return <Router />;
}
```

### Event Tracking

```tsx
// Track button clicks
function CheckoutButton() {
  const handleClick = () => {
    logEvent('Checkout', 'Click', 'Checkout Button');
    // ... proceed to checkout
  };

  return <button onClick={handleClick}>Checkout</button>;
}

// Track form submissions
function ContactForm() {
  const handleSubmit = (e) => {
    e.preventDefault();

    logEvent('Contact', 'Submit', 'Contact Form');

    // ... submit form
  };

  return <form onSubmit={handleSubmit}>{/* ... */}</form>;
}

// Track external links
function ExternalLink({ href, children }) {
  const handleClick = () => {
    logEvent('External Link', 'Click', href);
  };

  return (
    <a href={href} onClick={handleClick} target="_blank" rel="noopener">
      {children}
    </a>
  );
}
```

---

## ‚ö° Performance Monitoring

### Web Vitals

```bash
npm install web-vitals
```

```tsx
// lib/vitals.ts
import { onCLS, onFID, onFCP, onLCP, onTTFB } from 'web-vitals';

function sendToAnalytics(metric: any) {
  // Send to GA
  ReactGA.event({
    category: 'Web Vitals',
    action: metric.name,
    value: Math.round(metric.value),
    label: metric.id,
    nonInteraction: true
  });

  // Or send to custom analytics
  fetch('/api/analytics', {
    method: 'POST',
    body: JSON.stringify(metric)
  });
}

export function reportWebVitals() {
  onCLS(sendToAnalytics);  // Cumulative Layout Shift
  onFID(sendToAnalytics);  // First Input Delay
  onFCP(sendToAnalytics);  // First Contentful Paint
  onLCP(sendToAnalytics);  // Largest Contentful Paint
  onTTFB(sendToAnalytics); // Time to First Byte
}

// main.tsx
import { reportWebVitals } from './lib/vitals';

reportWebVitals();
```

### Performance Observer

```tsx
// Monitor long tasks
useEffect(() => {
  if ('PerformanceObserver' in window) {
    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries()) {
        if (entry.duration > 50) {
          console.warn('Long task detected:', entry);

          // Report to analytics
          logEvent('Performance', 'Long Task', entry.name, entry.duration);
        }
      }
    });

    observer.observe({ entryTypes: ['longtask'] });

    return () => observer.disconnect();
  }
}, []);
```

---

## üìà Custom Metrics

### Track Component Render Time

```tsx
function useRenderTime(componentName: string) {
  useEffect(() => {
    const startTime = performance.now();

    return () => {
      const endTime = performance.now();
      const renderTime = endTime - startTime;

      if (renderTime > 100) {
        console.warn(`${componentName} took ${renderTime}ms to render`);

        logEvent('Performance', 'Slow Render', componentName, renderTime);
      }
    };
  });
}

// Uso
function HeavyComponent() {
  useRenderTime('HeavyComponent');

  return <div>{/* ... */}</div>;
}
```

### Track API Call Duration

```tsx
async function fetchWithTiming(url: string) {
  const startTime = performance.now();

  try {
    const response = await fetch(url);
    const endTime = performance.now();
    const duration = endTime - startTime;

    logEvent('API', 'Request', url, duration);

    if (duration > 1000) {
      console.warn(`Slow API call: ${url} took ${duration}ms`);
    }

    return response.json();
  } catch (error) {
    const endTime = performance.now();
    const duration = endTime - startTime;

    logEvent('API', 'Error', url, duration);

    throw error;
  }
}
```

---

## üîî Alerting

### Sentry Alerts

```
Sentry ‚Üí Project Settings ‚Üí Alerts ‚Üí Create Alert

Conditions:
- Error count > 10 in 5 minutes
- New error appears
- Regression (error reappears)

Actions:
- Email team
- Slack notification
- PagerDuty incident
```

### Custom Alerts (Webhook)

```tsx
// Monitor error rate
let errorCount = 0;
let lastAlert = 0;

window.addEventListener('error', (event) => {
  errorCount++;

  // Alert se > 5 errors em 1 minuto
  const now = Date.now();
  if (errorCount > 5 && now - lastAlert > 60000) {
    fetch('/api/alerts', {
      method: 'POST',
      body: JSON.stringify({
        type: 'high_error_rate',
        count: errorCount,
        message: 'High error rate detected'
      })
    });

    lastAlert = now;
    errorCount = 0;
  }
});
```

---

## üìä Dashboards

### Sentry Dashboard

```
- Error rate (last 24h)
- Most common errors
- Affected users
- Error trends
- Session replays
```

### Google Analytics Dashboard

```
- Active users
- Page views
- Bounce rate
- Average session duration
- Top pages
- Conversion funnel
```

### Custom Dashboard (Grafana/Datadog)

```tsx
// Send custom metrics
fetch('/api/metrics', {
  method: 'POST',
  body: JSON.stringify({
    metric: 'page_load_time',
    value: performance.now(),
    tags: {
      page: location.pathname,
      user: user?.id
    }
  })
});

// Visualize in Grafana:
// - Page load time (p50, p95, p99)
// - API response times
// - Error rates by page
// - Active users
```

---

## üöÄ Conclus√£o

Monitoring inclui:
- **Error Tracking**: Sentry (crashes, exceptions, stack traces)
- **Analytics**: Google Analytics (pageviews, events, funnels)
- **Performance**: Web Vitals (LCP, FID, CLS)
- **Custom Metrics**: Render time, API duration
- **Alerting**: Sentry alerts, custom webhooks
- **Dashboards**: Visualizar m√©tricas e trends

**Setup Recomendado**:
1. Sentry (errors + session replay)
2. Google Analytics (user behavior)
3. Web Vitals (performance)
4. Custom metrics (business-specific)

Monitoring n√£o √© "nice to have" - √© **essencial** para aplica√ß√µes production. Sem dados, voc√™ est√° voando cego.
