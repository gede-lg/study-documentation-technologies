# Configura√ß√£o de Ambiente no React

## üéØ Introdu√ß√£o e Defini√ß√£o

### Defini√ß√£o Conceitual

**Configura√ß√£o de Ambiente** √© a pr√°tica de **gerenciar vari√°veis, configura√ß√µes e comportamentos** espec√≠ficos para **diferentes ambientes** (development, staging, production), permitindo que **mesmo c√≥digo rode diferentemente** dependendo do ambiente. Conceitualmente, representa **adaptabilidade contextual** - aplica√ß√£o se comporta de forma apropriada em cada ambiente sem mudar c√≥digo.

### Problema que Resolve

**Sem Configura√ß√£o de Ambiente**:
- API URLs hardcoded
- Secrets commitados no git
- Mesmo comportamento em dev e prod
- Debug em produ√ß√£o

**Com Configura√ß√£o de Ambiente**:
- URLs din√¢micas por ambiente
- Secrets em vari√°veis de ambiente
- Debug apenas em dev
- Otimiza√ß√µes apenas em prod

---

## üåç Environment Variables

### Vite (.env Files)

```bash
# .env (base - commitado no git)
VITE_APP_NAME=My App

# .env.development (dev - commitado)
VITE_API_URL=http://localhost:5000/api
VITE_DEBUG=true

# .env.production (prod - commitado)
VITE_API_URL=https://api.example.com
VITE_DEBUG=false

# .env.local (local - N√ÉO commitado)
VITE_API_KEY=secret_key_local
VITE_SENTRY_DSN=your_sentry_dsn

# .gitignore
.env.local
.env.*.local
```

### Prioridade de .env Files

```
.env.production.local   (maior prioridade em prod)
.env.production
.env.local
.env
```

### Acessar Vari√°veis

```tsx
// ‚úÖ Vari√°veis Vite (prefixo VITE_)
const apiUrl = import.meta.env.VITE_API_URL;
const apiKey = import.meta.env.VITE_API_KEY;
const isDev = import.meta.env.DEV;
const isProd = import.meta.env.PROD;
const mode = import.meta.env.MODE; // 'development' | 'production'

// config.ts - Centralizar configura√ß√µes
export const config = {
  apiUrl: import.meta.env.VITE_API_URL,
  apiKey: import.meta.env.VITE_API_KEY,
  isDev: import.meta.env.DEV,
  debug: import.meta.env.VITE_DEBUG === 'true',

  sentry: {
    dsn: import.meta.env.VITE_SENTRY_DSN,
    enabled: import.meta.env.PROD
  }
};

// Uso
import { config } from './config';

fetch(`${config.apiUrl}/users`);

if (config.debug) {
  console.log('Debug mode enabled');
}
```

### TypeScript Types

```typescript
// env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_URL: string;
  readonly VITE_API_KEY: string;
  readonly VITE_DEBUG: string;
  readonly VITE_SENTRY_DSN: string;
  // ... outras vari√°veis
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

---

## ‚öôÔ∏è Create React App (CRA)

### Environment Variables

```bash
# .env
REACT_APP_API_URL=http://localhost:5000/api
REACT_APP_VERSION=1.0.0

# .env.production
REACT_APP_API_URL=https://api.example.com
```

```tsx
// Acessar (prefixo REACT_APP_)
const apiUrl = process.env.REACT_APP_API_URL;
const version = process.env.REACT_APP_VERSION;
const nodeEnv = process.env.NODE_ENV; // 'development' | 'production'
```

---

## üîê Gerenciamento de Secrets

### ‚ùå NUNCA Fa√ßa Isso

```bash
# ‚ùå Commitar secrets
VITE_API_KEY=sk_live_abc123xyz
VITE_DATABASE_URL=postgres://user:password@host/db
```

### ‚úÖ Secrets Seguros

```bash
# .env.example (commitado - template)
VITE_API_URL=
VITE_API_KEY=
VITE_SENTRY_DSN=

# .env.local (N√ÉO commitado - valores reais)
VITE_API_URL=http://localhost:5000
VITE_API_KEY=sk_dev_abc123
VITE_SENTRY_DSN=https://...

# .gitignore
.env.local
.env.*.local
```

### CI/CD Secrets

```yaml
# GitHub Actions
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
          VITE_API_KEY: ${{ secrets.API_KEY }}
        run: npm run build

      - name: Deploy
        run: npm run deploy
```

---

## üéØ Configura√ß√£o por Ambiente

### Feature Flags

```tsx
// config.ts
export const features = {
  newDashboard: import.meta.env.VITE_FEATURE_NEW_DASHBOARD === 'true',
  betaCheckout: import.meta.env.VITE_FEATURE_BETA_CHECKOUT === 'true',
  analytics: import.meta.env.PROD
};

// Uso
import { features } from './config';

function Dashboard() {
  if (features.newDashboard) {
    return <NewDashboard />;
  }

  return <LegacyDashboard />;
}
```

### API Endpoints

```tsx
// api/config.ts
const API_URLS = {
  development: 'http://localhost:5000/api',
  staging: 'https://staging-api.example.com',
  production: 'https://api.example.com'
};

export const apiUrl =
  import.meta.env.VITE_API_URL ||
  API_URLS[import.meta.env.MODE as keyof typeof API_URLS] ||
  API_URLS.development;

// api/client.ts
import axios from 'axios';
import { apiUrl } from './config';

export const apiClient = axios.create({
  baseURL: apiUrl,
  timeout: 10000
});
```

### Logging

```tsx
// utils/logger.ts
const isDev = import.meta.env.DEV;

export const logger = {
  debug: (...args: any[]) => {
    if (isDev) console.debug('[DEBUG]', ...args);
  },

  info: (...args: any[]) => {
    if (isDev) console.info('[INFO]', ...args);
  },

  warn: (...args: any[]) => {
    console.warn('[WARN]', ...args);
  },

  error: (...args: any[]) => {
    console.error('[ERROR]', ...args);

    // Reportar para Sentry apenas em prod
    if (!isDev) {
      // Sentry.captureException(args[0]);
    }
  }
};

// Uso
logger.debug('User logged in', user);
logger.error('Failed to fetch products', error);
```

---

## üìã Diferentes Configura√ß√µes

### Development

```bash
# .env.development
VITE_API_URL=http://localhost:5000/api
VITE_DEBUG=true
VITE_MOCK_API=false
VITE_CACHE_ENABLED=false
VITE_SOURCE_MAPS=true
```

```tsx
// config.development.ts
export const devConfig = {
  api: {
    url: 'http://localhost:5000/api',
    timeout: 30000, // Maior timeout para debug
    retry: false
  },

  cache: {
    enabled: false
  },

  logging: {
    level: 'debug',
    console: true
  },

  performance: {
    warnThreshold: 1000 // ms
  }
};
```

### Staging

```bash
# .env.staging
VITE_API_URL=https://staging-api.example.com
VITE_DEBUG=true
VITE_MOCK_API=false
VITE_SENTRY_DSN=https://staging-sentry...
```

### Production

```bash
# .env.production
VITE_API_URL=https://api.example.com
VITE_DEBUG=false
VITE_SENTRY_DSN=https://prod-sentry...
VITE_ANALYTICS_ENABLED=true
```

```tsx
// config.production.ts
export const prodConfig = {
  api: {
    url: 'https://api.example.com',
    timeout: 10000,
    retry: true,
    retries: 3
  },

  cache: {
    enabled: true,
    ttl: 300000 // 5 min
  },

  logging: {
    level: 'error',
    console: false
  },

  sentry: {
    enabled: true,
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: 'production'
  },

  analytics: {
    enabled: true,
    googleAnalytics: import.meta.env.VITE_GA_ID
  }
};
```

---

## üîß Configura√ß√£o Din√¢mica

### Runtime Config (N√£o Build Time)

```tsx
// public/config.js (carregado em runtime)
window.__CONFIG__ = {
  apiUrl: 'https://api.example.com',
  features: {
    newDashboard: true
  }
};

// index.html
<script src="/config.js"></script>

// App.tsx
declare global {
  interface Window {
    __CONFIG__: {
      apiUrl: string;
      features: Record<string, boolean>;
    };
  }
}

const config = window.__CONFIG__ || {
  apiUrl: import.meta.env.VITE_API_URL,
  features: {}
};

export { config };
```

**Vantagem**: Mudar config sem rebuild (√∫til para Docker/Kubernetes)

---

## üöÄ Build-Time vs Runtime

### Build-Time (Vite)

```tsx
// ‚úÖ Substitu√≠do em build time
const apiUrl = import.meta.env.VITE_API_URL;

// Build output:
const apiUrl = "https://api.example.com";
```

**Pros**: Performance (valor hardcoded)
**Cons**: Precisa rebuild para mudar

### Runtime

```tsx
// ‚úÖ Avaliado em runtime
const apiUrl = window.__CONFIG__.apiUrl;
```

**Pros**: Muda sem rebuild
**Cons**: Slower (lookup em runtime)

---

## üìä Valida√ß√£o de Environment

### Zod Schema

```typescript
import { z } from 'zod';

const envSchema = z.object({
  VITE_API_URL: z.string().url(),
  VITE_API_KEY: z.string().min(10),
  VITE_DEBUG: z.enum(['true', 'false']).optional(),
  VITE_SENTRY_DSN: z.string().url().optional()
});

// Validar ao iniciar app
try {
  envSchema.parse(import.meta.env);
} catch (error) {
  console.error('‚ùå Invalid environment variables:', error);
  throw error;
}

export const env = {
  apiUrl: import.meta.env.VITE_API_URL,
  apiKey: import.meta.env.VITE_API_KEY,
  debug: import.meta.env.VITE_DEBUG === 'true',
  sentry: {
    dsn: import.meta.env.VITE_SENTRY_DSN
  }
} as const;
```

---

## üöÄ Conclus√£o

Configura√ß√£o de Ambiente inclui:
- **Vari√°veis de Ambiente**: .env, .env.local, .env.production
- **Secrets**: NUNCA commitar, usar .env.local + CI secrets
- **Por Ambiente**: Development (debug), Staging (test), Production (optimized)
- **Feature Flags**: Habilitar/desabilitar features
- **Valida√ß√£o**: Zod schema para garantir env v√°lido
- **Build vs Runtime**: Build-time (performance) vs Runtime (flexibilidade)

**Best Practice**: Use .env.example (template commitado) + .env.local (secrets locais n√£o commitados) + CI secrets (prod).
