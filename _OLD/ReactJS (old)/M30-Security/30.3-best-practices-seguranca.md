# Best Practices de Seguran√ßa no React

## üéØ Introdu√ß√£o e Defini√ß√£o

### Defini√ß√£o Conceitual

**Best Practices de Seguran√ßa** s√£o **recomenda√ß√µes consolidadas** pela ind√∫stria para **prevenir vulnerabilidades comuns**, incluindo **secure coding, dependency management, data protection e deployment seguro**. Conceitualmente, representam **checklist de seguran√ßa** - aplicar sistematicamente para reduzir superf√≠cie de ataque e proteger usu√°rios.

---

## ‚úÖ Checklist de Seguran√ßa

### 1. Input Validation & Sanitization

```tsx
// ‚ùå INSEGURO
function SearchResults({ query }: { query: string }) {
  return <div dangerouslySetInnerHTML={{ __html: query }} />;
}

// ‚úÖ SEGURO - React escapa automaticamente
function SearchResults({ query }: { query: string }) {
  return <div>Results for: {query}</div>;
}

// ‚úÖ Se precisar HTML, sanitize!
import DOMPurify from 'dompurify';

function RichContent({ html }: { html: string }) {
  const clean = DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'p', 'br', 'ul', 'li'],
    ALLOWED_ATTR: ['href']
  });

  return <div dangerouslySetInnerHTML={{ __html: clean }} />;
}
```

**Regra**: SEMPRE sanitize antes de usar `dangerouslySetInnerHTML`.

---

### 2. Secrets Management

```bash
# ‚ùå NUNCA commite secrets
VITE_API_KEY=sk_live_abc123xyz
DATABASE_URL=postgres://user:password@host/db

# ‚úÖ Use .env.local (n√£o commitado)
# .gitignore
.env.local
.env.*.local

# .env.example (template commitado)
VITE_API_URL=
VITE_API_KEY=
```

```tsx
// ‚ùå NUNCA hardcode secrets
const API_KEY = 'sk_live_abc123xyz';

// ‚úÖ Environment variables
const API_KEY = import.meta.env.VITE_API_KEY;

// ‚úÖ MELHOR - Backend proxy
// Frontend chama backend, backend adiciona API_KEY
async function fetchData() {
  const response = await fetch('/api/external-service');
  return response.json();
}

// Backend
app.get('/api/external-service', async (req, res) => {
  const response = await fetch('https://external.com/api', {
    headers: {
      'Authorization': `Bearer ${process.env.API_KEY}`
    }
  });

  res.json(await response.json());
});
```

**Regra**: NUNCA exponha secrets no frontend.

---

### 3. Authentication Best Practices

```tsx
// ‚úÖ httpOnly cookies (n√£o localStorage)
// Backend
res.cookie('authToken', token, {
  httpOnly: true,   // JavaScript n√£o acessa
  secure: true,     // HTTPS only
  sameSite: 'strict', // CSRF protection
  maxAge: 24 * 60 * 60 * 1000
});

// ‚úÖ Password requirements
const passwordSchema = z
  .string()
  .min(8, 'At least 8 characters')
  .regex(/[A-Z]/, 'At least 1 uppercase letter')
  .regex(/[a-z]/, 'At least 1 lowercase letter')
  .regex(/[0-9]/, 'At least 1 number')
  .regex(/[^A-Za-z0-9]/, 'At least 1 special character');

// ‚úÖ Rate limiting (backend)
import rateLimit from 'express-rate-limit';

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 min
  max: 5, // 5 attempts
  message: 'Too many login attempts, try again later'
});

app.post('/api/auth/login', loginLimiter, handleLogin);

// ‚úÖ Account lockout ap√≥s N tentativas
const MAX_LOGIN_ATTEMPTS = 5;
const LOCKOUT_TIME = 15 * 60 * 1000; // 15min

async function handleLogin(req, res) {
  const user = await getUserByEmail(email);

  if (user.lockoutUntil && user.lockoutUntil > Date.now()) {
    return res.status(429).json({
      error: 'Account locked. Try again later'
    });
  }

  if (user.loginAttempts >= MAX_LOGIN_ATTEMPTS) {
    await updateUser(user.id, {
      lockoutUntil: Date.now() + LOCKOUT_TIME,
      loginAttempts: 0
    });

    return res.status(429).json({
      error: 'Too many attempts. Account locked for 15 minutes'
    });
  }

  // Validar password...
}
```

---

### 4. HTTPS Everywhere

```tsx
// ‚úÖ Force HTTPS
// vite.config.ts
import fs from 'fs';

export default defineConfig({
  server: {
    https: {
      key: fs.readFileSync('./certs/key.pem'),
      cert: fs.readFileSync('./certs/cert.pem')
    }
  }
});

// ‚úÖ Upgrade insecure requests
// index.html
<meta http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests" />

// ‚úÖ HSTS (Strict-Transport-Security)
// Backend
app.use((req, res, next) => {
  res.setHeader(
    'Strict-Transport-Security',
    'max-age=31536000; includeSubDomains; preload'
  );
  next();
});
```

---

### 5. Content Security Policy (CSP)

```html
<!-- ‚úÖ CSP Headers -->
<meta
  http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self';
    connect-src 'self' https://api.example.com;
    frame-ancestors 'none';
  "
/>
```

```javascript
// Backend (mais controle)
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.example.com"
  );
  next();
});
```

---

### 6. Dependency Security

```bash
# ‚úÖ Audit regularmente
npm audit

# ‚úÖ Auto-fix vulnerabilities
npm audit fix

# ‚úÖ Force update (breaking changes)
npm audit fix --force

# ‚úÖ Usar apenas packages confi√°veis
# - Verificar downloads/semana
# - Verificar last publish
# - Verificar issues abertas
# - Verificar maintainers
```

```yaml
# ‚úÖ Dependabot (GitHub)
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
    open-pull-requests-limit: 10

# ‚úÖ Snyk (CI/CD)
- name: Run Snyk
  uses: snyk/actions/node@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

---

### 7. Error Handling

```tsx
// ‚ùå INSEGURO - Exp√µe stack traces
function ErrorBoundary({ error }: { error: Error }) {
  return (
    <div>
      <h1>Error</h1>
      <pre>{error.stack}</pre> {/* NUNCA em prod! */}
    </div>
  );
}

// ‚úÖ SEGURO - Mensagem gen√©rica em prod
function ErrorBoundary({ error }: { error: Error }) {
  const isDev = import.meta.env.DEV;

  // Log para Sentry/monitoring
  if (!isDev) {
    Sentry.captureException(error);
  }

  return (
    <div>
      <h1>Something went wrong</h1>
      <p>We've been notified and will fix it soon.</p>

      {isDev && (
        <details>
          <summary>Error details (dev only)</summary>
          <pre>{error.stack}</pre>
        </details>
      )}
    </div>
  );
}
```

---

### 8. Logging & Monitoring

```tsx
// ‚úÖ Remove logs em production
const logger = {
  debug: (...args: any[]) => {
    if (import.meta.env.DEV) {
      console.debug('[DEBUG]', ...args);
    }
  },

  info: (...args: any[]) => {
    if (import.meta.env.DEV) {
      console.info('[INFO]', ...args);
    }
  },

  error: (...args: any[]) => {
    console.error('[ERROR]', ...args);

    // Report para Sentry em prod
    if (import.meta.env.PROD) {
      Sentry.captureException(args[0]);
    }
  }
};

// ‚úÖ NUNCA logue dados sens√≠veis
logger.debug('User logged in', {
  id: user.id,
  email: user.email // OK em dev
  // password: user.password ‚Üê NUNCA!
});
```

---

### 9. CORS Configuration

```javascript
// ‚ùå INSEGURO - Permite qualquer origem
app.use(cors({
  origin: '*'  // NUNCA fa√ßa isso!
}));

// ‚úÖ SEGURO - Whitelist espec√≠fico
const allowedOrigins = [
  'https://example.com',
  'https://www.example.com'
];

if (process.env.NODE_ENV === 'development') {
  allowedOrigins.push('http://localhost:3000');
}

app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true // Permite cookies
}));
```

---

### 10. File Upload Security

```tsx
// ‚úÖ Validar tipo de arquivo
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_SIZE = 5 * 1024 * 1024; // 5MB

function FileUpload() {
  const handleFile = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];

    if (!file) return;

    // Validar tipo
    if (!ALLOWED_TYPES.includes(file.type)) {
      alert('Invalid file type. Only JPEG, PNG, WebP allowed.');
      return;
    }

    // Validar tamanho
    if (file.size > MAX_SIZE) {
      alert('File too large. Max 5MB.');
      return;
    }

    uploadFile(file);
  };

  return (
    <input
      type="file"
      accept="image/jpeg,image/png,image/webp"
      onChange={handleFile}
    />
  );
}

// Backend - Validar novamente!
app.post('/api/upload', upload.single('file'), (req, res) => {
  const file = req.file;

  // Validar MIME type (n√£o confie em extens√£o)
  const allowedMimes = ['image/jpeg', 'image/png', 'image/webp'];
  if (!allowedMimes.includes(file.mimetype)) {
    return res.status(400).json({ error: 'Invalid file type' });
  }

  // Validar tamanho
  if (file.size > 5 * 1024 * 1024) {
    return res.status(400).json({ error: 'File too large' });
  }

  // Sanitize filename
  const sanitizedFilename = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');

  // Salvar com nome √∫nico
  const uniqueFilename = `${Date.now()}-${sanitizedFilename}`;

  res.json({ filename: uniqueFilename });
});
```

---

## üöÄ Conclus√£o

Best Practices de Seguran√ßa:
1. **Input Validation**: Sanitize antes de `dangerouslySetInnerHTML`
2. **Secrets**: .env.local, NUNCA commitar, backend proxy
3. **Auth**: httpOnly cookies, password requirements, rate limiting
4. **HTTPS**: Sempre, HSTS, upgrade insecure requests
5. **CSP**: Content Security Policy headers
6. **Dependencies**: npm audit, dependabot, Snyk
7. **Errors**: Mensagens gen√©ricas em prod, log para Sentry
8. **Logging**: Remove logs em prod, NUNCA logue senhas
9. **CORS**: Whitelist espec√≠fico, n√£o `*`
10. **File Upload**: Validar tipo, tamanho, sanitize filename

**Checklist de Deploy**:
- [ ] HTTPS enabled
- [ ] CSP headers configurados
- [ ] Secrets em environment variables
- [ ] npm audit clean
- [ ] Error boundaries com mensagens gen√©ricas
- [ ] Logs de debug removidos
- [ ] CORS whitelist configurado
- [ ] Rate limiting em endpoints sens√≠veis

Seguran√ßa √© **processo cont√≠nuo**, n√£o feature √∫nica!
