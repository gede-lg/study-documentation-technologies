# Jest - Framework de Testes

## ðŸŽ¯ IntroduÃ§Ã£o e DefiniÃ§Ã£o

### DefiniÃ§Ã£o Conceitual

**Jest** Ã© um **framework de testes JavaScript** criado pelo Facebook, que oferece **zero-config** testing com **mocking**, **coverage** e **snapshot testing** integrados. Conceitualmente, representa uma **soluÃ§Ã£o completa** - combina test runner, assertion library, mocking e coverage em uma ferramenta Ãºnica. Ã‰ o padrÃ£o de fato para testar React, mas funciona com qualquer JavaScript.

### Contexto HistÃ³rico

Antes do Jest:
- Jasmine (test framework)
- Mocha (test runner) + Chai (assertions) + Sinon (mocks)
- ConfiguraÃ§Ã£o complexa e fragmentada

Jest unificou tudo em 2014, popularizou-se com React em 2016.

### Problema que Resolve

**Sem Jest**:
- Configurar mÃºltiplas bibliotecas
- Mocks complexos e verbosos
- Coverage separado
- Testes lentos (sem paralelizaÃ§Ã£o)

**Com Jest**:
- Zero configuraÃ§Ã£o inicial
- Mocks automÃ¡ticos e simples
- Coverage integrado
- ExecuÃ§Ã£o paralela rÃ¡pida
- Watch mode inteligente

---

## ðŸ“‹ Estrutura de Teste Jest

```javascript
// describe - agrupa testes relacionados
describe('Calculator', () => {
  // beforeEach - executa antes de cada teste
  beforeEach(() => {
    // Setup
  });

  // afterEach - executa depois de cada teste
  afterEach(() => {
    // Cleanup
  });

  // test/it - caso de teste individual
  test('soma dois nÃºmeros', () => {
    expect(add(2, 3)).toBe(5);
  });

  it('subtrai dois nÃºmeros', () => {
    expect(subtract(5, 3)).toBe(2);
  });

  // describe aninhado
  describe('operaÃ§Ãµes avanÃ§adas', () => {
    test('multiplica', () => {
      expect(multiply(2, 3)).toBe(6);
    });
  });
});
```

### Lifecycle Hooks

```javascript
describe('Lifecycle', () => {
  beforeAll(() => {
    // Executa UMA VEZ antes de todos os testes
    console.log('Setup inicial');
  });

  afterAll(() => {
    // Executa UMA VEZ depois de todos os testes
    console.log('Cleanup final');
  });

  beforeEach(() => {
    // Executa ANTES DE CADA teste
    console.log('Setup por teste');
  });

  afterEach(() => {
    // Executa DEPOIS DE CADA teste
    console.log('Cleanup por teste');
  });

  test('teste 1', () => {});
  test('teste 2', () => {});
});

// Output:
// Setup inicial
// Setup por teste
// teste 1
// Cleanup por teste
// Setup por teste
// teste 2
// Cleanup por teste
// Cleanup final
```

---

## ðŸ” Matchers - Assertions

### Matchers BÃ¡sicos

```javascript
// Igualdade
expect(2 + 2).toBe(4); // Igualdade estrita (===)
expect({ name: 'John' }).toEqual({ name: 'John' }); // Igualdade profunda

// Truthiness
expect(null).toBeNull();
expect(undefined).toBeUndefined();
expect(true).toBeTruthy();
expect(false).toBeFalsy();
expect(0).toBeDefined();

// NÃºmeros
expect(10).toBeGreaterThan(5);
expect(10).toBeGreaterThanOrEqual(10);
expect(5).toBeLessThan(10);
expect(5).toBeLessThanOrEqual(5);
expect(0.1 + 0.2).toBeCloseTo(0.3); // Floats
```

### Matchers de String

```javascript
// Substring
expect('hello world').toContain('world');
expect('team').not.toContain('I');

// Regex
expect('hello@test.com').toMatch(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/);
expect('123').toMatch(/^\d+$/);
```

### Matchers de Array/Iterables

```javascript
const arr = [1, 2, 3, 4, 5];

expect(arr).toContain(3);
expect(arr).toHaveLength(5);
expect(new Set([1, 2, 3])).toContain(2);

// Array especÃ­fico
expect(arr).toEqual([1, 2, 3, 4, 5]);

// ContÃ©m item que satisfaz condiÃ§Ã£o
expect([{ id: 1 }, { id: 2 }]).toContainEqual({ id: 1 });
```

### Matchers de Objetos

```javascript
const user = {
  id: 1,
  name: 'John',
  email: 'john@test.com'
};

// Propriedade existe
expect(user).toHaveProperty('email');
expect(user).toHaveProperty('email', 'john@test.com');

// Match parcial
expect(user).toMatchObject({
  name: 'John'
}); // Ignora outras props

// Estrutura exata
expect(user).toEqual({
  id: 1,
  name: 'John',
  email: 'john@test.com'
});
```

### Matchers de FunÃ§Ãµes

```javascript
// FunÃ§Ã£o foi chamada
const mockFn = jest.fn();
mockFn();
expect(mockFn).toHaveBeenCalled();

// Quantidade de chamadas
mockFn();
expect(mockFn).toHaveBeenCalledTimes(2);

// Chamada com argumentos
mockFn('hello', 42);
expect(mockFn).toHaveBeenCalledWith('hello', 42);
expect(mockFn).toHaveBeenLastCalledWith('hello', 42);

// FunÃ§Ã£o lanÃ§ou erro
const throwError = () => { throw new Error('Boom!'); };
expect(throwError).toThrow();
expect(throwError).toThrow('Boom!');
expect(throwError).toThrow(Error);
```

### Matchers AssÃ­ncronos

```javascript
// Promises
test('retorna dados', async () => {
  await expect(fetchData()).resolves.toEqual({ data: 'value' });
});

test('rejeita com erro', async () => {
  await expect(fetchData()).rejects.toThrow('Error');
});

// Async/await alternativo
test('async test', async () => {
  const data = await fetchData();
  expect(data).toEqual({ data: 'value' });
});
```

---

## ðŸŽ­ Mocks e Spies

### Mock Functions

```javascript
// Criar mock function
const mockFn = jest.fn();

// Mock com retorno
const mockFn = jest.fn(() => 'mocked value');
mockFn(); // 'mocked value'

// Mock com retornos diferentes
const mockFn = jest.fn()
  .mockReturnValueOnce('first')
  .mockReturnValueOnce('second')
  .mockReturnValue('default');

mockFn(); // 'first'
mockFn(); // 'second'
mockFn(); // 'default'
mockFn(); // 'default'

// Mock assÃ­ncrono
const mockAsync = jest.fn()
  .mockResolvedValue('success')
  .mockRejectedValueOnce(new Error('failed'));

await mockAsync(); // throws Error
await mockAsync(); // 'success'

// ImplementaÃ§Ã£o customizada
const mockFn = jest.fn((a, b) => a + b);
expect(mockFn(2, 3)).toBe(5);
```

### Mock de MÃ³dulos

```javascript
// api.js
export function fetchUser(id) {
  return fetch(`/api/users/${id}`).then(r => r.json());
}

// user.test.js
import { fetchUser } from './api';

// Mock do mÃ³dulo inteiro
jest.mock('./api');

test('busca usuÃ¡rio', async () => {
  // Mock do retorno
  fetchUser.mockResolvedValue({
    id: 1,
    name: 'John'
  });

  const user = await fetchUser(1);

  expect(user).toEqual({ id: 1, name: 'John' });
  expect(fetchUser).toHaveBeenCalledWith(1);
});
```

### Mock Parcial de MÃ³dulo

```javascript
// utils.js
export const add = (a, b) => a + b;
export const multiply = (a, b) => a * b;

// test.js
jest.mock('./utils', () => ({
  ...jest.requireActual('./utils'), // MantÃ©m funÃ§Ãµes reais
  multiply: jest.fn() // Mock apenas multiply
}));

import { add, multiply } from './utils';

test('mock parcial', () => {
  multiply.mockReturnValue(100);

  expect(add(2, 3)).toBe(5); // Real
  expect(multiply(2, 3)).toBe(100); // Mocked
});
```

### Spy em MÃ©todos

```javascript
// Spy em mÃ©todo de objeto
const calculator = {
  add: (a, b) => a + b
};

const spy = jest.spyOn(calculator, 'add');

calculator.add(2, 3); // Chama funÃ§Ã£o real

expect(spy).toHaveBeenCalled();
expect(spy).toHaveBeenCalledWith(2, 3);

// Restaurar implementaÃ§Ã£o original
spy.mockRestore();
```

### Mock de Timers

```javascript
// CÃ³digo que usa setTimeout
function delayedGreeting(callback) {
  setTimeout(() => {
    callback('Hello!');
  }, 1000);
}

test('chama callback apÃ³s delay', () => {
  jest.useFakeTimers(); // Ativa fake timers

  const callback = jest.fn();
  delayedGreeting(callback);

  // AvanÃ§a timers
  jest.advanceTimersByTime(1000);

  expect(callback).toHaveBeenCalledWith('Hello!');

  jest.useRealTimers(); // Restaura timers reais
});

// Pular todos os timers pendentes
jest.runAllTimers();

// Pular apenas timers imediatos (setImmediate)
jest.runOnlyPendingTimers();
```

---

## ðŸ“¸ Snapshot Testing

### Snapshot BÃ¡sico

```javascript
import React from 'react';
import { render } from '@testing-library/react';
import Button from './Button';

test('renderiza corretamente', () => {
  const { container } = render(<Button>Click me</Button>);

  // Cria snapshot
  expect(container.firstChild).toMatchSnapshot();
});

// __snapshots__/Button.test.js.snap
// exports[`renderiza corretamente 1`] = `
// <button
//   class="btn"
// >
//   Click me
// </button>
// `;
```

### Snapshot Inline

```javascript
test('configuraÃ§Ã£o de usuÃ¡rio', () => {
  const config = {
    theme: 'dark',
    notifications: true,
    language: 'pt-BR'
  };

  expect(config).toMatchInlineSnapshot(`
    Object {
      "language": "pt-BR",
      "notifications": true,
      "theme": "dark",
    }
  `);
});
```

### Quando Usar Snapshots

**âœ… Usar para**:
- Output de componentes simples
- Estruturas de dados complexas
- FormataÃ§Ã£o de textos/logs
- Catching mudanÃ§as nÃ£o intencionais

**âŒ Evitar para**:
- Valores dinÃ¢micos (timestamps, IDs)
- Estruturas muito grandes
- Testes que devem verificar comportamento especÃ­fico

### Property Matchers

```javascript
test('usuÃ¡rio criado', () => {
  const user = {
    id: generateId(), // Valor dinÃ¢mico
    createdAt: new Date(),
    name: 'John'
  };

  expect(user).toMatchSnapshot({
    id: expect.any(String), // Aceita qualquer string
    createdAt: expect.any(Date) // Aceita qualquer Date
  });
});
```

---

## ðŸ“Š Coverage - Cobertura de Testes

### Configurar Coverage

```json
// package.json
{
  "scripts": {
    "test": "jest",
    "test:coverage": "jest --coverage"
  },
  "jest": {
    "collectCoverageFrom": [
      "src/**/*.{js,jsx}",
      "!src/index.js",
      "!src/**/*.test.js"
    ],
    "coverageThresholds": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
}
```

### MÃ©tricas de Coverage

```
--------------------|---------|----------|---------|---------|
File                | % Stmts | % Branch | % Funcs | % Lines |
--------------------|---------|----------|---------|---------|
All files           |   85.71 |    66.67 |     100 |   85.71 |
 calculator.js      |   85.71 |    66.67 |     100 |   85.71 |
--------------------|---------|----------|---------|---------|
```

- **Statements**: % de declaraÃ§Ãµes executadas
- **Branches**: % de caminhos de if/else cobertos
- **Functions**: % de funÃ§Ãµes chamadas
- **Lines**: % de linhas executadas

### Ignorar Linhas no Coverage

```javascript
function processData(data) {
  if (data) {
    return processValidData(data);
  }
  /* istanbul ignore next */
  return null; // Linha nÃ£o coberta, mas ignorada
}
```

---

## ðŸš€ ConclusÃ£o

Jest oferece:
- **Matchers**: toBe, toEqual, toContain, toHaveBeenCalled
- **Mocks**: jest.fn(), jest.mock(), jest.spyOn()
- **Timers**: jest.useFakeTimers(), jest.advanceTimersByTime()
- **Snapshots**: toMatchSnapshot() para catching mudanÃ§as
- **Coverage**: MÃ©tricas de cobertura integradas

Framework completo que unifica test runner, assertions, mocks e coverage em uma ferramenta Ãºnica, com zero-config e performance otimizada.
