
Os arquivos de migrations são essenciais para controlar a evolução da estrutura do banco de dados. Cada tipo de migração tem um propósito específico e uma forma padrão de ser nomeado. Vamos ver em detalhes os tipos e prefixos mais comuns utilizados por ferramentas como **Flyway**.

---

## Tipos de Migrations

### 1. **Versioned Migrations**

As **Versioned Migrations** são o tipo padrão e mais comum. Elas evoluem o banco de dados passo a passo, aplicando alterações de forma incremental.

- **Identificação**: Cada versão recebe um número sequencial.
- **Aplicação**: Executadas na ordem numérica especificada.
- **Registro**: Cada migração aplicada é registrada para evitar execuções repetidas.

#### **Exemplo de Arquivo Versioned:**

**Nome do arquivo:** `V1__criar_tabela_clientes.sql`

```sql
CREATE TABLE clientes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Nome do arquivo:** `V2__adicionar_coluna_telefone.sql`

```sql
ALTER TABLE clientes ADD telefone VARCHAR(20);
```

---

### 2. **Undo Migrations**

As **Undo Migrations** permitem reverter alterações feitas por migrações versionadas. Elas não são obrigatórias, mas são úteis em cenários onde é necessário voltar atrás de mudanças específicas.

- **Identificação**: Usam o prefixo **U** seguido do número da migração a ser desfeita.
- **Aplicação**: Executadas em ordem reversa ao processo de aplicação.

#### **Exemplo de Arquivo Undo:**

**Nome do arquivo:** `U2__remover_coluna_telefone.sql`

```sql
ALTER TABLE clientes DROP COLUMN telefone;
```

Este arquivo desfaz a mudança introduzida na migração `V2`.

---

### 3. **Repeatable Migrations**

As **Repeatable Migrations** são aplicadas sempre que o conteúdo do arquivo muda. Elas são úteis para definir ou atualizar objetos que não precisam de versões sequenciais, como:

- **Views**
    
- **Stored Procedures**
    
- **Functions**
    
- **Triggers**
    
- **Identificação**: Usam o prefixo **R** seguido por uma descrição.
    
- **Aplicação**: Sempre que o conteúdo do arquivo for modificado, a migração será reaplicada.
    

#### **Exemplo de Arquivo Repeatable:**

**Nome do arquivo:** `R__criar_view_clientes_ativos.sql`

```sql
CREATE OR REPLACE VIEW clientes_ativos AS
SELECT id, nome, email
FROM clientes
WHERE ativo = true;
```

Neste caso, sempre que o conteúdo da view for alterado, a migração será reaplicada automaticamente.

---

## Prefixos de Nomenclatura

Os prefixos são fundamentais para identificar o tipo de migração. Seguem uma convenção padronizada para facilitar o controle e execução.

|**Prefixo**|**Tipo de Migração**|**Exemplo de Nome**|**Descrição**|
|---|---|---|---|
|**V**|Versioned|`V1.1__criar_tabela_usuarios`|Migração incremental padrão|
|**U**|Undo|`U1.1__remover_tabela_usuarios`|Desfaz a migração `V1.1`|
|**R**|Repeatable|`R__criar_view_clientes_ativos`|Executada sempre que o arquivo for modificado|

### **Regras de Nomenclatura**

1. **Separador**: O número da versão é separado por um duplo underscore `__` da descrição.
2. **Descrições Claras**: Utilize descrições que indiquem claramente o que a migração faz.
3. **Numeração**: Siga uma sequência lógica para Versioned e Undo Migrations.
4. **Sem Espaços**: Use underscores `_` em vez de espaços.

---

## Estrutura Completa de um Diretório de Migrations

Um diretório típico de migrations pode ter a seguinte estrutura:

```
src/main/resources/db/migration/
│-- V1__criar_tabela_usuarios.sql
│-- V2__adicionar_coluna_email.sql
│-- U2__remover_coluna_email.sql
│-- R__criar_view_usuarios_ativos.sql
```

### **Ordem de Execução:**

1. **Versioned Migrations (`V`)** são aplicadas em ordem numérica (`V1`, `V2`, etc.).
2. **Repeatable Migrations (`R`)** são executadas após todas as Versioned Migrations, sempre que houver mudanças.
3. **Undo Migrations (`U`)** são aplicadas apenas quando for necessário reverter mudanças específicas.

---

## Boas Práticas

1. **Mantenha Scripts Pequenos**: Cada migração deve ser focada em uma única alteração.
2. **Evite Alterar Migrations Aplicadas**: Não edite arquivos versionados já aplicados em ambientes de produção.
3. **Teste Antes de Executar**: Sempre teste migrações localmente ou em um ambiente de teste antes de aplicá-las em produção.
4. **Rollback Planejado**: Prepare Undo Migrations para cenários críticos em que a reversão é essencial.
5. **Documente Mudanças**: Mantenha um histórico claro das alterações feitas no banco de dados.

---

Essa estrutura e organização ajudam a garantir que as migrações sejam gerenciadas de forma eficiente e que o banco de dados esteja sempre sincronizado com a aplicação.