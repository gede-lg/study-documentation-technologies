
## Criando Diretórios Necessários

1. Crie um diretório para armazenar os dados do registry:

     ```sh
     mkdir -p ~/docker_registry/data
     ```

## Gerando Certificados TLS

   - Gere um certificado autoassinado usando `openssl` (especializado para ambientes dev e testes, para ambientes e produção de forma gratuita conferir o Lets Encrypt - São as opções gratuitas):

     ```sh
     mkdir -p ~/docker_registry/certs
     openssl req -newkey rsa:4096 -nodes -sha256 -keyout ~/docker_registry/certs/domain.key -x509 -days 365 -out ~/docker_registry/certs/domain.crt
     ```

## Configurando a Autenticação

1. **Instalar `htpasswd`**:
   - No Ubuntu, você pode instalar o Apache2-utils:
     ```sh
     sudo apt-get install apache2-utils
     ```

2. **Criar Arquivo de Senhas**:
   - Crie um arquivo de senhas para autenticação:
     ```sh
     mkdir -p ~/docker_registry/auth
     htpasswd -Bc ~/docker_registry/auth/htpasswd <username>
     ```

## Iniciando o Docker Registry

1. **Executar o Registry**:
   - Use o comando Docker para iniciar o registry com suporte a TLS e autenticação:
     ```sh
     docker run -d \
       -p 5000:5000 \
       --name registry \
       --restart always \
       -v ~/docker_registry/data:/var/lib/registry \
       -v ~/docker_registry/certs:/certs \
       -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
       -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
       -v ~/docker_registry/auth:/auth \
       -e "REGISTRY_AUTH=htpasswd" \
       -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
       -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
       registry:2
     ```

2. verifique se o registry subiu: `curl -k -u <username>:<password> https://172.19.34.68:5000/v2/_catalog` a resposta deverá ser:

```json
{"repositories":[]}
```

**OBS:** caso dê o erro `server gave HTTP response to HTTPS client.` Favor executar os próximos passos, irá configurar o docker para aceitar envio de requisições http para esse serviço:
  
```
sudo nano /etc/docker/daemon.json
```

Após isso cole o seguinte no arquivo: 
```json
{ "insecure-registries":["<hostname>:5000"] }
```

Aperte `Ctrl+X` para sair, e `Y` para salvar. Logo em seguida execute o seguinte comando para reiniciar o sistema e aplicar as mudanças. Após isso é só testar novamente:

```bash
sudo systemctl restart docker
```

3. **Configurar o Docker para confiar no Certificado**:
   - Adicione o certificado à lista de certificados confiáveis do Docker:

```sh
     sudo mkdir -p /etc/docker/certs.d/<hostname>:5000
     sudo cp ~/docker_registry/certs/domain.crt /etc/docker/certs.d/<hostname>:5000/ca.crt
```

2. **Logar no Registry**:
   - Use o comando `docker login` para se autenticar:

```sh
     docker login <hostname>:5000
```

3. **Push e Pull de Imagens**:
   - Tag e envie uma imagem para o registry:
     ```sh
     docker tag <imagem> <hostname>:5000/<nome_imagem>
     docker push <hostname>:5000/<nome_imagem>
     ```
   - Baixe uma imagem do registry:
     ```sh
     docker pull <hostname>:5000/<nome_imagem>
     ```