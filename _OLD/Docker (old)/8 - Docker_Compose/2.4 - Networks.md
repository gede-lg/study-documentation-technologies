## O que é e para que serve?

A chave `networks` no `docker-compose.yml` é usada para definir e configurar redes dentro de um contexto do Docker Compose. Redes no Docker permitem que contêineres se comuniquem entre si de forma isolada e segura. Ao especificar redes no Docker Compose, você pode controlar a comunicação entre os serviços, definir políticas de rede e segmentar partes do seu aplicativo para melhorar a segurança e a eficiência do tráfego.

## Restrições de uso

- **Compatibilidade de versão**: A utilização da chave `networks` requer que o arquivo `docker-compose.yml` esteja usando a versão 2 ou superior.
- **Isolamento de rede**: Redes definidas em um `docker-compose.yml` são isoladas de outras redes não especificadas no mesmo arquivo, a menos que se configure explicitamente uma conexão entre elas.
- **Dependência de driver**: Algumas configurações de redes podem depender de drivers de rede específicos, como `overlay` ou `bridge`. Certos parâmetros de configuração só estão disponíveis para determinados drivers.

## Subchaves disponíveis

A chave `networks` pode incluir várias subchaves para configurar diferentes aspectos das redes:

- `driver`: Especifica o driver de rede a ser usado (por exemplo, `bridge`, `overlay`).
- `driver_opts`: Fornece opções específicas do driver como um mapa de chaves e valores.
- `ipam`: Configurações de gerenciamento de endereços IP. Subchaves:
  - `driver`: O driver de IPAM a usar.
  - `config`: Uma lista de configurações de IPAM, que podem incluir:
    - `subnet`: O subnet em CIDR format.
    - `ip_range`: O range de IPs dentro do subnet.
    - `gateway`: O gateway padrão para o subnet.
    - `aux_addresses`: Endereços IP auxiliares atribuídos a dispositivos específicos.
- `external`: Indica se a rede é externa ao conjunto de serviços definidos no arquivo, permitindo o uso de uma rede criada fora do Docker Compose.
- `name`: Nome personalizado para a rede no contexto do Docker.

#### 1. **driver**
A subchave `driver` especifica qual driver de rede o Docker deve usar para criar a rede. Os drivers comuns incluem `bridge`, `overlay`, e `macvlan`, cada um adequado para diferentes tipos de tarefas e ambientes operacionais.

**Formato de Uso:**
```yaml
networks:
  my_network:
    driver: bridge
```

#### 2. **driver_opts**
`driver_opts` permite especificar opções que são passadas diretamente para o driver de rede. Estas opções são específicas para cada driver e podem incluir configurações como opções de bridge, ajustes de MTU, etc.

**Formato de Uso:**
```yaml
networks:
  my_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: "docker1"
      com.docker.network.bridge.enable_ip_masquerade: "true"
```

#### 3. **ipam**
`ipam` configura o gerenciamento de endereços IP. Possui suas próprias subchaves para uma configuração detalhada.

##### 3.1 **ipam.driver**
Especifica o driver de IPAM (IP Address Management) a ser usado. O valor padrão geralmente é `default`, que é gerenciado internamente pelo Docker.

**Formato de Uso:**
```yaml
networks:
  my_network:
    ipam:
      driver: default
```

##### 3.2 **ipam.config**
Esta subchave permite a definição de uma lista de parâmetros de configuração de rede.

###### - **subnet**
Define o sub-rede em notação CIDR que será usada pela rede.

###### - **ip_range**
Especifica um alcance de endereços IP dentro do subnet especificado que pode ser usado para alocação dinâmica.

###### - **gateway**
Define o gateway padrão para o subnet.

###### - **aux_addresses**
Permite definir endereços IP específicos a serem atribuídos a determinados contêineres ou serviços.

**Exemplo de Uso:**
```yaml
networks:
  my_network:
    ipam:
      config:
        - subnet: "192.168.0.0/24"
          ip_range: "192.168.0.0/25"
          gateway: "192.168.0.1"
          aux_addresses:
            my_container: "192.168.0.5"
```

#### 4. **name**
Permite especificar um nome personalizado para a rede dentro do contexto do Docker, que pode ser referenciado por outros serviços ou especificações de rede.

**Formato de Uso:**
```yaml
networks:
  my_custom_network:
    name: my_custom_network
```

#### 5. **external**
A subchave `external` indica se a rede é externa ao Docker Compose, ou seja, uma rede que foi criada fora do contexto do arquivo `docker-compose.yml` atual. Isso é útil para compartilhar uma mesma rede entre múltiplos projetos Docker Compose.

**Formato de Uso:**
```yaml
networks:
  my_existing_network:
    external: true
```

## Exemplo completo utilizando a chave `networks` e todas suas subchaves

```yaml
version: '3.8'

services:
  app:
    image: my-app-image
    networks:
      - internal_network
      - external_network

  database:
    image: my-database-image
    networks:
      internal_network:
        ipv4_address: 192.168.10.5

networks:
  internal_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: "docker1"
      com.docker.network.bridge.enable_ip_masquerade: "true"
    ipam:
      driver: default
      config:
        - subnet: "192.168.10.0/24"
          ip_range: "192.168.10.0/26"
          gateway: "192.168.10.1"
          aux_addresses:
            app_static: "192.168.10.5"
            db_static: "192.168.10.6"
    name: my-bridge-network

  external_network:
    external: true
    name: existing-network

```

### Explicação do Exemplo

**Serviços:**

- **app**: Este serviço usa a imagem `my-app-image` e está conectado a duas redes, `internal_network` e `external_network`.
- **database**: Usa a imagem `my-database-image` e está conectado apenas à rede interna `internal_network`. Ele também recebe um endereço IP estático dentro da rede interna.

**Redes:**

- **internal_network**:
    
    - **Driver**: Usamos o `bridge` para a rede interna, configurando-a com o nome `docker1`.
    - **Driver Options**: Habilitamos a mascaramento de IP para permitir a comunicação com a Internet ou outras redes.
    - **IPAM**: Configuração padrão de gerenciamento de IP:
        - **Subnet**: Definimos o subnet para `192.168.10.0/24`.
        - **IP Range**: Limitamos a alocação dinâmica de IPs à primeira metade do subnet (`192.168.10.0/26`).
        - **Gateway**: Especificamos um gateway padrão para a rede.
        - **Aux Addresses**: Atribuímos endereços IP estáticos para os serviços `app` e `database`.
    - **Name**: O nome personalizado da rede dentro do Docker é `my-bridge-network`.
- **external_network**:
    
    - **External**: Indicamos que esta é uma rede externa, ou seja, não definida dentro deste `docker-compose.yml`.
    - **Name**: Especificamos o nome da rede externa existente que o Docker deve se conectar como `existing-network`.

#### Considerações Adicionais

A definição de redes no Docker Compose é crucial para aplicações que precisam de comunicação entre múltiplos contêineres, oferecendo uma maneira controlada e segura de gerenciar o tráfego de rede. Além disso, pode-se integrar redes Compose com redes já existentes no ambiente Docker, facilitando a integração com infraestruturas mais amplas e complexas.