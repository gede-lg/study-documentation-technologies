
## O que é e para que serve?

No contexto do Docker Compose, a chave `secrets` é usada para gerenciar dados sensíveis, como senhas, chaves de API e certificados, que não devem ser expostos ou armazenados diretamente nos arquivos `docker-compose.yml`. O uso de segredos ajuda a aumentar a segurança das aplicações, pois os dados sensíveis são armazenados de forma segura e apenas referenciados nos serviços que necessitam deles.

## Restrições de Uso

A principal restrição ao usar segredos em Docker Compose é que eles requerem o Docker Engine em modo swarm para serem gerenciados nativamente pelo Docker. Para usuários que não utilizam o swarm, é necessário criar uma abordagem alternativa para gerenciar segredos, como o uso de volumes para injetar segredos em contêineres de forma segura ou o uso de ferramentas de terceiros para gestão de segredos.

Outra restrição é que os segredos são imutáveis: uma vez que um segredo é criado no swarm, ele não pode ser alterado; apenas novos segredos podem ser criados e os antigos, removidos.

## Subchaves de `secrets`

No Docker Compose, a chave `secrets` pode conter subchaves que definem cada segredo individualmente. As principais subchaves são:

- `file`: Caminho para o arquivo que contém o dado sensível no host. Esse arquivo não é adicionado ao versionamento e tipicamente está presente apenas no ambiente de produção ou similar.
- `external`: Indica se o segredo é externo ao stack do Docker Compose, ou seja, foi criado diretamente via Docker e não é gerenciado pelo arquivo `docker-compose.yml`.

Dentro da chave `secrets`, podemos configurar cada segredo individualmente. Aqui estão as subchaves para `file` e `external`, que são as principais formas de especificar os segredos:

- **file**: 
  - **Uso**: A subchave `file` indica o caminho para o arquivo no host que contém o segredo. Esse arquivo será carregado pelo Docker Compose como um segredo.
  - **Nota**: O caminho deve ser relativo ao local do arquivo `docker-compose.yml` ou um caminho absoluto.

- **external**:
  - **Uso**: A subchave `external` indica se o segredo é gerenciado fora do Docker Compose. Isso é útil quando você tem segredos que foram criados por outros meios e apenas precisa referenciá-los em seu serviço.
  - **Formato**:
    - `name`: O nome do segredo externo como é conhecido no Docker.
    - `optional`: Booleano que indica se o segredo é opcional. Se definido como `true`, o Docker Compose não falhará se o segredo não existir.

#### Exemplo completo utilizando a chave `secrets`

```yaml
version: '3.8'
services:
  app:
    image: my-app-image
    secrets:
      - my_secret
      - my_external_secret

secrets:
  my_secret:
    file: ./secret_data/my_secret.txt
  my_external_secret:
    external:
      name: my-predefined-secret
      optional: true
```

#### Explicação do Exemplo

Neste exemplo, definimos dois segredos para o serviço `app`:

1. **my_secret**: Este segredo é definido localmente no arquivo `docker-compose.yml`. A subchave `file` é usada para especificar o caminho do arquivo que contém o segredo, neste caso, `./secret_data/my_secret.txt`.

2. **my_external_secret**: Este segredo é gerenciado externamente. A subchave `external` é usada para indicar que o Docker Compose deve buscar um segredo já existente chamado `my-predefined-secret`. A opção `optional: true` indica que o serviço não falhará se esse segredo não estiver disponível, o que é útil para ambientes de desenvolvimento onde certos segredos podem não ser necessários.
## Exemplo Completo Utilizando a Chave `secrets` e suas Subchaves

A seguir, um exemplo de como usar a chave `secrets` no arquivo `docker-compose.yml`, considerando todas as subchaves mencionadas:

```yaml
version: '3.9'  # versão mínima para suporte de secrets

services:
  app:
    image: minha-imagem
    ports:
      - "80:80"
    secrets:
      - my_secret
      - another_secret

secrets:
  my_secret:
    file: ./path/to/my_secret.txt  # caminho local do arquivo de segredo
  another_secret:
    external: true  # segredo criado e gerenciado externamente ao docker-compose

```

Neste exemplo, dois segredos são utilizados pelo serviço `app`:

1. `my_secret`: Um segredo local, cujo valor é armazenado em um arquivo no host e é especificado pelo caminho `./path/to/my_secret.txt`.
2. `another_secret`: Um segredo que é gerenciado externamente, talvez criado diretamente através de comandos do Docker em um ambiente swarm.

## Considerações Adicionais

Ao usar segredos, é crucial garantir que os arquivos no host estejam protegidos adequadamente com as permissões de acesso corretas, para que apenas os usuários e serviços autorizados possam lê-los. Além disso, é importante manter os arquivos de segredos fora do controle de versão para evitar a exposição acidental de dados sensíveis.

Em um ambiente de produção, recomenda-se usar ferramentas de gerenciamento de segredos mais robustas, como HashiCorp Vault, AWS Secrets Manager ou Azure Key Vault, especialmente em configurações que não utilizam Docker swarm, para uma gestão mais flexível e segura dos segredos.

- **Segurança**: Ao trabalhar com segredos, é importante garantir que os arquivos de segredos não sejam incluídos em repositórios de código fonte ou expostos de qualquer forma. Utilize `.gitignore` para excluir arquivos de segredos do controle de versão.
- **Gerenciamento de Segredos**: Para produção, considere usar gerenciadores de segredos mais robustos, como o Docker Swarm Secrets ou soluções de terceiros como HashiCorp Vault, que oferecem mais controle e segurança.

Usar a chave `secrets` no Docker Compose ajuda a manter os dados sensíveis seguros e separados do restante do código, facilitando a manutenção e aumentando a segurança da aplicação.

O uso adequado de segredos é uma parte fundamental da segurança de aplicações em contêineres e deve ser cuidadosamente planejado e implementado conforme as necessidades específicas de cada projeto.